<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BTP Connect v8.11</title>
  <link rel="icon" href="data:,">
  <!-- PWA (LOT B) - harmless in Electron; SW registration is guarded in JS -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0b1220">
  <!-- iOS installability hints -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="BTP Connect">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; box-sizing: border-box; }
    body { background: linear-gradient(135deg, #020617 0%, #0f172a 50%, #1e1b4b 100%); min-height: 100vh; margin: 0; }
    .sidebar { width: 260px; background: linear-gradient(180deg, #0f172a 0%, #1e1b4b 100%); border-right: 1px solid rgba(51, 65, 85, 0.5); }
    .main-content { margin-left: 260px; min-height: 100vh; }
    .card { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 1rem; }
    .menu-item { transition: all 0.2s; border-left: 3px solid transparent; }
    .menu-item:hover { background: rgba(139, 92, 246, 0.1); }
    .menu-item.active { background: rgba(139, 92, 246, 0.2); border-left-color: #8b5cf6; color: #a78bfa; }
    .btn-primary { background: linear-gradient(135deg, #7c3aed 0%, #4f46e5 100%); cursor: pointer; }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); cursor: pointer; }
    .btn-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); cursor: pointer; }
    .stat-card { transition: all 0.3s; cursor: pointer; }
    .stat-card:hover { transform: translateY(-2px); border-color: rgba(139, 92, 246, 0.5); box-shadow: 0 4px 15px rgba(139, 92, 246, 0.2); }
    .badge { padding: 2px 8px; border-radius: 9999px; font-size: 11px; font-weight: 500; }
    .badge-success { background: rgba(16, 185, 129, 0.2); color: #34d399; }
    .badge-warning { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
    .badge-danger { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    .badge-info { background: rgba(56, 189, 248, 0.2); color: #38bdf8; }
    .badge-violet { background: rgba(139, 92, 246, 0.2); color: #a78bfa; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 1000; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: all 0.3s; }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal-content { background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 1rem; max-width: 700px; width: 95%; max-height: 90vh; overflow-y: auto; }
    .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
    .accordion-content.open { max-height: 2000px; }
    .progress-bar { height: 8px; border-radius: 4px; background: rgba(51, 65, 85, 0.5); overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease-out; }
    .drop-zone { border: 2px dashed rgba(100, 116, 139, 0.5); transition: all 0.3s; cursor: pointer; }
    .drop-zone:hover { border-color: #8b5cf6; background: rgba(139, 92, 246, 0.1); }
    .toast { position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; background: #1e293b; border: 1px solid #334155; border-radius: 10px; color: #e2e8f0; z-index: 2000; animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes pulse-alert { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .pulse-alert { animation: pulse-alert 2s infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .animate-spin { animation: spin 1s linear infinite; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    .data-table { width: 100%; border-collapse: collapse; }
    .data-table th { text-align: left; padding: 12px; background: rgba(30, 41, 59, 0.5); color: #94a3b8; font-weight: 500; font-size: 12px; text-transform: uppercase; }
    .data-table td { padding: 12px; border-top: 1px solid rgba(51, 65, 85, 0.3); }
    .data-table tr:hover { background: rgba(51, 65, 85, 0.2); }
    input, select, textarea { background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 0.5rem; padding: 10px 14px; color: #e2e8f0; width: 100%; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #7c3aed; box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2); }
    .header-btn { padding: 8px; border-radius: 8px; cursor: pointer; transition: background 0.2s; background: transparent; border: none; font-size: 16px; position: relative; z-index: 50; }
    .header-btn:hover { background: rgba(51, 65, 85, 0.5); }
    .toggle-btn { transition: all 0.2s; }
    .toggle-btn.active { background: linear-gradient(135deg, #7c3aed 0%, #4f46e5 100%) !important; color: white !important; }
    .toggle-btn:not(.active) { background: transparent; color: #64748b; }
    .clickable-row { cursor: pointer; }
    .clickable-row:hover { background: rgba(139, 92, 246, 0.1); }

    /* Responsive (mobile) - imported from ecosystem_27 UI */
    @media (max-width: 1024px) {
      .sidebar { position: fixed; left: -260px; top: 0; bottom: 0; z-index: 60; transition: left 0.3s; }
      .sidebar.open { left: 0; }
      .main-content { margin-left: 0; }
      .mobile-menu-btn { display: inline-flex !important; }
    }
    .mobile-menu-btn { display: none; }
    
    /* ThÃ¨me clair - CORRECTIONS COMPLÃˆTES */
    .light-theme { background: #f1f5f9 !important; }
    .light-theme .sidebar { background: linear-gradient(180deg, #e2e8f0 0%, #cbd5e1 100%) !important; border-color: #94a3b8 !important; }
    .light-theme .card { background: #ffffff !important; border-color: #e2e8f0 !important; box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important; }
    .light-theme .main-content { background: #f1f5f9 !important; }
    .light-theme header { background: rgba(241,245,249,0.95) !important; border-color: #e2e8f0 !important; }
    .light-theme .text-slate-100, .light-theme .text-slate-200, .light-theme .text-white { color: #1e293b !important; }
    .light-theme .text-slate-400, .light-theme .text-slate-500 { color: #64748b !important; }
    .light-theme .text-slate-300 { color: #334155 !important; }
    .light-theme .bg-slate-800, .light-theme .bg-slate-800\/50, .light-theme .bg-slate-800\/30 { background: #e2e8f0 !important; }
    .light-theme input, .light-theme select, .light-theme textarea { background: #ffffff !important; border-color: #cbd5e1 !important; color: #1e293b !important; }
    .light-theme input::placeholder, .light-theme textarea::placeholder { color: #94a3b8 !important; }
    .light-theme .modal-content { background: #ffffff !important; border-color: #e2e8f0 !important; }
    .light-theme .menu-item { color: #475569 !important; }
    .light-theme .menu-item.active { background: rgba(124, 58, 237, 0.15) !important; color: #7c3aed !important; }
    .light-theme .data-table th { background: #e2e8f0 !important; color: #475569 !important; }
    .light-theme .data-table td { color: #1e293b !important; border-color: #e2e8f0 !important; }
    .light-theme .data-table tr:hover { background: #f8fafc !important; }
    .light-theme .toggle-btn:not(.active) { color: #1e293b !important; background: #e2e8f0 !important; }
    .light-theme .badge { color: inherit; }
    .light-theme .badge-success { background: rgba(16, 185, 129, 0.15) !important; color: #059669 !important; }
    .light-theme .badge-warning { background: rgba(251, 191, 36, 0.15) !important; color: #d97706 !important; }
    .light-theme .badge-danger { background: rgba(239, 68, 68, 0.15) !important; color: #dc2626 !important; }
    .light-theme .badge-info { background: rgba(56, 189, 248, 0.15) !important; color: #0284c7 !important; }
    .light-theme .badge-violet { background: rgba(139, 92, 246, 0.15) !important; color: #7c3aed !important; }
    .light-theme .progress-bar { background: #cbd5e1 !important; }
    .light-theme .drop-zone { border-color: #94a3b8 !important; background: #f8fafc !important; }
    .light-theme .drop-zone:hover { border-color: #7c3aed !important; background: rgba(124, 58, 237, 0.05) !important; }
    .light-theme .toast { background: #ffffff !important; border-color: #e2e8f0 !important; color: #1e293b !important; box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important; }
    .light-theme .header-btn { color: #475569 !important; }
    .light-theme .header-btn:hover { background: #e2e8f0 !important; }
    .light-theme #themeMenu { background: #ffffff !important; border-color: #e2e8f0 !important; }
    .light-theme #themeMenu button { color: #1e293b !important; }
    .light-theme #themeMenu button:hover { background: #f1f5f9 !important; }
    .light-theme #themeMenu p.text-slate-500 { color: #64748b !important; }
    .light-theme .stat-card:hover { box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important; }
    
    /* ThÃ¨me OcÃ©an Bleu */
    .ocean-theme { background: linear-gradient(135deg, #0c1929 0%, #0d3b66 50%, #1a5276 100%) !important; }
    .ocean-theme .sidebar { background: linear-gradient(180deg, #0d3b66 0%, #1a5276 100%) !important; }
    .ocean-theme .card { background: rgba(13, 59, 102, 0.6) !important; border-color: rgba(26, 82, 118, 0.5) !important; }
    .ocean-theme .menu-item.active { background: rgba(52, 152, 219, 0.2) !important; border-left-color: #3498db !important; color: #85c1e9 !important; }
    .ocean-theme .btn-primary { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%) !important; }
    
    /* ThÃ¨me Coucher de soleil */
    .sunset-theme { background: linear-gradient(135deg, #1a1a2e 0%, #2d132c 50%, #3d1f3d 100%) !important; }
    .sunset-theme .sidebar { background: linear-gradient(180deg, #2d132c 0%, #ee5a24 100%) !important; }
    .sunset-theme .card { background: rgba(45, 19, 44, 0.6) !important; border-color: rgba(238, 90, 36, 0.3) !important; }
    .sunset-theme .menu-item.active { background: rgba(238, 90, 36, 0.2) !important; border-left-color: #ee5a24 !important; color: #f39c12 !important; }
    .sunset-theme .btn-primary { background: linear-gradient(135deg, #ee5a24 0%, #e74c3c 100%) !important; }
    
    /* ThÃ¨me Minuit Violet */
    .midnight-theme { background: linear-gradient(135deg, #0a0a1a 0%, #1a0a2e 50%, #2d1b4e 100%) !important; }
    .midnight-theme .sidebar { background: linear-gradient(180deg, #1a0a2e 0%, #4a1c6b 100%) !important; }
    .midnight-theme .card { background: rgba(26, 10, 46, 0.6) !important; border-color: rgba(74, 28, 107, 0.5) !important; }
    .midnight-theme .menu-item.active { background: rgba(156, 39, 176, 0.2) !important; border-left-color: #9c27b0 !important; color: #ce93d8 !important; }
    .midnight-theme .btn-primary { background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%) !important; }

    @media (max-width: 1024px) {
      .sidebar { position: fixed; left: -260px; z-index: 50; transition: left 0.3s; height: 100vh; }
      .sidebar.open { left: 0; }
      .main-content { margin-left: 0; }
    }
    
    /* Mobile specific styles */
    @media (max-width: 768px) {
      .desktop-only { display: none !important; }
      .mobile-actions-limited .action-edit,
      .mobile-actions-limited .action-delete,
      .mobile-actions-limited .action-download { display: none !important; }
      #menu-documents-container { display: none !important; }
      .modal-content { max-width: 95vw !important; max-height: 90vh !important; overflow-y: auto; }
      .grid-cols-2 { grid-template-columns: 1fr !important; }
      .grid-cols-3 { grid-template-columns: 1fr !important; }
      .grid-cols-4 { grid-template-columns: repeat(2, 1fr) !important; }
    }
    
    @media (min-width: 769px) {
      .mobile-only { display: none !important; }
    }
  
    /* --- UX hardening (LOT 4) --- */
    :focus-visible { outline: 2px solid #a78bfa; outline-offset: 2px; }
    @media (prefers-reduced-motion: reduce) {
      * { animation-duration: 0.001ms !important; animation-iteration-count: 1 !important; transition-duration: 0.001ms !important; scroll-behavior: auto !important; }
    }
    .truncate-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .break-anywhere { overflow-wrap: anywhere; word-break: break-word; }
    .btn-primary, .btn-success, .btn-danger { min-height: 40px; }
    .modal-content { outline: none; }
    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

  </style>
</head>
<body class="text-slate-200">

  <!-- SIDEBAR -->
  <aside class="sidebar fixed left-0 top-0 bottom-0 flex flex-col z-40" id="sidebar">
    <div class="p-6 border-b border-slate-800/50">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-gradient-to-br from-violet-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg">
          <span class="text-xl">ğŸ—ï¸</span>
        </div>
        <div>
          <h1 class="text-lg font-bold bg-gradient-to-r from-violet-400 to-indigo-400 bg-clip-text text-transparent">BTP Connect</h1>
          <p class="text-xs text-slate-500">v8.11-API</p>
        </div>
      </div>
    </div>

    <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
      <button onclick="showTab('dashboard')" id="menu-dashboard" class="menu-item active w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-300 rounded-lg">
        <span>ğŸ </span> Tableau de bord
      </button>
      <button onclick="showTab('annuaire')" id="menu-annuaire" class="menu-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-400 rounded-lg">
        <span>ğŸ¢</span> Annuaire
        <span class="ml-auto badge badge-violet" id="badge-annuaire">6</span>
      </button>
      <button onclick="showTab('chantiers')" id="menu-chantiers" class="menu-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-400 rounded-lg">
        <span>ğŸ‘·</span> Chantiers
        <span class="ml-auto badge badge-info">3</span>
      </button>
      <button onclick="showTab('situations')" id="menu-situations" class="menu-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-400 rounded-lg">
        <span>ğŸ“„</span> Situations
        <span class="ml-auto badge badge-warning pulse-alert" id="badge-situations">4</span>
      </button>
      <button onclick="showTab('analyse')" id="menu-analyse" class="menu-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-400 rounded-lg">
        <span>ğŸ¤–</span> Analyse IA
      </button>
      <button onclick="showTab('facturation')" id="menu-facturation" class="menu-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-400 rounded-lg">
        <span>ğŸ’¶</span> Facturation
        <span class="ml-auto badge badge-danger" id="badge-factures">2</span>
      </button>
      <button onclick="showTab('documents')" id="menu-documents" class="menu-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-400 rounded-lg">
        <span>ğŸ“</span> Documents
      </button>
      <button onclick="showTab('parametres')" id="menu-parametres" class="menu-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-400 rounded-lg">
        <span>âš™ï¸</span> ParamÃ¨tres
      </button>
      
      <!-- Menu Admin - Visible uniquement pour les administrateurs -->
      <div id="menu-admin-container" class="mt-4 pt-4 border-t border-slate-700/50 hidden">
        <p class="px-4 text-xs text-slate-600 uppercase tracking-wider mb-2">Administration</p>
        <button onclick="showTab('admin')" id="menu-admin" class="menu-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-400 rounded-lg">
          <span>ğŸ”</span> Admin BDD
          <span class="ml-auto badge badge-danger text-xs">Admin</span>
        </button>
      </div>
    </nav>

    <div class="p-4 border-t border-slate-800/50">
      <div class="flex items-center gap-3 p-3 rounded-xl bg-slate-800/30 cursor-pointer hover:bg-slate-800/50 transition-colors" onclick="openModal('modalProfil')">
        <div class="w-10 h-10 bg-gradient-to-br from-emerald-400 to-cyan-500 rounded-full flex items-center justify-center text-white font-bold">JD</div>
        <div class="flex-1">
          <p class="text-sm font-medium text-slate-200">JÃ©rÃ©mie Durand</p>
          <p class="text-xs text-slate-500">Administrateur ğŸ”</p>
        </div>
        <span class="text-slate-500">â–¶</span>
      </div>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main-content">
    <header class="sticky top-0 z-30 bg-slate-900/80 backdrop-blur-xl border-b border-slate-800/50 px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <button onclick="toggleSidebar()" class="mobile-menu-btn header-btn" type="button" aria-label="Ouvrir le menu">â˜°</button>
          <div>
            <h2 class="text-xl font-bold text-slate-100" id="page-title">Tableau de bord</h2>
            <p class="text-sm text-slate-500" id="page-subtitle">Vue d'ensemble de votre activitÃ©</p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <div class="relative">
            <button type="button" class="header-btn" onclick="toggleThemeMenu()" title="Changer le thÃ¨me">
              <span id="themeIcon">ğŸŒ™</span>
            </button>
            <div id="themeMenu" class="hidden absolute right-0 top-full mt-2 w-48 bg-slate-800 border border-slate-700 rounded-xl shadow-xl z-50 overflow-hidden">
              <div class="p-2 text-xs text-slate-500 uppercase tracking-wide border-b border-slate-700">ThÃ¨mes</div>
              <button onclick="setTheme('dark')" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-slate-700 text-left">
                <span class="text-lg">ğŸŒ™</span>
                <div><p class="text-sm text-slate-200">Sombre</p><p class="text-xs text-slate-500">ThÃ¨me par dÃ©faut</p></div>
              </button>
              <button onclick="setTheme('light')" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-slate-700 text-left">
                <span class="text-lg">â˜€ï¸</span>
                <div><p class="text-sm text-slate-200">Clair</p><p class="text-xs text-slate-500">Mode jour</p></div>
              </button>
              <button onclick="setTheme('ocean')" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-slate-700 text-left">
                <span class="text-lg">ğŸŒŠ</span>
                <div><p class="text-sm text-slate-200">OcÃ©an Bleu</p><p class="text-xs text-slate-500">Tons bleus</p></div>
              </button>
              <button onclick="setTheme('sunset')" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-slate-700 text-left">
                <span class="text-lg">ğŸŒ…</span>
                <div><p class="text-sm text-slate-200">Coucher de soleil</p><p class="text-xs text-slate-500">Tons orangÃ©s</p></div>
              </button>
              <button onclick="setTheme('midnight')" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-slate-700 text-left">
                <span class="text-lg">ğŸŒŒ</span>
                <div><p class="text-sm text-slate-200">Minuit Violet</p><p class="text-xs text-slate-500">Tons violets profonds</p></div>
              </button>
            </div>
          </div>
          <button type="button" class="header-btn" onclick="openModal('modalAide')" title="Aide">â“</button>
          <button type="button" class="header-btn" onclick="toggleNotifications()" title="Notifications" id="btnNotif">
            ğŸ””<span class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full text-xs flex items-center justify-center text-white" id="notif-count">3</span>
          </button>
        </div>
      </div>
    </header>

    <div class="p-6">
      <!-- TAB: Dashboard -->
      <div id="tab-dashboard" class="tab-content">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
          <div class="card p-5 cursor-pointer hover:border-violet-500/50 transition-all" onclick="showTab('chantiers')">
            <div class="flex items-start justify-between">
              <div>
                <p class="text-sm text-slate-500">Chantiers en cours</p>
                <p class="text-3xl font-bold mt-1 text-slate-100" id="stat-chantiers">3</p>
              </div>
              <div class="p-3 rounded-xl bg-violet-500/20">
                <span class="text-2xl">ğŸ‘·</span>
              </div>
            </div>
          </div>
          <div class="card p-5 cursor-pointer hover:border-sky-500/50 transition-all" onclick="showTab('annuaire')">
            <div class="flex items-start justify-between">
              <div>
                <p class="text-sm text-slate-500">Sous-Traitants actifs</p>
                <p class="text-3xl font-bold mt-1 text-slate-100" id="stat-st">6</p>
              </div>
              <div class="p-3 rounded-xl bg-sky-500/20">
                <span class="text-2xl">ğŸ‘¥</span>
              </div>
            </div>
          </div>
          <div class="card p-5 cursor-pointer hover:border-amber-500/50 transition-all" onclick="showTab('situations')">
            <div class="flex items-start justify-between">
              <div>
                <p class="text-sm text-slate-500">Situations en attente</p>
                <p class="text-3xl font-bold mt-1 text-amber-400" id="stat-situations">4</p>
              </div>
              <div class="p-3 rounded-xl bg-amber-500/20">
                <span class="text-2xl">ğŸ“‹</span>
              </div>
            </div>
          </div>
          <div class="card p-5 cursor-pointer hover:border-emerald-500/50 transition-all" onclick="showTab('facturation')">
            <div class="flex items-start justify-between gap-2">
              <div class="min-w-0 flex-1">
                <p class="text-sm text-slate-500">CA Chantiers</p>
                <p class="text-xl font-bold mt-1 text-emerald-400 truncate" id="stat-ca">2,33Mâ‚¬</p>
              </div>
              <div class="p-3 rounded-xl bg-emerald-500/20 flex-shrink-0">
                <span class="text-2xl">ğŸ’¶</span>
              </div>
            </div>
          </div>
          <div class="card p-5 cursor-pointer hover:border-red-500/50 transition-all" onclick="showTab('documents')">
            <div class="flex items-start justify-between">
              <div>
                <p class="text-sm text-slate-500">Docs Ã  renouveler</p>
                <p class="text-3xl font-bold mt-1 text-red-400" id="stat-docs-alerte">3</p>
              </div>
              <div class="p-3 rounded-xl bg-red-500/20">
                <span class="text-2xl">âš ï¸</span>
              </div>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="card p-6">
            <h3 class="text-lg font-semibold text-slate-200 mb-4">ğŸ“Š Avancement des chantiers</h3>
            <div class="space-y-4" id="dashboardChantiers"></div>
          </div>
          <div class="card p-6">
            <h3 class="text-lg font-semibold text-slate-200 mb-4">ğŸ’¶ Facturations mensuelles</h3>
            <div class="h-64"><canvas id="chartFacturations"></canvas></div>
          </div>
        </div>

        <div class="card p-6">
          <h3 class="text-lg font-semibold text-slate-200 mb-4">â³ Situations en attente de validation</h3>
          <div id="situationsAttente" class="space-y-3"></div>
        </div>
      </div>

      <!-- TAB: Annuaire -->
      <div id="tab-annuaire" class="tab-content hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <div class="card p-4 flex items-center gap-4 cursor-pointer hover:border-violet-500/50 transition-all" onclick="openModal('modalStatsAnnuaire')">
            <div class="w-12 h-12 bg-violet-500/20 rounded-xl flex items-center justify-center"><span class="text-2xl">ğŸ¢</span></div>
            <div><p class="text-2xl font-bold text-violet-400" id="annuaire-total">6</p><p class="text-sm text-slate-500">Total entreprises</p></div>
          </div>
          <div class="card p-4 flex items-center gap-4 cursor-pointer hover:border-emerald-500/50 transition-all" onclick="openModal('modalStatsAnnuaire')">
            <div class="w-12 h-12 bg-emerald-500/20 rounded-xl flex items-center justify-center"><span class="text-2xl">ğŸ”’</span></div>
            <div><p class="text-2xl font-bold text-emerald-400" id="annuaire-actifs">6</p><p class="text-sm text-slate-500">Annuaire privÃ©</p></div>
          </div>
          <div class="card p-4 flex items-center gap-4 cursor-pointer hover:border-sky-500/50 transition-all" onclick="openModal('modalStatsAnnuaire')">
            <div class="w-12 h-12 bg-sky-500/20 rounded-xl flex items-center justify-center"><span class="text-2xl">ğŸ“‹</span></div>
            <div><p class="text-2xl font-bold text-sky-400" id="annuaire-contrats">7</p><p class="text-sm text-slate-500">Contrats actifs</p></div>
          </div>
          <div class="card p-4 flex items-center gap-4 cursor-pointer hover:border-amber-500/50 transition-all" onclick="openModal('modalStatsAnnuaire')">
            <div class="w-12 h-12 bg-amber-500/20 rounded-xl flex items-center justify-center"><span class="text-2xl">â­</span></div>
            <div><p class="text-2xl font-bold text-amber-400" id="annuaire-note">4.6</p><p class="text-sm text-slate-500">Note moyenne</p></div>
          </div>
        </div>

        <!-- Toolbar avec bascule de mode -->
        <div class="flex flex-col gap-4 mb-6">
          <div class="flex flex-col lg:flex-row gap-4">
            <div class="flex items-center gap-2 bg-slate-800/50 rounded-xl p-1 border border-slate-700/50">
              <button id="btn-mode-general" onclick="setAnnuaireMode('recherche')" class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium text-slate-400 hover:text-white">ğŸŒ Annuaire gÃ©nÃ©ral</button>
              <button id="btn-mode-prive" onclick="setAnnuaireMode('actifs')" class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium bg-violet-600 text-white">ğŸ”’ Mon annuaire privÃ©</button>
            </div>
            <button onclick="openModal('modalAddST')" class="flex items-center gap-2 px-5 py-3 btn-success rounded-xl text-white font-medium">â• Ajouter manuellement</button>
          </div>

          <!-- Zone recherche Annuaire GÃ©nÃ©ral (SIRENE) - Style V7 -->
          <div id="zoneRechercheGenerale" class="hidden mb-4 p-4 bg-blue-900/20 border border-blue-700/30 rounded-xl">
            <p class="text-sm text-blue-300 mb-3">ğŸ” Recherchez une entreprise dans la base officielle SIRENE (entreprise.data.gouv.fr)</p>
            <div class="flex flex-col md:flex-row gap-3 mb-4">
              <input type="text" id="sireneSearchInput" placeholder="Nom d'entreprise, SIRET, ville..." class="flex-1" onkeyup="if(event.key==='Enter') rechercherSirene()">
              <button onclick="rechercherSirene()" class="px-6 py-3 bg-blue-600 hover:bg-blue-500 rounded-xl text-white font-medium">ğŸ” Rechercher</button>
            </div>
            <!-- Filtres de recherche API Gouv -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 pt-4 border-t border-blue-700/30">
              <div>
                <label class="block text-sm text-slate-400 mb-2">RÃ©gion</label>
                <select id="apiRegion" onchange="searchAPI()">
                  <option value="">Toutes rÃ©gions</option>
                  <option value="11">Ãle-de-France</option>
                  <option value="24">Centre-Val de Loire</option>
                  <option value="27">Bourgogne-Franche-ComtÃ©</option>
                  <option value="28">Normandie</option>
                  <option value="32">Hauts-de-France</option>
                  <option value="44">Grand Est</option>
                  <option value="52">Pays de la Loire</option>
                  <option value="53">Bretagne</option>
                  <option value="75">Nouvelle-Aquitaine</option>
                  <option value="76">Occitanie</option>
                  <option value="84">Auvergne-RhÃ´ne-Alpes</option>
                  <option value="93">PACA</option>
                  <option value="94">Corse</option>
                </select>
              </div>
              <div>
                <label class="block text-sm text-slate-400 mb-2">ActivitÃ© (NAF)</label>
                <select id="apiNaf" onchange="searchAPI()">
                  <option value="">Tous secteurs BTP</option>
                  <option value="43.21A">âš¡ Travaux Ã©lectriques</option>
                  <option value="43.22A">ğŸ”§ Plomberie, chauffage</option>
                  <option value="43.22B">â„ï¸ Climatisation</option>
                  <option value="43.34Z">ğŸ¨ Peinture, vitrerie</option>
                  <option value="43.31Z">ğŸ§± Travaux de plÃ¢trerie</option>
                  <option value="43.32A">ğŸªµ Menuiserie bois</option>
                  <option value="43.32B">ğŸªŸ Menuiserie PVC/mÃ©tal</option>
                  <option value="43.33Z">ğŸ”² Carrelage</option>
                  <option value="43.91A">ğŸ  Charpente</option>
                  <option value="43.91B">ğŸ  Couverture</option>
                  <option value="41.20A">ğŸ—ï¸ Construction bÃ¢timents rÃ©sidentiels</option>
                  <option value="41.20B">ğŸ¢ Construction bÃ¢timents non rÃ©sidentiels</option>
                  <option value="42.11Z">ğŸ›¤ï¸ Routes et autoroutes</option>
                </select>
              </div>
              <div>
                <label class="block text-sm text-slate-400 mb-2">Effectif</label>
                <select id="apiEffectif" onchange="searchAPI()">
                  <option value="">Tous effectifs</option>
                  <option value="00">0 salariÃ©</option>
                  <option value="01">1-2 salariÃ©s</option>
                  <option value="02">3-5 salariÃ©s</option>
                  <option value="03">6-9 salariÃ©s</option>
                  <option value="11">10-19 salariÃ©s</option>
                  <option value="12">20-49 salariÃ©s</option>
                  <option value="21">50-99 salariÃ©s</option>
                  <option value="22">100-199 salariÃ©s</option>
                </select>
              </div>
              <div>
                <label class="block text-sm text-slate-400 mb-2">DÃ©partement</label>
                <select id="apiDepartement" onchange="searchAPI()">
                  <option value="">Tous dÃ©partements</option>
                  <option value="01">01 - Ain</option>
                  <option value="02">02 - Aisne</option>
                  <option value="03">03 - Allier</option>
                  <option value="04">04 - Alpes-de-Haute-Provence</option>
                  <option value="05">05 - Hautes-Alpes</option>
                  <option value="06">06 - Alpes-Maritimes</option>
                  <option value="07">07 - ArdÃ¨che</option>
                  <option value="08">08 - Ardennes</option>
                  <option value="09">09 - AriÃ¨ge</option>
                  <option value="10">10 - Aube</option>
                  <option value="11">11 - Aude</option>
                  <option value="12">12 - Aveyron</option>
                  <option value="13">13 - Bouches-du-RhÃ´ne</option>
                  <option value="14">14 - Calvados</option>
                  <option value="15">15 - Cantal</option>
                  <option value="16">16 - Charente</option>
                  <option value="17">17 - Charente-Maritime</option>
                  <option value="18">18 - Cher</option>
                  <option value="19">19 - CorrÃ¨ze</option>
                  <option value="2A">2A - Corse-du-Sud</option>
                  <option value="2B">2B - Haute-Corse</option>
                  <option value="21">21 - CÃ´te-d'Or</option>
                  <option value="22">22 - CÃ´tes-d'Armor</option>
                  <option value="23">23 - Creuse</option>
                  <option value="24">24 - Dordogne</option>
                  <option value="25">25 - Doubs</option>
                  <option value="26">26 - DrÃ´me</option>
                  <option value="27">27 - Eure</option>
                  <option value="28">28 - Eure-et-Loir</option>
                  <option value="29">29 - FinistÃ¨re</option>
                  <option value="30">30 - Gard</option>
                  <option value="31">31 - Haute-Garonne</option>
                  <option value="32">32 - Gers</option>
                  <option value="33">33 - Gironde</option>
                  <option value="34">34 - HÃ©rault</option>
                  <option value="35">35 - Ille-et-Vilaine</option>
                  <option value="36">36 - Indre</option>
                  <option value="37">37 - Indre-et-Loire</option>
                  <option value="38">38 - IsÃ¨re</option>
                  <option value="39">39 - Jura</option>
                  <option value="40">40 - Landes</option>
                  <option value="41">41 - Loir-et-Cher</option>
                  <option value="42">42 - Loire</option>
                  <option value="43">43 - Haute-Loire</option>
                  <option value="44">44 - Loire-Atlantique</option>
                  <option value="45">45 - Loiret</option>
                  <option value="46">46 - Lot</option>
                  <option value="47">47 - Lot-et-Garonne</option>
                  <option value="48">48 - LozÃ¨re</option>
                  <option value="49">49 - Maine-et-Loire</option>
                  <option value="50">50 - Manche</option>
                  <option value="51">51 - Marne</option>
                  <option value="52">52 - Haute-Marne</option>
                  <option value="53">53 - Mayenne</option>
                  <option value="54">54 - Meurthe-et-Moselle</option>
                  <option value="55">55 - Meuse</option>
                  <option value="56">56 - Morbihan</option>
                  <option value="57">57 - Moselle</option>
                  <option value="58">58 - NiÃ¨vre</option>
                  <option value="59">59 - Nord</option>
                  <option value="60">60 - Oise</option>
                  <option value="61">61 - Orne</option>
                  <option value="62">62 - Pas-de-Calais</option>
                  <option value="63">63 - Puy-de-DÃ´me</option>
                  <option value="64">64 - PyrÃ©nÃ©es-Atlantiques</option>
                  <option value="65">65 - Hautes-PyrÃ©nÃ©es</option>
                  <option value="66">66 - PyrÃ©nÃ©es-Orientales</option>
                  <option value="67">67 - Bas-Rhin</option>
                  <option value="68">68 - Haut-Rhin</option>
                  <option value="69">69 - RhÃ´ne</option>
                  <option value="70">70 - Haute-SaÃ´ne</option>
                  <option value="71">71 - SaÃ´ne-et-Loire</option>
                  <option value="72">72 - Sarthe</option>
                  <option value="73">73 - Savoie</option>
                  <option value="74">74 - Haute-Savoie</option>
                  <option value="75">75 - Paris</option>
                  <option value="76">76 - Seine-Maritime</option>
                  <option value="77">77 - Seine-et-Marne</option>
                  <option value="78">78 - Yvelines</option>
                  <option value="79">79 - Deux-SÃ¨vres</option>
                  <option value="80">80 - Somme</option>
                  <option value="81">81 - Tarn</option>
                  <option value="82">82 - Tarn-et-Garonne</option>
                  <option value="83">83 - Var</option>
                  <option value="84">84 - Vaucluse</option>
                  <option value="85">85 - VendÃ©e</option>
                  <option value="86">86 - Vienne</option>
                  <option value="87">87 - Haute-Vienne</option>
                  <option value="88">88 - Vosges</option>
                  <option value="89">89 - Yonne</option>
                  <option value="90">90 - Territoire de Belfort</option>
                  <option value="91">91 - Essonne</option>
                  <option value="92">92 - Hauts-de-Seine</option>
                  <option value="93">93 - Seine-Saint-Denis</option>
                  <option value="94">94 - Val-de-Marne</option>
                  <option value="95">95 - Val-d'Oise</option>
                  <option value="971">971 - Guadeloupe</option>
                  <option value="972">972 - Martinique</option>
                  <option value="973">973 - Guyane</option>
                  <option value="974">974 - La RÃ©union</option>
                  <option value="976">976 - Mayotte</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Zone filtres Annuaire PrivÃ© -->
          <div id="zoneFiltresPrive" class="flex flex-col lg:flex-row gap-4">
            <input type="text" id="searchAnnuaire" placeholder="ğŸ” Rechercher dans mon annuaire..." oninput="filterAnnuaire()" class="flex-1">
            <select id="filterCorpsMetier" onchange="filterAnnuaire()">
              <option value="">Tous les corps de mÃ©tier</option>
              <option value="Ã‰lectricitÃ©">âš¡ Ã‰lectricitÃ©</option>
              <option value="Climatisation">â„ï¸ Climatisation / CVC</option>
              <option value="Plomberie">ğŸ”§ Plomberie</option>
              <option value="MaÃ§onnerie">ğŸ§± MaÃ§onnerie</option>
              <option value="Peinture">ğŸ¨ Peinture</option>
              <option value="Menuiserie">ğŸªµ Menuiserie</option>
              <option value="Carrelage">ğŸ”² Carrelage</option>
              <option value="Couverture">ğŸ  Couverture</option>
              <option value="Serrurerie">ğŸ”© Serrurerie</option>
              <option value="Transport">ğŸš› Transport</option>
            </select>
          </div>
        </div>

        <!-- Loading -->
        <div id="sireneLoading" class="hidden text-center py-12">
          <div class="inline-block animate-spin text-5xl">â³</div>
          <p class="text-slate-400 mt-3">Recherche en cours dans la base SIRENE...</p>
        </div>

        <div id="annuaireContent" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </div>

      <!-- TAB: Chantiers -->
      <div id="tab-chantiers" class="tab-content hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <div class="card p-4 flex items-center gap-4 cursor-pointer hover:border-emerald-500/50 transition-all" onclick="openModal('modalStatsChantiers')">
            <div class="w-12 h-12 bg-emerald-500/20 rounded-xl flex items-center justify-center"><span class="text-2xl">ğŸ—ï¸</span></div>
            <div><p class="text-2xl font-bold text-emerald-400">3</p><p class="text-sm text-slate-500">Chantiers actifs</p></div>
          </div>
          <div class="card p-4 flex items-center gap-4 cursor-pointer hover:border-violet-500/50 transition-all" onclick="openModal('modalStatsChantiers')">
            <div class="w-12 h-12 bg-violet-500/20 rounded-xl flex items-center justify-center"><span class="text-2xl">ğŸ’¶</span></div>
            <div><p class="text-2xl font-bold text-violet-400" id="chantiers-ca">2,33Mâ‚¬</p><p class="text-sm text-slate-500">CA Total</p></div>
          </div>
          <div class="card p-4 flex items-center gap-4 cursor-pointer hover:border-sky-500/50 transition-all" onclick="openModal('modalStatsChantiers')">
            <div class="w-12 h-12 bg-sky-500/20 rounded-xl flex items-center justify-center"><span class="text-2xl">ğŸ‘·</span></div>
            <div><p class="text-2xl font-bold text-sky-400">6</p><p class="text-sm text-slate-500">Sous-traitants</p></div>
          </div>
          <div class="card p-4 flex items-center gap-4 cursor-pointer hover:border-amber-500/50 transition-all" onclick="openModal('modalStatsChantiers')">
            <div class="w-12 h-12 bg-amber-500/20 rounded-xl flex items-center justify-center"><span class="text-2xl">ğŸ“‹</span></div>
            <div><p class="text-2xl font-bold text-amber-400">7</p><p class="text-sm text-slate-500">Contrats</p></div>
          </div>
        </div>

        <div class="card p-6 mb-6">
          <div class="flex items-center gap-4">
            <input type="text" id="searchChantiers" placeholder="ğŸ” Rechercher un chantier..." class="flex-1" oninput="renderChantiers()">
            <select id="filterChantierStatut" onchange="renderChantiers()">
              <option value="">Tous les statuts</option>
              <option value="en_cours">ğŸŸ¢ En cours</option>
              <option value="termine">âœ… TerminÃ©</option>
              <option value="suspendu">â¸ï¸ Suspendu</option>
            </select>
            <button onclick="openModal('modalNewChantier')" class="btn-success px-4 py-2 rounded-xl text-white font-medium">â• Nouveau Chantier</button>
          </div>
        </div>

        <div id="chantiersList" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4"></div>
      </div>

      <!-- TAB: Situations -->
      <div id="tab-situations" class="tab-content hidden">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div class="card p-4 flex items-center gap-4 cursor-pointer hover:border-amber-500/50 transition-all" onclick="filterByStatut('soumise')">
            <div class="w-12 h-12 bg-amber-500/20 rounded-xl flex items-center justify-center"><span class="text-2xl">â³</span></div>
            <div><p class="text-2xl font-bold text-amber-400" id="situ-attente">4</p><p class="text-sm text-slate-500">En attente</p></div>
          </div>
          <div class="card p-4 flex items-center gap-4 cursor-pointer hover:border-emerald-500/50 transition-all" onclick="filterByStatut('validee')">
            <div class="w-12 h-12 bg-emerald-500/20 rounded-xl flex items-center justify-center"><span class="text-2xl">âœ…</span></div>
            <div><p class="text-2xl font-bold text-emerald-400" id="situ-validees">12</p><p class="text-sm text-slate-500">ValidÃ©es</p></div>
          </div>
          <div class="card p-4 flex items-center gap-4 cursor-pointer hover:border-red-500/50 transition-all" onclick="filterByStatut('refusee')">
            <div class="w-12 h-12 bg-red-500/20 rounded-xl flex items-center justify-center"><span class="text-2xl">âŒ</span></div>
            <div><p class="text-2xl font-bold text-red-400" id="situ-refusees">1</p><p class="text-sm text-slate-500">RefusÃ©es</p></div>
          </div>
          <div class="card p-4 flex items-center gap-4 cursor-pointer hover:border-violet-500/50 transition-all" onclick="openModal('modalStatsSituations')">
            <div class="w-12 h-12 bg-violet-500/20 rounded-xl flex items-center justify-center"><span class="text-2xl">ğŸ’¶</span></div>
            <div><p class="text-2xl font-bold text-violet-400" id="situ-montant">1,2Mâ‚¬</p><p class="text-sm text-slate-500">Total validÃ©</p></div>
          </div>
        </div>

        <div class="card p-6 mb-6">
          <div class="flex flex-wrap items-center gap-4">
            <div class="flex bg-slate-800/50 rounded-xl p-1">
              <button onclick="setFlux('flux1')" id="btn-flux1" class="toggle-btn active px-4 py-2 rounded-lg text-sm font-medium">ğŸ“¥ Sous-traitants â†’ Entreprise</button>
              <button onclick="setFlux('flux2')" id="btn-flux2" class="toggle-btn px-4 py-2 rounded-lg text-sm font-medium">ğŸ“¤ Entreprise â†’ Client</button>
            </div>
            <select id="filterSituChantier" onchange="renderSituations()" class="flex-1">
              <option value="">Tous les chantiers</option>
            </select>
            <select id="filterSituStatut" onchange="renderSituations()">
              <option value="">Tous les statuts</option>
              <option value="soumise">En attente</option>
              <option value="validee">ValidÃ©es</option>
              <option value="refusee">RefusÃ©es</option>
            </select>
          </div>
        </div>

        <div id="situationsList" class="space-y-4"></div>
      </div>

      <!-- TAB: Facturation -->
      <div id="tab-facturation" class="tab-content hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <div class="card p-4 flex items-center gap-4 cursor-pointer hover:border-amber-500/50 transition-all" onclick="openFacturationModal('attente')">
            <div class="w-12 h-12 bg-amber-500/20 rounded-xl flex items-center justify-center"><span class="text-2xl">â³</span></div>
            <div><p class="text-2xl font-bold text-amber-400" id="fact-attente">5</p><p class="text-sm text-slate-500">En attente</p></div>
          </div>
          <div class="card p-4 flex items-center gap-4 cursor-pointer hover:border-emerald-500/50 transition-all" onclick="openFacturationModal('payees')">
            <div class="w-12 h-12 bg-emerald-500/20 rounded-xl flex items-center justify-center"><span class="text-2xl">âœ…</span></div>
            <div><p class="text-2xl font-bold text-emerald-400" id="fact-payees">5</p><p class="text-sm text-slate-500">PayÃ©es</p></div>
          </div>
          <div class="card p-4 flex items-center gap-4 cursor-pointer hover:border-red-500/50 transition-all" onclick="openFacturationModal('retard')">
            <div class="w-12 h-12 bg-red-500/20 rounded-xl flex items-center justify-center"><span class="text-2xl">ğŸš¨</span></div>
            <div><p class="text-2xl font-bold text-red-400" id="fact-retard">2</p><p class="text-sm text-slate-500">En retard</p></div>
          </div>
          <div class="card p-4 flex items-center gap-4 cursor-pointer hover:border-violet-500/50 transition-all" onclick="openFacturationModal('total')">
            <div class="w-12 h-12 bg-violet-500/20 rounded-xl flex items-center justify-center"><span class="text-2xl">ğŸ’¶</span></div>
            <div><p class="text-2xl font-bold text-violet-400" id="fact-total">987Kâ‚¬</p><p class="text-sm text-slate-500">Total</p></div>
          </div>
        </div>

        <div class="card p-6 mb-6">
          <div class="flex flex-wrap items-center gap-4">
            <div class="flex bg-slate-800/50 rounded-xl p-1">
              <button onclick="setFactFlux('recues')" id="btn-fact-recues" class="toggle-btn active px-4 py-2 rounded-lg text-sm font-medium">ğŸ“¥ ReÃ§ues</button>
              <button onclick="setFactFlux('emises')" id="btn-fact-emises" class="toggle-btn px-4 py-2 rounded-lg text-sm font-medium">ğŸ“¤ Ã‰mises</button>
            </div>
            <select id="filterFactStatut" onchange="renderFactures()" class="px-4 py-2 bg-slate-800 border border-slate-700 rounded-lg text-slate-300">
              <option value="">Tous les statuts</option>
              <option value="en_attente">â³ En attente</option>
              <option value="payee">âœ… PayÃ©e</option>
              <option value="en_retard">ğŸš¨ En retard</option>
            </select>
            <input type="text" id="searchFactures" placeholder="ğŸ” Rechercher..." class="px-4 py-2 bg-slate-800 border border-slate-700 rounded-lg text-slate-300" oninput="renderFactures()">
          </div>
        </div>

        <div class="card overflow-hidden">
          <table class="data-table">
            <thead>
              <tr>
                <th>NÂ° Facture</th>
                <th>Chantier</th>
                <th>Tiers</th>
                <th class="text-right">Montant HT</th>
                <th>Ã‰chÃ©ance</th>
                <th>Statut</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="facturesTableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- TAB: Documents - Style V7 avec regroupement par ST -->
      <div id="tab-documents" class="tab-content hidden">
        <!-- Stats documents V7 -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
          <div class="card p-4 flex items-center gap-4 cursor-pointer hover:border-emerald-500/50 transition-all" onclick="filterDocsByStatut('valides')">
            <div class="w-12 h-12 bg-emerald-500/20 rounded-xl flex items-center justify-center"><span class="text-2xl">âœ…</span></div>
            <div><p class="text-2xl font-bold text-emerald-400" id="docs-valides">18</p><p class="text-sm font-medium text-emerald-400">Valides</p></div>
          </div>
          <div class="card p-4 flex items-center gap-4 cursor-pointer hover:border-amber-500/50 transition-all" onclick="filterDocsByStatut('attente')">
            <div class="w-12 h-12 bg-amber-500/20 rounded-xl flex items-center justify-center"><span class="text-2xl">â³</span></div>
            <div><p class="text-2xl font-bold text-amber-400" id="docs-attente">0</p><p class="text-sm font-medium text-amber-400">En analyse</p></div>
          </div>
          <div class="card p-4 flex items-center gap-4 cursor-pointer hover:border-violet-500/50 transition-all" onclick="filterDocsByStatut('rejetes')">
            <div class="w-12 h-12 bg-violet-500/20 rounded-xl flex items-center justify-center"><span class="text-2xl">ğŸ¤–</span></div>
            <div><p class="text-2xl font-bold text-violet-400" id="docs-rejetes">0</p><p class="text-sm font-medium text-violet-400">RejetÃ©s IA</p></div>
          </div>
          <div class="card p-4 flex items-center gap-4 cursor-pointer hover:border-sky-500/50 transition-all" onclick="filterDocsByStatut('expire60')">
            <div class="w-12 h-12 bg-sky-500/20 rounded-xl flex items-center justify-center"><span class="text-2xl">ğŸ“…</span></div>
            <div><p class="text-2xl font-bold text-sky-400" id="docs-expire60">2</p><p class="text-sm font-medium text-sky-400">Expire &lt;60j</p></div>
          </div>
          <div class="card p-4 flex items-center gap-4 cursor-pointer hover:border-amber-500/50 transition-all" onclick="filterDocsByStatut('expire30')">
            <div class="w-12 h-12 bg-amber-500/20 rounded-xl flex items-center justify-center"><span class="text-2xl">âš ï¸</span></div>
            <div><p class="text-2xl font-bold text-amber-400" id="docs-expire30">2</p><p class="text-sm font-medium text-amber-400">Expire &lt;30j</p></div>
          </div>
          <div class="card p-4 flex items-center gap-4 cursor-pointer hover:border-red-500/50 transition-all" onclick="filterDocsByStatut('expires')">
            <div class="w-12 h-12 bg-red-500/20 rounded-xl flex items-center justify-center"><span class="text-2xl">ğŸš¨</span></div>
            <div><p class="text-2xl font-bold text-red-400" id="docs-expires">1</p><p class="text-sm font-medium text-red-400">ExpirÃ©s</p></div>
          </div>
        </div>
        
        <!-- Lien vers portail ST -->
        <div class="card p-4 mb-6 border-violet-500/30 flex items-center justify-between">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-violet-500/20 rounded-xl flex items-center justify-center text-2xl">ğŸ”—</div>
            <div>
              <h4 class="font-semibold text-slate-100">Portail documentaire sous-traitants</h4>
              <p class="text-sm text-slate-400">Vos sous-traitants peuvent dÃ©poser leurs documents directement</p>
            </div>
          </div>
          <div class="flex gap-2">
            <button onclick="openModal('modalDemandeDoc')" class="px-4 py-2 bg-amber-600 hover:bg-amber-500 rounded-lg text-white text-sm">ğŸ“¨ Demander docs</button>
            <button onclick="showToast('ğŸ”— Lien portail copiÃ©')" class="px-4 py-2 bg-violet-600 hover:bg-violet-500 rounded-lg text-white text-sm">ğŸ”— Copier lien portail</button>
          </div>
        </div>

        <!-- Zone de filtres -->
        <div class="card p-4 mb-6">
          <div class="flex flex-col lg:flex-row gap-4">
            <input type="text" id="searchDocs" placeholder="ğŸ” Rechercher un document ou sous-traitant..." class="flex-1" oninput="renderDocuments()">
            <select id="filterDocType" onchange="renderDocuments()">
              <option value="">Tous les types</option>
              <option value="Kbis">ğŸ“‹ Kbis</option>
              <option value="URSSAF">ğŸ“„ Attestation URSSAF</option>
              <option value="RC Pro">ğŸ›¡ï¸ RC Pro</option>
              <option value="DÃ©cennale">ğŸ—ï¸ DÃ©cennale</option>
              <option value="Vigilance">ğŸ“„ Attestation vigilance</option>
              <option value="Fiscale">ğŸ’¼ Attestation fiscale</option>
            </select>
            <select id="filterDocStatut" onchange="renderDocuments()">
              <option value="">Tous statuts</option>
              <option value="valide">âœ… Valides</option>
              <option value="en_attente">â³ En analyse</option>
              <option value="rejete">âŒ RejetÃ©s</option>
              <option value="expire">ğŸš¨ ExpirÃ©s</option>
            </select>
          </div>
        </div>

        <!-- Documents regroupÃ©s par ST avec dÃ©roulÃ© -->
        <div id="documentsList" class="space-y-4"></div>
      </div>

      <!-- TAB: ParamÃ¨tres - Style V7 Complet -->
      <div id="tab-parametres" class="tab-content hidden">
        <!-- Sous-navigation horizontale style V7 -->
        <div class="flex gap-2 mb-6 flex-wrap">
          <button onclick="showParamSection('entreprise')" id="param-btn-entreprise" class="param-btn px-4 py-2 rounded-lg text-sm font-medium bg-violet-600 text-white">ğŸ¢ Entreprise</button>
          <button onclick="showParamSection('roles')" id="param-btn-roles" class="param-btn px-4 py-2 rounded-lg text-sm font-medium bg-slate-700 text-slate-300 hover:bg-slate-600">ğŸ‘¥ RÃ´les</button>
          <button onclick="showParamSection('apparence')" id="param-btn-apparence" class="param-btn px-4 py-2 rounded-lg text-sm font-medium bg-slate-700 text-slate-300 hover:bg-slate-600">ğŸ¨ Apparence</button>
          <button onclick="showParamSection('abonnement')" id="param-btn-abonnement" class="param-btn px-4 py-2 rounded-lg text-sm font-medium bg-slate-700 text-slate-300 hover:bg-slate-600">ğŸ’³ Abonnement</button>
          <button onclick="showParamSection('integrations')" id="param-btn-integrations" class="param-btn px-4 py-2 rounded-lg text-sm font-medium bg-slate-700 text-slate-300 hover:bg-slate-600">ğŸ”— IntÃ©grations</button>
          <!-- Admin-only: configuration systÃ¨me (A2) -->
          <button onclick="showParamSection('systeme'); loadSystemeConfig();" id="param-btn-systeme" class="param-btn px-4 py-2 rounded-lg text-sm font-medium bg-slate-700 text-slate-300 hover:bg-slate-600 hidden">ğŸ–¥ï¸ SystÃ¨me</button>
          <button onclick="showParamSection('apropos')" id="param-btn-apropos" class="param-btn px-4 py-2 rounded-lg text-sm font-medium bg-slate-700 text-slate-300 hover:bg-slate-600">â„¹ï¸ Ã€ propos</button>
        </div>

        <!-- Section Entreprise - Enrichie style V7 -->
        <div id="param-section-entreprise" class="param-section">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="card p-6">
              <h3 class="text-lg font-semibold text-slate-100 mb-4">ğŸ¢ Informations de l'entreprise</h3>
              <div class="space-y-4">
                <div><label class="block text-sm text-slate-400 mb-2">Nom de l'entreprise *</label><input type="text" id="configNomEntreprise" placeholder="Ex: Dupont Construction" value="BTP Excellence SAS"></div>
                <div><label class="block text-sm text-slate-400 mb-2">SIRET</label><input type="text" id="configSiret" placeholder="Ex: 123 456 789 00012" value="123 456 789 00012"></div>
                <div><label class="block text-sm text-slate-400 mb-2">Adresse</label><input type="text" id="configAdresse" placeholder="Ex: 12 rue de la Paix" value="15 rue de la Construction"></div>
                <div class="grid grid-cols-2 gap-4">
                  <div><label class="block text-sm text-slate-400 mb-2">Code postal</label><input type="text" id="configCodePostal" placeholder="75001" value="75001"></div>
                  <div><label class="block text-sm text-slate-400 mb-2">Ville</label><input type="text" id="configVille" placeholder="Paris" value="Paris"></div>
                </div>
              </div>
            </div>
            <div class="card p-6">
              <h3 class="text-lg font-semibold text-slate-100 mb-4">ğŸ“ Contact</h3>
              <div class="space-y-4">
                <div><label class="block text-sm text-slate-400 mb-2">TÃ©lÃ©phone</label><input type="text" id="configTelephone" placeholder="01 23 45 67 89" value="01 23 45 67 89"></div>
                <div><label class="block text-sm text-slate-400 mb-2">Email</label><input type="email" id="configEmail" placeholder="contact@entreprise.fr" value="contact@btp-excellence.fr"></div>
                <div><label class="block text-sm text-slate-400 mb-2">Site web</label><input type="text" id="configSiteWeb" placeholder="www.entreprise.fr" value="www.btp-excellence.fr"></div>
              </div>
            </div>
            <div class="card p-6">
              <h3 class="text-lg font-semibold text-slate-100 mb-4">ğŸ¦ Informations bancaires</h3>
              <div class="space-y-4">
                <div><label class="block text-sm text-slate-400 mb-2">IBAN</label><input type="text" id="configIban" placeholder="FR76 1234 5678 9012 3456 7890 123"></div>
                <div><label class="block text-sm text-slate-400 mb-2">BIC</label><input type="text" id="configBic" placeholder="BNPAFRPP"></div>
                <div><label class="block text-sm text-slate-400 mb-2">Banque</label><input type="text" id="configBanque" placeholder="BNP Paribas"></div>
              </div>
            </div>
            <div class="card p-6">
              <h3 class="text-lg font-semibold text-slate-100 mb-4">ğŸ“‹ Informations lÃ©gales</h3>
              <div class="space-y-4">
                <div><label class="block text-sm text-slate-400 mb-2">NÂ° TVA</label><input type="text" id="configTva" placeholder="FR 12 345678901"></div>
                <div><label class="block text-sm text-slate-400 mb-2">Capital social</label><input type="text" id="configCapital" placeholder="10 000 â‚¬"></div>
                <div><label class="block text-sm text-slate-400 mb-2">Forme juridique</label>
                  <select id="configFormeJuridique">
                    <option value="">SÃ©lectionner...</option>
                    <option value="SARL">SARL</option>
                    <option value="SAS" selected>SAS</option>
                    <option value="SASU">SASU</option>
                    <option value="EURL">EURL</option>
                    <option value="SA">SA</option>
                    <option value="EI">Entreprise Individuelle</option>
                    <option value="Auto-entrepreneur">Auto-entrepreneur</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          <div class="mt-6 flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
            <div class="card p-4 flex-1 w-full lg:w-auto">
              <h4 class="text-sm font-medium text-slate-300 mb-2">ğŸ‘ï¸ AperÃ§u en-tÃªte</h4>
              <div class="p-4 bg-white rounded-lg text-slate-800 text-sm">
                <div class="font-bold" id="apercuNom">BTP Excellence SAS</div>
                <div class="text-slate-600 text-xs" id="apercuAdresse">15 rue de la Construction, 75001 Paris</div>
                <div class="text-slate-600 text-xs" id="apercuContact">01 23 45 67 89 / <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="bbd8d4d5cfdad8cffbd9cfcb96dec3d8ded7d7ded5d8de95ddc9">[email&#160;protected]</a></div>
                <div class="text-slate-500 text-xs mt-1" id="apercuLegal">SIRET: 123 456 789 00012 - TVA: FR 12 345678901</div>
              </div>
            </div>
            <div class="flex gap-3">
              <button onclick="reinitialiserParametres()" class="px-5 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl text-slate-200 font-medium">ğŸ”„ RÃ©initialiser</button>
              <button onclick="sauvegarderParametres()" class="px-6 py-3 btn-success rounded-xl text-white font-medium">ğŸ’¾ Sauvegarder</button>
            </div>
          </div>
        </div>

        <!-- Section RÃ´les -->
        <div id="param-section-roles" class="param-section hidden">
          <div class="card p-6 mb-6">
            <h3 class="text-lg font-semibold text-slate-100 mb-4">ğŸ‘¥ Gestion des utilisateurs et rÃ´les</h3>
            <p class="text-slate-400 mb-6">DÃ©finissez les rÃ´les et permissions de chaque utilisateur.</p>
            <div class="overflow-x-auto">
              <table class="data-table">
                <thead><tr><th>Utilisateur</th><th>Email</th><th>RÃ´le</th><th>Actions</th></tr></thead>
                <tbody id="usersTableBody"></tbody>
              </table>
            </div>
            <button onclick="openModal('modalAddUser')" class="mt-4 px-4 py-2 bg-violet-600 hover:bg-violet-500 rounded-lg text-white text-sm">â• Ajouter un utilisateur</button>
          </div>
          <div class="card p-6">
            <h3 class="text-lg font-semibold text-slate-100 mb-4">ğŸ” DÃ©finition des rÃ´les</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="p-4 bg-slate-800/50 rounded-xl border border-violet-500/30">
                <h4 class="font-semibold text-violet-400 mb-2">ğŸ‘‘ Administrateur</h4>
                <ul class="text-sm text-slate-400 space-y-1"><li>âœ“ AccÃ¨s complet</li><li>âœ“ Gestion utilisateurs</li><li>âœ“ ParamÃ¨tres systÃ¨me</li><li>âœ“ Facturation & finances</li></ul>
              </div>
              <div class="p-4 bg-slate-800/50 rounded-xl border border-sky-500/30">
                <h4 class="font-semibold text-sky-400 mb-2">ğŸ‘· Conducteur de travaux</h4>
                <ul class="text-sm text-slate-400 space-y-1"><li>âœ“ Chantiers & situations</li><li>âœ“ Sous-traitants</li><li>âœ“ Documents</li><li>âœ— Facturation limitÃ©e</li></ul>
              </div>
              <div class="p-4 bg-slate-800/50 rounded-xl border border-emerald-500/30">
                <h4 class="font-semibold text-emerald-400 mb-2">ğŸ“Š Comptable</h4>
                <ul class="text-sm text-slate-400 space-y-1"><li>âœ“ Facturation complÃ¨te</li><li>âœ“ Situations (lecture)</li><li>âœ— Pas de modification</li><li>âœ— ParamÃ¨tres limitÃ©s</li></ul>
              </div>
            </div>
          </div>
        </div>

        <!-- Section Apparence -->
        <div id="param-section-apparence" class="param-section hidden">
          <div class="card p-6">
            <h3 class="text-lg font-semibold text-slate-100 mb-4">ğŸ–¼ï¸ Logo de l'entreprise</h3>
            <div class="flex items-center gap-6">
              <div class="w-24 h-24 bg-slate-800 rounded-xl flex items-center justify-center text-4xl border-2 border-dashed border-slate-700 cursor-pointer hover:border-violet-500 transition-colors" onclick="document.getElementById('logoInput').click()" id="logoPreview">ğŸ¢</div>
              <div>
                <p class="text-slate-400 text-sm mb-3">TÃ©lÃ©chargez le logo de votre entreprise (PNG, JPG - max 2Mo)</p>
                <input type="file" id="logoInput" class="hidden" accept="image/*" onchange="handleLogoUpload(this)">
                <button onclick="document.getElementById('logoInput').click()" class="px-4 py-2 bg-violet-600 hover:bg-violet-500 rounded-lg text-white text-sm">ğŸ“¤ TÃ©lÃ©charger un logo</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Section SystÃ¨me (Admin uniquement) - A2: multi-modes (local/lan/cloud) -->
        <div id="param-section-systeme" class="param-section hidden">
          <div class="card p-6 mb-6 border border-violet-500/30">
            <h3 class="text-lg font-semibold text-slate-100 mb-2">ğŸ–¥ï¸ Mode d'exÃ©cution (Standalone / LAN / Cloud)</h3>
            <p class="text-slate-400 text-sm mb-6">Le changement de mode est <b>appliquÃ© au prochain dÃ©marrage</b>. Utilisez Â« Appliquer et redÃ©marrer Â».</p>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm text-slate-400 mb-2">Mode</label>
                <select id="sysMode">
                  <option value="local">Local (backend embarquÃ©)</option>
                  <option value="lan">LAN (backend local partagÃ©)</option>
                  <option value="cloud">Cloud (backend distant)</option>
                </select>
              </div>
              <div>
                <label class="block text-sm text-slate-400 mb-2">Port backend (local/LAN)</label>
                <input id="sysBackendPort" type="number" min="1" max="65535" placeholder="3000" />
              </div>
              <div class="lg:col-span-2">
                <label class="block text-sm text-slate-400 mb-2">URL API (Cloud ou LAN distant)</label>
                <input id="sysApiUrl" type="text" placeholder="https://api.votredomaine.tld" />
                <p class="text-xs text-slate-500 mt-2">En mode Cloud, l'application utilisera cette URL. En mode Local/LAN, l'app utilise le backend embarquÃ©.</p>
              </div>
              <div class="lg:col-span-2">
                <label class="block text-sm text-slate-400 mb-2">Exposer le backend sur le rÃ©seau (LAN)</label>
                <div class="flex items-center gap-3">
                  <button type="button" class="toggle-btn px-4 py-2 rounded-lg bg-slate-800/50 text-slate-300" id="sysLanExposeOff" onclick="setLanExpose(false)">OFF</button>
                  <button type="button" class="toggle-btn px-4 py-2 rounded-lg bg-slate-800/50 text-slate-300" id="sysLanExposeOn" onclick="setLanExpose(true)">ON</button>
                  <span class="text-xs text-slate-500">RecommandÃ© OFF sauf besoin de postes multiples.</span>
                </div>
                <input type="hidden" id="sysLanExpose" value="false" />
              </div>
            </div>

            <div class="mt-6 flex flex-col md:flex-row gap-3 justify-end">
              <button class="px-5 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl text-slate-200 font-medium" onclick="loadSystemeConfig()">â†» Recharger</button>
              <button class="px-6 py-3 btn-primary rounded-xl text-white font-medium" onclick="applySystemeConfig(true)">âœ… Appliquer et redÃ©marrer</button>
            </div>
          </div>
        </div>

        <!-- Section Abonnement - RestaurÃ©e de V7 -->
        <div id="param-section-abonnement" class="param-section hidden">
          <div class="card p-6 mb-6 border border-violet-500/30">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold text-slate-100">ğŸ’ Votre abonnement actuel</h3>
              <span class="px-4 py-1 bg-violet-500/20 text-violet-400 rounded-full text-sm font-medium">Plan Pro</span>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
              <div class="text-center p-4 bg-slate-800/50 rounded-xl"><p class="text-2xl font-bold text-slate-100">âˆ</p><p class="text-xs text-slate-500">Sous-traitants</p></div>
              <div class="text-center p-4 bg-slate-800/50 rounded-xl"><p class="text-2xl font-bold text-slate-100">âˆ</p><p class="text-xs text-slate-500">Chantiers</p></div>
              <div class="text-center p-4 bg-slate-800/50 rounded-xl"><p class="text-2xl font-bold text-slate-100">5</p><p class="text-xs text-slate-500">Utilisateurs</p></div>
              <div class="text-center p-4 bg-slate-800/50 rounded-xl"><p class="text-2xl font-bold text-slate-100">10 Go</p><p class="text-xs text-slate-500">Stockage</p></div>
            </div>
            <p class="text-slate-400 text-sm">Prochain renouvellement : <span class="text-slate-200">15 fÃ©vrier 2026</span></p>
          </div>
          <h3 class="text-lg font-semibold text-slate-100 mb-4">ğŸ“‹ Offres disponibles</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="card p-6 border-slate-700 flex flex-col">
              <div class="flex items-center gap-3 mb-3">
                <div class="w-12 h-12 bg-slate-500/20 rounded-xl flex items-center justify-center text-2xl">ğŸ†“</div>
                <h4 class="text-xl font-bold text-slate-100">Starter</h4>
              </div>
              <p class="text-3xl font-bold text-slate-100 mt-2">Gratuit</p>
              <p class="text-sm text-slate-500 mb-4">Pour dÃ©marrer</p>
              <ul class="flex-1 mt-4 space-y-2 text-sm text-slate-400">
                <li>âœ“ 10 sous-traitants</li>
                <li>âœ“ 3 chantiers</li>
                <li>âœ“ 1 utilisateur</li>
                <li>âœ“ 1 Go stockage</li>
                <li>âœ— IntÃ©grations</li>
              </ul>
              <button onclick="openModal('modalPaiement'); setPlanPaiement('starter')" class="w-full mt-4 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-slate-300">Choisir ce plan</button>
            </div>
            <div class="card p-6 border-violet-500/50 relative flex flex-col">
              <span class="absolute -top-3 right-4 px-3 py-1 bg-violet-500 text-white text-xs rounded-full">Populaire</span>
              <div class="flex items-center gap-3 mb-3">
                <div class="w-12 h-12 bg-violet-500/20 rounded-xl flex items-center justify-center text-2xl">â­</div>
                <h4 class="text-xl font-bold text-violet-400">Pro</h4>
              </div>
              <p class="text-3xl font-bold text-slate-100 mt-2">29â‚¬<span class="text-sm text-slate-500">/mois</span></p>
              <p class="text-sm text-slate-500 mb-4">Pour les professionnels</p>
              <ul class="flex-1 mt-4 space-y-2 text-sm text-slate-400">
                <li>âœ“ Sous-traitants illimitÃ©s</li>
                <li>âœ“ Chantiers illimitÃ©s</li>
                <li>âœ“ 5 utilisateurs</li>
                <li>âœ“ 10 Go stockage</li>
                <li>âœ“ IntÃ©grations CRM</li>
                <li>âœ“ Support prioritaire</li>
              </ul>
              <button class="w-full mt-4 px-4 py-2 bg-violet-600 rounded-lg text-white cursor-default">Plan actuel âœ“</button>
            </div>
            <div class="card p-6 border-amber-500/30 flex flex-col">
              <div class="flex items-center gap-3 mb-3">
                <div class="w-12 h-12 bg-amber-500/20 rounded-xl flex items-center justify-center text-2xl">ğŸ†</div>
                <h4 class="text-xl font-bold text-amber-400">Enterprise</h4>
              </div>
              <p class="text-3xl font-bold text-slate-100 mt-2">99â‚¬<span class="text-sm text-slate-500">/mois</span></p>
              <p class="text-sm text-slate-500 mb-4">Pour les grandes Ã©quipes</p>
              <ul class="flex-1 mt-4 space-y-2 text-sm text-slate-400">
                <li>âœ“ Tout illimitÃ©</li>
                <li>âœ“ Utilisateurs illimitÃ©s</li>
                <li>âœ“ 100 Go stockage</li>
                <li>âœ“ Support dÃ©diÃ© 24/7</li>
                <li>âœ“ Formation incluse</li>
                <li>âœ“ API personnalisÃ©e</li>
              </ul>
              <button onclick="openModal('modalPaiement'); setPlanPaiement('enterprise')" class="w-full mt-4 px-4 py-2 bg-amber-600 hover:bg-amber-500 rounded-lg text-white">Choisir ce plan</button>
            </div>
          </div>
          
          <!-- Moyens de paiement -->
          <div class="card p-6 mt-6 border border-emerald-500/30">
            <h3 class="text-lg font-semibold text-slate-100 mb-4">ğŸ’³ Moyens de paiement enregistrÃ©s</h3>
            <div id="savedPaymentMethods" class="space-y-3 mb-6">
              <!-- Carte par dÃ©faut simulÃ©e -->
              <div class="p-4 bg-slate-800/50 rounded-xl flex items-center justify-between">
                <div class="flex items-center gap-4">
                  <div class="w-12 h-12 bg-blue-500/20 rounded-xl flex items-center justify-center text-2xl">ğŸ’³</div>
                  <div>
                    <p class="font-medium text-slate-200">Visa â€¢â€¢â€¢â€¢ 4242</p>
                    <p class="text-sm text-slate-500">Expire 12/2027</p>
                  </div>
                </div>
                <div class="flex items-center gap-3">
                  <span class="badge badge-success">Par dÃ©faut</span>
                  <button onclick="removePaymentMethod(1)" class="text-red-400 hover:text-red-300 text-sm">Supprimer</button>
                </div>
              </div>
            </div>
            <button onclick="openModal('modalAddPayment')" class="w-full px-4 py-3 border-2 border-dashed border-slate-700 hover:border-violet-500 rounded-xl text-slate-400 hover:text-violet-400 transition-colors">
              â• Ajouter un moyen de paiement
            </button>
          </div>
          
          <!-- Historique des transactions -->
          <div class="card p-6 mt-6">
            <h3 class="text-lg font-semibold text-slate-100 mb-4">ğŸ“œ Historique des transactions</h3>
            <div class="overflow-x-auto">
              <table class="data-table w-full">
                <thead>
                  <tr><th>Date</th><th>Description</th><th>Montant</th><th>Statut</th></tr>
                </thead>
                <tbody id="transactionsHistory">
                  <tr>
                    <td class="text-slate-400">01/01/2026</td>
                    <td class="text-slate-200">Abonnement Pro - Janvier 2026</td>
                    <td class="text-emerald-400 font-medium">29,00 â‚¬</td>
                    <td><span class="badge badge-success">âœ“ PayÃ©</span></td>
                  </tr>
                  <tr>
                    <td class="text-slate-400">01/12/2025</td>
                    <td class="text-slate-200">Abonnement Pro - DÃ©cembre 2025</td>
                    <td class="text-emerald-400 font-medium">29,00 â‚¬</td>
                    <td><span class="badge badge-success">âœ“ PayÃ©</span></td>
                  </tr>
                  <tr>
                    <td class="text-slate-400">01/11/2025</td>
                    <td class="text-slate-200">Abonnement Pro - Novembre 2025</td>
                    <td class="text-emerald-400 font-medium">29,00 â‚¬</td>
                    <td><span class="badge badge-success">âœ“ PayÃ©</span></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Section IntÃ©grations - RestaurÃ©e de V7 -->
        <div id="param-section-integrations" class="param-section hidden">
          <!-- Portails documentaires -->
          <div class="card p-6 mb-6 border border-violet-500/30">
            <h3 class="text-lg font-semibold text-slate-100 mb-2">ğŸ”— Portails documentaires</h3>
            <p class="text-slate-400 mb-6">Permettez Ã  vos sous-traitants et maÃ®tres d'ouvrage de dÃ©poser leurs documents directement via un portail dÃ©diÃ© avec analyse IA automatique.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="p-5 bg-slate-800/50 rounded-xl border border-violet-500/30">
                <div class="flex items-center gap-4 mb-4">
                  <div class="w-14 h-14 bg-violet-500/20 rounded-xl flex items-center justify-center text-3xl">ğŸ‘¥</div>
                  <div><h4 class="font-semibold text-slate-100">Portail Sous-Traitants</h4><p class="text-xs text-slate-400">RÃ©ception des documents ST â†’ EE</p></div>
                </div>
                <p class="text-sm text-slate-400 mb-4">Vos sous-traitants peuvent dÃ©poser leurs Kbis, attestations URSSAF, assurances RC/dÃ©cennale directement.</p>
                <div class="flex gap-2">
                  <button onclick="openModal('modalPortailDepot')" class="flex-1 px-4 py-2 bg-violet-600 hover:bg-violet-500 rounded-lg text-white text-sm text-center">ğŸ”— Ouvrir le portail</button>
                  <button onclick="copierLienPortail('st')" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-slate-200 text-sm">ğŸ“‹ Copier lien</button>
                </div>
              </div>
              <div class="p-5 bg-slate-800/50 rounded-xl border border-emerald-500/30">
                <div class="flex items-center gap-4 mb-4">
                  <div class="w-14 h-14 bg-emerald-500/20 rounded-xl flex items-center justify-center text-3xl">ğŸ›ï¸</div>
                  <div><h4 class="font-semibold text-slate-100">Portail MaÃ®tres d'Ouvrage</h4><p class="text-xs text-slate-400">Envoi des documents EE â†’ MO</p></div>
                </div>
                <p class="text-sm text-slate-400 mb-4">DÃ©posez vos DC1, DC2, attestations et situations de travaux auprÃ¨s de vos maÃ®tres d'ouvrage.</p>
                <div class="flex gap-2">
                  <button onclick="openModal('modalPortailDepot')" class="flex-1 px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg text-white text-sm text-center">ğŸ”— Ouvrir le portail</button>
                  <button onclick="copierLienPortail('mo')" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-slate-200 text-sm">ğŸ“‹ Copier lien</button>
                </div>
              </div>
            </div>
            <div class="mt-4 p-4 bg-blue-500/10 border border-blue-500/30 rounded-xl">
              <p class="text-blue-300 text-sm">ğŸ¤– <strong>Analyse IA automatique :</strong> Tous les documents dÃ©posÃ©s sont analysÃ©s automatiquement pour vÃ©rifier leur conformitÃ© (SIRET, dates, lisibilitÃ©). En cas de problÃ¨me, le dÃ©posant et l'administrateur sont notifiÃ©s.</p>
            </div>
          </div>
          <!-- Export de donnÃ©es -->
          <div class="card p-6 mb-6">
            <h3 class="text-lg font-semibold text-slate-100 mb-2">ğŸ“¤ Exporter vos donnÃ©es</h3>
            <p class="text-slate-400 mb-6">Exportez vos donnÃ©es au format CSV pour les importer dans vos logiciels de comptabilitÃ© (Sage, EBP, QuickBooks, Excel...)</p>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div class="p-4 bg-slate-800/50 rounded-xl text-center">
                <span class="text-4xl">ğŸ‘¥</span><h4 class="font-medium text-slate-200 mt-2">Sous-traitants</h4><p class="text-xs text-slate-500 mt-1 mb-3">Annuaire complet</p>
                <button onclick="exporterCSV('sous-traitants')" class="w-full px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg text-white text-sm">ğŸ“¥ Exporter CSV</button>
              </div>
              <div class="p-4 bg-slate-800/50 rounded-xl text-center">
                <span class="text-4xl">ğŸ—ï¸</span><h4 class="font-medium text-slate-200 mt-2">Chantiers</h4><p class="text-xs text-slate-500 mt-1 mb-3">Liste des chantiers</p>
                <button onclick="exporterCSV('chantiers')" class="w-full px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg text-white text-sm">ğŸ“¥ Exporter CSV</button>
              </div>
              <div class="p-4 bg-slate-800/50 rounded-xl text-center">
                <span class="text-4xl">ğŸ“‹</span><h4 class="font-medium text-slate-200 mt-2">Situations</h4><p class="text-xs text-slate-500 mt-1 mb-3">Toutes les situations</p>
                <button onclick="exporterCSV('situations')" class="w-full px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg text-white text-sm">ğŸ“¥ Exporter CSV</button>
              </div>
              <div class="p-4 bg-slate-800/50 rounded-xl text-center">
                <span class="text-4xl">ğŸ’¶</span><h4 class="font-medium text-slate-200 mt-2">Factures</h4><p class="text-xs text-slate-500 mt-1 mb-3">Historique facturation</p>
                <button onclick="exporterCSV('factures')" class="w-full px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg text-white text-sm">ğŸ“¥ Exporter CSV</button>
              </div>
            </div>
            <div class="mt-4 p-4 bg-blue-500/10 border border-blue-500/30 rounded-xl">
              <p class="text-blue-300 text-sm">ğŸ’¡ <strong>Astuce :</strong> Les fichiers CSV exportÃ©s sont compatibles avec Excel, Sage, EBP BÃ¢timent, QuickBooks et la plupart des logiciels de comptabilitÃ©.</p>
            </div>
          </div>
          <!-- CompatibilitÃ© logiciels -->
          <div class="card p-6">
            <h3 class="text-lg font-semibold text-slate-100 mb-4">ğŸ”— CompatibilitÃ© avec vos logiciels</h3>
            <p class="text-slate-400 mb-4">Nos exports CSV sont compatibles avec :</p>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div class="p-4 bg-slate-800/50 rounded-xl text-center"><span class="text-3xl">ğŸ“Š</span><p class="text-sm text-slate-200 mt-2">Microsoft Excel</p><span class="text-xs text-emerald-400">âœ“ Compatible</span></div>
              <div class="p-4 bg-slate-800/50 rounded-xl text-center"><span class="text-3xl">ğŸ“—</span><p class="text-sm text-slate-200 mt-2">Google Sheets</p><span class="text-xs text-emerald-400">âœ“ Compatible</span></div>
              <div class="p-4 bg-slate-800/50 rounded-xl text-center"><span class="text-3xl">ğŸ§¾</span><p class="text-sm text-slate-200 mt-2">Sage</p><span class="text-xs text-emerald-400">âœ“ Compatible</span></div>
              <div class="p-4 bg-slate-800/50 rounded-xl text-center"><span class="text-3xl">ğŸ“‘</span><p class="text-sm text-slate-200 mt-2">EBP BÃ¢timent</p><span class="text-xs text-emerald-400">âœ“ Compatible</span></div>
              <div class="p-4 bg-slate-800/50 rounded-xl text-center"><span class="text-3xl">ğŸ“’</span><p class="text-sm text-slate-200 mt-2">QuickBooks</p><span class="text-xs text-emerald-400">âœ“ Compatible</span></div>
              <div class="p-4 bg-slate-800/50 rounded-xl text-center"><span class="text-3xl">ğŸ”µ</span><p class="text-sm text-slate-200 mt-2">Pennylane</p><span class="text-xs text-emerald-400">âœ“ Compatible</span></div>
              <div class="p-4 bg-slate-800/50 rounded-xl text-center"><span class="text-3xl">ğŸ“§</span><p class="text-sm text-slate-200 mt-2">Axonaut</p><span class="text-xs text-emerald-400">âœ“ Compatible</span></div>
              <div class="p-4 bg-slate-800/50 rounded-xl text-center"><span class="text-3xl">ğŸ—ƒï¸</span><p class="text-sm text-slate-200 mt-2">Autres (CSV)</p><span class="text-xs text-emerald-400">âœ“ Compatible</span></div>
            </div>
          </div>
        </div>

        <!-- Section SystÃ¨me (Admin only) - A2 Mode local/LAN/cloud -->
        <div id="param-section-systeme" class="param-section hidden">
          <div class="card p-6 mb-6 border border-violet-500/30">
            <h3 class="text-lg font-semibold text-slate-100 mb-2">ğŸ–¥ï¸ Configuration systÃ¨me</h3>
            <p class="text-slate-400 mb-6">Choisissez le mode d'exÃ©cution. Le changement de mode est appliquÃ© <strong>au prochain dÃ©marrage</strong> (redÃ©marrage contrÃ´lÃ©).</p>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
              <!-- Mode Local -->
              <div class="p-4 bg-slate-800/30 rounded-xl cursor-pointer border-2 transition-all mode-card" id="mode-card-local" onclick="selectMode('local')">
                <div class="flex items-center gap-3 mb-3">
                  <span class="text-3xl">ğŸ’»</span>
                  <div>
                    <h4 class="font-semibold text-slate-200">Local</h4>
                    <p class="text-xs text-slate-500">Un seul utilisateur</p>
                  </div>
                </div>
                <ul class="text-xs text-slate-400 space-y-1">
                  <li>âœ… Backend embarquÃ©</li>
                  <li>âœ… Fonctionne hors-ligne</li>
                  <li>âœ… DonnÃ©es locales</li>
                  <li>ğŸ”’ AccÃ¨s: 127.0.0.1 uniquement</li>
                </ul>
              </div>
              
              <!-- Mode LAN -->
              <div class="p-4 bg-slate-800/30 rounded-xl cursor-pointer border-2 transition-all mode-card" id="mode-card-lan" onclick="selectMode('lan')">
                <div class="flex items-center gap-3 mb-3">
                  <span class="text-3xl">ğŸŒ</span>
                  <div>
                    <h4 class="font-semibold text-slate-200">LAN / RÃ©seau</h4>
                    <p class="text-xs text-slate-500">Multi-utilisateurs locaux</p>
                  </div>
                </div>
                <ul class="text-xs text-slate-400 space-y-1">
                  <li>âœ… Backend embarquÃ©</li>
                  <li>âœ… Accessible depuis le rÃ©seau</li>
                  <li>âœ… Partage en Ã©quipe</li>
                  <li>ğŸ”“ AccÃ¨s: IP locale</li>
                </ul>
              </div>
              
              <!-- Mode Cloud -->
              <div class="p-4 bg-slate-800/30 rounded-xl cursor-pointer border-2 transition-all mode-card" id="mode-card-cloud" onclick="selectMode('cloud')">
                <div class="flex items-center gap-3 mb-3">
                  <span class="text-3xl">â˜ï¸</span>
                  <div>
                    <h4 class="font-semibold text-slate-200">Cloud</h4>
                    <p class="text-xs text-slate-500">Serveur distant</p>
                  </div>
                </div>
                <ul class="text-xs text-slate-400 space-y-1">
                  <li>âŒ Pas de backend local</li>
                  <li>âœ… Connexion serveur distant</li>
                  <li>âœ… AccÃ¨s partout</li>
                  <li>ğŸŒ NÃ©cessite Internet</li>
                </ul>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm text-slate-400 mb-2">Mode sÃ©lectionnÃ©</label>
                <select id="sysMode" onchange="updateModeCards()">
                  <option value="local">Local (backend embarquÃ©)</option>
                  <option value="lan">LAN (backend embarquÃ© + rÃ©seau)</option>
                  <option value="cloud">Cloud (API distante)</option>
                </select>
              </div>

              <div>
                <label class="block text-sm text-slate-400 mb-2">Port backend (local/LAN)</label>
                <input type="number" id="sysBackendPort" min="1" max="65535" value="3000" />
              </div>

              <div id="cloudUrlSection" class="hidden">
                <label class="block text-sm text-slate-400 mb-2">URL Serveur Cloud</label>
                <input type="text" id="sysApiUrl" placeholder="https://api.btpconnect.fr" />
                <p class="text-xs text-slate-500 mt-2">URL complÃ¨te de votre serveur BTP Connect en ligne.</p>
              </div>

              <div id="lanExposeSection" class="hidden">
                <label class="block text-sm text-slate-400 mb-2">Exposition LAN</label>
                <div class="flex items-center gap-3">
                  <button type="button" id="sysLanExposeBtn" class="toggle-btn px-4 py-2 rounded-lg bg-slate-800/50 border border-slate-700" onclick="toggleLanExpose()">DÃ©sactivÃ©</button>
                  <span class="text-xs text-slate-500">Permet l'accÃ¨s depuis d'autres machines du rÃ©seau.</span>
                </div>
              </div>
            </div>

            <div class="mt-6 flex flex-col lg:flex-row justify-end gap-3">
              <button onclick="loadSystemeConfig()" class="px-5 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl text-slate-200 font-medium">â†» Recharger</button>
              <button onclick="saveSystemeConfig(false)" class="px-6 py-3 btn-primary rounded-xl text-white font-medium">ğŸ’¾ Sauvegarder</button>
              <button onclick="saveSystemeConfig(true)" class="px-6 py-3 btn-success rounded-xl text-white font-medium">âœ… Appliquer et redÃ©marrer</button>
            </div>
          </div>

          <!-- Infos rÃ©seau -->
          <div class="card p-6 mb-6 border border-sky-500/30">
            <h4 class="text-lg font-semibold text-slate-200 mb-4">ğŸ“¡ Informations rÃ©seau</h4>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
              <div class="p-3 bg-slate-800/30 rounded-xl">
                <p class="text-xs text-slate-500">Mode actuel</p>
                <p class="text-slate-200 font-medium" id="sysCurrentMode">-</p>
              </div>
              <div class="p-3 bg-slate-800/30 rounded-xl">
                <p class="text-xs text-slate-500">URL Backend</p>
                <p class="text-slate-200 font-mono text-sm" id="sysResolvedBackendUrl">-</p>
              </div>
              <div class="p-3 bg-slate-800/30 rounded-xl">
                <p class="text-xs text-slate-500">IP Locale (LAN)</p>
                <p class="text-emerald-400 font-mono" id="sysLocalIP">-</p>
              </div>
              <div class="p-3 bg-slate-800/30 rounded-xl">
                <p class="text-xs text-slate-500">URL d'accÃ¨s LAN</p>
                <div class="flex items-center gap-2">
                  <p class="text-sky-400 font-mono text-sm flex-1" id="sysLanUrl">-</p>
                  <button onclick="copyLanUrl()" class="px-2 py-1 bg-sky-600 hover:bg-sky-500 rounded text-white text-xs">ğŸ“‹</button>
                </div>
              </div>
            </div>
          </div>

          <div class="card p-6">
            <h4 class="text-sm font-semibold text-slate-200 mb-2">â„¹ï¸ Instructions</h4>
            <div class="text-sm text-slate-400 space-y-2">
              <p><strong>Mode Local :</strong> L'application fonctionne en autonomie complÃ¨te sur votre machine.</p>
              <p><strong>Mode LAN :</strong> Partagez l'accÃ¨s avec d'autres machines sur le mÃªme rÃ©seau. Donnez-leur l'URL d'accÃ¨s LAN.</p>
              <p><strong>Mode Cloud :</strong> Connectez-vous Ã  un serveur BTP Connect hÃ©bergÃ© en ligne.</p>
            </div>
          </div>
        </div>

        <!-- Section Ã€ propos -->
        <div id="param-section-apropos" class="param-section hidden">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="card p-6">
              <h3 class="text-lg font-semibold text-slate-100 mb-4">â„¹ï¸ Informations sur l'application</h3>
              <div class="space-y-3 text-sm">
                <div class="flex justify-between py-2 border-b border-slate-800"><span class="text-slate-400">Application</span><span class="text-slate-200">BTP Connect</span></div>
                <div class="flex justify-between py-2 border-b border-slate-800"><span class="text-slate-400">Version</span><span class="text-slate-200">8.2.0</span></div>
                <div class="flex justify-between py-2 border-b border-slate-800"><span class="text-slate-400">DerniÃ¨re mise Ã  jour</span><span class="text-slate-200">Janvier 2026</span></div>
                <div class="flex justify-between py-2 border-b border-slate-800"><span class="text-slate-400">Licence</span><span class="text-slate-200">PropriÃ©taire</span></div>
              </div>
            </div>
            <div class="card p-6">
              <h3 class="text-lg font-semibold text-slate-100 mb-4">ğŸ›ï¸ Ã‰diteur</h3>
              <div class="space-y-3 text-sm">
                <div class="flex justify-between py-2 border-b border-slate-800"><span class="text-slate-400">SociÃ©tÃ©</span><span class="text-slate-200">BTP Connect SAS</span></div>
                <div class="flex justify-between py-2 border-b border-slate-800"><span class="text-slate-400">SiÃ¨ge social</span><span class="text-slate-200">Paris, France</span></div>
                <div class="flex justify-between py-2 border-b border-slate-800"><span class="text-slate-400">SIRET</span><span class="text-slate-200">XXX XXX XXX 00000</span></div>
                <div class="flex justify-between py-2 border-b border-slate-800"><span class="text-slate-400">Contact</span><span class="text-slate-200"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="3f4c4a4f4f504d4b7f5d4b4f5c5051515a5c4b11594d">[email&#160;protected]</a></span></div>
              </div>
            </div>
            <div class="card p-6 md:col-span-2">
              <h3 class="text-lg font-semibold text-slate-100 mb-4">ğŸ“œ Mentions lÃ©gales</h3>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div onclick="openModal('modalCGU')" class="p-4 bg-slate-800/50 rounded-xl text-center hover:bg-slate-800 transition-colors cursor-pointer"><span class="text-2xl">ğŸ“‹</span><p class="text-sm text-slate-200 mt-2">CGU</p></div>
                <div onclick="openModal('modalConfidentialite')" class="p-4 bg-slate-800/50 rounded-xl text-center hover:bg-slate-800 transition-colors cursor-pointer"><span class="text-2xl">ğŸ”’</span><p class="text-sm text-slate-200 mt-2">Politique de confidentialitÃ©</p></div>
                <div onclick="openModal('modalCookies')" class="p-4 bg-slate-800/50 rounded-xl text-center hover:bg-slate-800 transition-colors cursor-pointer"><span class="text-2xl">ğŸª</span><p class="text-sm text-slate-200 mt-2">Cookies</p></div>
                <div onclick="openModal('modalMentionsLegales')" class="p-4 bg-slate-800/50 rounded-xl text-center hover:bg-slate-800 transition-colors cursor-pointer"><span class="text-2xl">âš–ï¸</span><p class="text-sm text-slate-200 mt-2">Mentions lÃ©gales</p></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: Administration (Admin uniquement) -->
      <div id="tab-admin" class="tab-content hidden">
        <!-- Alerte sÃ©curitÃ© -->
        <div class="card p-4 mb-6 border border-red-500/50 bg-red-500/10">
          <div class="flex items-center gap-3">
            <span class="text-2xl">ğŸ”</span>
            <div>
              <h3 class="font-semibold text-red-400">Zone Administrateur</h3>
              <p class="text-sm text-slate-400">AccÃ¨s rÃ©servÃ© aux administrateurs. Les modifications ici affectent l'ensemble du systÃ¨me.</p>
            </div>
          </div>
        </div>

        <!-- Stats rapides BDD -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
          <div class="card p-4 text-center">
            <p class="text-2xl font-bold text-violet-400" id="admin-st-count">0</p>
            <p class="text-xs text-slate-500">Sous-traitants</p>
          </div>
          <div class="card p-4 text-center">
            <p class="text-2xl font-bold text-emerald-400" id="admin-chantiers-count">0</p>
            <p class="text-xs text-slate-500">Chantiers</p>
          </div>
          <div class="card p-4 text-center">
            <p class="text-2xl font-bold text-sky-400" id="admin-contrats-count">0</p>
            <p class="text-xs text-slate-500">Contrats</p>
          </div>
          <div class="card p-4 text-center">
            <p class="text-2xl font-bold text-amber-400" id="admin-situations-count">0</p>
            <p class="text-xs text-slate-500">Situations</p>
          </div>
          <div class="card p-4 text-center">
            <p class="text-2xl font-bold text-red-400" id="admin-docs-count">0</p>
            <p class="text-xs text-slate-500">Documents</p>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Gestion Base de DonnÃ©es -->
          <div class="card p-6">
            <h3 class="text-lg font-semibold text-slate-100 mb-4">ğŸ—„ï¸ Gestion Base de DonnÃ©es</h3>
            
            <!-- Import de fichiers -->
            <div class="mb-6">
              <h4 class="text-sm font-medium text-slate-300 mb-3">ğŸ“¥ Importer des donnÃ©es</h4>
              <div class="drop-zone p-6 rounded-xl text-center mb-3" id="adminDropZone" 
                   ondrop="handleAdminDrop(event)" ondragover="event.preventDefault()" ondragleave="this.classList.remove('border-violet-500')">
                <div class="text-3xl mb-2">ğŸ“</div>
                <p class="text-slate-400 text-sm">Glissez vos fichiers ici</p>
                <p class="text-slate-500 text-xs mt-1">CSV, JSON, Excel (.xlsx)</p>
                <input type="file" id="adminFileInput" class="hidden" accept=".csv,.json,.xlsx" multiple onchange="handleAdminFiles(this.files)">
                <button onclick="document.getElementById('adminFileInput').click()" class="mt-3 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm text-slate-300">
                  Parcourir...
                </button>
              </div>
              <div id="adminImportPreview" class="hidden mb-3 p-3 bg-slate-800/50 rounded-lg">
                <div class="flex justify-between items-center mb-2">
                  <span class="text-sm text-slate-300" id="adminImportFileName">fichier.csv</span>
                  <button onclick="clearAdminImport()" class="text-red-400 hover:text-red-300 text-sm">âœ• Annuler</button>
                </div>
                <div class="text-xs text-slate-500" id="adminImportInfo">0 lignes dÃ©tectÃ©es</div>
              </div>
              <select id="adminImportType" class="w-full p-2 bg-slate-800 border border-slate-700 rounded-lg text-slate-300 text-sm mb-3">
                <option value="">-- SÃ©lectionner le type de donnÃ©es --</option>
                <option value="soustraitants">Sous-traitants</option>
                <option value="chantiers">Chantiers</option>
                <option value="contrats">Contrats</option>
                <option value="situations">Situations</option>
                <option value="documents">Documents</option>
              </select>
              <button onclick="executeAdminImport()" class="w-full btn-primary px-4 py-2 rounded-lg text-white text-sm">
                ğŸ“¥ Importer les donnÃ©es
              </button>
            </div>

            <!-- Export de donnÃ©es -->
            <div class="mb-6">
              <h4 class="text-sm font-medium text-slate-300 mb-3">ğŸ“¤ Exporter des donnÃ©es</h4>
              <div class="grid grid-cols-2 gap-2">
                <button onclick="exportAdminData('json')" class="p-3 bg-slate-800/50 hover:bg-slate-700/50 rounded-lg text-sm text-slate-300 flex items-center justify-center gap-2">
                  <span>ğŸ“‹</span> Export JSON
                </button>
                <button onclick="exportAdminData('csv')" class="p-3 bg-slate-800/50 hover:bg-slate-700/50 rounded-lg text-sm text-slate-300 flex items-center justify-center gap-2">
                  <span>ğŸ“Š</span> Export CSV
                </button>
                <button onclick="exportAdminData('sql')" class="p-3 bg-slate-800/50 hover:bg-slate-700/50 rounded-lg text-sm text-slate-300 flex items-center justify-center gap-2">
                  <span>ğŸ—ƒï¸</span> Export SQL
                </button>
                <button onclick="exportAdminData('backup')" class="p-3 bg-emerald-500/20 hover:bg-emerald-500/30 rounded-lg text-sm text-emerald-400 flex items-center justify-center gap-2">
                  <span>ğŸ’¾</span> Backup complet
                </button>
              </div>
            </div>

            <!-- Zone dangereuse -->
            <div class="border border-red-500/30 rounded-xl p-4 bg-red-500/5">
              <h4 class="text-sm font-medium text-red-400 mb-3 flex items-center gap-2">
                <span>âš ï¸</span> Zone dangereuse
              </h4>
              <div class="space-y-2">
                <button onclick="confirmResetTable()" class="w-full p-2 bg-red-500/20 hover:bg-red-500/30 rounded-lg text-sm text-red-400 text-left flex items-center gap-2">
                  <span>ğŸ—‘ï¸</span> Vider une table...
                </button>
                <button onclick="confirmResetAll()" class="w-full p-2 bg-red-500/20 hover:bg-red-500/30 rounded-lg text-sm text-red-400 text-left flex items-center gap-2">
                  <span>ğŸ’£</span> RÃ©initialiser toute la BDD
                </button>
              </div>
            </div>
          </div>

          <!-- Analyse IA Documents -->
          <div class="card p-6">
            <h3 class="text-lg font-semibold text-slate-100 mb-4">ğŸ¤– Analyse IA Documents</h3>
            
            <!-- Upload documents pour analyse -->
            <div class="mb-6">
              <h4 class="text-sm font-medium text-slate-300 mb-3">ğŸ“„ Documents Ã  analyser</h4>
              <div class="drop-zone p-6 rounded-xl text-center mb-3" id="iaDropZone"
                   ondrop="handleIADrop(event)" ondragover="event.preventDefault()">
                <div class="text-3xl mb-2">ğŸ”</div>
                <p class="text-slate-400 text-sm">DÃ©posez vos documents</p>
                <p class="text-slate-500 text-xs mt-1">PDF, Images, Word, Excel</p>
                <input type="file" id="iaFileInput" class="hidden" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx" multiple onchange="handleIAFiles(this.files)">
                <button onclick="document.getElementById('iaFileInput').click()" class="mt-3 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm text-slate-300">
                  SÃ©lectionner des fichiers
                </button>
              </div>
              <div id="iaFilesList" class="space-y-2 mb-3"></div>
            </div>

            <!-- Type d'analyse -->
            <div class="mb-6">
              <h4 class="text-sm font-medium text-slate-300 mb-3">ğŸ¯ Type d'analyse</h4>
              <div class="grid grid-cols-2 gap-2">
                <label class="p-3 bg-slate-800/50 hover:bg-slate-700/50 rounded-lg cursor-pointer flex items-center gap-2 border border-transparent has-[:checked]:border-violet-500 has-[:checked]:bg-violet-500/10">
                  <input type="radio" name="iaAnalyseType" value="extraction" class="hidden" checked>
                  <span>ğŸ“</span>
                  <div>
                    <p class="text-sm text-slate-300">Extraction</p>
                    <p class="text-xs text-slate-500">Extraire les donnÃ©es clÃ©s</p>
                  </div>
                </label>
                <label class="p-3 bg-slate-800/50 hover:bg-slate-700/50 rounded-lg cursor-pointer flex items-center gap-2 border border-transparent has-[:checked]:border-violet-500 has-[:checked]:bg-violet-500/10">
                  <input type="radio" name="iaAnalyseType" value="conformite" class="hidden">
                  <span>âœ…</span>
                  <div>
                    <p class="text-sm text-slate-300">ConformitÃ©</p>
                    <p class="text-xs text-slate-500">VÃ©rifier la validitÃ©</p>
                  </div>
                </label>
                <label class="p-3 bg-slate-800/50 hover:bg-slate-700/50 rounded-lg cursor-pointer flex items-center gap-2 border border-transparent has-[:checked]:border-violet-500 has-[:checked]:bg-violet-500/10">
                  <input type="radio" name="iaAnalyseType" value="anomalies" class="hidden">
                  <span>ğŸ”</span>
                  <div>
                    <p class="text-sm text-slate-300">Anomalies</p>
                    <p class="text-xs text-slate-500">DÃ©tecter les erreurs</p>
                  </div>
                </label>
                <label class="p-3 bg-slate-800/50 hover:bg-slate-700/50 rounded-lg cursor-pointer flex items-center gap-2 border border-transparent has-[:checked]:border-violet-500 has-[:checked]:bg-violet-500/10">
                  <input type="radio" name="iaAnalyseType" value="classification" class="hidden">
                  <span>ğŸ·ï¸</span>
                  <div>
                    <p class="text-sm text-slate-300">Classification</p>
                    <p class="text-xs text-slate-500">CatÃ©goriser les docs</p>
                  </div>
                </label>
              </div>
            </div>

            <button onclick="launchIAAnalysis()" class="w-full btn-primary px-4 py-3 rounded-lg text-white flex items-center justify-center gap-2">
              <span>ğŸš€</span> Lancer l'analyse IA
            </button>

            <!-- RÃ©sultats IA -->
            <div id="iaResultsContainer" class="mt-4 hidden">
              <h4 class="text-sm font-medium text-slate-300 mb-3">ğŸ“Š RÃ©sultats de l'analyse</h4>
              <div id="iaResults" class="p-4 bg-slate-800/30 rounded-xl max-h-64 overflow-y-auto">
                <p class="text-slate-500 text-sm">Les rÃ©sultats apparaÃ®tront ici...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Logs systÃ¨me -->
        <div class="card p-6 mt-6">
          <h3 class="text-lg font-semibold text-slate-100 mb-4">ğŸ“œ Journal des actions</h3>
          <div id="adminLogsContainer" class="space-y-2 max-h-48 overflow-y-auto">
            <div class="flex items-center gap-3 p-2 bg-slate-800/30 rounded-lg text-sm">
              <span class="text-emerald-400">âœ“</span>
              <span class="text-slate-500 text-xs" id="logTime1">--</span>
              <span class="text-slate-300">Onglet Admin initialisÃ©</span>
            </div>
          </div>
        </div>
        
        <!-- Section IntÃ©grations Logiciels BTP -->
        <div class="card p-6 mt-6">
          <h3 class="text-lg font-semibold text-slate-100 mb-4">ğŸ”— IntÃ©grations logiciels mÃ©tier</h3>
          <p class="text-sm text-slate-400 mb-6">Connectez BTP Connect Ã  vos outils de chiffrage et devis</p>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Quick Devis -->
            <div class="p-5 bg-slate-800/50 rounded-xl border border-amber-500/30">
              <div class="flex items-center gap-4 mb-4">
                <div class="w-14 h-14 bg-amber-500/20 rounded-xl flex items-center justify-center text-3xl">ğŸ“Š</div>
                <div>
                  <h4 class="font-semibold text-slate-100">Quick Devis</h4>
                  <p class="text-xs text-slate-400">Logiciel de chiffrage BTP</p>
                </div>
                <span class="ml-auto px-3 py-1 bg-amber-500/20 text-amber-400 rounded-full text-xs" id="quickDevisStatus">Non connectÃ©</span>
              </div>
              <p class="text-sm text-slate-400 mb-4">Synchronisez vos devis Quick Devis avec BTP Connect pour un suivi automatique.</p>
              <div class="space-y-3">
                <div>
                  <label class="block text-xs text-slate-500 mb-1">ClÃ© API Quick Devis</label>
                  <input type="password" id="quickDevisApiKey" placeholder="Entrez votre clÃ© API..." class="w-full p-2 text-sm">
                </div>
                <div>
                  <label class="block text-xs text-slate-500 mb-1">URL du serveur</label>
                  <input type="text" id="quickDevisUrl" placeholder="https://api.quickdevis.fr" class="w-full p-2 text-sm" value="https://api.quickdevis.fr">
                </div>
                <div class="flex gap-2">
                  <button onclick="testQuickDevisConnection()" class="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm text-slate-300">ğŸ”„ Tester</button>
                  <button onclick="connectQuickDevis()" class="flex-1 px-4 py-2 bg-amber-600 hover:bg-amber-500 rounded-lg text-sm text-white">ğŸ”— Connecter</button>
                </div>
              </div>
              <div id="quickDevisActions" class="hidden mt-4 pt-4 border-t border-slate-700 space-y-2">
                <button onclick="syncQuickDevis('import')" class="w-full p-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm text-slate-300 text-left flex items-center gap-2">
                  <span>ğŸ“¥</span> Importer les devis depuis Quick Devis
                </button>
                <button onclick="syncQuickDevis('export')" class="w-full p-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm text-slate-300 text-left flex items-center gap-2">
                  <span>ğŸ“¤</span> Exporter vers Quick Devis
                </button>
              </div>
            </div>
            
            <!-- Optima -->
            <div class="p-5 bg-slate-800/50 rounded-xl border border-sky-500/30">
              <div class="flex items-center gap-4 mb-4">
                <div class="w-14 h-14 bg-sky-500/20 rounded-xl flex items-center justify-center text-3xl">ğŸ“</div>
                <div>
                  <h4 class="font-semibold text-slate-100">Optima</h4>
                  <p class="text-xs text-slate-400">Solution de gestion BTP</p>
                </div>
                <span class="ml-auto px-3 py-1 bg-sky-500/20 text-sky-400 rounded-full text-xs" id="optimaStatus">Non connectÃ©</span>
              </div>
              <p class="text-sm text-slate-400 mb-4">Connectez Optima pour importer vos chantiers et sous-traitants automatiquement.</p>
              <div class="space-y-3">
                <div>
                  <label class="block text-xs text-slate-500 mb-1">Identifiant Optima</label>
                  <input type="text" id="optimaClientId" placeholder="Votre identifiant client..." class="w-full p-2 text-sm">
                </div>
                <div>
                  <label class="block text-xs text-slate-500 mb-1">Token d'accÃ¨s</label>
                  <input type="password" id="optimaToken" placeholder="Votre token d'accÃ¨s..." class="w-full p-2 text-sm">
                </div>
                <div class="flex gap-2">
                  <button onclick="testOptimaConnection()" class="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm text-slate-300">ğŸ”„ Tester</button>
                  <button onclick="connectOptima()" class="flex-1 px-4 py-2 bg-sky-600 hover:bg-sky-500 rounded-lg text-sm text-white">ğŸ”— Connecter</button>
                </div>
              </div>
              <div id="optimaActions" class="hidden mt-4 pt-4 border-t border-slate-700 space-y-2">
                <button onclick="syncOptima('chantiers')" class="w-full p-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm text-slate-300 text-left flex items-center gap-2">
                  <span>ğŸ—ï¸</span> Synchroniser les chantiers
                </button>
                <button onclick="syncOptima('soustraitants')" class="w-full p-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm text-slate-300 text-left flex items-center gap-2">
                  <span>ğŸ‘·</span> Synchroniser les sous-traitants
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Assistant IA Admin -->
        <div class="card p-6 mt-6 border border-violet-500/30">
          <div class="flex items-center gap-4 mb-4">
            <div class="w-12 h-12 bg-gradient-to-br from-violet-500 to-indigo-600 rounded-xl flex items-center justify-center text-2xl">ğŸ¤–</div>
            <div>
              <h3 class="text-lg font-semibold text-slate-100">Assistant IA Administration</h3>
              <p class="text-sm text-slate-400">Posez vos questions sur la gestion de la base de donnÃ©es</p>
            </div>
          </div>
          
          <div class="bg-slate-800/30 rounded-xl p-4 mb-4 max-h-64 overflow-y-auto" id="adminAiChat">
            <div class="flex gap-3 mb-4">
              <div class="w-8 h-8 bg-violet-500/30 rounded-full flex items-center justify-center text-sm">ğŸ¤–</div>
              <div class="flex-1 bg-slate-800 p-3 rounded-xl rounded-tl-sm">
                <p class="text-sm text-slate-300">Bonjour ! Je suis votre assistant IA pour la gestion de la base de donnÃ©es. Je peux vous aider Ã  :</p>
                <ul class="text-sm text-slate-400 mt-2 space-y-1">
                  <li>â€¢ Analyser les donnÃ©es (statistiques, tendances)</li>
                  <li>â€¢ Identifier les anomalies ou doublons</li>
                  <li>â€¢ GÃ©nÃ©rer des requÃªtes SQL personnalisÃ©es</li>
                  <li>â€¢ Expliquer les relations entre les donnÃ©es</li>
                </ul>
              </div>
            </div>
          </div>
          
          <div class="flex gap-2">
            <input type="text" id="adminAiInput" placeholder="Posez votre question sur les donnÃ©es..." class="flex-1 p-3" onkeypress="if(event.key==='Enter') sendAdminAiMessage()">
            <button onclick="sendAdminAiMessage()" class="px-6 py-3 bg-violet-600 hover:bg-violet-500 rounded-xl text-white">Envoyer</button>
          </div>
          
          <div class="flex flex-wrap gap-2 mt-3">
            <button onclick="askAdminAi('Combien de sous-traitants ont des documents expirÃ©s ?')" class="px-3 py-1 bg-slate-800 hover:bg-slate-700 rounded-full text-xs text-slate-400">Documents expirÃ©s</button>
            <button onclick="askAdminAi('Quels chantiers ont le plus de situations en attente ?')" class="px-3 py-1 bg-slate-800 hover:bg-slate-700 rounded-full text-xs text-slate-400">Situations en attente</button>
            <button onclick="askAdminAi('Y a-t-il des doublons dans les sous-traitants ?')" class="px-3 py-1 bg-slate-800 hover:bg-slate-700 rounded-full text-xs text-slate-400">DÃ©tecter doublons</button>
            <button onclick="askAdminAi('GÃ©nÃ©rer un rapport de synthÃ¨se')" class="px-3 py-1 bg-slate-800 hover:bg-slate-700 rounded-full text-xs text-slate-400">Rapport synthÃ¨se</button>
          </div>
        </div>
        
        <!-- Historique des modifications BDD -->
        <div class="card p-6 mt-6">
          <h3 class="text-lg font-semibold text-slate-100 mb-4">ğŸ“ Historique des modifications</h3>
          <div class="overflow-x-auto">
            <table class="data-table w-full">
              <thead>
                <tr>
                  <th>Date/Heure</th>
                  <th>Utilisateur</th>
                  <th>Action</th>
                  <th>Table</th>
                  <th>DÃ©tails</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="adminHistoryTable">
                <tr>
                  <td class="text-slate-400 text-sm">05/01/2026 17:30</td>
                  <td class="text-slate-300">JÃ©rÃ©mie D.</td>
                  <td><span class="badge badge-success">Ajout</span></td>
                  <td class="text-slate-300">sous_traitants</td>
                  <td class="text-slate-400 text-sm">Nouveau ST: Ã‰lectricitÃ© Pro</td>
                  <td><button onclick="undoHistoryAction(1, 'ajout', 'sous_traitants')" class="text-violet-400 text-sm hover:text-violet-300">ğŸ”„ Annuler</button></td>
                </tr>
                <tr>
                  <td class="text-slate-400 text-sm">05/01/2026 16:45</td>
                  <td class="text-slate-300">JÃ©rÃ©mie D.</td>
                  <td><span class="badge badge-info">Modification</span></td>
                  <td class="text-slate-300">chantiers</td>
                  <td class="text-slate-400 text-sm">Mise Ã  jour: RÃ©sidence Les Tilleuls</td>
                  <td><button onclick="undoHistoryAction(2, 'modification', 'chantiers')" class="text-violet-400 text-sm hover:text-violet-300">ğŸ”„ Annuler</button></td>
                </tr>
                <tr>
                  <td class="text-slate-400 text-sm">05/01/2026 15:20</td>
                  <td class="text-slate-300">JÃ©rÃ©mie D.</td>
                  <td><span class="badge badge-danger">Suppression</span></td>
                  <td class="text-slate-300">documents</td>
                  <td class="text-slate-400 text-sm">Document expirÃ© supprimÃ©</td>
                  <td><button onclick="restoreHistoryAction(3, 'suppression', 'documents')" class="text-violet-400 text-sm hover:text-violet-300">ğŸ”„ Restaurer</button></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Console BDD AvancÃ©e -->
        <div class="card p-6 mt-6 border border-violet-500/30">
          <h3 class="text-lg font-semibold text-slate-100 mb-4">ğŸ—„ï¸ Console BDD AvancÃ©e</h3>
          <p class="text-sm text-slate-400 mb-6">Visualisez, modifiez et exportez les donnÃ©es de votre base de donnÃ©es.</p>
          
          <!-- SÃ©lection de table -->
          <div class="flex flex-wrap gap-4 mb-6">
            <div class="flex-1">
              <label class="block text-sm text-slate-400 mb-2">Table Ã  visualiser</label>
              <select id="adminTableSelect" onchange="loadAdminTable()" class="w-full">
                <option value="">-- SÃ©lectionner une table --</option>
                <option value="soustraitants">ğŸ“‹ Sous-traitants</option>
                <option value="chantiers">ğŸ—ï¸ Chantiers</option>
                <option value="contrats">ğŸ“„ Contrats</option>
                <option value="situations">ğŸ“Š Situations</option>
                <option value="factures">ğŸ’¶ Factures</option>
                <option value="documents">ğŸ“ Documents</option>
                <option value="users">ğŸ‘¥ Utilisateurs</option>
              </select>
            </div>
            <div class="flex items-end gap-2">
              <button onclick="exportTableExcel()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg text-white text-sm flex items-center gap-2">
                <span>ğŸ“Š</span> Export Excel
              </button>
              <button onclick="exportAllExcel()" class="px-4 py-2 bg-violet-600 hover:bg-violet-500 rounded-lg text-white text-sm flex items-center gap-2">
                <span>ğŸ“¦</span> Export complet
              </button>
              <button onclick="document.getElementById('excelImportInput').click()" class="px-4 py-2 bg-amber-600 hover:bg-amber-500 rounded-lg text-white text-sm flex items-center gap-2">
                <span>ğŸ“¥</span> Importer Excel
              </button>
              <input type="file" id="excelImportInput" class="hidden" accept=".xlsx,.xls" onchange="importExcelFile(this)">
            </div>
          </div>
          
          <!-- Affichage des donnÃ©es de la table -->
          <div id="adminTableContainer" class="bg-slate-800/30 rounded-xl p-4 max-h-96 overflow-auto">
            <div class="text-center py-8 text-slate-500">
              <span class="text-4xl">ğŸ“‹</span>
              <p class="mt-2">SÃ©lectionnez une table pour afficher les donnÃ©es</p>
            </div>
          </div>
          
          <!-- Actions sur la ligne sÃ©lectionnÃ©e -->
          <div id="adminRowActions" class="hidden mt-4 p-4 bg-violet-500/10 rounded-xl border border-violet-500/30">
            <div class="flex items-center justify-between">
              <div>
                <h4 class="font-medium text-slate-200">Ligne sÃ©lectionnÃ©e: <span id="selectedRowId" class="text-violet-400">#0</span></h4>
                <p class="text-sm text-slate-400">Modifiez ou supprimez cet enregistrement</p>
              </div>
              <div class="flex gap-2">
                <button onclick="editSelectedRow()" class="px-4 py-2 bg-sky-600 hover:bg-sky-500 rounded-lg text-white text-sm">âœï¸ Modifier</button>
                <button onclick="deleteSelectedRow()" class="px-4 py-2 bg-red-600 hover:bg-red-500 rounded-lg text-white text-sm">ğŸ—‘ï¸ Supprimer</button>
                <button onclick="deselectRow()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-slate-200 text-sm">âœ• Annuler</button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- ModÃ¨les de Documents -->
        <div class="card p-6 mt-6 border border-amber-500/30">
          <h3 class="text-lg font-semibold text-slate-100 mb-4">ğŸ“ ModÃ¨les de Documents</h3>
          <p class="text-sm text-slate-400 mb-6">CrÃ©ez et gÃ©rez vos modÃ¨les pour les factures, situations, exports et emails.</p>
          
          <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="p-4 bg-slate-800/30 rounded-xl cursor-pointer hover:bg-slate-800/50" onclick="openTemplateEditor('facture')">
              <div class="flex items-center gap-3 mb-2">
                <span class="text-2xl">ğŸ’¶</span>
                <h4 class="font-medium text-slate-200">Facture Ã©mise</h4>
              </div>
              <p class="text-xs text-slate-500">ModÃ¨le de facture pour vos clients</p>
            </div>
            <div class="p-4 bg-slate-800/30 rounded-xl cursor-pointer hover:bg-slate-800/50" onclick="openTemplateEditor('situation')">
              <div class="flex items-center gap-3 mb-2">
                <span class="text-2xl">ğŸ“Š</span>
                <h4 class="font-medium text-slate-200">Situation de travaux</h4>
              </div>
              <p class="text-xs text-slate-500">ModÃ¨le de situation mensuelle</p>
            </div>
            <div class="p-4 bg-slate-800/30 rounded-xl cursor-pointer hover:bg-slate-800/50" onclick="openTemplateEditor('email-demande')">
              <div class="flex items-center gap-3 mb-2">
                <span class="text-2xl">ğŸ“§</span>
                <h4 class="font-medium text-slate-200">Email demande documents</h4>
              </div>
              <p class="text-xs text-slate-500">Template pour demander des docs aux ST</p>
            </div>
            <div class="p-4 bg-slate-800/30 rounded-xl cursor-pointer hover:bg-slate-800/50" onclick="openTemplateEditor('email-relance')">
              <div class="flex items-center gap-3 mb-2">
                <span class="text-2xl">ğŸ””</span>
                <h4 class="font-medium text-slate-200">Email relance</h4>
              </div>
              <p class="text-xs text-slate-500">Template pour relancer les documents</p>
            </div>
            <div class="p-4 bg-slate-800/30 rounded-xl cursor-pointer hover:bg-slate-800/50" onclick="openTemplateEditor('contrat')">
              <div class="flex items-center gap-3 mb-2">
                <span class="text-2xl">ğŸ“„</span>
                <h4 class="font-medium text-slate-200">Contrat sous-traitant</h4>
              </div>
              <p class="text-xs text-slate-500">ModÃ¨le de contrat ST</p>
            </div>
            <div class="p-4 bg-slate-800/30 rounded-xl cursor-pointer hover:bg-slate-800/50" onclick="openTemplateEditor('export')">
              <div class="flex items-center gap-3 mb-2">
                <span class="text-2xl">ğŸ“‹</span>
                <h4 class="font-medium text-slate-200">Export personnalisÃ©</h4>
              </div>
              <p class="text-xs text-slate-500">Format d'export des donnÃ©es</p>
            </div>
          </div>
        </div>
        
        <!-- Modal d'Ã©dition de ligne -->
        <div id="modalEditRow" class="modal-overlay" onclick="closeModal('modalEditRow')">
          <div class="modal-content" style="max-width: 600px;" onclick="event.stopPropagation()">
            <div class="p-5 border-b border-slate-700 flex items-center justify-between">
              <h3 class="text-xl font-bold text-white">âœï¸ Modifier l'enregistrement</h3>
              <button onclick="closeModal('modalEditRow')" class="header-btn">âœ•</button>
            </div>
            <div class="p-6">
              <div id="editRowFields" class="space-y-4"></div>
              <div class="flex gap-3 mt-6">
                <button onclick="saveRowEdit()" class="flex-1 btn-success px-4 py-3 rounded-xl text-white">ğŸ’¾ Sauvegarder</button>
                <button onclick="closeModal('modalEditRow')" class="flex-1 px-4 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl text-slate-200">Annuler</button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Modal Ã‰diteur de Templates -->
        <div id="modalTemplateEditor" class="modal-overlay" onclick="closeModal('modalTemplateEditor')">
          <div class="modal-content" style="max-width: 800px;" onclick="event.stopPropagation()">
            <div class="p-5 border-b border-slate-700 flex items-center justify-between">
              <h3 class="text-xl font-bold text-white" id="templateEditorTitle">ğŸ“ Ã‰diter le modÃ¨le</h3>
              <button onclick="closeModal('modalTemplateEditor')" class="header-btn">âœ•</button>
            </div>
            <div class="p-6">
              <div class="mb-4">
                <label class="block text-sm text-slate-400 mb-2">Nom du modÃ¨le</label>
                <input type="text" id="templateName" class="w-full" placeholder="Mon modÃ¨le">
              </div>
              <div class="mb-4">
                <label class="block text-sm text-slate-400 mb-2">Contenu du modÃ¨le</label>
                <textarea id="templateContent" rows="15" class="w-full font-mono text-sm" placeholder="Entrez le contenu du modÃ¨le..."></textarea>
              </div>
              <div class="p-3 bg-slate-800/50 rounded-xl mb-4">
                <p class="text-sm text-slate-400 mb-2">ğŸ“Œ Variables disponibles :</p>
                <div class="flex flex-wrap gap-2 text-xs">
                  <span class="px-2 py-1 bg-violet-500/20 text-violet-300 rounded">{NOM_ST}</span>
                  <span class="px-2 py-1 bg-violet-500/20 text-violet-300 rounded">{NOM_ENTREPRISE}</span>
                  <span class="px-2 py-1 bg-violet-500/20 text-violet-300 rounded">{DATE}</span>
                  <span class="px-2 py-1 bg-violet-500/20 text-violet-300 rounded">{MONTANT}</span>
                  <span class="px-2 py-1 bg-violet-500/20 text-violet-300 rounded">{CHANTIER}</span>
                  <span class="px-2 py-1 bg-violet-500/20 text-violet-300 rounded">{LIEN_PORTAIL}</span>
                  <span class="px-2 py-1 bg-violet-500/20 text-violet-300 rounded">{DOCUMENTS}</span>
                </div>
              </div>
              <div class="flex gap-3">
                <button onclick="saveTemplate()" class="flex-1 btn-success px-4 py-3 rounded-xl text-white">ğŸ’¾ Enregistrer</button>
                <button onclick="resetTemplate()" class="px-4 py-3 bg-amber-600 hover:bg-amber-500 rounded-xl text-white">ğŸ”„ RÃ©initialiser</button>
                <button onclick="closeModal('modalTemplateEditor')" class="px-4 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl text-slate-200">Annuler</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: Analyse IA (simplified) -->
      <div id="tab-analyse" class="tab-content hidden">
        <div class="card p-6 mb-6">
          <h3 class="text-lg font-semibold text-slate-200 mb-4">ğŸ¯ Mode d'analyse</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="p-4 bg-slate-800/30 rounded-xl cursor-pointer border-2 border-violet-500 bg-violet-500/10" id="mode-comparaison" onclick="setAnalyseMode('comparaison')">
              <div class="flex items-center gap-3">
                <span class="text-3xl">âš–ï¸</span>
                <div><p class="font-medium text-slate-200">Comparaison multi-devis</p><p class="text-sm text-slate-500">Comparez 2 Ã  5 devis</p></div>
              </div>
            </div>
            <div class="p-4 bg-slate-800/30 rounded-xl cursor-pointer border-2 border-transparent hover:border-violet-500/50" id="mode-unique" onclick="setAnalyseMode('unique')">
              <div class="flex items-center gap-3">
                <span class="text-3xl">ğŸ”</span>
                <div><p class="font-medium text-slate-200">Analyse devis unique</p><p class="text-sm text-slate-500">Analysez vs piÃ¨ces marchÃ©</p></div>
              </div>
            </div>
          </div>
        </div>

        <div class="card p-6 mb-6">
          <h3 class="text-lg font-semibold text-slate-200 mb-4">ğŸ“‹ Contexte du projet</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm text-slate-400 mb-2">Chantier *</label>
              <select id="analyseChantier" onchange="updateAnalyseLots()"><option value="">SÃ©lectionner...</option></select>
            </div>
            <div>
              <label class="block text-sm text-slate-400 mb-2">Lot *</label>
              <select id="analyseLot"><option value="">SÃ©lectionner d'abord un chantier...</option></select>
            </div>
            <div>
              <label class="block text-sm text-slate-400 mb-2">Budget estimÃ©</label>
              <input type="text" placeholder="Ex: 85000">
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="card p-6">
            <h3 class="text-lg font-semibold text-slate-200 mb-4">ğŸ“‘ PiÃ¨ces du marchÃ©</h3>
            <div class="space-y-3">
              <div class="drop-zone rounded-xl p-4 text-center cursor-pointer hover:border-violet-500" onclick="document.getElementById('fileCCTP').click()" id="dropCCTP">
                <input type="file" id="fileCCTP" class="hidden" accept=".pdf,.doc,.docx" onchange="handleAnalyseFile(this, 'cctp')">
                <span class="text-2xl">ğŸ“„</span>
                <p class="text-xs text-slate-400 mt-1" id="labelCCTP">CCTP (obligatoire)</p>
              </div>
              <div class="drop-zone rounded-xl p-4 text-center cursor-pointer hover:border-violet-500" onclick="document.getElementById('fileDPGF').click()" id="dropDPGF">
                <input type="file" id="fileDPGF" class="hidden" accept=".pdf,.xlsx,.xls" onchange="handleAnalyseFile(this, 'dpgf')">
                <span class="text-2xl">ğŸ“Š</span>
                <p class="text-xs text-slate-400 mt-1" id="labelDPGF">DPGF (obligatoire)</p>
              </div>
            </div>
          </div>
          <div class="card p-6">
            <h3 class="text-lg font-semibold text-slate-200 mb-4">ğŸ“ Devis Ã  comparer (2-5 fichiers)</h3>
            <div class="drop-zone rounded-xl p-6 text-center cursor-pointer hover:border-violet-500" onclick="document.getElementById('fileDevis').click()" id="dropDevis">
              <input type="file" id="fileDevis" class="hidden" accept=".pdf,.xlsx,.xls" multiple onchange="handleAnalyseDevis(this)">
              <span class="text-3xl">ğŸ“</span>
              <p class="text-sm text-slate-400 mt-2">Glissez ou cliquez pour ajouter</p>
            </div>
            <div id="devisFilesList" class="mt-3 space-y-2"></div>
          </div>
        </div>

        <!-- Barre de progression analyse -->
        <div id="analyseProgress" class="card p-4 mb-6 hidden">
          <div class="flex items-center gap-3 mb-2">
            <div class="animate-spin w-5 h-5 border-2 border-violet-500 border-t-transparent rounded-full"></div>
            <span class="text-slate-200" id="analyseProgressText">Analyse en cours...</span>
          </div>
          <div class="progress-bar h-2"><div class="progress-fill bg-violet-500" id="analyseProgressBar" style="width:0%"></div></div>
        </div>

        <div class="flex justify-center gap-4">
          <button onclick="resetAnalyseFiles()" class="px-6 py-4 bg-slate-700 hover:bg-slate-600 rounded-xl text-slate-200 font-medium">ğŸ”„ RÃ©initialiser</button>
          <button onclick="launchAnalyseIA()" class="btn-primary px-8 py-4 rounded-xl text-white font-semibold text-lg">ğŸ¤– Lancer l'analyse IA</button>
        </div>
      </div>
    </div>
  </main>

  <!-- MODALS -->
  <div id="modalProfil" class="modal-overlay" onclick="closeModal('modalProfil')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="p-5 border-b border-slate-700 flex items-center justify-between">
        <h3 class="text-xl font-bold text-white">ğŸ‘¤ Mon Profil</h3>
        <button onclick="closeModal('modalProfil')" class="header-btn">âœ•</button>
      </div>
      <div class="p-6">
        <div class="flex items-center gap-4 mb-6">
          <div class="w-20 h-20 bg-gradient-to-br from-emerald-400 to-cyan-500 rounded-full flex items-center justify-center text-3xl font-bold text-white" id="profilInitiales">JD</div>
          <div>
            <h4 class="text-xl font-semibold text-slate-200" id="profilNom">JÃ©rÃ©mie Durand</h4>
            <p class="text-slate-400" id="profilRole">Administrateur</p>
            <span class="badge badge-danger mt-1" id="profilBadge">ğŸ” Admin</span>
          </div>
        </div>
        
        <!-- Informations du profil -->
        <div class="space-y-3 mb-6">
          <div class="flex justify-between py-2 border-b border-slate-800">
            <span class="text-slate-500">ğŸ“§ Email</span>
            <span class="text-slate-200" id="profilEmail">jeremie@btpconnect.fr</span>
          </div>
          <div class="flex justify-between py-2 border-b border-slate-800">
            <span class="text-slate-500">ğŸ¢ Entreprise</span>
            <span class="text-slate-200" id="profilEntreprise">BTP Excellence SAS</span>
          </div>
          <div class="flex justify-between py-2 border-b border-slate-800">
            <span class="text-slate-500">ğŸ“… Membre depuis</span>
            <span class="text-slate-200">Janvier 2024</span>
          </div>
        </div>
        
        <!-- Droits et permissions -->
        <div class="p-4 bg-slate-800/30 rounded-xl mb-6">
          <h5 class="font-medium text-slate-200 mb-3">ğŸ” Droits et permissions</h5>
          <div class="grid grid-cols-2 gap-2 text-sm">
            <div class="flex items-center gap-2"><span class="text-emerald-400">âœ“</span><span class="text-slate-400">Gestion des chantiers</span></div>
            <div class="flex items-center gap-2"><span class="text-emerald-400">âœ“</span><span class="text-slate-400">Gestion facturation</span></div>
            <div class="flex items-center gap-2"><span class="text-emerald-400">âœ“</span><span class="text-slate-400">Gestion sous-traitants</span></div>
            <div class="flex items-center gap-2"><span class="text-emerald-400">âœ“</span><span class="text-slate-400">Validation situations</span></div>
            <div class="flex items-center gap-2"><span class="text-emerald-400">âœ“</span><span class="text-slate-400">Administration BDD</span></div>
            <div class="flex items-center gap-2"><span class="text-emerald-400">âœ“</span><span class="text-slate-400">Export/Import donnÃ©es</span></div>
          </div>
        </div>
        
        <div class="flex gap-3">
          <button onclick="showTab('parametres'); closeModal('modalProfil')" class="flex-1 btn-primary px-4 py-2 rounded-xl text-white">âš™ï¸ ParamÃ¨tres</button>
          <button onclick="deconnexion()" class="flex-1 px-4 py-2 bg-red-500/20 text-red-400 rounded-xl hover:bg-red-500/30">ğŸšª DÃ©connexion</button>
        </div>
      </div>
    </div>
  </div>

  <div id="modalNotifications" class="modal-overlay" onclick="closeModal('modalNotifications')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="p-5 border-b border-slate-700 flex items-center justify-between">
        <h3 class="text-xl font-bold text-white">ğŸ”” Notifications</h3>
        <button onclick="markAllRead(); closeModal('modalNotifications')" class="text-sm text-violet-400">Marquer comme tous lu</button>
      </div>
      <div class="p-6" id="notificationsList"></div>
    </div>
  </div>

  <div id="modalAide" class="modal-overlay" onclick="closeModal('modalAide')">
    <div class="modal-content" style="max-width: 900px; max-height: 90vh; display: flex; flex-direction: column;" onclick="event.stopPropagation()">
      <div class="p-5 border-b border-slate-800 flex items-center justify-between flex-shrink-0">
        <h3 class="text-xl font-bold text-slate-100">â“ Aide & Tutoriels</h3>
        <button onclick="closeModal('modalAide')" class="p-2 hover:bg-slate-800 rounded-xl">âœ•</button>
      </div>
      <div class="p-6 overflow-y-auto flex-1">
        <!-- Recherche -->
        <div class="mb-6">
          <input type="text" id="searchAide" placeholder="ğŸ” Rechercher dans l'aide..." class="w-full px-4 py-3 bg-slate-800/50 border border-slate-700/50 rounded-xl text-slate-200" oninput="filterAide(this.value)" />
        </div>
        
        <!-- Tutoriels rapides -->
        <h4 class="text-lg font-semibold text-slate-100 mb-4">ğŸ“ Tutoriels rapides</h4>
        <div class="grid grid-cols-2 gap-4 mb-6" id="tutorielsGrid">
          <div class="p-4 bg-slate-800/50 rounded-xl hover:bg-slate-800 cursor-pointer transition-colors" onclick="openTutoriel('demarrer')">
            <span class="text-2xl">ğŸš€</span>
            <h5 class="font-medium text-slate-200 mt-2">DÃ©marrer avec BTP Connect</h5>
            <p class="text-xs text-slate-500 mt-1">5 min â€¢ Niveau dÃ©butant</p>
          </div>
          <div class="p-4 bg-slate-800/50 rounded-xl hover:bg-slate-800 cursor-pointer transition-colors" onclick="openTutoriel('situation')">
            <span class="text-2xl">ğŸ“‹</span>
            <h5 class="font-medium text-slate-200 mt-2">CrÃ©er une situation de travaux</h5>
            <p class="text-xs text-slate-500 mt-1">3 min â€¢ Niveau dÃ©butant</p>
          </div>
          <div class="p-4 bg-slate-800/50 rounded-xl hover:bg-slate-800 cursor-pointer transition-colors" onclick="openTutoriel('soustraitants')">
            <span class="text-2xl">ğŸ‘¥</span>
            <h5 class="font-medium text-slate-200 mt-2">GÃ©rer les sous-traitants</h5>
            <p class="text-xs text-slate-500 mt-1">4 min â€¢ Niveau dÃ©butant</p>
          </div>
          <div class="p-4 bg-slate-800/50 rounded-xl hover:bg-slate-800 cursor-pointer transition-colors" onclick="openTutoriel('facturation')">
            <span class="text-2xl">ğŸ’¶</span>
            <h5 class="font-medium text-slate-200 mt-2">Facturation et encaissements</h5>
            <p class="text-xs text-slate-500 mt-1">6 min â€¢ Niveau intermÃ©diaire</p>
          </div>
        </div>
        
        <!-- FAQ -->
        <h4 class="text-lg font-semibold text-slate-100 mb-4">â“ Questions frÃ©quentes</h4>
        <div class="space-y-3 mb-6" id="faqContainer">
          <details class="p-4 bg-slate-800/50 rounded-xl cursor-pointer group">
            <summary class="font-medium text-slate-200 flex items-center justify-between">
              Comment ajouter un sous-traitant ?
              <span class="text-slate-500 group-open:rotate-180 transition-transform">â–¼</span>
            </summary>
            <p class="text-slate-400 text-sm mt-3">Allez dans l'onglet <strong>Annuaire</strong>, puis cliquez sur <strong>"Ajouter manuellement"</strong> ou recherchez dans l'annuaire SIRENE pour importer automatiquement les informations de l'entreprise via l'API Gouvernement.</p>
          </details>
          <details class="p-4 bg-slate-800/50 rounded-xl cursor-pointer group">
            <summary class="font-medium text-slate-200 flex items-center justify-between">
              Comment valider une situation ?
              <span class="text-slate-500 group-open:rotate-180 transition-transform">â–¼</span>
            </summary>
            <p class="text-slate-400 text-sm mt-3">Dans l'onglet <strong>Situations</strong>, trouvez la situation en attente et cliquez sur <strong>"âœ“ Valider"</strong>. Vous pouvez aussi la refuser avec un motif en cliquant sur <strong>"âœ• Refuser"</strong>.</p>
          </details>
          <details class="p-4 bg-slate-800/50 rounded-xl cursor-pointer group">
            <summary class="font-medium text-slate-200 flex items-center justify-between">
              Qu'est-ce que le Flux 1 et Flux 2 ?
              <span class="text-slate-500 group-open:rotate-180 transition-transform">â–¼</span>
            </summary>
            <p class="text-slate-400 text-sm mt-3">
              <strong>ğŸ“¥ Flux 1 (ST â†’ Entreprise)</strong> : Situations envoyÃ©es par vos sous-traitants vers vous.<br/>
              <strong>ğŸ“¤ Flux 2 (Entreprise â†’ Client)</strong> : Situations que vous envoyez Ã  vos clients (maÃ®tres d'ouvrage).
            </p>
          </details>
          <details class="p-4 bg-slate-800/50 rounded-xl cursor-pointer group">
            <summary class="font-medium text-slate-200 flex items-center justify-between">
              Comment connecter un logiciel de facturation ?
              <span class="text-slate-500 group-open:rotate-180 transition-transform">â–¼</span>
            </summary>
            <p class="text-slate-400 text-sm mt-3">Allez dans <strong>ParamÃ¨tres â†’ IntÃ©grations</strong>, et cliquez sur <strong>"Connecter"</strong> Ã  cÃ´tÃ© du logiciel souhaitÃ© (Quick Devis, Optima). Suivez les instructions pour autoriser la connexion.</p>
          </details>
          <details class="p-4 bg-slate-800/50 rounded-xl cursor-pointer group">
            <summary class="font-medium text-slate-200 flex items-center justify-between">
              Comment gÃ©rer les documents des sous-traitants ?
              <span class="text-slate-500 group-open:rotate-180 transition-transform">â–¼</span>
            </summary>
            <p class="text-slate-400 text-sm mt-3">Dans l'onglet <strong>Documents</strong>, vous pouvez voir tous les documents obligatoires regroupÃ©s par sous-traitant. Les documents expirÃ©s ou rejetÃ©s sont mis en Ã©vidence. Vous pouvez envoyer un lien de portail Ã  vos ST pour qu'ils dÃ©posent leurs documents directement.</p>
          </details>
        </div>
        
        <!-- Contact support -->
        <div class="p-4 bg-violet-500/10 border border-violet-500/30 rounded-xl">
          <h5 class="font-medium text-violet-400 mb-2">ğŸ†˜ Besoin d'aide supplÃ©mentaire ?</h5>
          <p class="text-slate-400 text-sm mb-3">Notre Ã©quipe support est disponible du lundi au vendredi, 9h-18h.</p>
          <div class="flex gap-3 flex-wrap">
            <button onclick="openModal('modalContactSupport')" class="px-4 py-2 bg-violet-600 hover:bg-violet-500 rounded-lg text-white text-sm">ğŸ“§ Contacter le support</button>
            <button onclick="openLiveChat()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-slate-200 text-sm">ğŸ’¬ Chat en direct</button>
            <a href="mailto:support@btpconnect.fr" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-slate-200 text-sm">âœ‰ï¸ support@btpconnect.fr</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Tutoriel -->
  <div id="modalTutoriel" class="modal-overlay" onclick="closeModal('modalTutoriel')">
    <div class="modal-content modal-large" style="max-height: 90vh; display: flex; flex-direction: column;" onclick="event.stopPropagation()">
      <div class="p-5 border-b border-slate-800 flex items-center justify-between flex-shrink-0">
        <h3 class="text-xl font-bold text-slate-100" id="tutorielTitle">ğŸ“ Tutoriel</h3>
        <button onclick="closeModal('modalTutoriel')" class="p-2 hover:bg-slate-800 rounded-xl">âœ•</button>
      </div>
      <div class="p-6 overflow-y-auto flex-1" id="tutorielContent"></div>
    </div>
  </div>

  <!-- Modal Contact Support -->
  <div id="modalContactSupport" class="modal-overlay" onclick="closeModal('modalContactSupport')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="p-5 border-b border-slate-800 flex items-center justify-between">
        <h3 class="text-xl font-bold text-slate-100">ğŸ“§ Contacter le support</h3>
        <button onclick="closeModal('modalContactSupport')" class="p-2 hover:bg-slate-800 rounded-xl">âœ•</button>
      </div>
      <div class="p-6 space-y-4">
        <div>
          <label class="block text-sm text-slate-400 mb-2">Sujet *</label>
          <select id="supportSubject" class="w-full">
            <option value="">SÃ©lectionner un sujet...</option>
            <option value="technique">ProblÃ¨me technique</option>
            <option value="facturation">Question facturation</option>
            <option value="abonnement">Abonnement</option>
            <option value="autre">Autre</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-slate-400 mb-2">Message *</label>
          <textarea id="supportMessage" rows="5" placeholder="DÃ©crivez votre problÃ¨me ou question..." class="w-full"></textarea>
        </div>
        <div class="flex gap-3">
          <button onclick="closeModal('modalContactSupport')" class="flex-1 px-4 py-2 bg-slate-700 rounded-xl text-slate-200">Annuler</button>
          <button onclick="envoyerSupport()" class="flex-1 btn-primary px-4 py-2 rounded-xl text-white">ğŸ“¨ Envoyer</button>
        </div>
      </div>
    </div>
  </div>

  <div id="modalAddST" class="modal-overlay" onclick="closeModal('modalAddST')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="p-5 border-b border-slate-700 flex items-center justify-between">
        <h3 class="text-xl font-bold text-white">+ Ajouter un sous-traitant</h3>
        <button onclick="closeModal('modalAddST')" class="header-btn">âœ•</button>
      </div>
      <div class="p-6 space-y-4">
        <div><label class="block text-sm text-slate-400 mb-2">Nom *</label><input type="text" id="newSTNom" placeholder="Nom de l'entreprise"></div>
        <div class="grid grid-cols-2 gap-4">
          <div><label class="block text-sm text-slate-400 mb-2">SIRET</label><input type="text" id="newSTSiret"></div>
          <div><label class="block text-sm text-slate-400 mb-2">MÃ©tier *</label>
            <select id="newSTMetier"><option value="">SÃ©lectionner...</option><option value="Ã‰lectricitÃ©">Ã‰lectricitÃ©</option><option value="Plomberie">Plomberie</option><option value="CVC">CVC</option><option value="MaÃ§onnerie">MaÃ§onnerie</option><option value="Peinture">Peinture</option></select>
          </div>
        </div>
        <div><label class="block text-sm text-slate-400 mb-2">Email</label><input type="email" id="newSTEmail" placeholder="contact@entreprise.fr"></div>
        <div><label class="block text-sm text-slate-400 mb-2">Ville</label><input type="text" id="newSTVille" placeholder="Paris"></div>
        <div class="flex gap-3 mt-6">
          <button onclick="closeModal('modalAddST')" class="flex-1 px-4 py-2 bg-slate-700 rounded-xl text-slate-200">Annuler</button>
          <button onclick="addST()" class="flex-1 btn-primary px-4 py-2 rounded-xl text-white">Ajouter</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Edition ST (annuaire privÃ© uniquement) -->
  <div id="modalEditST" class="modal-overlay" onclick="closeModal('modalEditST')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="p-5 border-b border-slate-700 flex items-center justify-between">
        <h3 class="text-xl font-bold text-white">âœï¸ Modifier le sous-traitant</h3>
        <button onclick="closeModal('modalEditST')" class="header-btn">âœ•</button>
      </div>
      <div class="p-6 space-y-4">
        <input type="hidden" id="editSTId">
        <div><label class="block text-sm text-slate-400 mb-2">Nom *</label><input type="text" id="editSTNom" placeholder="Nom de l'entreprise"></div>
        <div class="grid grid-cols-2 gap-4">
          <div><label class="block text-sm text-slate-400 mb-2">SIRET</label><input type="text" id="editSTSiret"></div>
          <div><label class="block text-sm text-slate-400 mb-2">MÃ©tier *</label>
            <select id="editSTMetier"><option value="">SÃ©lectionner...</option><option value="Ã‰lectricitÃ©">Ã‰lectricitÃ©</option><option value="Plomberie">Plomberie</option><option value="CVC">CVC</option><option value="MaÃ§onnerie">MaÃ§onnerie</option><option value="Peinture">Peinture</option><option value="Menuiserie">Menuiserie</option><option value="Carrelage">Carrelage</option></select>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div><label class="block text-sm text-slate-400 mb-2">Email</label><input type="email" id="editSTEmail"></div>
          <div><label class="block text-sm text-slate-400 mb-2">TÃ©lÃ©phone</label><input type="text" id="editSTTel"></div>
        </div>
        <div><label class="block text-sm text-slate-400 mb-2">Ville</label><input type="text" id="editSTVille"></div>
        <div><label class="block text-sm text-slate-400 mb-2">Note (1-5)</label><input type="number" id="editSTNote" min="1" max="5" step="0.5"></div>
        <div class="flex gap-3 mt-6">
          <button onclick="closeModal('modalEditST')" class="flex-1 px-4 py-2 bg-slate-700 rounded-xl text-slate-200">Annuler</button>
          <button onclick="deleteST()" class="px-4 py-2 bg-red-600 hover:bg-red-500 rounded-xl text-white">ğŸ—‘ï¸</button>
          <button onclick="saveST()" class="flex-1 btn-primary px-4 py-2 rounded-xl text-white">ğŸ’¾ Enregistrer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Ajout Contrat ST -->
  <div id="modalAddContrat" class="modal-overlay" onclick="closeModal('modalAddContrat')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="p-5 border-b border-slate-700 flex items-center justify-between">
        <h3 class="text-xl font-bold text-white">â• Ajouter un contrat sous-traitant</h3>
        <button onclick="closeModal('modalAddContrat')" class="header-btn">âœ•</button>
      </div>
      <div class="p-6 space-y-4">
        <input type="hidden" id="contratChantierId">
        <div id="contratChantierInfo" class="p-3 bg-slate-800/50 rounded-xl mb-4"></div>
        <div><label class="block text-sm text-slate-400 mb-2">Sous-traitant *</label>
          <select id="contratSTSelect" class="w-full"></select>
        </div>
        <div><label class="block text-sm text-slate-400 mb-2">Lot *</label>
          <select id="contratLot"><option value="">SÃ©lectionner...</option><option value="Ã‰lectricitÃ© CFO/CFA">Ã‰lectricitÃ© CFO/CFA</option><option value="Plomberie">Plomberie</option><option value="CVC Climatisation">CVC Climatisation</option><option value="Peinture">Peinture</option><option value="Menuiserie">Menuiserie</option><option value="Carrelage">Carrelage</option><option value="MaÃ§onnerie">MaÃ§onnerie</option></select>
        </div>
        <div><label class="block text-sm text-slate-400 mb-2">Montant marchÃ© HT *</label><input type="number" id="contratMontant" placeholder="0"></div>
        <div class="flex gap-3 mt-6">
          <button onclick="closeModal('modalAddContrat')" class="flex-1 px-4 py-2 bg-slate-700 rounded-xl text-slate-200">Annuler</button>
          <button onclick="saveContrat()" class="flex-1 btn-primary px-4 py-2 rounded-xl text-white">CrÃ©er le contrat</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Modification Chantier -->
  <div id="modalEditChantier" class="modal-overlay" onclick="closeModal('modalEditChantier')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="p-5 border-b border-slate-700 flex items-center justify-between">
        <h3 class="text-xl font-bold text-white">âœï¸ Modifier le chantier</h3>
        <button onclick="closeModal('modalEditChantier')" class="header-btn">âœ•</button>
      </div>
      <div class="p-6 space-y-4">
        <input type="hidden" id="editChantierId">
        <div><label class="block text-sm text-slate-400 mb-2">Nom *</label><input type="text" id="editChantierNom"></div>
        <div><label class="block text-sm text-slate-400 mb-2">Adresse</label><input type="text" id="editChantierAdresse"></div>
        <div class="grid grid-cols-2 gap-4">
          <div><label class="block text-sm text-slate-400 mb-2">Client</label><input type="text" id="editChantierClient"></div>
          <div><label class="block text-sm text-slate-400 mb-2">Montant HT</label><input type="number" id="editChantierMontant"></div>
        </div>
        <div><label class="block text-sm text-slate-400 mb-2">Statut</label>
          <select id="editChantierStatut">
            <option value="en_cours">ğŸŸ¢ En cours</option>
            <option value="termine">âœ… TerminÃ©</option>
            <option value="suspendu">â¸ï¸ Suspendu</option>
          </select>
        </div>
        <div class="flex gap-3 mt-6">
          <button onclick="closeModal('modalEditChantier')" class="flex-1 px-4 py-2 bg-slate-700 rounded-xl text-slate-200">Annuler</button>
          <button onclick="saveChantier()" class="flex-1 btn-primary px-4 py-2 rounded-xl text-white">ğŸ’¾ Enregistrer</button>
        </div>
      </div>
    </div>
  </div>

  <div id="modalNewChantier" class="modal-overlay" onclick="closeModal('modalNewChantier')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="p-5 border-b border-slate-700 flex items-center justify-between">
        <h3 class="text-xl font-bold text-white">+ Nouveau chantier</h3>
        <button onclick="closeModal('modalNewChantier')" class="header-btn">âœ•</button>
      </div>
      <div class="p-6 space-y-4">
        <div><label class="block text-sm text-slate-400 mb-2">Nom *</label><input type="text" id="newChantierNom" placeholder="Nom du chantier"></div>
        <div><label class="block text-sm text-slate-400 mb-2">Adresse</label><input type="text" id="newChantierAdresse"></div>
        <div class="grid grid-cols-2 gap-4">
          <div><label class="block text-sm text-slate-400 mb-2">Client</label><input type="text" id="newChantierClient"></div>
          <div><label class="block text-sm text-slate-400 mb-2">Montant HT</label><input type="number" id="newChantierMontant"></div>
        </div>
        <div class="flex gap-3 mt-6">
          <button onclick="closeModal('modalNewChantier')" class="flex-1 px-4 py-2 bg-slate-700 rounded-xl text-slate-200">Annuler</button>
          <button onclick="addChantier()" class="flex-1 btn-primary px-4 py-2 rounded-xl text-white">CrÃ©er</button>
        </div>
      </div>
    </div>
  </div>

  <div id="modalDetailST" class="modal-overlay" onclick="closeModal('modalDetailST')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="p-5 border-b border-slate-700 flex items-center justify-between">
        <h3 class="text-xl font-bold text-white" id="modalSTTitle">DÃ©tail ST</h3>
        <button onclick="closeModal('modalDetailST')" class="header-btn">âœ•</button>
      </div>
      <div class="p-6" id="modalSTContent"></div>
    </div>
  </div>

  <div id="modalDetailChantier" class="modal-overlay" onclick="closeModal('modalDetailChantier')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="p-5 border-b border-slate-700 flex items-center justify-between">
        <h3 class="text-xl font-bold text-white" id="modalChantierTitle">DÃ©tail Chantier</h3>
        <button onclick="closeModal('modalDetailChantier')" class="header-btn">âœ•</button>
      </div>
      <div class="p-6" id="modalChantierContent"></div>
    </div>
  </div>

  <div id="modalDetailSituation" class="modal-overlay" onclick="closeModal('modalDetailSituation')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="p-5 border-b border-slate-700 flex items-center justify-between">
        <h3 class="text-xl font-bold text-white" id="modalSituTitle">DÃ©tail Situation</h3>
        <button onclick="closeModal('modalDetailSituation')" class="header-btn">âœ•</button>
      </div>
      <div class="p-6" id="modalSituContent"></div>
    </div>
  </div>

  <!-- Stats modals -->
  <div id="modalStatsAnnuaire" class="modal-overlay" onclick="closeModal('modalStatsAnnuaire')">
    <div class="modal-content" style="max-width: 700px;" onclick="event.stopPropagation()">
      <div class="p-5 border-b border-slate-700 flex items-center justify-between">
        <h3 class="text-xl font-bold text-white">ğŸ“Š Statistiques Annuaire</h3>
        <button onclick="closeModal('modalStatsAnnuaire')" class="header-btn">âœ•</button>
      </div>
      <div class="p-6" id="statsAnnuaireContent"></div>
    </div>
  </div>

  <div id="modalStatsChantiers" class="modal-overlay" onclick="closeModal('modalStatsChantiers')">
    <div class="modal-content" style="max-width: 700px;" onclick="event.stopPropagation()">
      <div class="p-5 border-b border-slate-700 flex items-center justify-between">
        <h3 class="text-xl font-bold text-white">ğŸ“Š Statistiques Chantiers</h3>
        <button onclick="closeModal('modalStatsChantiers')" class="header-btn">âœ•</button>
      </div>
      <div class="p-6" id="statsChantiersContent"></div>
    </div>
  </div>

  <div id="modalStatsSituations" class="modal-overlay" onclick="closeModal('modalStatsSituations')">
    <div class="modal-content" style="max-width: 700px;" onclick="event.stopPropagation()">
      <div class="p-5 border-b border-slate-700 flex items-center justify-between">
        <h3 class="text-xl font-bold text-white">ğŸ“Š Statistiques Situations</h3>
        <button onclick="closeModal('modalStatsSituations')" class="header-btn">âœ•</button>
      </div>
      <div class="p-6" id="statsSituationsContent"></div>
    </div>
  </div>

  <div id="modalStatsFacturation" class="modal-overlay" onclick="closeModal('modalStatsFacturation')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="p-5 border-b border-slate-700"><h3 class="text-xl font-bold text-white">ğŸ“Š Stats Facturation</h3></div>
      <div class="p-6" id="statsFacturationContent"></div>
    </div>
  </div>

  <div id="modalStatsDocuments" class="modal-overlay" onclick="closeModal('modalStatsDocuments')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="p-5 border-b border-slate-700"><h3 class="text-xl font-bold text-white">ğŸ“Š Stats Documents</h3></div>
      <div class="p-6" id="statsDocumentsContent"></div>
    </div>
  </div>

  <div id="modalDemandeDoc" class="modal-overlay" onclick="closeModal('modalDemandeDoc')">
    <div class="modal-content" style="max-width: 550px;" onclick="event.stopPropagation()">
      <div class="p-5 border-b border-slate-700 flex items-center justify-between">
        <h3 class="text-xl font-bold text-white">ğŸ“¨ Demander documents</h3>
        <button onclick="closeModal('modalDemandeDoc')" class="header-btn">âœ•</button>
      </div>
      <div class="p-6">
        <div class="mb-4">
          <label class="block text-sm text-slate-400 mb-2">Sous-traitant *</label>
          <select id="demandeDocST" class="w-full"></select>
        </div>
        <div class="mb-4">
          <label class="block text-sm text-slate-400 mb-3">Documents Ã  demander</label>
          <div class="grid grid-cols-2 gap-3">
            <label class="flex items-center gap-3 p-3 bg-slate-800/30 rounded-lg cursor-pointer hover:bg-slate-700/30">
              <input type="checkbox" id="docKbis" checked class="w-4 h-4 rounded">
              <span class="text-slate-300">ğŸ“‹ Kbis</span>
            </label>
            <label class="flex items-center gap-3 p-3 bg-slate-800/30 rounded-lg cursor-pointer hover:bg-slate-700/30">
              <input type="checkbox" id="docURSSAF" checked class="w-4 h-4 rounded">
              <span class="text-slate-300">ğŸ›ï¸ URSSAF</span>
            </label>
            <label class="flex items-center gap-3 p-3 bg-slate-800/30 rounded-lg cursor-pointer hover:bg-slate-700/30">
              <input type="checkbox" id="docRCPro" class="w-4 h-4 rounded">
              <span class="text-slate-300">ğŸ›¡ï¸ RC Pro</span>
            </label>
            <label class="flex items-center gap-3 p-3 bg-slate-800/30 rounded-lg cursor-pointer hover:bg-slate-700/30">
              <input type="checkbox" id="docDecennale" class="w-4 h-4 rounded">
              <span class="text-slate-300">ğŸ—ï¸ DÃ©cennale</span>
            </label>
            <label class="flex items-center gap-3 p-3 bg-slate-800/30 rounded-lg cursor-pointer hover:bg-slate-700/30">
              <input type="checkbox" id="docVigilance" class="w-4 h-4 rounded">
              <span class="text-slate-300">ğŸ“„ Vigilance</span>
            </label>
            <label class="flex items-center gap-3 p-3 bg-slate-800/30 rounded-lg cursor-pointer hover:bg-slate-700/30">
              <input type="checkbox" id="docFiscale" class="w-4 h-4 rounded">
              <span class="text-slate-300">ğŸ’¼ Att. fiscale</span>
            </label>
          </div>
        </div>
        <div class="mb-4">
          <label class="block text-sm text-slate-400 mb-2">Message personnalisÃ© (optionnel)</label>
          <textarea id="demandeDocMessage" rows="3" placeholder="Ajoutez un message pour le sous-traitant..." class="w-full"></textarea>
        </div>
        <div class="mb-4">
          <label class="block text-sm text-slate-400 mb-2">Date limite de rÃ©ponse</label>
          <input type="date" id="demandeDocDate" class="w-full">
        </div>
        <div class="p-3 bg-blue-500/10 border border-blue-500/30 rounded-xl mb-4">
          <p class="text-blue-300 text-sm">ğŸ“§ Un email sera envoyÃ© automatiquement au sous-traitant avec un lien vers le portail de dÃ©pÃ´t.</p>
        </div>
        <div class="flex gap-3">
          <button onclick="closeModal('modalDemandeDoc')" class="flex-1 px-4 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl text-slate-200">Annuler</button>
          <button onclick="envoyerDemandeDoc()" class="flex-1 btn-primary px-4 py-3 rounded-xl text-white font-medium">ğŸ“§ Envoyer la demande</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal CGU -->
  <div id="modalCGU" class="modal-overlay" onclick="closeModal('modalCGU')">
    <div class="modal-content modal-large" style="max-height: 90vh; display: flex; flex-direction: column;" onclick="event.stopPropagation()">
      <div class="p-5 border-b border-slate-800 flex items-center justify-between flex-shrink-0">
        <h3 class="text-xl font-bold text-slate-100">ğŸ“‹ Conditions GÃ©nÃ©rales d'Utilisation</h3>
        <button onclick="closeModal('modalCGU')" class="p-2 hover:bg-slate-800 rounded-xl">âœ•</button>
      </div>
      <div class="p-6 overflow-y-auto flex-1 text-slate-300 text-sm space-y-4">
        <p class="text-slate-400">DerniÃ¨re mise Ã  jour : 1er janvier 2026</p>
        <h4 class="text-lg font-semibold text-white">1. Objet</h4>
        <p>Les prÃ©sentes Conditions GÃ©nÃ©rales d'Utilisation (CGU) ont pour objet de dÃ©finir les modalitÃ©s et conditions d'utilisation de la plateforme BTP Connect, ainsi que de dÃ©finir les droits et obligations des parties dans ce cadre.</p>
        <h4 class="text-lg font-semibold text-white">2. Acceptation des CGU</h4>
        <p>L'utilisation de BTP Connect implique l'acceptation pleine et entiÃ¨re des prÃ©sentes CGU. En cas de non-acceptation, l'utilisateur doit renoncer Ã  accÃ©der aux services.</p>
        <h4 class="text-lg font-semibold text-white">3. Description des services</h4>
        <p>BTP Connect propose une plateforme collaborative pour la gestion des sous-traitants, des situations de travaux, et des documents dans le secteur du BTP. Les fonctionnalitÃ©s incluent : gestion des contrats, validation des situations, suivi documentaire avec IA, et intÃ©grations avec logiciels mÃ©tier.</p>
        <h4 class="text-lg font-semibold text-white">4. Inscription et compte</h4>
        <p>L'accÃ¨s Ã  certains services nÃ©cessite une inscription prÃ©alable. L'utilisateur s'engage Ã  fournir des informations exactes et Ã  les maintenir Ã  jour. Il est responsable de la confidentialitÃ© de ses identifiants.</p>
        <h4 class="text-lg font-semibold text-white">5. ResponsabilitÃ©s</h4>
        <p>BTP Connect met tout en Å“uvre pour assurer la disponibilitÃ© et la sÃ©curitÃ© de la plateforme. Cependant, BTP Connect ne peut Ãªtre tenu responsable des dommages directs ou indirects rÃ©sultant de l'utilisation ou de l'impossibilitÃ© d'utiliser les services.</p>
        <h4 class="text-lg font-semibold text-white">6. PropriÃ©tÃ© intellectuelle</h4>
        <p>L'ensemble des Ã©lÃ©ments de BTP Connect (textes, graphiques, logos, icÃ´nes, logiciels) sont protÃ©gÃ©s par le droit de la propriÃ©tÃ© intellectuelle. Toute reproduction non autorisÃ©e est interdite.</p>
        <h4 class="text-lg font-semibold text-white">7. DonnÃ©es personnelles</h4>
        <p>Le traitement des donnÃ©es personnelles est effectuÃ© conformÃ©ment Ã  notre Politique de confidentialitÃ© et au RGPD.</p>
        <h4 class="text-lg font-semibold text-white">8. RÃ©siliation</h4>
        <p>L'utilisateur peut rÃ©silier son compte Ã  tout moment. BTP Connect se rÃ©serve le droit de suspendre ou supprimer un compte en cas de non-respect des CGU.</p>
        <h4 class="text-lg font-semibold text-white">9. Droit applicable</h4>
        <p>Les prÃ©sentes CGU sont soumises au droit franÃ§ais. Tout litige sera de la compÃ©tence exclusive des tribunaux de Paris.</p>
        <div class="mt-6 p-4 bg-slate-800/50 rounded-xl">
          <p class="text-slate-400">Pour toute question concernant ces CGU, contactez-nous Ã  <a href="mailto:legal@btpconnect.fr" class="text-violet-400">legal@btpconnect.fr</a></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Politique de confidentialitÃ© -->
  <div id="modalConfidentialite" class="modal-overlay" onclick="closeModal('modalConfidentialite')">
    <div class="modal-content modal-large" style="max-height: 90vh; display: flex; flex-direction: column;" onclick="event.stopPropagation()">
      <div class="p-5 border-b border-slate-800 flex items-center justify-between flex-shrink-0">
        <h3 class="text-xl font-bold text-slate-100">ğŸ”’ Politique de ConfidentialitÃ©</h3>
        <button onclick="closeModal('modalConfidentialite')" class="p-2 hover:bg-slate-800 rounded-xl">âœ•</button>
      </div>
      <div class="p-6 overflow-y-auto flex-1 text-slate-300 text-sm space-y-4">
        <p class="text-slate-400">DerniÃ¨re mise Ã  jour : 1er janvier 2026</p>
        <h4 class="text-lg font-semibold text-white">1. Responsable du traitement</h4>
        <p>BTP Connect SAS, immatriculÃ©e au RCS de Paris sous le numÃ©ro 123 456 789, dont le siÃ¨ge social est situÃ© 15 rue de la Construction, 75001 Paris.</p>
        <h4 class="text-lg font-semibold text-white">2. DonnÃ©es collectÃ©es</h4>
        <p>Nous collectons les donnÃ©es suivantes : donnÃ©es d'identification (nom, prÃ©nom, email), donnÃ©es professionnelles (SIRET, fonction), donnÃ©es de connexion, et donnÃ©es relatives Ã  l'utilisation de nos services.</p>
        <h4 class="text-lg font-semibold text-white">3. FinalitÃ©s du traitement</h4>
        <p>Vos donnÃ©es sont utilisÃ©es pour : fournir et amÃ©liorer nos services, gÃ©rer votre compte, communiquer avec vous, assurer la sÃ©curitÃ© de la plateforme, et respecter nos obligations lÃ©gales.</p>
        <h4 class="text-lg font-semibold text-white">4. Base lÃ©gale</h4>
        <p>Les traitements sont fondÃ©s sur : l'exÃ©cution du contrat, notre intÃ©rÃªt lÃ©gitime, le respect d'obligations lÃ©gales, et votre consentement lorsque requis.</p>
        <h4 class="text-lg font-semibold text-white">5. DurÃ©e de conservation</h4>
        <p>Les donnÃ©es sont conservÃ©es pendant la durÃ©e de la relation contractuelle, puis archivÃ©es conformÃ©ment aux dÃ©lais lÃ©gaux de prescription.</p>
        <h4 class="text-lg font-semibold text-white">6. Vos droits</h4>
        <p>ConformÃ©ment au RGPD, vous disposez des droits d'accÃ¨s, de rectification, d'effacement, de limitation, de portabilitÃ© et d'opposition. Pour exercer ces droits : <a href="mailto:dpo@btpconnect.fr" class="text-violet-400">dpo@btpconnect.fr</a></p>
        <h4 class="text-lg font-semibold text-white">7. SÃ©curitÃ©</h4>
        <p>Nous mettons en Å“uvre des mesures techniques et organisationnelles appropriÃ©es pour protÃ©ger vos donnÃ©es : chiffrement, contrÃ´le d'accÃ¨s, sauvegardes rÃ©guliÃ¨res.</p>
        <h4 class="text-lg font-semibold text-white">8. Transferts internationaux</h4>
        <p>Vos donnÃ©es sont hÃ©bergÃ©es en France/UE. En cas de transfert hors UE, des garanties appropriÃ©es sont mises en place.</p>
      </div>
    </div>
  </div>

  <!-- Modal Cookies -->
  <div id="modalCookies" class="modal-overlay" onclick="closeModal('modalCookies')">
    <div class="modal-content" style="max-width: 700px; max-height: 90vh; display: flex; flex-direction: column;" onclick="event.stopPropagation()">
      <div class="p-5 border-b border-slate-800 flex items-center justify-between flex-shrink-0">
        <h3 class="text-xl font-bold text-slate-100">ğŸª Politique des Cookies</h3>
        <button onclick="closeModal('modalCookies')" class="p-2 hover:bg-slate-800 rounded-xl">âœ•</button>
      </div>
      <div class="p-6 overflow-y-auto flex-1 text-slate-300 text-sm space-y-4">
        <p>BTP Connect utilise des cookies pour amÃ©liorer votre expÃ©rience. Un cookie est un petit fichier texte dÃ©posÃ© sur votre terminal.</p>
        <h4 class="text-lg font-semibold text-white">Types de cookies utilisÃ©s</h4>
        <div class="space-y-3">
          <div class="p-4 bg-slate-800/50 rounded-xl">
            <div class="flex items-center justify-between mb-2">
              <span class="font-medium text-emerald-400">âœ“ Cookies essentiels</span>
              <span class="text-xs text-slate-500">Obligatoires</span>
            </div>
            <p class="text-slate-400 text-xs">NÃ©cessaires au fonctionnement du site (authentification, prÃ©fÃ©rences de session).</p>
          </div>
          <div class="p-4 bg-slate-800/50 rounded-xl">
            <div class="flex items-center justify-between mb-2">
              <span class="font-medium text-sky-400">ğŸ“Š Cookies analytiques</span>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="cookieAnalytics" checked class="sr-only peer">
                <div class="w-11 h-6 bg-slate-700 peer-focus:ring-2 peer-focus:ring-violet-500 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-violet-600"></div>
              </label>
            </div>
            <p class="text-slate-400 text-xs">Nous aident Ã  comprendre comment vous utilisez le site.</p>
          </div>
          <div class="p-4 bg-slate-800/50 rounded-xl">
            <div class="flex items-center justify-between mb-2">
              <span class="font-medium text-amber-400">ğŸ¯ Cookies marketing</span>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="cookieMarketing" class="sr-only peer">
                <div class="w-11 h-6 bg-slate-700 peer-focus:ring-2 peer-focus:ring-violet-500 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-violet-600"></div>
              </label>
            </div>
            <p class="text-slate-400 text-xs">UtilisÃ©s pour afficher des publicitÃ©s pertinentes.</p>
          </div>
        </div>
        <div class="flex gap-3 mt-6">
          <button onclick="saveCookiePreferences(); closeModal('modalCookies')" class="flex-1 btn-primary px-4 py-2 rounded-xl text-white">Enregistrer mes prÃ©fÃ©rences</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Mentions lÃ©gales -->
  <div id="modalMentionsLegales" class="modal-overlay" onclick="closeModal('modalMentionsLegales')">
    <div class="modal-content modal-large" style="max-height: 90vh; display: flex; flex-direction: column;" onclick="event.stopPropagation()">
      <div class="p-5 border-b border-slate-800 flex items-center justify-between flex-shrink-0">
        <h3 class="text-xl font-bold text-slate-100">âš–ï¸ Mentions LÃ©gales</h3>
        <button onclick="closeModal('modalMentionsLegales')" class="p-2 hover:bg-slate-800 rounded-xl">âœ•</button>
      </div>
      <div class="p-6 overflow-y-auto flex-1 text-slate-300 text-sm space-y-4">
        <h4 class="text-lg font-semibold text-white">Ã‰diteur du site</h4>
        <p><strong>BTP Connect SAS</strong><br>
        Capital social : 50 000 â‚¬<br>
        RCS Paris : 123 456 789<br>
        SiÃ¨ge social : 15 rue de la Construction, 75001 Paris<br>
        NÂ° TVA : FR 12 345678901<br>
        TÃ©lÃ©phone : 01 23 45 67 89<br>
        Email : <a href="mailto:contact@btpconnect.fr" class="text-violet-400">contact@btpconnect.fr</a></p>
        
        <h4 class="text-lg font-semibold text-white">Directeur de la publication</h4>
        <p>JÃ©rÃ©mie Durand, PrÃ©sident</p>
        
        <h4 class="text-lg font-semibold text-white">HÃ©bergeur</h4>
        <p><strong>OVH SAS</strong><br>
        2 rue Kellermann, 59100 Roubaix<br>
        RCS Lille MÃ©tropole : 424 761 419</p>
        
        <h4 class="text-lg font-semibold text-white">PropriÃ©tÃ© intellectuelle</h4>
        <p>L'ensemble du contenu de ce site (textes, images, vidÃ©os, graphismes, logo, icÃ´nes, logiciels...) est la propriÃ©tÃ© exclusive de BTP Connect SAS ou de ses partenaires. Toute reproduction, reprÃ©sentation, modification, publication, transmission, dÃ©naturation, totale ou partielle du site ou de son contenu, par quelque procÃ©dÃ© que ce soit, et sur quelque support que ce soit est interdite sans autorisation Ã©crite prÃ©alable.</p>
        
        <h4 class="text-lg font-semibold text-white">CrÃ©dits</h4>
        <p>Design et dÃ©veloppement : BTP Connect SAS<br>
        IcÃ´nes : Emoji standards</p>
      </div>
    </div>
  </div>

  <!-- Modal Paiement -->
  <div id="modalPaiement" class="modal-overlay" onclick="closeModal('modalPaiement')">
    <div class="modal-content" style="max-width: 550px;" onclick="event.stopPropagation()">
      <div class="p-5 border-b border-slate-800 flex items-center justify-between">
        <h3 class="text-xl font-bold text-slate-100">ğŸ’³ Paiement sÃ©curisÃ©</h3>
        <button onclick="closeModal('modalPaiement')" class="p-2 hover:bg-slate-800 rounded-xl">âœ•</button>
      </div>
      <div class="p-6">
        <div class="mb-6 p-4 bg-slate-800/50 rounded-xl">
          <div class="flex items-center justify-between mb-2">
            <span class="text-slate-400">Plan sÃ©lectionnÃ©</span>
            <span class="font-semibold text-white" id="paiementPlanNom">Enterprise</span>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-slate-400">Montant mensuel</span>
            <span class="font-bold text-2xl text-emerald-400" id="paiementMontant">99â‚¬</span>
          </div>
        </div>
        
        <div class="space-y-4">
          <div>
            <label class="block text-sm text-slate-400 mb-2">NumÃ©ro de carte</label>
            <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19" oninput="formatCardNumber(this)" class="w-full">
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-slate-400 mb-2">Date d'expiration</label>
              <input type="text" id="cardExpiry" placeholder="MM/AA" maxlength="5" oninput="formatExpiry(this)" class="w-full">
            </div>
            <div>
              <label class="block text-sm text-slate-400 mb-2">CVV</label>
              <input type="text" id="cardCVV" placeholder="123" maxlength="3" class="w-full">
            </div>
          </div>
          <div>
            <label class="block text-sm text-slate-400 mb-2">Nom sur la carte</label>
            <input type="text" id="cardName" placeholder="JEAN DUPONT" class="w-full uppercase">
          </div>
        </div>
        
        <div class="mt-6 p-3 bg-emerald-500/10 border border-emerald-500/30 rounded-xl flex items-center gap-3">
          <span class="text-2xl">ğŸ”’</span>
          <p class="text-emerald-400 text-sm">Paiement sÃ©curisÃ© par SSL. Vos donnÃ©es bancaires ne sont jamais stockÃ©es.</p>
        </div>
        
        <div class="flex gap-3 mt-6">
          <button onclick="closeModal('modalPaiement')" class="flex-1 px-4 py-3 bg-slate-700 rounded-xl text-slate-200">Annuler</button>
          <button onclick="processerPaiement()" class="flex-1 btn-primary px-4 py-3 rounded-xl text-white">ğŸ’³ Payer maintenant</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal Ajouter Moyen de Paiement -->
  <div id="modalAddPayment" class="modal-overlay" onclick="closeModal('modalAddPayment')">
    <div class="modal-content" style="max-width: 500px;" onclick="event.stopPropagation()">
      <div class="p-5 border-b border-slate-800 flex items-center justify-between">
        <h3 class="text-xl font-bold text-slate-100">ğŸ’³ Ajouter un moyen de paiement</h3>
        <button onclick="closeModal('modalAddPayment')" class="p-2 hover:bg-slate-800 rounded-xl">âœ•</button>
      </div>
      <div class="p-6">
        <!-- Type de carte -->
        <div class="flex gap-3 mb-6">
          <button type="button" onclick="selectCardType('visa')" id="cardTypeVisa" class="flex-1 p-3 border-2 border-violet-500 bg-violet-500/10 rounded-xl text-center">
            <span class="text-2xl">ğŸ’³</span>
            <p class="text-sm text-slate-200 mt-1">Visa</p>
          </button>
          <button type="button" onclick="selectCardType('mastercard')" id="cardTypeMastercard" class="flex-1 p-3 border-2 border-transparent hover:border-slate-600 bg-slate-800/50 rounded-xl text-center">
            <span class="text-2xl">ğŸ’³</span>
            <p class="text-sm text-slate-200 mt-1">Mastercard</p>
          </button>
          <button type="button" onclick="selectCardType('amex')" id="cardTypeAmex" class="flex-1 p-3 border-2 border-transparent hover:border-slate-600 bg-slate-800/50 rounded-xl text-center">
            <span class="text-2xl">ğŸ’³</span>
            <p class="text-sm text-slate-200 mt-1">Amex</p>
          </button>
        </div>
        
        <!-- Formulaire carte -->
        <div class="space-y-4">
          <div>
            <label class="block text-sm text-slate-400 mb-2">NumÃ©ro de carte *</label>
            <input type="text" id="newCardNumber" placeholder="1234 5678 9012 3456" maxlength="19" oninput="formatCardNumber(this)" class="w-full font-mono">
          </div>
          <div>
            <label class="block text-sm text-slate-400 mb-2">Titulaire de la carte *</label>
            <input type="text" id="newCardHolder" placeholder="JEAN DUPONT" style="text-transform: uppercase;" class="w-full">
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-slate-400 mb-2">Date d'expiration *</label>
              <input type="text" id="newCardExpiry" placeholder="MM/AA" maxlength="5" oninput="formatExpiry(this)" class="w-full font-mono">
            </div>
            <div>
              <label class="block text-sm text-slate-400 mb-2">CVV *</label>
              <input type="password" id="newCardCVV" placeholder="â€¢â€¢â€¢" maxlength="4" class="w-full font-mono">
            </div>
          </div>
          <div class="flex items-center gap-3 p-3 bg-slate-800/50 rounded-xl">
            <input type="checkbox" id="newCardDefault" checked class="w-5 h-5">
            <label for="newCardDefault" class="text-sm text-slate-300">DÃ©finir comme moyen de paiement par dÃ©faut</label>
          </div>
        </div>
        
        <div class="mt-4 p-3 bg-emerald-500/10 border border-emerald-500/30 rounded-xl flex items-center gap-3">
          <span class="text-xl">ğŸ”’</span>
          <p class="text-sm text-emerald-300">Vos donnÃ©es sont sÃ©curisÃ©es et chiffrÃ©es selon la norme PCI-DSS</p>
        </div>
        
        <div class="flex gap-3 mt-6">
          <button onclick="closeModal('modalAddPayment')" class="flex-1 px-4 py-3 bg-slate-700 rounded-xl text-slate-200">Annuler</button>
          <button onclick="savePaymentMethod()" class="flex-1 btn-success px-4 py-3 rounded-xl text-white">ğŸ’¾ Enregistrer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Portail DÃ©pÃ´t Documents -->
  <div id="modalPortailDepot" class="modal-overlay" onclick="closeModal('modalPortailDepot')">
    <div class="modal-content modal-large" style="max-height: 90vh; display: flex; flex-direction: column;" onclick="event.stopPropagation()">
      <div class="p-5 border-b border-slate-800 flex items-center justify-between flex-shrink-0">
        <h3 class="text-xl font-bold text-slate-100">ğŸ“¤ Portail de dÃ©pÃ´t de documents</h3>
        <button onclick="closeModal('modalPortailDepot')" class="p-2 hover:bg-slate-800 rounded-xl">âœ•</button>
      </div>
      <div class="p-6 overflow-y-auto flex-1">
        <div class="mb-6 p-4 bg-violet-500/10 border border-violet-500/30 rounded-xl">
          <p class="text-violet-300">Bienvenue sur le portail de dÃ©pÃ´t BTP Connect. DÃ©posez vos documents obligatoires ici. Ils seront automatiquement analysÃ©s par notre IA.</p>
        </div>
        
        <div class="mb-6">
          <label class="block text-sm text-slate-400 mb-2">Type de document *</label>
          <select id="portailDocType" class="w-full">
            <option value="">SÃ©lectionner le type de document...</option>
            <option value="kbis">ğŸ“‹ Extrait Kbis</option>
            <option value="urssaf">ğŸ›ï¸ Attestation URSSAF</option>
            <option value="rcpro">ğŸ›¡ï¸ Attestation RC Pro</option>
            <option value="decennale">ğŸ—ï¸ Attestation DÃ©cennale</option>
            <option value="vigilance">ğŸ“„ Attestation de vigilance</option>
            <option value="fiscale">ğŸ’¼ Attestation fiscale</option>
            <option value="autre">ğŸ“ Autre document</option>
          </select>
        </div>
        
        <div class="mb-6">
          <label class="block text-sm text-slate-400 mb-2">Fichier Ã  dÃ©poser *</label>
          <div id="portailDropZone" class="border-2 border-dashed border-slate-600 hover:border-violet-500 rounded-xl p-8 text-center cursor-pointer transition-colors" onclick="document.getElementById('portailFileInput').click()">
            <span class="text-4xl">ğŸ“„</span>
            <p class="text-slate-300 mt-3">Glissez-dÃ©posez votre fichier ici</p>
            <p class="text-slate-500 text-sm mt-1">ou cliquez pour sÃ©lectionner</p>
            <p class="text-slate-600 text-xs mt-2">PDF, JPG, PNG â€¢ Max 10 Mo</p>
            <input type="file" id="portailFileInput" class="hidden" accept=".pdf,.jpg,.jpeg,.png" onchange="handlePortailFile(this)">
          </div>
          <div id="portailFilePreview" class="hidden mt-3 p-3 bg-emerald-500/10 border border-emerald-500/30 rounded-xl">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <span class="text-xl">âœ…</span>
                <div>
                  <p class="font-medium text-slate-200" id="portailFileName">document.pdf</p>
                  <p class="text-xs text-slate-500" id="portailFileSize">1.2 Mo</p>
                </div>
              </div>
              <button onclick="clearPortailFile()" class="text-red-400 hover:text-red-300">âœ•</button>
            </div>
          </div>
        </div>
        
        <div class="mb-6">
          <label class="block text-sm text-slate-400 mb-2">Date d'expiration du document</label>
          <input type="date" id="portailDocExpiration" class="w-full">
        </div>
        
        <div class="mb-6">
          <label class="block text-sm text-slate-400 mb-2">Commentaire (optionnel)</label>
          <textarea id="portailComment" rows="2" placeholder="Informations complÃ©mentaires..." class="w-full"></textarea>
        </div>
        
        <div class="flex gap-3">
          <button onclick="closeModal('modalPortailDepot')" class="flex-1 px-4 py-3 bg-slate-700 rounded-xl text-slate-200">Annuler</button>
          <button onclick="soumettreDocument()" class="flex-1 btn-primary px-4 py-3 rounded-xl text-white">ğŸ“¤ DÃ©poser le document</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Ajouter Utilisateur -->
  <div id="modalAddUser" class="modal-overlay" onclick="closeModal('modalAddUser')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="p-5 border-b border-slate-800 flex items-center justify-between">
        <h3 class="text-xl font-bold text-slate-100">â• Ajouter un utilisateur</h3>
        <button onclick="closeModal('modalAddUser')" class="p-2 hover:bg-slate-800 rounded-xl">âœ•</button>
      </div>
      <div class="p-6 space-y-4">
        <div>
          <label class="block text-sm text-slate-400 mb-2">Nom complet *</label>
          <input type="text" id="newUserNom" placeholder="Jean Dupont" class="w-full">
        </div>
        <div>
          <label class="block text-sm text-slate-400 mb-2">Email *</label>
          <input type="email" id="newUserEmail" placeholder="jean.dupont@entreprise.fr" class="w-full">
        </div>
        <div>
          <label class="block text-sm text-slate-400 mb-2">Mot de passe *</label>
          <input type="password" id="newUserPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="w-full">
        </div>
        <div>
          <label class="block text-sm text-slate-400 mb-2">RÃ´le *</label>
          <select id="newUserRole" class="w-full">
            <option value="admin">ğŸ‘‘ Administrateur</option>
            <option value="conducteur" selected>ğŸ‘· Conducteur de travaux</option>
            <option value="comptable">ğŸ“Š Comptable</option>
          </select>
        </div>
        <div class="flex gap-3 mt-6">
          <button onclick="closeModal('modalAddUser')" class="flex-1 px-4 py-2 bg-slate-700 rounded-xl text-slate-200">Annuler</button>
          <button onclick="addUser()" class="flex-1 btn-primary px-4 py-2 rounded-xl text-white">â• Ajouter</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Ã‰diter Utilisateur -->
  <div id="modalEditUser" class="modal-overlay" onclick="closeModal('modalEditUser')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="p-5 border-b border-slate-800 flex items-center justify-between">
        <h3 class="text-xl font-bold text-slate-100">âœï¸ Modifier l'utilisateur</h3>
        <button onclick="closeModal('modalEditUser')" class="p-2 hover:bg-slate-800 rounded-xl">âœ•</button>
      </div>
      <div class="p-6 space-y-4">
        <input type="hidden" id="editUserId">
        <div>
          <label class="block text-sm text-slate-400 mb-2">Nom complet *</label>
          <input type="text" id="editUserNom" class="w-full">
        </div>
        <div>
          <label class="block text-sm text-slate-400 mb-2">Email *</label>
          <input type="email" id="editUserEmail" class="w-full">
        </div>
        <div>
          <label class="block text-sm text-slate-400 mb-2">Nouveau mot de passe (laisser vide pour ne pas changer)</label>
          <input type="password" id="editUserPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="w-full">
        </div>
        <div>
          <label class="block text-sm text-slate-400 mb-2">RÃ´le *</label>
          <select id="editUserRole" class="w-full">
            <option value="admin">ğŸ‘‘ Administrateur</option>
            <option value="conducteur">ğŸ‘· Conducteur de travaux</option>
            <option value="comptable">ğŸ“Š Comptable</option>
          </select>
        </div>
        <div class="flex gap-3 mt-6">
          <button onclick="deleteUser()" class="px-4 py-2 bg-red-600 hover:bg-red-500 rounded-xl text-white">ğŸ—‘ï¸ Supprimer</button>
          <button onclick="closeModal('modalEditUser')" class="flex-1 px-4 py-2 bg-slate-700 rounded-xl text-slate-200">Annuler</button>
          <button onclick="saveUser()" class="flex-1 btn-primary px-4 py-2 rounded-xl text-white">ğŸ’¾ Enregistrer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal DÃ©tail Facture -->
  <div id="modalDetailFacture" class="modal-overlay" onclick="closeModal('modalDetailFacture')">
    <div class="modal-content" style="max-width: 600px;" onclick="event.stopPropagation()">
      <div class="p-5 border-b border-slate-800 flex items-center justify-between">
        <h3 class="text-xl font-bold text-slate-100" id="detailFactureTitle">ğŸ“„ DÃ©tail Facture</h3>
        <button onclick="closeModal('modalDetailFacture')" class="p-2 hover:bg-slate-800 rounded-xl">âœ•</button>
      </div>
      <div class="p-6" id="detailFactureContent"></div>
    </div>
  </div>

  <!-- Modal Live Chat -->
  <div id="modalLiveChat" class="modal-overlay" onclick="closeModal('modalLiveChat')">
    <div class="modal-content" style="max-width: 450px; height: 600px; display: flex; flex-direction: column;" onclick="event.stopPropagation()">
      <div class="p-4 border-b border-slate-800 flex items-center justify-between flex-shrink-0">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-emerald-500 rounded-full flex items-center justify-center text-white">ğŸ’¬</div>
          <div>
            <h3 class="font-bold text-slate-100">Support BTP Connect</h3>
            <p class="text-xs text-emerald-400">â— En ligne</p>
          </div>
        </div>
        <button onclick="closeModal('modalLiveChat')" class="p-2 hover:bg-slate-800 rounded-xl">âœ•</button>
      </div>
      <div class="flex-1 overflow-y-auto p-4 space-y-4" id="liveChatMessages">
        <div class="flex gap-3">
          <div class="w-8 h-8 bg-violet-500 rounded-full flex items-center justify-center text-white text-sm">ğŸ¤–</div>
          <div class="bg-slate-800 p-3 rounded-xl rounded-tl-sm max-w-xs">
            <p class="text-sm text-slate-300">Bonjour ! Je suis l'assistant BTP Connect. Comment puis-je vous aider aujourd'hui ?</p>
            <p class="text-xs text-slate-500 mt-1">Support â€¢ Maintenant</p>
          </div>
        </div>
      </div>
      <div class="p-4 border-t border-slate-800 flex-shrink-0">
        <div class="flex gap-2">
          <input type="text" id="liveChatInput" placeholder="Tapez votre message..." class="flex-1" onkeypress="if(event.key==='Enter') sendLiveChatMessage()">
          <button onclick="sendLiveChatMessage()" class="px-4 py-2 bg-violet-600 hover:bg-violet-500 rounded-xl text-white">ğŸ“¨</button>
        </div>
      </div>
    </div>
  </div>


  <!-- ==================== LANDING PAGE PROFESSIONNELLE ==================== -->
  <div id="landingPage" class="fixed inset-0 z-50 overflow-y-auto">
    <style>
      #landingPage { font-family: 'Inter', -apple-system, sans-serif; background: white; }
      #landingPage * { margin: 0; padding: 0; box-sizing: border-box; }
      .lp-topbar { background: #0f172a; color: white; padding: 10px 24px; font-size: 13px; display: flex; justify-content: space-between; align-items: center; }
      .lp-topbar-promo { background: linear-gradient(90deg, #2563eb, #f59e0b); padding: 4px 12px; border-radius: 20px; font-weight: 500; }
      .lp-navbar { display: flex; justify-content: space-between; align-items: center; padding: 16px 48px; background: white; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
      .lp-logo { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 24px; color: #0f172a; text-decoration: none; }
      .lp-logo-icon { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; padding: 8px 12px; border-radius: 8px; font-size: 14px; font-weight: 800; }
      .lp-nav-links { display: flex; gap: 32px; }
      .lp-nav-links a { color: #64748b; text-decoration: none; font-weight: 500; font-size: 15px; transition: color 0.2s; }
      .lp-nav-links a:hover { color: #2563eb; }
      .lp-btn { padding: 12px 24px; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; border: none; }
      .lp-btn-primary { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; box-shadow: 0 4px 14px rgba(37,99,235,0.4); }
      .lp-btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(37,99,235,0.5); }
      .lp-btn-outline { background: white; color: #334155; border: 2px solid #e2e8f0; }
      .lp-btn-outline:hover { border-color: #2563eb; color: #2563eb; }
      .lp-hero { padding: 60px 48px 80px; background: linear-gradient(180deg, #f8fafc 0%, white 100%); display: grid; grid-template-columns: 1fr 1fr; gap: 60px; align-items: center; max-width: 1400px; margin: 0 auto; }
      .lp-hero-badge { display: inline-flex; align-items: center; gap: 8px; background: rgba(37,99,235,0.1); border: 1px solid rgba(37,99,235,0.2); padding: 8px 16px; border-radius: 50px; font-size: 14px; font-weight: 600; color: #2563eb; margin-bottom: 24px; }
      .lp-hero-dot { width: 8px; height: 8px; background: #10b981; border-radius: 50%; animation: lp-pulse 2s infinite; }
      @keyframes lp-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
      .lp-hero h1 { font-size: 48px; font-weight: 800; line-height: 1.1; color: #0f172a; margin-bottom: 24px; }
      .lp-hero h1 span { background: linear-gradient(135deg, #2563eb, #f59e0b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
      .lp-hero-desc { font-size: 18px; color: #64748b; margin-bottom: 32px; line-height: 1.7; }
      .lp-hero-buttons { display: flex; gap: 16px; margin-bottom: 40px; }
      .lp-hero-trust { display: flex; gap: 24px; color: #64748b; font-size: 14px; }
      .lp-hero-visual { background: white; border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); padding: 24px; }
      .lp-section { padding: 80px 48px; max-width: 1200px; margin: 0 auto; }
      .lp-section-header { text-align: center; margin-bottom: 60px; }
      .lp-section-badge { display: inline-block; background: rgba(37,99,235,0.1); color: #2563eb; padding: 8px 16px; border-radius: 50px; font-size: 14px; font-weight: 600; margin-bottom: 16px; }
      .lp-section-title { font-size: 40px; font-weight: 800; color: #0f172a; margin-bottom: 16px; }
      .lp-section-desc { font-size: 18px; color: #64748b; max-width: 600px; margin: 0 auto; }
      .lp-features-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 32px; }
      .lp-feature-card { background: white; border: 1px solid #e2e8f0; border-radius: 16px; padding: 32px; transition: all 0.3s; }
      .lp-feature-card:hover { transform: translateY(-8px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); border-color: #2563eb; }
      .lp-feature-icon { width: 56px; height: 56px; background: rgba(37,99,235,0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 28px; margin-bottom: 20px; }
      .lp-feature-title { font-size: 20px; font-weight: 700; color: #0f172a; margin-bottom: 12px; }
      .lp-feature-desc { color: #64748b; font-size: 15px; line-height: 1.6; }
      .lp-pricing-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 32px; }
      .lp-pricing-card { background: white; border: 2px solid #e2e8f0; border-radius: 20px; padding: 40px; text-align: center; transition: all 0.3s; position: relative; }
      .lp-pricing-card.popular { border-color: #2563eb; transform: scale(1.05); box-shadow: 0 20px 40px rgba(37,99,235,0.15); }
      .lp-pricing-badge { position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; padding: 6px 20px; border-radius: 50px; font-size: 13px; font-weight: 600; }
      .lp-pricing-name { font-size: 24px; font-weight: 700; color: #0f172a; margin-bottom: 8px; }
      .lp-pricing-price { font-size: 48px; font-weight: 800; color: #0f172a; }
      .lp-pricing-price span { font-size: 16px; color: #64748b; }
      .lp-pricing-features { list-style: none; margin: 24px 0; text-align: left; }
      .lp-pricing-features li { padding: 12px 0; border-bottom: 1px solid #f1f5f9; color: #475569; font-size: 15px; }
      .lp-pricing-features li:before { content: "âœ“"; color: #10b981; margin-right: 12px; font-weight: 700; }
      .lp-testimonials-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 32px; }
      .lp-testimonial-card { background: white; border: 1px solid #e2e8f0; border-radius: 16px; padding: 32px; }
      .lp-testimonial-stars { color: #f59e0b; font-size: 20px; margin-bottom: 16px; }
      .lp-testimonial-text { color: #334155; font-size: 16px; line-height: 1.7; margin-bottom: 24px; font-style: italic; }
      .lp-testimonial-author { display: flex; align-items: center; gap: 12px; }
      .lp-testimonial-avatar { width: 48px; height: 48px; background: linear-gradient(135deg, #2563eb, #f59e0b); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; }
      .lp-cta { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); padding: 80px 48px; text-align: center; color: white; }
      .lp-cta h2 { font-size: 40px; font-weight: 800; margin-bottom: 16px; }
      .lp-cta p { font-size: 18px; color: #94a3b8; margin-bottom: 32px; }
      .lp-cta-buttons { display: flex; gap: 16px; justify-content: center; }
      .lp-footer { background: #0f172a; color: #94a3b8; padding: 60px 48px 30px; }
      .lp-footer-grid { display: grid; grid-template-columns: 2fr repeat(4, 1fr); gap: 40px; max-width: 1200px; margin: 0 auto 40px; }
      .lp-footer-brand p { margin-top: 16px; font-size: 14px; line-height: 1.6; }
      .lp-footer-col h4 { color: white; font-weight: 600; margin-bottom: 20px; font-size: 15px; }
      .lp-footer-col a { display: block; color: #94a3b8; text-decoration: none; padding: 8px 0; font-size: 14px; transition: color 0.2s; cursor: pointer; }
      .lp-footer-col a:hover { color: white; }
      .lp-footer-bottom { border-top: 1px solid #334155; padding-top: 24px; display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; font-size: 14px; }
      .lp-faq-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; max-width: 900px; margin: 0 auto; }
      .lp-faq-item { background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 24px; }
      .lp-faq-item h4 { font-weight: 600; color: #0f172a; margin-bottom: 12px; }
      .lp-faq-item p { color: #64748b; font-size: 15px; line-height: 1.6; }
      @media (max-width: 1024px) { 
        .lp-hero { grid-template-columns: 1fr; text-align: center; padding: 40px 24px; } 
        .lp-hero-visual { display: none; } 
        .lp-hero-buttons, .lp-hero-trust { justify-content: center; }
        .lp-features-grid, .lp-pricing-grid, .lp-testimonials-grid, .lp-faq-grid { grid-template-columns: 1fr; } 
        .lp-footer-grid { grid-template-columns: 1fr 1fr; }
        .lp-navbar { padding: 16px 24px; }
        .lp-nav-links { display: none; }
        .lp-section { padding: 60px 24px; }
        .lp-pricing-card.popular { transform: none; }
      }
    
    /* --- UX hardening (LOT 4) --- */
    :focus-visible { outline: 2px solid #a78bfa; outline-offset: 2px; }
    @media (prefers-reduced-motion: reduce) {
      * { animation-duration: 0.001ms !important; animation-iteration-count: 1 !important; transition-duration: 0.001ms !important; scroll-behavior: auto !important; }
    }
    .truncate-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .break-anywhere { overflow-wrap: anywhere; word-break: break-word; }
    .btn-primary, .btn-success, .btn-danger { min-height: 40px; }
    .modal-content { outline: none; }
    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

  </style>
    
    <!-- Top Bar -->
    <div class="lp-topbar">
      <span>ğŸ“ 01 23 45 67 89 | âœ‰ï¸ contact@btpconnect.fr</span>
      <span class="lp-topbar-promo">ğŸ‰ Essai gratuit 30 jours - Sans engagement</span>
    </div>
    
    <!-- Navbar -->
    <nav class="lp-navbar">
      <a href="#" class="lp-logo">
        <div class="lp-logo-icon">BTP</div>
        Connect
      </a>
      <div class="lp-nav-links">
        <a href="#lp-fonctionnalites">FonctionnalitÃ©s</a>
        <a href="#lp-tarifs">Tarifs</a>
        <a href="#lp-temoignages">TÃ©moignages</a>
        <a href="#lp-faq">FAQ</a>
      </div>
      <div style="display: flex; gap: 12px;">
        <button onclick="showLoginPage()" class="lp-btn lp-btn-outline">Se connecter</button>
        <button onclick="showLoginPage()" class="lp-btn lp-btn-primary">Essai gratuit â†’</button>
      </div>
    </nav>
    
    <!-- Hero -->
    <section class="lp-hero">
      <div>
        <div class="lp-hero-badge">
          <span class="lp-hero-dot"></span>
          Nouveau : Module IA Chiffrage disponible
        </div>
        <h1>Simplifiez la gestion de vos <span>chantiers BTP</span></h1>
        <p class="lp-hero-desc">Centralisez la gestion de vos sous-traitants, automatisez le traitement de vos factures grÃ¢ce Ã  l'IA et assurez la conformitÃ© documentaire de tous vos projets.</p>
        <div class="lp-hero-buttons">
          <button onclick="showLoginPage()" class="lp-btn lp-btn-primary" style="padding: 16px 32px; font-size: 16px;">ğŸš€ DÃ©marrer l'essai gratuit</button>
          <a href="#lp-fonctionnalites" class="lp-btn lp-btn-outline" style="padding: 16px 32px; font-size: 16px;">Voir la dÃ©mo</a>
        </div>
        <div class="lp-hero-trust">
          <span>âœ“ Sans carte bancaire</span>
          <span>âœ“ Support inclus</span>
          <span>âœ“ 2 500+ entreprises</span>
        </div>
      </div>
      <div class="lp-hero-visual">
        <div style="display: flex; gap: 8px; margin-bottom: 20px;">
          <div style="width: 12px; height: 12px; border-radius: 50%; background: #ef4444;"></div>
          <div style="width: 12px; height: 12px; border-radius: 50%; background: #f59e0b;"></div>
          <div style="width: 12px; height: 12px; border-radius: 50%; background: #10b981;"></div>
        </div>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 20px;">
          <div style="background: #f1f5f9; padding: 16px; border-radius: 12px; text-align: center;">
            <div style="font-size: 28px; font-weight: 800; color: #2563eb;">12</div>
            <div style="font-size: 12px; color: #64748b;">Chantiers actifs</div>
          </div>
          <div style="background: #f1f5f9; padding: 16px; border-radius: 12px; text-align: center;">
            <div style="font-size: 28px; font-weight: 800; color: #10b981;">2.4Mâ‚¬</div>
            <div style="font-size: 12px; color: #64748b;">CA en cours</div>
          </div>
          <div style="background: #f1f5f9; padding: 16px; border-radius: 12px; text-align: center;">
            <div style="font-size: 28px; font-weight: 800; color: #f59e0b;">98%</div>
            <div style="font-size: 12px; color: #64748b;">ConformitÃ©</div>
          </div>
        </div>
        <div style="background: #f8fafc; border-radius: 12px; padding: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <span style="font-weight: 600; color: #0f172a;">RÃ©sidence Les Tilleuls</span>
            <span style="background: #dcfce7; color: #16a34a; padding: 4px 12px; border-radius: 20px; font-size: 12px;">En cours</span>
          </div>
          <div style="background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden;">
            <div style="background: linear-gradient(90deg, #2563eb, #3b82f6); height: 100%; width: 67%;"></div>
          </div>
          <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px; color: #64748b;">
            <span>Avancement: 67%</span>
            <span>450 000 â‚¬</span>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Features -->
    <section class="lp-section" id="lp-fonctionnalites">
      <div class="lp-section-header">
        <span class="lp-section-badge">FonctionnalitÃ©s</span>
        <h2 class="lp-section-title">Tout ce dont vous avez besoin</h2>
        <p class="lp-section-desc">Une suite complÃ¨te d'outils pour gÃ©rer efficacement vos projets BTP</p>
      </div>
      <div class="lp-features-grid">
        <div class="lp-feature-card">
          <div class="lp-feature-icon">ğŸ‘·</div>
          <h3 class="lp-feature-title">Gestion des sous-traitants</h3>
          <p class="lp-feature-desc">Centralisez tous vos sous-traitants, suivez leurs contrats et gÃ©rez leurs documents obligatoires automatiquement.</p>
        </div>
        <div class="lp-feature-card">
          <div class="lp-feature-icon">ğŸ“‹</div>
          <h3 class="lp-feature-title">Situations de travaux</h3>
          <p class="lp-feature-desc">GÃ©rez le double flux (STâ†’EE et EEâ†’MO) avec validation en un clic et suivi des paiements.</p>
        </div>
        <div class="lp-feature-card">
          <div class="lp-feature-icon">ğŸ“„</div>
          <h3 class="lp-feature-title">ConformitÃ© documentaire</h3>
          <p class="lp-feature-desc">Suivi automatisÃ© des documents obligatoires avec alertes d'expiration et analyse IA.</p>
        </div>
        <div class="lp-feature-card">
          <div class="lp-feature-icon">ğŸ¤–</div>
          <h3 class="lp-feature-title">IA & Chiffrage</h3>
          <p class="lp-feature-desc">Analyse automatique de vos plans pour gÃ©nÃ©rer des estimations prÃ©cises en quelques minutes.</p>
        </div>
        <div class="lp-feature-card">
          <div class="lp-feature-icon">ğŸ’¶</div>
          <h3 class="lp-feature-title">Facturation intÃ©grÃ©e</h3>
          <p class="lp-feature-desc">GÃ©nÃ©rez vos factures automatiquement Ã  partir des situations validÃ©es avec export comptable.</p>
        </div>
        <div class="lp-feature-card">
          <div class="lp-feature-icon">ğŸ“Š</div>
          <h3 class="lp-feature-title">Tableaux de bord</h3>
          <p class="lp-feature-desc">Visualisez l'avancement de tous vos chantiers et la santÃ© financiÃ¨re de votre entreprise.</p>
        </div>
      </div>
    </section>
    
    <!-- Pricing -->
    <section class="lp-section" style="background: #f8fafc;" id="lp-tarifs">
      <div class="lp-section-header">
        <span class="lp-section-badge">Tarifs</span>
        <h2 class="lp-section-title">Des offres adaptÃ©es Ã  votre taille</h2>
        <p class="lp-section-desc">Choisissez la formule qui correspond Ã  vos besoins. Sans engagement.</p>
      </div>
      <div class="lp-pricing-grid">
        <div class="lp-pricing-card">
          <div class="lp-pricing-name">Starter</div>
          <div style="color: #64748b; margin-bottom: 16px;">Pour les artisans et TPE</div>
          <div class="lp-pricing-price">49â‚¬ <span>HT/mois</span></div>
          <ul class="lp-pricing-features">
            <li>Jusqu'Ã  5 chantiers actifs</li>
            <li>10 sous-traitants</li>
            <li>Gestion documentaire</li>
            <li>Support email</li>
          </ul>
          <button onclick="showLoginPage()" class="lp-btn lp-btn-outline" style="width: 100%;">Commencer</button>
        </div>
        <div class="lp-pricing-card popular">
          <div class="lp-pricing-badge">Le plus populaire</div>
          <div class="lp-pricing-name">Pro</div>
          <div style="color: #64748b; margin-bottom: 16px;">Pour les PME du BTP</div>
          <div class="lp-pricing-price">149â‚¬ <span>HT/mois</span></div>
          <ul class="lp-pricing-features">
            <li>Chantiers illimitÃ©s</li>
            <li>Sous-traitants illimitÃ©s</li>
            <li>Module IA & Chiffrage</li>
            <li>IntÃ©grations ERP</li>
            <li>Support prioritaire</li>
          </ul>
          <button onclick="showLoginPage()" class="lp-btn lp-btn-primary" style="width: 100%;">Essai gratuit</button>
        </div>
        <div class="lp-pricing-card">
          <div class="lp-pricing-name">Enterprise</div>
          <div style="color: #64748b; margin-bottom: 16px;">Pour les grands groupes</div>
          <div class="lp-pricing-price">Sur mesure</div>
          <ul class="lp-pricing-features">
            <li>Multi-entreprises</li>
            <li>API dÃ©diÃ©e</li>
            <li>SSO & SAML</li>
            <li>Account manager dÃ©diÃ©</li>
            <li>SLA garanti 99.9%</li>
          </ul>
          <button onclick="showLoginPage()" class="lp-btn lp-btn-outline" style="width: 100%;">Nous contacter</button>
        </div>
      </div>
    </section>
    
    <!-- Testimonials -->
    <section class="lp-section" id="lp-temoignages">
      <div class="lp-section-header">
        <span class="lp-section-badge">TÃ©moignages</span>
        <h2 class="lp-section-title">Ce que nos clients disent</h2>
        <p class="lp-section-desc">DÃ©couvrez comment BTP Connect transforme le quotidien des professionnels</p>
      </div>
      <div class="lp-testimonials-grid">
        <div class="lp-testimonial-card">
          <div class="lp-testimonial-stars">â˜…â˜…â˜…â˜…â˜…</div>
          <p class="lp-testimonial-text">"BTP Connect nous a permis de diviser par 2 le temps passÃ© sur l'administratif. La conformitÃ© documentaire automatisÃ©e est un vrai game-changer."</p>
          <div class="lp-testimonial-author">
            <div class="lp-testimonial-avatar">JD</div>
            <div>
              <div style="font-weight: 600; color: #0f172a;">Jean Dupont</div>
              <div style="font-size: 14px; color: #64748b;">Directeur, Dupont BTP</div>
            </div>
          </div>
        </div>
        <div class="lp-testimonial-card">
          <div class="lp-testimonial-stars">â˜…â˜…â˜…â˜…â˜…</div>
          <p class="lp-testimonial-text">"L'IA de chiffrage est bluffante. En 10 minutes, j'ai une estimation fiable lÃ  oÃ¹ il me fallait une journÃ©e auparavant."</p>
          <div class="lp-testimonial-author">
            <div class="lp-testimonial-avatar">ML</div>
            <div>
              <div style="font-weight: 600; color: #0f172a;">Marie Laurent</div>
              <div style="font-size: 14px; color: #64748b;">Conducteur de travaux</div>
            </div>
          </div>
        </div>
        <div class="lp-testimonial-card">
          <div class="lp-testimonial-stars">â˜…â˜…â˜…â˜…â˜…</div>
          <p class="lp-testimonial-text">"Interface intuitive, support rÃ©actif, et des mises Ã  jour rÃ©guliÃ¨res. C'est l'outil qu'il manquait au secteur BTP."</p>
          <div class="lp-testimonial-author">
            <div class="lp-testimonial-avatar">PA</div>
            <div>
              <div style="font-weight: 600; color: #0f172a;">Pierre AndrÃ©</div>
              <div style="font-size: 14px; color: #64748b;">GÃ©rant, AndrÃ© Construction</div>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- FAQ -->
    <section class="lp-section" style="background: #f8fafc;" id="lp-faq">
      <div class="lp-section-header">
        <span class="lp-section-badge">FAQ</span>
        <h2 class="lp-section-title">Questions frÃ©quentes</h2>
      </div>
      <div class="lp-faq-grid">
        <div class="lp-faq-item">
          <h4>Puis-je essayer gratuitement ?</h4>
          <p>Oui, tous nos plans incluent un essai gratuit de 30 jours sans engagement et sans carte bancaire requise.</p>
        </div>
        <div class="lp-faq-item">
          <h4>Comment fonctionne l'IA de chiffrage ?</h4>
          <p>Notre IA analyse vos plans (PDF, DWG) et extrait automatiquement les mÃ©trÃ©s pour gÃ©nÃ©rer une estimation basÃ©e sur notre base de prix.</p>
        </div>
        <div class="lp-faq-item">
          <h4>Mes donnÃ©es sont-elles sÃ©curisÃ©es ?</h4>
          <p>Absolument. HÃ©bergement en France, chiffrement AES-256, sauvegardes quotidiennes et conformitÃ© RGPD garantie.</p>
        </div>
        <div class="lp-faq-item">
          <h4>Puis-je intÃ©grer mon ERP existant ?</h4>
          <p>Oui, nous proposons des connecteurs pour les principaux ERP du marchÃ© (Sage, Cegid, etc.) ainsi qu'une API ouverte.</p>
        </div>
        <div class="lp-faq-item">
          <h4>Y a-t-il une application mobile ?</h4>
          <p>Oui, notre application mobile (iOS & Android) vous permet de gÃ©rer vos chantiers depuis le terrain.</p>
        </div>
        <div class="lp-faq-item">
          <h4>Quel support proposez-vous ?</h4>
          <p>Support email pour tous, tÃ©lÃ©phonique pour Pro et Enterprise, account manager dÃ©diÃ© pour Enterprise.</p>
        </div>
      </div>
    </section>
    
    <!-- CTA -->
    <section class="lp-cta">
      <h2>PrÃªt Ã  simplifier votre gestion BTP ?</h2>
      <p>Rejoignez les 2 500+ entreprises qui font confiance Ã  BTP Connect</p>
      <div class="lp-cta-buttons">
        <button onclick="showLoginPage()" class="lp-btn lp-btn-primary" style="padding: 16px 32px; font-size: 16px;">DÃ©marrer l'essai gratuit â†’</button>
        <button onclick="showLoginPage()" class="lp-btn lp-btn-outline" style="padding: 16px 32px; font-size: 16px; background: transparent; color: white; border-color: rgba(255,255,255,0.3);">Demander une dÃ©mo</button>
      </div>
    </section>
    
    <!-- Footer -->
    <footer class="lp-footer">
      <div class="lp-footer-grid">
        <div class="lp-footer-brand">
          <a href="#" class="lp-logo" style="color: white;">
            <div class="lp-logo-icon">BTP</div>
            Connect
          </a>
          <p>La solution tout-en-un pour gÃ©rer vos chantiers BTP, vos sous-traitants et votre conformitÃ© documentaire.</p>
        </div>
        <div class="lp-footer-col">
          <h4>Produit</h4>
          <a href="#lp-fonctionnalites">FonctionnalitÃ©s</a>
          <a href="#lp-tarifs">Tarifs</a>
          <a href="#">IntÃ©grations</a>
          <a href="#">Mobile</a>
        </div>
        <div class="lp-footer-col">
          <h4>Ressources</h4>
          <a href="#">Documentation</a>
          <a href="#">Blog</a>
          <a href="#">Guides</a>
          <a href="#">Webinars</a>
        </div>
        <div class="lp-footer-col">
          <h4>Entreprise</h4>
          <a href="#">Ã€ propos</a>
          <a href="#">CarriÃ¨res</a>
          <a href="#">Presse</a>
          <a href="#">Contact</a>
        </div>
        <div class="lp-footer-col">
          <h4>LÃ©gal</h4>
          <a onclick="openModal('modalMentionsLegales')">Mentions lÃ©gales</a>
          <a onclick="openModal('modalCGU')">CGU</a>
          <a onclick="openModal('modalConfidentialite')">ConfidentialitÃ©</a>
          <a onclick="openModal('modalCookies')">Cookies</a>
        </div>
      </div>
      <div class="lp-footer-bottom">
        <span>Â© 2026 BTP Connect. Tous droits rÃ©servÃ©s.</span>
        <div style="display: flex; gap: 24px;">
          <a onclick="openModal('modalMentionsLegales')" style="color: #94a3b8; cursor: pointer;">Mentions lÃ©gales</a>
          <a onclick="openModal('modalConfidentialite')" style="color: #94a3b8; cursor: pointer;">ConfidentialitÃ©</a>
          <a onclick="openModal('modalCGU')" style="color: #94a3b8; cursor: pointer;">CGU</a>
        </div>
      </div>
    </footer>
  </div>

  <!-- ==================== LOGIN PAGE PROFESSIONNELLE ==================== -->
  <div id="loginPage" class="fixed inset-0 z-50 hidden" style="background: linear-gradient(135deg, #020617 0%, #0f172a 50%, #1e1b4b 100%); font-family: 'Inter', sans-serif;">
    <style>
      .login-container { width: 100%; max-width: 420px; padding: 20px; margin: 0 auto; display: flex; align-items: center; min-height: 100vh; }
      .login-card { background: rgba(15, 23, 42, 0.9); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 20px; padding: 40px; backdrop-filter: blur(20px); width: 100%; }
      .login-logo { text-align: center; margin-bottom: 30px; }
      .login-logo-icon { width: 70px; height: 70px; background: linear-gradient(135deg, #7c3aed, #4f46e5); border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 36px; margin: 0 auto 15px; box-shadow: 0 10px 30px rgba(124, 58, 237, 0.3); }
      .login-logo h1 { font-size: 28px; background: linear-gradient(135deg, #a78bfa, #818cf8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
      .login-logo p { color: #64748b; font-size: 14px; margin-top: 5px; }
      .login-tabs { display: flex; margin-bottom: 30px; background: rgba(30, 41, 59, 0.5); border-radius: 12px; padding: 4px; }
      .login-tab { flex: 1; padding: 12px; text-align: center; border-radius: 10px; cursor: pointer; transition: all 0.3s; font-weight: 500; color: #94a3b8; border: none; background: none; font-size: 14px; }
      .login-tab.active { background: linear-gradient(135deg, #7c3aed, #4f46e5); color: white; }
      .login-tab:hover:not(.active) { color: white; }
      .login-form { display: none; }
      .login-form.active { display: block; }
      .login-field { margin-bottom: 20px; }
      .login-field label { display: block; margin-bottom: 8px; color: #94a3b8; font-size: 14px; }
      .login-field input, .login-field select { width: 100%; padding: 14px 16px; background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 12px; color: white; font-size: 16px; transition: border-color 0.3s; }
      .login-field input:focus, .login-field select:focus { outline: none; border-color: #7c3aed; box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2); }
      .login-field input::placeholder { color: #475569; }
      .login-field select option { background: #1e293b; color: white; }
      .login-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, #7c3aed, #4f46e5); border: none; border-radius: 12px; color: white; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
      .login-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(124, 58, 237, 0.3); }
      .login-message { padding: 12px 16px; border-radius: 10px; margin-bottom: 20px; font-size: 14px; display: none; }
      .login-message.error { background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.3); color: #f87171; display: block; }
      .login-message.success { background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.3); color: #34d399; display: block; }
      .login-back { text-align: center; margin-top: 20px; }
      .login-back button { background: none; border: none; color: #94a3b8; cursor: pointer; font-size: 14px; }
      .login-back button:hover { color: white; }
      .login-portals { margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(51, 65, 85, 0.5); }
      .login-portals p { text-align: center; color: #64748b; font-size: 13px; margin-bottom: 15px; }
      .login-portal-links { display: flex; gap: 10px; }
      .login-portal-link { flex: 1; padding: 12px; background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 10px; color: #94a3b8; text-decoration: none; text-align: center; font-size: 13px; transition: all 0.3s; cursor: pointer; }
      .login-portal-link:hover { border-color: #7c3aed; color: white; }
      .login-portal-link span { display: block; font-size: 24px; margin-bottom: 5px; }
    
    /* --- UX hardening (LOT 4) --- */
    :focus-visible { outline: 2px solid #a78bfa; outline-offset: 2px; }
    @media (prefers-reduced-motion: reduce) {
      * { animation-duration: 0.001ms !important; animation-iteration-count: 1 !important; transition-duration: 0.001ms !important; scroll-behavior: auto !important; }
    }
    .truncate-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .break-anywhere { overflow-wrap: anywhere; word-break: break-word; }
    .btn-primary, .btn-success, .btn-danger { min-height: 40px; }
    .modal-content { outline: none; }
    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

  </style>
    
    <div class="login-container">
      <div class="login-card">
        <div class="login-logo">
          <div class="login-logo-icon">ğŸ—ï¸</div>
          <h1>BTP Connect</h1>
          <p>Plateforme Collaborative</p>
        </div>

        <div class="login-tabs">
          <button class="login-tab active" onclick="showLoginForm('connexion')">Connexion</button>
          <button class="login-tab" onclick="showLoginForm('inscription')">Inscription</button>
        </div>

        <div id="loginMessage" class="login-message"></div>

        <!-- Formulaire Connexion -->
        <form id="form-connexion" class="login-form active" onsubmit="doLogin(event); return false;">
          <div class="login-field">
            <label>Email</label>
            <input type="email" id="loginEmail" placeholder="admin@btpconnect.fr" value="admin@btpconnect.fr" required>
          </div>
          <div class="login-field">
            <label>Mot de passe</label>
            <input type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" value="BtpConnect2026!" required>
          </div>
          <button type="submit" class="login-btn">ğŸ” Se connecter</button>
        </form>

        <!-- Formulaire Inscription -->
        <form id="form-inscription" class="login-form" onsubmit="doRegister(event); return false;">
          <div class="login-field">
            <label>Nom complet</label>
            <input type="text" id="registerNom" placeholder="Jean Dupont" required>
          </div>
          <div class="login-field">
            <label>Email</label>
            <input type="email" id="registerEmail" placeholder="votre@email.fr" required>
          </div>
          <div class="login-field">
            <label>Mot de passe</label>
            <input type="password" id="registerPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required minlength="6">
          </div>
          <div class="login-field">
            <label>Type de compte</label>
            <select id="registerRole">
              <option value="ee">Entreprise GÃ©nÃ©rale / EE</option>
              <option value="st">Sous-Traitant</option>
              <option value="mo">MaÃ®tre d'Ouvrage</option>
            </select>
          </div>
          <button type="submit" class="login-btn">ğŸ“ S'inscrire</button>
        </form>

        <!-- Liens portails -->
        <div class="login-portals">
          <p>AccÃ¨s rapide aux portails :</p>
          <div class="login-portal-links">
            <div class="login-portal-link" onclick="showToast('Portail ST bientÃ´t disponible')">
              <span>ğŸ‘·</span>
              Portail ST
            </div>
            <div class="login-portal-link" onclick="showToast('Portail EE bientÃ´t disponible')">
              <span>ğŸ¢</span>
              Portail EE
            </div>
          </div>
        </div>

        <div class="login-back">
          <button onclick="showLandingPage()">â† Retour Ã  l'accueil</button>
        </div>
      </div>
    </div>
  </div>

  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
    // ========== CONNECTEUR API (Ã‰TAPE 2) ==========
    // URL du backend - configurÃ© pour pointer vers le serveur Fastify
    // Port 3000 pour Ãªtre accessible via la preview
    // API URL - dÃ©tection automatique du backend
    let API_URL = "http://localhost:3000";
    
    // En mode Electron, utiliser l'URL configurÃ©e
    if (window.btpconnect && window.btpconnect.backendUrl) {
      window.btpconnect.backendUrl().then(url => {
        if (url) API_URL = url;
        console.log('[BTP] API URL:', API_URL);
      }).catch(() => {});
    } else if (window.location.protocol === 'file:') {
      // Mode fichier local (Electron sans serveur)
      API_URL = "http://127.0.0.1:3000";
    } else if (window.location.origin && window.location.origin !== 'null') {
      API_URL = window.location.origin;
    }
    
    console.log('[BTP] Initial API URL:', API_URL);

    // ========== OFFLINE-FIRST MODULE (Ã‰TAPE 5) ==========
    // ClÃ©s de stockage local
    const CACHE_KEYS = {
      ST: 'btp_cache_st',
      CHANTIERS: 'btp_cache_chantiers',
      QUEUE: 'btp_offline_queue',
      LAST_SYNC: 'btp_last_sync'
    };

    // Ã‰tat de connexion
    let isOnline = navigator.onLine;

    // Ã‰couter les changements de connexion
    window.addEventListener('online', async () => {
      isOnline = true;
      console.log('ğŸŒ Connexion rÃ©tablie');
      showToast('ğŸŒ Connexion rÃ©tablie - Synchronisation...', 'info');
      await processOfflineQueue();
      await syncAllFromAPI();
    });

    window.addEventListener('offline', () => {
      isOnline = false;
      console.log('ğŸ“´ Mode hors-ligne activÃ©');
      showToast('ğŸ“´ Mode hors-ligne - Les donnÃ©es seront synchronisÃ©es au retour', 'warning');
    });

    // Sauvegarder dans le cache local
    function saveToLocalCache(key, data) {
      try {
        localStorage.setItem(key, JSON.stringify({
          data: data,
          timestamp: Date.now()
        }));
        console.log(`ğŸ’¾ Cache sauvegardÃ©: ${key}`);
      } catch (e) {
        console.warn('âš ï¸ Erreur sauvegarde cache:', e);
      }
    }

    // Charger depuis le cache local
    function loadFromLocalCache(key) {
      try {
        const cached = localStorage.getItem(key);
        if (cached) {
          const parsed = JSON.parse(cached);
          console.log(`ğŸ“‚ Cache chargÃ©: ${key} (${new Date(parsed.timestamp).toLocaleString()})`);
          return parsed.data;
        }
      } catch (e) {
        console.warn('âš ï¸ Erreur lecture cache:', e);
      }
      return null;
    }

    // ========== QUEUE OFFLINE ==========
    // Ajouter une opÃ©ration Ã  la queue
    function addToOfflineQueue(operation) {
      const queue = loadFromLocalCache(CACHE_KEYS.QUEUE) || [];
      queue.push({
        ...operation,
        id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        timestamp: Date.now()
      });
      saveToLocalCache(CACHE_KEYS.QUEUE, queue);
      console.log('ğŸ“ OpÃ©ration ajoutÃ©e Ã  la queue offline:', operation.type);
      return true;
    }

    // Traiter la queue offline
    async function processOfflineQueue() {
      const queue = loadFromLocalCache(CACHE_KEYS.QUEUE) || [];
      if (queue.length === 0) {
        console.log('âœ… Queue offline vide');
        return;
      }

      console.log(`ğŸ”„ Traitement de ${queue.length} opÃ©ration(s) en attente...`);
      const failedOps = [];

      for (const op of queue) {
        try {
          switch (op.type) {
            case 'CREATE_ST':
              await apiFetch('/st', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(op.data)
              });
              break;
            case 'UPDATE_ST':
              await apiFetch('/st/' + op.id, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(op.data)
              });
              break;
            case 'DELETE_ST':
              await apiFetch('/st/' + op.id, { method: 'DELETE' });
              break;
            case 'CREATE_CHANTIER':
              await apiFetch('/chantiers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(op.data)
              });
              break;
            case 'UPDATE_CHANTIER':
              await apiFetch('/chantiers/' + op.id, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(op.data)
              });
              break;
            case 'DELETE_CHANTIER':
              await apiFetch('/chantiers/' + op.id, { method: 'DELETE' });
              break;
          }
          console.log(`âœ… OpÃ©ration synchronisÃ©e: ${op.type}`);
        } catch (err) {
          console.error(`âŒ Ã‰chec sync: ${op.type}`, err);
          failedOps.push(op);
        }
      }

      // Sauvegarder les opÃ©rations Ã©chouÃ©es
      saveToLocalCache(CACHE_KEYS.QUEUE, failedOps);
      
      if (failedOps.length > 0) {
        showToast(`âš ï¸ ${queue.length - failedOps.length} opÃ©ration(s) synchronisÃ©e(s), ${failedOps.length} en erreur`, 'warning');
      } else {
        showToast(`âœ… ${queue.length} opÃ©ration(s) synchronisÃ©e(s)`, 'success');
      }
    }

    // Afficher le statut de la queue
    function getQueueStatus() {
      const queue = loadFromLocalCache(CACHE_KEYS.QUEUE) || [];
      return {
        count: queue.length,
        operations: queue
      };
    }

    // ========== FIN OFFLINE MODULE ==========

    // RÃ©cupÃ©ration du token d'accÃ¨s
    function getAccessToken() {
      return localStorage.getItem("accessToken");
    }

    function getToken() {
      return getAccessToken();
    }

    // Fonction principale d'appel API
    async function apiFetch(path, options = {}) {
      const token = getAccessToken();
      const headers = {
        ...(options.headers || {}),
        ...(token ? { Authorization: "Bearer " + token } : {}),
      };

      const res = await fetch(API_URL + path, { ...options, headers });

      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        throw new Error(`API ${res.status} ${res.statusText} -> ${txt}`);
      }

      const ct = res.headers.get("content-type") || "";
      if (ct.includes("application/json")) return res.json();
      return res.text();
    }

    // Login via API
    async function apiLogin(email, password) {
      const res = await fetch(API_URL + "/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password }),
      });

      if (!res.ok) {
        throw new Error("Login failed: " + res.status);
      }

      const data = await res.json();
      if (data.accessToken) {
        localStorage.setItem("accessToken", data.accessToken);
        if (data.refreshToken) {
          localStorage.setItem("refreshToken", data.refreshToken);
        }
      }

      // RÃ©cupÃ©rer les infos utilisateur
      const me = await apiFetch("/auth/me");
      return me.user || { nom: email.split("@")[0], email: email, role: "admin" };
    }

    // ========== FONCTIONS DB - SOUS-TRAITANTS ==========
    async function loadSousTraitantsFromDB() {
      try {
        const data = await apiFetch("/st");
        // Mapper les donnÃ©es de l'API vers la structure UI
        const mappedItems = (data.items || []).map(item => ({
          id: item.id,
          nom: item.nom,
          logo: getMetierLogo(item.metier), // GÃ©nÃ©rer logo depuis mÃ©tier
          corpsMetier: item.metier || 'Non dÃ©fini',
          note: item.note || 0,
          ville: item.ville || '',
          siret: item.siret || '',
          email: item.email || '',
          tel: item.tel || '',
          entrepriseId: item.entrepriseId,
          dansAnnuairePrivate: true
        }));
        window.sousTraitants = mappedItems;
        sousTraitants = window.sousTraitants;
        // Sauvegarder dans le cache local (Ã‰TAPE 5)
        saveToLocalCache(CACHE_KEYS.ST, mappedItems);
        if (typeof renderAnnuaire === "function") renderAnnuaire();
        if (typeof renderDashboard === "function") renderDashboard();
        console.log("âœ… Sous-traitants chargÃ©s depuis API:", sousTraitants.length);
      } catch (err) {
        console.warn("âš ï¸ API non disponible, chargement depuis cache local...");
        // Fallback sur le cache local (Ã‰TAPE 5)
        const cached = loadFromLocalCache(CACHE_KEYS.ST);
        if (cached && cached.length > 0) {
          window.sousTraitants = cached;
          sousTraitants = cached;
          if (typeof renderAnnuaire === "function") renderAnnuaire();
          if (typeof renderDashboard === "function") renderDashboard();
          console.log("ğŸ“‚ Sous-traitants chargÃ©s depuis CACHE:", sousTraitants.length);
        } else {
          console.error("âŒ Aucune donnÃ©e en cache");
          throw err;
        }
      }
    }

    // Helper: GÃ©nÃ©rer un logo emoji basÃ© sur le mÃ©tier
    function getMetierLogo(metier) {
      if (!metier) return 'ğŸ¢';
      const m = metier.toLowerCase();
      if (m.includes('Ã©lectric')) return 'âš¡';
      if (m.includes('climati') || m.includes('cvc')) return 'â„ï¸';
      if (m.includes('plomb')) return 'ğŸ”§';
      if (m.includes('maÃ§on')) return 'ğŸ§±';
      if (m.includes('peint')) return 'ğŸ¨';
      if (m.includes('menuise')) return 'ğŸªµ';
      if (m.includes('carrel')) return 'ğŸ”²';
      if (m.includes('couv') || m.includes('toit')) return 'ğŸ ';
      if (m.includes('serru')) return 'ğŸ”©';
      if (m.includes('transport')) return 'ğŸš›';
      return 'ğŸ¢';
    }

    async function createSousTraitantInDB(st) {
      // Mapper de la structure UI vers la structure API
      const apiData = {
        nom: st.nom,
        metier: st.corpsMetier || st.metier,
        siret: st.siret || null,
        email: st.email || null,
        tel: st.tel || null,
        ville: st.ville || null,
        note: st.note || null
      };
      
      // Mode offline (Ã‰TAPE 5)
      if (!isOnline) {
        addToOfflineQueue({ type: 'CREATE_ST', data: apiData });
        // Ajouter localement avec un ID temporaire
        const tempST = {
          ...st,
          id: 'temp_' + Date.now(),
          logo: getMetierLogo(apiData.metier),
          corpsMetier: apiData.metier,
          _pending: true
        };
        sousTraitants.push(tempST);
        saveToLocalCache(CACHE_KEYS.ST, sousTraitants);
        if (typeof renderAnnuaire === "function") renderAnnuaire();
        showToast('ğŸ“ Sous-traitant enregistrÃ© (sync au retour en ligne)', 'info');
        return;
      }
      
      await apiFetch("/st", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(apiData),
      });
      await loadSousTraitantsFromDB();
    }

    async function updateSousTraitantInDB(id, st) {
      const apiData = {
        nom: st.nom,
        metier: st.corpsMetier || st.metier,
        siret: st.siret || null,
        email: st.email || null,
        tel: st.tel || null,
        ville: st.ville || null,
        note: st.note || null
      };
      
      // Mode offline (Ã‰TAPE 5)
      if (!isOnline) {
        addToOfflineQueue({ type: 'UPDATE_ST', id: id, data: apiData });
        // Mettre Ã  jour localement
        const idx = sousTraitants.findIndex(s => s.id === id);
        if (idx !== -1) {
          sousTraitants[idx] = { ...sousTraitants[idx], ...st, _pending: true };
          saveToLocalCache(CACHE_KEYS.ST, sousTraitants);
          if (typeof renderAnnuaire === "function") renderAnnuaire();
        }
        showToast('ğŸ“ Modification enregistrÃ©e (sync au retour en ligne)', 'info');
        return;
      }
      
      await apiFetch("/st/" + id, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(apiData),
      });
      await loadSousTraitantsFromDB();
    }

    async function deleteSousTraitantInDB(id) {
      // Mode offline (Ã‰TAPE 5)
      if (!isOnline) {
        addToOfflineQueue({ type: 'DELETE_ST', id: id });
        // Supprimer localement
        sousTraitants = sousTraitants.filter(s => s.id !== id);
        window.sousTraitants = sousTraitants;
        saveToLocalCache(CACHE_KEYS.ST, sousTraitants);
        if (typeof renderAnnuaire === "function") renderAnnuaire();
        showToast('ğŸ—‘ï¸ Suppression enregistrÃ©e (sync au retour en ligne)', 'info');
        return;
      }
      
      await apiFetch("/st/" + id, { method: "DELETE" });
      await loadSousTraitantsFromDB();
    }

    // ========== FONCTIONS DB - CHANTIERS ==========
    async function loadChantiersFromDB() {
      try {
        const data = await apiFetch("/chantiers");
        // Mapper les donnÃ©es de l'API vers la structure UI
        const mappedItems = (data.items || []).map(item => ({
          id: item.id,
          nom: item.nom,
          adresse: item.adresse || '',
          montantTotal: item.montant || 0,
          client: item.client || '',
          statut: item.statut || 'en_cours',
          conducteur: 'Non assignÃ©', // Ã€ amÃ©liorer plus tard
          avancement: 0, // Ã€ calculer depuis les situations
          entrepriseId: item.entrepriseId
        }));
        window.chantiers = mappedItems;
        chantiers = window.chantiers;
        // Sauvegarder dans le cache local (Ã‰TAPE 5)
        saveToLocalCache(CACHE_KEYS.CHANTIERS, mappedItems);
        if (typeof renderChantiers === "function") renderChantiers();
        if (typeof renderDashboard === "function") renderDashboard();
        console.log("âœ… Chantiers chargÃ©s depuis API:", chantiers.length);
      } catch (err) {
        console.warn("âš ï¸ API non disponible, chargement depuis cache local...");
        // Fallback sur le cache local (Ã‰TAPE 5)
        const cached = loadFromLocalCache(CACHE_KEYS.CHANTIERS);
        if (cached && cached.length > 0) {
          window.chantiers = cached;
          chantiers = cached;
          if (typeof renderChantiers === "function") renderChantiers();
          if (typeof renderDashboard === "function") renderDashboard();
          console.log("ğŸ“‚ Chantiers chargÃ©s depuis CACHE:", chantiers.length);
        } else {
          console.error("âŒ Aucune donnÃ©e en cache");
          throw err;
        }
      }
    }

    async function createChantierInDB(chantier) {
      // Mapper de la structure UI vers la structure API
      const apiData = {
        nom: chantier.nom,
        client: chantier.client || null,
        adresse: chantier.adresse || null,
        montant: chantier.montantTotal || chantier.montant || null,
        statut: chantier.statut || 'en_cours'
      };
      
      // Mode offline (Ã‰TAPE 5)
      if (!isOnline) {
        addToOfflineQueue({ type: 'CREATE_CHANTIER', data: apiData });
        // Ajouter localement avec un ID temporaire
        const tempChantier = {
          ...chantier,
          id: 'temp_' + Date.now(),
          montantTotal: apiData.montant,
          _pending: true
        };
        chantiers.push(tempChantier);
        saveToLocalCache(CACHE_KEYS.CHANTIERS, chantiers);
        if (typeof renderChantiers === "function") renderChantiers();
        showToast('ğŸ“ Chantier enregistrÃ© (sync au retour en ligne)', 'info');
        return;
      }
      
      await apiFetch("/chantiers", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(apiData),
      });
      await loadChantiersFromDB();
    }

    async function updateChantierInDB(id, chantier) {
      const apiData = {
        nom: chantier.nom,
        client: chantier.client || null,
        adresse: chantier.adresse || null,
        montant: chantier.montantTotal || chantier.montant || null,
        statut: chantier.statut || null
      };
      
      // Mode offline (Ã‰TAPE 5)
      if (!isOnline) {
        addToOfflineQueue({ type: 'UPDATE_CHANTIER', id: id, data: apiData });
        // Mettre Ã  jour localement
        const idx = chantiers.findIndex(c => c.id === id);
        if (idx !== -1) {
          chantiers[idx] = { ...chantiers[idx], ...chantier, _pending: true };
          saveToLocalCache(CACHE_KEYS.CHANTIERS, chantiers);
          if (typeof renderChantiers === "function") renderChantiers();
        }
        showToast('ğŸ“ Modification enregistrÃ©e (sync au retour en ligne)', 'info');
        return;
      }
      
      await apiFetch("/chantiers/" + id, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(apiData),
      });
      await loadChantiersFromDB();
    }

    async function deleteChantierInDB(id) {
      // Mode offline (Ã‰TAPE 5)
      if (!isOnline) {
        addToOfflineQueue({ type: 'DELETE_CHANTIER', id: id });
        // Supprimer localement
        chantiers = chantiers.filter(c => c.id !== id);
        window.chantiers = chantiers;
        saveToLocalCache(CACHE_KEYS.CHANTIERS, chantiers);
        if (typeof renderChantiers === "function") renderChantiers();
        showToast('ğŸ—‘ï¸ Suppression enregistrÃ©e (sync au retour en ligne)', 'info');
        return;
      }
      
      await apiFetch("/chantiers/" + id, { method: "DELETE" });
      await loadChantiersFromDB();
    }

    // ========== SYNC DEPUIS API ==========
    async function syncAllFromAPI() {
      // Traiter d'abord la queue offline si on est en ligne
      if (isOnline) {
        await processOfflineQueue();
      }
      
      try {
        await Promise.all([
          loadSousTraitantsFromDB(),
          loadChantiersFromDB()
        ]);
        // Sauvegarder le timestamp de derniÃ¨re sync
        localStorage.setItem(CACHE_KEYS.LAST_SYNC, Date.now().toString());
        showToast("âœ… DonnÃ©es synchronisÃ©es avec le serveur", "success");
        return true;
      } catch (err) {
        console.warn("âš ï¸ Mode hors-ligne - donnÃ©es locales utilisÃ©es:", err);
        return false;
      }
    }

    // ========== DONNÃ‰ES ==========
    // Identifiants de connexion (correspondant au seed Prisma)
    const AUTH_CREDENTIALS = {
      email: 'admin@btpconnect.local',
      password: 'BtpConnect2026!'
    };
    
    let isLoggedIn = false;
    
    let users = [
      { id: 1, nom: 'JÃ©rÃ©mie Durand', email: 'admin@btpconnect.local', role: 'admin', password: 'BtpConnect2026!' },
      { id: 2, nom: 'Jean Dupont', email: 'conducteur@btpconnect.local', role: 'conducteur', password: 'BtpConnect2026!' },
      { id: 3, nom: 'Marie Leroy', email: 'comptable@btpconnect.local', role: 'comptable', password: 'BtpConnect2026!' }
    ];
    
    let sousTraitants = [
      { id: 1, nom: "Ã‰lectricitÃ© Durand", logo: "âš¡", corpsMetier: "Ã‰lectricitÃ©", note: 4.8, ville: "Paris", siret: "412 345 678 00012", email: "contact@durand-elec.fr" },
      { id: 2, nom: "CVC Martin & Fils", logo: "â„ï¸", corpsMetier: "Climatisation", note: 4.5, ville: "Boulogne", siret: "523 456 789 00023", email: "info@cvc-martin.fr" },
      { id: 3, nom: "Plomberie Sanchez", logo: "ğŸ”§", corpsMetier: "Plomberie", note: 4.2, ville: "Montreuil", siret: "634 567 890 00034", email: "sanchez@mail.fr" },
      { id: 4, nom: "MaÃ§onnerie Lefebvre", logo: "ğŸ§±", corpsMetier: "MaÃ§onnerie", note: 4.6, ville: "Lille", siret: "745 678 901 00045", email: "contact@lefebvre.fr" },
      { id: 5, nom: "Peinture Bernard", logo: "ğŸ¨", corpsMetier: "Peinture", note: 4.9, ville: "Versailles", siret: "856 789 012 00056", email: "bernard@mail.fr" },
      { id: 6, nom: "Transport Express", logo: "ğŸš›", corpsMetier: "Transport", note: 4.4, ville: "Gennevilliers", siret: "967 890 123 00067", email: "express@transport.fr" }
    ];

    let chantiers = [
      { id: 1, nom: "RÃ©sidence Les Tilleuls", adresse: "12 rue des Fleurs, 75016 Paris", montantTotal: 450000, client: "SCI Les Tilleuls", statut: "en_cours", conducteur: "Jean Dupont", avancement: 45 },
      { id: 2, nom: "Immeuble Green Park", adresse: "45 avenue de la RÃ©publique, 92100 Boulogne", montantTotal: 680000, client: "Nexity Immobilier", statut: "en_cours", conducteur: "Paul Martin", avancement: 28 },
      { id: 3, nom: "Centre Commercial Ã‰toile", adresse: "Place de l'Ã‰toile, 93200 Saint-Denis", montantTotal: 1200000, client: "Unibail-Rodamco", statut: "en_cours", conducteur: "Jean Dupont", avancement: 47 }
    ];

    let contrats = [
      { id: 1, chantierId: 1, stId: 1, montantMarche: 85000, lot: "Ã‰lectricitÃ© CFO/CFA" },
      { id: 2, chantierId: 1, stId: 5, montantMarche: 35000, lot: "Peinture" },
      { id: 3, chantierId: 2, stId: 2, montantMarche: 120000, lot: "CVC" },
      { id: 4, chantierId: 2, stId: 3, montantMarche: 45000, lot: "Plomberie" },
      { id: 5, chantierId: 3, stId: 1, montantMarche: 150000, lot: "Ã‰lectricitÃ©" },
      { id: 6, chantierId: 3, stId: 5, montantMarche: 55000, lot: "Peinture" },
      { id: 7, chantierId: 3, stId: 4, montantMarche: 280000, lot: "MaÃ§onnerie" }
    ];

    let situations = [
      { id: 1, flux: "flux1", contratId: 1, numero: 1, date: "2025-11-15", montantMois: 25000, cumulAnt: 0, statut: "validee" },
      { id: 2, flux: "flux1", contratId: 1, numero: 2, date: "2025-12-10", montantMois: 20050, cumulAnt: 25000, statut: "validee" },
      { id: 3, flux: "flux1", contratId: 1, numero: 3, date: "2026-01-10", montantMois: 18000, cumulAnt: 45050, statut: "soumise" },
      { id: 4, flux: "flux1", contratId: 2, numero: 1, date: "2025-12-05", montantMois: 12000, cumulAnt: 0, statut: "validee" },
      { id: 5, flux: "flux1", contratId: 2, numero: 2, date: "2026-01-12", montantMois: 8500, cumulAnt: 12000, statut: "soumise" },
      { id: 6, flux: "flux1", contratId: 3, numero: 1, date: "2025-11-20", montantMois: 32000, cumulAnt: 0, statut: "validee" },
      { id: 7, flux: "flux1", contratId: 4, numero: 1, date: "2025-12-01", montantMois: 15000, cumulAnt: 0, statut: "validee" },
      { id: 8, flux: "flux1", contratId: 5, numero: 1, date: "2025-12-18", montantMois: 45000, cumulAnt: 0, statut: "validee" },
      { id: 9, flux: "flux1", contratId: 6, numero: 1, date: "2026-01-08", montantMois: 22000, cumulAnt: 0, statut: "soumise" },
      { id: 10, flux: "flux1", contratId: 7, numero: 1, date: "2025-12-15", montantMois: 80000, cumulAnt: 0, statut: "validee" },
      { id: 11, flux: "flux1", contratId: 3, numero: 2, date: "2026-01-18", montantMois: 28000, cumulAnt: 32000, statut: "soumise" },
      { id: 20, flux: "flux1", contratId: 2, numero: 3, date: "2026-01-05", montantMois: 5000, cumulAnt: 20500, statut: "refusee", commentaireRefus: "Montants non conformes" },
      { id: 12, flux: "flux2", chantierId: 1, numero: 1, date: "2025-11-25", montantMois: 95000, cumulAnt: 0, statut: "validee" },
      { id: 13, flux: "flux2", chantierId: 1, numero: 2, date: "2025-12-20", montantMois: 85000, cumulAnt: 95000, statut: "validee" },
      { id: 14, flux: "flux2", chantierId: 2, numero: 1, date: "2025-12-15", montantMois: 120000, cumulAnt: 0, statut: "validee" },
      { id: 15, flux: "flux2", chantierId: 2, numero: 2, date: "2026-01-10", montantMois: 75000, cumulAnt: 120000, statut: "soumise" },
      { id: 16, flux: "flux2", chantierId: 3, numero: 1, date: "2025-11-30", montantMois: 250000, cumulAnt: 0, statut: "validee" },
      { id: 17, flux: "flux2", chantierId: 3, numero: 2, date: "2025-12-28", montantMois: 320000, cumulAnt: 250000, statut: "validee" }
    ];

    let factures = [
      { id: 1, type: 'recue', numero: 'FE-2025-0142', chantierId: 1, stId: 1, montantHT: 25000, dateEcheance: '2025-12-20', statut: 'payee' },
      { id: 2, type: 'recue', numero: 'FE-2025-0156', chantierId: 1, stId: 1, montantHT: 20050, dateEcheance: '2026-01-15', statut: 'validee' },
      { id: 3, type: 'recue', numero: 'FE-2025-0089', chantierId: 1, stId: 5, montantHT: 12000, dateEcheance: '2026-01-05', statut: 'validee' },
      { id: 4, type: 'recue', numero: 'FE-2025-0201', chantierId: 2, stId: 2, montantHT: 32000, dateEcheance: '2025-12-28', statut: 'payee' },
      { id: 5, type: 'recue', numero: 'FE-2025-0215', chantierId: 2, stId: 3, montantHT: 15000, dateEcheance: '2026-01-08', statut: 'validee' },
      { id: 6, type: 'recue', numero: 'FE-2025-0245', chantierId: 3, stId: 1, montantHT: 45000, dateEcheance: '2026-01-22', statut: 'recue' },
      { id: 8, type: 'emise', numero: 'FC-2025-0045', chantierId: 1, montantHT: 95000, dateEcheance: '2025-12-28', statut: 'encaissee' },
      { id: 9, type: 'emise', numero: 'FC-2025-0052', chantierId: 1, montantHT: 85000, dateEcheance: '2026-01-22', statut: 'envoyee' },
      { id: 10, type: 'emise', numero: 'FC-2025-0048', chantierId: 2, montantHT: 120000, dateEcheance: '2026-01-18', statut: 'encaissee' },
      { id: 11, type: 'emise', numero: 'FC-2025-0061', chantierId: 3, montantHT: 250000, dateEcheance: '2026-01-05', statut: 'encaissee' },
      { id: 12, type: 'emise', numero: 'FC-2025-0068', chantierId: 3, montantHT: 320000, dateEcheance: '2026-02-02', statut: 'creee' }
    ];

    let notifications = [
      { id: 1, message: '4 Situations en attente', icon: 'ğŸ“‹', color: 'amber', lu: false, tab: 'situations' },
      { id: 2, message: '2 Factures en retard', icon: 'ğŸ’¶', color: 'red', lu: false, tab: 'facturation' },
      { id: 3, message: '3 Documents Ã  renouveler', icon: 'ğŸ“„', color: 'sky', lu: false, tab: 'documents' }
    ];

    // Ã‰tat
    let annuaireMode = 'actifs';
    let currentFlux = 'flux1';
    let currentFactFlux = 'recues';
    let docTypeFilter = '';

    // ========== UTILS ==========
    function formatDate(d) { return d ? new Date(d).toLocaleDateString('fr-FR') : '-'; }
    function formatMontant(m) { return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(m); }
    function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
    function showToast(msg) { const t = document.createElement('div'); t.className = 'toast'; t.textContent = msg; document.body.appendChild(t); setTimeout(() => t.remove(), 3000); }
    function openModal(id) { document.getElementById(id)?.classList.add('active'); renderModalContent(id); }
    function closeModal(id) { document.getElementById(id)?.classList.remove('active'); }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

    // ========== THEME ==========
    function toggleTheme() { setTheme(document.body.classList.contains('light-theme') ? 'dark' : 'light'); }
    
    function toggleThemeMenu() {
      const menu = document.getElementById('themeMenu');
      menu.classList.toggle('hidden');
      // Fermer le menu si on clique ailleurs
      if (!menu.classList.contains('hidden')) {
        setTimeout(() => {
          document.addEventListener('click', closeThemeMenuOnClickOutside, { once: true });
        }, 10);
      }
    }
    
    function closeThemeMenuOnClickOutside(e) {
      const menu = document.getElementById('themeMenu');
      if (!menu.contains(e.target) && !e.target.closest('.header-btn')) {
        menu.classList.add('hidden');
      }
    }
    
    function setTheme(theme) {
      // Supprimer tous les thÃ¨mes existants
      document.body.classList.remove('light-theme', 'ocean-theme', 'sunset-theme', 'midnight-theme');
      
      // Appliquer le nouveau thÃ¨me
      const themeIcons = { dark: 'ğŸŒ™', light: 'â˜€ï¸', ocean: 'ğŸŒŠ', sunset: 'ğŸŒ…', midnight: 'ğŸŒŒ' };
      
      if (theme !== 'dark') {
        document.body.classList.add(theme + '-theme');
      }
      
      document.getElementById('themeIcon').textContent = themeIcons[theme] || 'ğŸŒ™';
      document.getElementById('themeMenu')?.classList.add('hidden');
      localStorage.setItem('btp-theme', theme);
    }

    // ========== NOTIFICATIONS ==========
    function toggleNotifications() { openModal('modalNotifications'); }
    function renderNotifications() {
      const notifLu = notifications.filter(n => !n.lu);
      document.getElementById('notif-count').textContent = notifLu.length;
      document.getElementById('notif-count').style.display = notifLu.length ? 'flex' : 'none';
      document.getElementById('notificationsList').innerHTML = notifications.map(n => 
        `<div class="p-3 bg-${n.color}-500/10 border border-${n.color}-500/30 rounded-xl mb-3 cursor-pointer ${n.lu ? 'opacity-50' : ''}" 
              onclick="notifications.find(x=>x.id===${n.id}).lu=true; renderNotifications(); showTab('${n.tab}'); closeModal('modalNotifications')">
          <p class="font-medium text-${n.color}-400">${n.icon} ${n.message}</p>
          <p class="text-sm text-slate-400">Cliquez pour voir</p>
        </div>`
      ).join('');
    }
    function markAllRead() { notifications.forEach(n => n.lu = true); renderNotifications(); showToast('âœ“ MarquÃ©es lues'); }

    // ========== NAVIGATION ==========
    function showTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
      document.getElementById('tab-' + tabId)?.classList.remove('hidden');
      document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
      document.getElementById('menu-' + tabId)?.classList.add('active');
      
      const titles = { dashboard: ['Tableau de bord', "Vue d'ensemble"], annuaire: ['Annuaire', sousTraitants.length + ' ST'], 
        chantiers: ['Chantiers', chantiers.length + ' en cours'], situations: ['Situations', 'Suivi avancements'],
        analyse: ['Analyse IA', 'Comparaison devis'], facturation: ['Facturation', 'Gestion factures'],
        documents: ['Documents', 'Portail documentaire'], parametres: ['ParamÃ¨tres', 'Configuration'],
        admin: ['Administration', 'Gestion BDD & IA'] };
      document.getElementById('page-title').textContent = titles[tabId]?.[0] || tabId;
      document.getElementById('page-subtitle').textContent = titles[tabId]?.[1] || '';
      
      if (tabId === 'dashboard') renderDashboard();
      if (tabId === 'annuaire') renderAnnuaire();
      if (tabId === 'chantiers') renderChantiers();
      if (tabId === 'situations') { populateSituFilters(); renderSituations(); }
      if (tabId === 'facturation') renderFactures();
      if (tabId === 'documents') renderDocuments();
      if (tabId === 'analyse') initAnalyse();
      if (tabId === 'admin') updateAdminStats();
      
      document.getElementById('sidebar').classList.remove('open');
    }

    // ========== DASHBOARD ==========
    function renderDashboard() {
      document.getElementById('stat-chantiers').textContent = chantiers.length;
      document.getElementById('stat-situations').textContent = situations.filter(s => s.statut === 'soumise').length;
      document.getElementById('stat-ca').textContent = formatMontant(chantiers.reduce((s, c) => s + c.montantTotal, 0)).replace(' â‚¬', '');
      document.getElementById('stat-st').textContent = sousTraitants.length;

      // Avancement des chantiers avec barres de progression (style V7)
      document.getElementById('dashboardChantiers').innerHTML = chantiers.map(c => {
        const facture = situations.filter(s => s.flux === 'flux2' && s.chantierId === c.id && s.statut === 'validee').reduce((a, b) => a + b.montantMois, 0);
        const pct = Math.round(facture / c.montantTotal * 100);
        const color = pct >= 75 ? 'emerald' : pct >= 50 ? 'amber' : 'violet';
        return `<div>
          <div class="flex justify-between text-sm mb-1">
            <span class="text-slate-300">${c.nom}</span>
            <span class="text-slate-400">${pct}% â€¢ ${formatMontant(facture)} / ${formatMontant(c.montantTotal)}</span>
          </div>
          <div class="progress-bar h-3">
            <div class="progress-fill bg-${color}-500" style="width:${pct}%"></div>
          </div>
        </div>`;
      }).join('');

      // Situations en attente
      const attente = situations.filter(s => s.statut === 'soumise').slice(0, 5);
      document.getElementById('situationsAttente').innerHTML = attente.length ? attente.map(s => {
        const info = getSituInfo(s);
        return `<div class="flex items-center justify-between p-4 bg-slate-800/30 rounded-xl cursor-pointer hover:bg-slate-700/30" onclick="openSituationDetail(${s.id})">
          <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-amber-500/20 rounded-xl flex items-center justify-center"><span>${s.flux === 'flux1' ? 'ğŸ“¥' : 'ğŸ“¤'}</span></div>
            <div><p class="font-medium text-slate-200">${info.label}</p><p class="text-sm text-slate-500">Situation nÂ°${s.numero} - ${formatDate(s.date)}</p></div>
          </div>
          <div class="flex items-center gap-3">
            <span class="text-lg font-bold text-violet-400">${formatMontant(s.montantMois)}</span>
            <button onclick="event.stopPropagation(); validerSituation(${s.id})" class="p-2 btn-success rounded-lg text-white">âœ“</button>
            <button onclick="event.stopPropagation(); refuserSituation(${s.id})" class="p-2 btn-danger rounded-lg text-white">âœ—</button>
          </div>
        </div>`;
      }).join('') : '<p class="text-slate-500 text-center py-4">Aucune situation en attente</p>';

      initCharts();
    }

    function getSituInfo(s) {
      if (s.flux === 'flux1') {
        const contrat = contrats.find(c => c.id === s.contratId);
        const st = sousTraitants.find(st => st.id === contrat?.stId);
        const ch = chantiers.find(c => c.id === contrat?.chantierId);
        return { label: `${st?.nom || 'ST'} - ${ch?.nom || 'Chantier'}`, st, chantier: ch?.nom, contrat };
      } else {
        const ch = chantiers.find(c => c.id === s.chantierId);
        return { label: `${ch?.nom || 'Chantier'} â†’ ${ch?.client || 'Client'}`, chantier: ch?.nom };
      }
    }

    function initCharts() {
      // Graphique facturations mensuelles (style V7)
      const ctx = document.getElementById('chartFacturations');
      if (ctx && !ctx.chart) {
        ctx.chart = new Chart(ctx, {
          type: 'bar',
          data: { 
            labels: ['Nov. 2025', 'DÃ©c. 2025', 'Jan. 2026'], 
            datasets: [
              { label: 'Sous-Traitants', data: [102000, 79050, 48500], backgroundColor: '#8b5cf6' }, 
              { label: 'Client', data: [345000, 205000, 75000], backgroundColor: '#06b6d4' }
            ] 
          },
          options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            plugins: { legend: { labels: { color: '#94a3b8' } } }, 
            scales: { 
              x: { ticks: { color: '#64748b' } }, 
              y: { ticks: { color: '#64748b', callback: v => (v/1000)+'Kâ‚¬' } } 
            } 
          }
        });
      }
    }

    // ========== ANNUAIRE ==========
    function setAnnuaireMode(mode) {
      annuaireMode = mode;
      // Mise Ã  jour des boutons de bascule
      const btnGeneral = document.getElementById('btn-mode-general');
      const btnPrive = document.getElementById('btn-mode-prive');
      if (btnGeneral && btnPrive) {
        if (mode === 'recherche') {
          btnGeneral.classList.add('bg-violet-600', 'text-white');
          btnGeneral.classList.remove('text-slate-400');
          btnPrive.classList.remove('bg-violet-600', 'text-white');
          btnPrive.classList.add('text-slate-400');
        } else {
          btnPrive.classList.add('bg-violet-600', 'text-white');
          btnPrive.classList.remove('text-slate-400');
          btnGeneral.classList.remove('bg-violet-600', 'text-white');
          btnGeneral.classList.add('text-slate-400');
        }
      }
      // Afficher/masquer les zones de filtres
      const zoneRecherche = document.getElementById('zoneRechercheGenerale');
      const zoneFiltres = document.getElementById('zoneFiltresPrive');
      if (zoneRecherche) zoneRecherche.classList.toggle('hidden', mode !== 'recherche');
      if (zoneFiltres) zoneFiltres.classList.toggle('hidden', mode === 'recherche');
      renderAnnuaire();
    }
    
    async function rechercherSirene() {
      const query = document.getElementById('sireneSearchInput')?.value.trim();
      if (!query || query.length < 3) {
        showToast('âš ï¸ Saisissez au moins 3 caractÃ¨res');
        return;
      }
      const loading = document.getElementById('sireneLoading');
      const content = document.getElementById('annuaireContent');
      if (loading) loading.classList.remove('hidden');
      if (content) content.innerHTML = '';
      
      try {
        // Simulation API SIRENE - en production, appeler l'API rÃ©elle
        await new Promise(r => setTimeout(r, 1200));
        const region = document.getElementById('apiRegion')?.value || '';
        const naf = document.getElementById('apiNaf')?.value || '';
        const effectif = document.getElementById('apiEffectif')?.value || '';
        
        // RÃ©sultats simulÃ©s
        const results = [
          { nom: query.charAt(0).toUpperCase() + query.slice(1) + ' Construction SARL', siret: '412 345 678 00012', ville: 'Paris 15e', naf: '41.20A - Construction bÃ¢timents', effectif: '10-19 salariÃ©s', adresse: '25 rue de la Paix, 75015 Paris' },
          { nom: query.charAt(0).toUpperCase() + query.slice(1) + ' BTP Services', siret: '523 456 789 00023', ville: 'Boulogne-Billancourt', naf: '43.21A - Travaux Ã©lectriques', effectif: '3-5 salariÃ©s', adresse: '12 avenue Victor Hugo, 92100 Boulogne' },
          { nom: 'Ets ' + query.charAt(0).toUpperCase() + query.slice(1) + ' & Fils', siret: '634 567 890 00034', ville: 'Versailles', naf: '43.22A - Plomberie', effectif: '6-9 salariÃ©s', adresse: '8 bd du Roi, 78000 Versailles' },
        ];
        
        if (loading) loading.classList.add('hidden');
        
        if (content) {
          content.innerHTML = results.map(r => {
            const escapedNom = escapeHtml(r.nom);
            const escapedVille = escapeHtml(r.ville);
            const escapedNaf = escapeHtml(r.naf);
            const escapedEffectif = escapeHtml(r.effectif);
            const escapedAdresse = escapeHtml(r.adresse);
            return `
            <div class="card p-4 hover:border-violet-500/50 transition-all">
              <div class="flex items-start gap-3 mb-3">
                <div class="w-12 h-12 bg-blue-500/20 rounded-xl flex items-center justify-center text-2xl">ğŸ¢</div>
                <div class="flex-1">
                  <h4 class="font-semibold text-slate-200">${escapedNom}</h4>
                  <p class="text-sm text-slate-500">${escapedNaf}</p>
                </div>
                <span class="badge badge-info">SIRENE</span>
              </div>
              <div class="grid grid-cols-2 gap-2 text-sm mb-3">
                <div><span class="text-slate-500">SIRET:</span> <span class="text-slate-300">${r.siret}</span></div>
                <div><span class="text-slate-500">Ville:</span> <span class="text-slate-300">${escapedVille}</span></div>
                <div><span class="text-slate-500">Effectif:</span> <span class="text-slate-300">${escapedEffectif}</span></div>
              </div>
              <p class="text-xs text-slate-500">ğŸ“ ${escapedAdresse}</p>
              <button onclick="importerEntreprise('${r.siret}', '${escapedNom.replace(/'/g, "\\'")}', '${escapedVille.replace(/'/g, "\\'")}', '${escapedNaf.replace(/'/g, "\\'")}', '${escapedEffectif.replace(/'/g, "\\'")}', '${escapedAdresse.replace(/'/g, "\\'")}')" class="w-full mt-3 px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg text-white text-sm">â• Ajouter Ã  mon annuaire</button>
            </div>
          `}).join('') || '<div class="col-span-full text-center py-8 text-slate-400">Aucun rÃ©sultat trouvÃ©</div>';
        }
      } catch (error) {
        if (loading) loading.classList.add('hidden');
        if (content) content.innerHTML = '<div class="col-span-full text-center py-8 text-red-400">Erreur lors de la recherche. VÃ©rifiez votre connexion.</div>';
      }
    }
    
    function importerEntreprise(siret, nom, ville, naf, effectif, adresse) {
      // VÃ©rifier si dÃ©jÃ  prÃ©sent
      const exists = sousTraitants.find(st => st.siret === siret);
      if (exists) {
        showToast('âš ï¸ Cette entreprise est dÃ©jÃ  dans votre annuaire', 'warning');
        return;
      }
      
      // DÃ©duire le corps de mÃ©tier depuis le code NAF
      const metierFromNaf = {
        '43.21A': 'Ã‰lectricitÃ©',
        '43.22A': 'Plomberie',
        '43.22B': 'Climatisation',
        '43.34Z': 'Peinture',
        '43.31Z': 'PlÃ¢trerie',
        '43.32A': 'Menuiserie',
        '43.32B': 'Menuiserie',
        '43.33Z': 'Carrelage',
        '43.91A': 'Charpente',
        '43.91B': 'Couverture',
        '41.20A': 'MaÃ§onnerie',
        '41.20B': 'MaÃ§onnerie',
        '42.11Z': 'VRD'
      };
      
      const nafCode = naf ? naf.split(' - ')[0] : '';
      const corpsMetier = metierFromNaf[nafCode] || 'Autre';
      
      // CrÃ©er le nouveau ST
      const newST = {
        id: Date.now(),
        nom: nom || 'Entreprise importÃ©e',
        siret: siret.replace(/\s/g, ''),
        corpsMetier: corpsMetier,
        ville: ville || '',
        adresse: adresse || '',
        effectif: effectif || '',
        naf: naf || '',
        telephone: '',
        email: '',
        note: 0,
        logo: 'ğŸ¢',
        dansAnnuairePrivate: true,
        dateAjout: new Date().toISOString()
      };
      
      sousTraitants.push(newST);
      
      // Sauvegarder en local
      localStorage.setItem('btp-st', JSON.stringify(sousTraitants));
      
      showToast('âœ… Entreprise ajoutÃ©e Ã  votre annuaire privÃ©', 'success');
      addAdminLog('success', `ST importÃ©: ${nom}`);
      
      setAnnuaireMode('actifs');
      renderAnnuaire();
    }

    function renderAnnuaire() {
      const search = document.getElementById('searchAnnuaire')?.value.toLowerCase() || '';
      const metierFilter = document.getElementById('filterCorpsMetier')?.value || '';
      
      // Stats
      document.getElementById('annuaire-total').textContent = sousTraitants.length;
      document.getElementById('annuaire-actifs').textContent = sousTraitants.filter(s => s.dansAnnuairePrivate !== false).length;
      document.getElementById('annuaire-contrats').textContent = contrats.length;
      document.getElementById('annuaire-note').textContent = sousTraitants.length > 0 ? (sousTraitants.reduce((s, st) => s + st.note, 0) / sousTraitants.length).toFixed(1) : '0';

      if (annuaireMode === 'recherche') {
        if (!search || search.length < 3) {
          document.getElementById('annuaireContent').innerHTML = '<div class="col-span-full text-center py-12"><span class="text-6xl">ğŸ”</span><p class="text-slate-400 mt-4">Saisissez au moins 3 caractÃ¨res pour rechercher dans la base SIRENE</p></div>';
          return;
        }
        searchAPI();
        return;
      }
      
      // Mode annuaire privÃ© - Style V7
      let data = sousTraitants.filter(st => st.dansAnnuairePrivate !== false);
      
      // Filtre recherche
      if (search) {
        data = data.filter(st => {
          const nomMatch = st.nom.toLowerCase().includes(search);
          const metierMatch = st.corpsMetier.toLowerCase().includes(search);
          const villeMatch = st.ville && st.ville.toLowerCase().includes(search);
          const siretMatch = st.siret && st.siret.toLowerCase().replace(/\s/g, '').includes(search.replace(/\s/g, ''));
          return nomMatch || metierMatch || villeMatch || siretMatch;
        });
      }
      
      // Filtre corps de mÃ©tier
      if (metierFilter) {
        data = data.filter(st => st.corpsMetier.includes(metierFilter));
      }
      
      document.getElementById('annuaireContent').innerHTML = data.map(st => {
        const stContrats = contrats.filter(c => c.stId === st.id);
        const totalMarche = stContrats.reduce((a, b) => a + b.montantMarche, 0);
        const nbAvis = st.avis ? st.avis.length : 0;
        
        return `<div class="card p-5 cursor-pointer hover:border-violet-500/40 transition-all" onclick="openSTDetail(${st.id})">
          <div class="flex gap-4">
            <div class="w-16 h-16 bg-slate-800 rounded-2xl flex items-center justify-center text-3xl">${st.logo}</div>
            <div class="flex-1">
              <div class="flex items-start justify-between">
                <div>
                  <h3 class="font-semibold text-lg text-slate-100">${escapeHtml(st.nom)}</h3>
                  <p class="text-sm text-slate-500">${st.corpsMetier}</p>
                </div>
                <div class="flex items-center gap-1">
                  <span class="text-amber-400">â˜…</span>
                  <span class="text-sm font-medium text-amber-400">${st.note}</span>
                  ${nbAvis > 0 ? `<span class="text-xs text-slate-500">(${nbAvis})</span>` : ''}
                </div>
              </div>
              <div class="flex items-center gap-4 mt-2 text-sm flex-wrap">
                <span class="text-slate-400">ğŸ“ ${st.ville || 'Non renseignÃ©'}</span>
                ${st.siret ? `<span class="text-slate-500 text-xs">SIRET: ${st.siret}</span>` : ''}
                ${stContrats.length > 0 ? `<span class="text-violet-400">ğŸ“‹ ${stContrats.length} contrat(s)</span>` : ''}
                ${totalMarche > 0 ? `<span class="text-emerald-400">${formatMontant(totalMarche)}</span>` : ''}
              </div>
            </div>
          </div>
        </div>`;
      }).join('') || '<div class="col-span-full text-center py-8 text-slate-500">Aucune entreprise dans votre annuaire privÃ©</div>';
    }

    function filterAnnuaire() { if (annuaireMode === 'recherche') searchAPI(); else renderAnnuaire(); }

    async function searchAPI() {
      const q = document.getElementById('searchAnnuaire')?.value;
      if (!q || q.length < 3) return;
      const region = document.getElementById('apiRegion')?.value || '';
      const naf = document.getElementById('apiNaf')?.value || '';
      
      document.getElementById('annuaireContent').innerHTML = '<div class="col-span-full text-center py-12"><span class="animate-spin text-4xl">âš™ï¸</span></div>';
      try {
        let url = `https://recherche-entreprises.api.gouv.fr/search?q=${encodeURIComponent(q)}&page=1&per_page=12`;
        if (region) url += `&region=${region}`;
        if (naf) url += `&activite_principale=${naf}`;
        
        const res = await fetch(url);
        const data = await res.json();
        if (data.results?.length) {
          document.getElementById('annuaireContent').innerHTML = data.results.map(e => `
            <div class="card p-4">
              <h4 class="font-semibold text-slate-200 mb-2">${escapeHtml(e.nom_complet || '')}</h4>
              <p class="text-sm text-slate-500 mb-1">SIRET: ${e.siege?.siret || '-'}</p>
              <p class="text-sm text-slate-400 mb-3">ğŸ“ ${e.siege?.commune || '-'} (${e.siege?.code_postal || ''})</p>
              <button onclick="addSTFromAPI('${escapeHtml(e.nom_complet || '')}', '${e.siege?.siret || ''}', '${escapeHtml(e.siege?.commune || '')}')" class="w-full btn-primary px-3 py-2 rounded-lg text-white text-sm">+ Ajouter</button>
            </div>
          `).join('');
        } else document.getElementById('annuaireContent').innerHTML = '<p class="col-span-full text-center text-slate-500 py-8">Aucun rÃ©sultat</p>';
      } catch { document.getElementById('annuaireContent').innerHTML = '<p class="col-span-full text-center text-red-400 py-8">Erreur de recherche</p>'; }
    }

    function addSTFromAPI(nom, siret, ville) {
      sousTraitants.push({ id: Date.now(), nom, siret, ville, logo: 'ğŸ¢', corpsMetier: 'Ã€ dÃ©finir', note: 0, email: '' });
      showToast('âœ… ST ajoutÃ©'); setAnnuaireMode('actifs');
    }

    function addST() {
      const nom = document.getElementById('newSTNom').value;
      const metier = document.getElementById('newSTMetier').value;
      if (!nom || !metier) { showToast('âš ï¸ Nom et mÃ©tier requis'); return; }
      sousTraitants.push({ 
        id: Date.now(), 
        nom, 
        siret: document.getElementById('newSTSiret').value || '', 
        corpsMetier: metier, 
        logo: 'ğŸ¢', 
        note: 4, 
        ville: document.getElementById('newSTVille')?.value || '', 
        email: document.getElementById('newSTEmail')?.value || '',
        dansAnnuairePrivate: true, // Les fiches ajoutÃ©es manuellement sont toujours privÃ©es
        ajouteManuellement: true   // Marqueur pour identifier les fiches manuelles
      });
      closeModal('modalAddST'); 
      showToast('âœ… ST ajoutÃ© Ã  votre annuaire privÃ©'); 
      renderAnnuaire();
      addAdminLog('success', `Nouveau ST ajoutÃ©: ${nom}`);
    }

    function openSTDetail(id) {
      const st = sousTraitants.find(s => s.id === id);
      if (!st) return;
      const stContrats = contrats.filter(c => c.stId === id);
      const totalMarche = stContrats.reduce((sum, c) => sum + c.montantMarche, 0);
      const stFactures = factures.filter(f => f.stId === id);
      const totalFacture = stFactures.reduce((sum, f) => sum + f.montantHT, 0);
      
      // GÃ©nÃ©rer les avis (simulation)
      const avis = st.avis || [
        { note: 5, commentaire: "Excellent travail, trÃ¨s professionnel", auteur: "Jean Dupont", date: "2025-12-15", chantier: "RÃ©sidence Les Tilleuls" },
        { note: 4, commentaire: "Bon respect des dÃ©lais", auteur: "Paul Martin", date: "2025-11-20", chantier: "Immeuble Green Park" }
      ];
      
      document.getElementById('modalSTTitle').textContent = st.nom;
      document.getElementById('modalSTContent').innerHTML = `
        <div class="space-y-6">
          <!-- En-tÃªte avec logo et infos principales -->
          <div class="flex items-start gap-4">
            <div class="w-20 h-20 bg-slate-800 rounded-2xl flex items-center justify-center text-4xl">${st.logo}</div>
            <div class="flex-1">
              <h2 class="text-2xl font-bold text-slate-100">${st.nom}</h2>
              <p class="text-slate-400">${st.corpsMetier}</p>
              <div class="flex items-center gap-2 mt-2">
                <span class="text-amber-400">${'â˜…'.repeat(Math.floor(st.note))}${'â˜†'.repeat(5 - Math.floor(st.note))}</span>
                <span class="font-medium text-amber-400">${st.note}/5</span>
                <span class="text-xs text-slate-500">(${avis.length} avis)</span>
                ${st.dansAnnuairePrivate ? '<span class="badge badge-success ml-2">ğŸ”’ Annuaire privÃ©</span>' : ''}
              </div>
            </div>
          </div>
          
          <!-- Infos de contact -->
          <div class="grid grid-cols-2 gap-4">
            <div class="p-4 bg-slate-800/30 rounded-xl">
              <p class="text-sm text-slate-500 mb-1">ğŸ“ Ville</p>
              <p class="font-medium text-slate-200">${st.ville || 'Non renseignÃ©'}</p>
            </div>
            <div class="p-4 bg-slate-800/30 rounded-xl">
              <p class="text-sm text-slate-500 mb-1">ğŸ“ TÃ©lÃ©phone</p>
              <p class="font-medium text-slate-200">${st.tel || st.telephone || '01 23 45 67 89'}</p>
            </div>
            <div class="p-4 bg-slate-800/30 rounded-xl">
              <p class="text-sm text-slate-500 mb-1">ğŸ“§ Email</p>
              <p class="font-medium text-slate-200">${st.email || 'Non renseignÃ©'}</p>
            </div>
            <div class="p-4 bg-slate-800/30 rounded-xl">
              <p class="text-sm text-slate-500 mb-1">ğŸ¢ SIRET</p>
              <p class="font-medium text-slate-200">${st.siret || 'Non renseignÃ©'}</p>
            </div>
          </div>
          
          <!-- Statistiques -->
          <div class="grid grid-cols-3 gap-4">
            <div class="p-4 bg-violet-500/10 border border-violet-500/30 rounded-xl text-center">
              <p class="text-2xl font-bold text-violet-400">${stContrats.length}</p>
              <p class="text-sm text-slate-500">Contrats</p>
            </div>
            <div class="p-4 bg-emerald-500/10 border border-emerald-500/30 rounded-xl text-center">
              <p class="text-2xl font-bold text-emerald-400">${formatMontant(totalMarche)}</p>
              <p class="text-sm text-slate-500">Total marchÃ©s</p>
            </div>
            <div class="p-4 bg-sky-500/10 border border-sky-500/30 rounded-xl text-center">
              <p class="text-2xl font-bold text-sky-400">${formatMontant(totalFacture)}</p>
              <p class="text-sm text-slate-500">FacturÃ©</p>
            </div>
          </div>
          
          <!-- Notes internes -->
          ${st.notes ? `
          <div class="p-4 bg-slate-800/30 rounded-xl">
            <p class="text-sm text-slate-500 mb-1">ğŸ“ Notes internes</p>
            <p class="text-slate-300">${st.notes}</p>
          </div>
          ` : ''}
          
          <!-- Contrats en cours -->
          <div>
            <h4 class="font-semibold text-slate-200 mb-3">ğŸ“‹ Contrats en cours (${stContrats.length})</h4>
            <div class="space-y-2">
              ${stContrats.length ? stContrats.map(c => {
                const ch = chantiers.find(x => x.id === c.chantierId);
                return `<div class="p-3 bg-slate-800/30 rounded-xl flex justify-between items-center">
                  <div>
                    <p class="font-medium text-slate-200">${ch?.nom || 'Chantier'}</p>
                    <p class="text-sm text-slate-500">${c.lot}</p>
                  </div>
                  <span class="text-emerald-400 font-medium">${formatMontant(c.montantMarche)}</span>
                </div>`;
              }).join('') : '<p class="text-slate-500 text-center py-4">Aucun contrat actif</p>'}
            </div>
          </div>
          
          <!-- Section Avis -->
          <div>
            <div class="flex items-center justify-between mb-3">
              <h4 class="font-semibold text-slate-200">â­ Avis et Ã©valuations</h4>
              <button onclick="openModal('modalAddAvis')" class="text-sm text-violet-400 hover:text-violet-300">+ Ajouter un avis</button>
            </div>
            <div class="space-y-3 max-h-48 overflow-y-auto">
              ${avis.map(a => `
                <div class="p-3 bg-slate-800/30 rounded-xl">
                  <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                      <span class="text-amber-400 text-sm">${'â˜…'.repeat(a.note)}${'â˜†'.repeat(5 - a.note)}</span>
                      <span class="text-xs text-slate-500">â€¢ ${a.chantier || ''}</span>
                    </div>
                    <span class="text-xs text-slate-500">${a.date}</span>
                  </div>
                  <p class="text-sm text-slate-300 mb-1">${a.commentaire}</p>
                  <p class="text-xs text-slate-500">â€” ${a.auteur}</p>
                </div>
              `).join('')}
            </div>
          </div>
          
          <!-- Boutons d'action -->
          <div class="flex gap-3 pt-4 border-t border-slate-800">
            <button onclick="closeModal('modalDetailST')" class="flex-1 px-4 py-3 bg-slate-800 hover:bg-slate-700 rounded-xl text-slate-200">Fermer</button>
            <button onclick="editST(${st.id})" class="flex-1 px-4 py-3 bg-violet-600 hover:bg-violet-500 rounded-xl text-white">âœï¸ Modifier</button>
            <button onclick="toggleSTPrivate(${st.id})" class="px-4 py-3 ${st.dansAnnuairePrivate ? 'bg-slate-700 hover:bg-slate-600' : 'bg-emerald-600 hover:bg-emerald-500'} rounded-xl text-white">${st.dansAnnuairePrivate ? 'ğŸ”“ Retirer' : 'ğŸ”’ PrivÃ©'}</button>
          </div>
        </div>
      `;
      openModal('modalDetailST');
    }
    
    function editST(id) {
      const st = sousTraitants.find(s => s.id === id);
      if (!st) return;
      
      // VÃ©rifier si la fiche est dans l'annuaire privÃ© (seules celles-ci sont Ã©ditables)
      if (!st.dansAnnuairePrivate && !st.ajouteManuellement) {
        showToast('âš ï¸ Seules les fiches de l\'annuaire privÃ© sont modifiables', 'warning');
        return;
      }
      
      closeModal('modalDetailST');
      
      // Remplir le formulaire
      document.getElementById('editSTId').value = id;
      document.getElementById('editSTNom').value = st.nom || '';
      document.getElementById('editSTSiret').value = st.siret || '';
      document.getElementById('editSTMetier').value = st.corpsMetier || '';
      document.getElementById('editSTEmail').value = st.email || '';
      document.getElementById('editSTTel').value = st.tel || '';
      document.getElementById('editSTVille').value = st.ville || '';
      document.getElementById('editSTNote').value = st.note || 4;
      
      openModal('modalEditST');
    }
    
    function saveST() {
      const id = parseInt(document.getElementById('editSTId').value);
      const st = sousTraitants.find(s => s.id === id);
      if (!st) return;
      
      st.nom = document.getElementById('editSTNom').value;
      st.siret = document.getElementById('editSTSiret').value;
      st.corpsMetier = document.getElementById('editSTMetier').value;
      st.email = document.getElementById('editSTEmail').value;
      st.tel = document.getElementById('editSTTel').value;
      st.ville = document.getElementById('editSTVille').value;
      st.note = parseFloat(document.getElementById('editSTNote').value) || 4;
      
      closeModal('modalEditST');
      renderAnnuaire();
      showToast('âœ… Sous-traitant modifiÃ©', 'success');
      addAdminLog('info', `ST modifiÃ©: ${st.nom}`);
    }
    
    function deleteST() {
      const id = parseInt(document.getElementById('editSTId').value);
      const st = sousTraitants.find(s => s.id === id);
      if (!st) return;
      
      if (!confirm(`Supprimer ${st.nom} de votre annuaire privÃ© ?`)) return;
      
      const index = sousTraitants.findIndex(s => s.id === id);
      if (index > -1) {
        sousTraitants.splice(index, 1);
        closeModal('modalEditST');
        renderAnnuaire();
        showToast('ğŸ—‘ï¸ Sous-traitant supprimÃ©', 'success');
        addAdminLog('warning', `ST supprimÃ©: ${st.nom}`);
      }
    }
    
    function toggleSTPrivate(id) {
      const st = sousTraitants.find(s => s.id === id);
      if (st) {
        // Si dÃ©jÃ  dans l'annuaire privÃ© (ajoutÃ© manuellement), on ne peut pas le rendre non-privÃ©
        if (st.ajouteManuellement) {
          showToast('â„¹ï¸ Les fiches ajoutÃ©es manuellement sont toujours privÃ©es', 'info');
          return;
        }
        
        st.dansAnnuairePrivate = !st.dansAnnuairePrivate;
        closeModal('modalDetailST');
        renderAnnuaire();
        showToast(st.dansAnnuairePrivate ? 'ğŸ”’ AjoutÃ© Ã  votre annuaire privÃ©' : 'ğŸ”“ RetirÃ© de votre annuaire privÃ©');
      }
    }

    // ========== CHANTIERS ==========
    function renderChantiers() {
      const search = document.getElementById('searchChantiers')?.value.toLowerCase() || '';
      const statutFilter = document.getElementById('filterChantierStatut')?.value || '';
      
      let data = chantiers.filter(c => c.nom.toLowerCase().includes(search));
      if (statutFilter) {
        data = data.filter(c => c.statut === statutFilter);
      }
      
      // Mise Ã  jour des stats
      document.getElementById('chantiers-ca').textContent = formatMontant(chantiers.reduce((s, c) => s + c.montantTotal, 0)).replace(' â‚¬', '');

      document.getElementById('chantiersList').innerHTML = data.map(c => {
        const facture = situations.filter(s => s.flux === 'flux2' && s.chantierId === c.id && s.statut === 'validee').reduce((a, b) => a + b.montantMois, 0);
        const pct = Math.round(facture / c.montantTotal * 100);
        const color = pct >= 75 ? 'emerald' : pct >= 50 ? 'amber' : 'violet';
        const chantierContrats = contrats.filter(ct => ct.chantierId === c.id);
        const statutBadge = c.statut === 'en_cours' ? 'ğŸŸ¢ En cours' : c.statut === 'termine' ? 'âœ… TerminÃ©' : 'â¸ï¸ Suspendu';
        const statutColor = c.statut === 'en_cours' ? 'emerald' : c.statut === 'termine' ? 'sky' : 'amber';
        
        return `<div class="card p-6 hover:border-violet-500/50 transition-all cursor-pointer" onclick="openChantierDetail(${c.id})">
          <div class="flex items-start justify-between mb-4">
            <div>
              <h3 class="font-semibold text-lg text-slate-100">${escapeHtml(c.nom)}</h3>
              <p class="text-sm text-slate-500">ğŸ“ ${c.adresse}</p>
              <p class="text-sm text-slate-400 mt-1">ğŸ‘¤ ${c.client}</p>
            </div>
            <span class="badge bg-${statutColor}-500/20 text-${statutColor}-400 border border-${statutColor}-500/30">${statutBadge}</span>
          </div>
          <div class="progress-bar h-2 mb-4"><div class="progress-fill bg-${color}-500" style="width:${pct}%"></div></div>
          <div class="flex justify-between text-sm mb-4">
            <span class="text-slate-500">Avancement</span>
            <span class="text-slate-200 font-medium">${formatMontant(facture)} / ${formatMontant(c.montantTotal)} (${pct}%)</span>
          </div>
          <div class="text-sm text-slate-500 mb-4">
            ğŸ“‹ ${chantierContrats.length} contrat(s) sous-traitant
          </div>
          <div class="flex gap-2">
            <button onclick="event.stopPropagation(); openChantierDetail(${c.id})" class="flex-1 px-3 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm text-slate-300">ğŸ‘ï¸ DÃ©tails</button>
            <button onclick="event.stopPropagation(); openNewContratModal(${c.id})" class="flex-1 px-3 py-2 bg-violet-600 hover:bg-violet-500 rounded-lg text-sm text-white">â• Contrat</button>
          </div>
        </div>`;
      }).join('') || '<div class="col-span-3 text-center py-12 text-slate-500">Aucun chantier trouvÃ©</div>';
    }
    
    function openNewContratModal(chantierId) {
      const chantier = chantiers.find(c => c.id === chantierId);
      if (!chantier) return;
      
      document.getElementById('contratChantierId').value = chantierId;
      document.getElementById('contratChantierInfo').innerHTML = `
        <p class="font-medium text-slate-200">ğŸ—ï¸ ${escapeHtml(chantier.nom)}</p>
        <p class="text-sm text-slate-400">${chantier.client} - ${formatMontant(chantier.montantTotal)}</p>
      `;
      
      // Remplir la liste des sous-traitants disponibles
      const stPrives = sousTraitants.filter(st => st.dansAnnuairePrivate || st.ajouteManuellement);
      document.getElementById('contratSTSelect').innerHTML = '<option value="">SÃ©lectionner un sous-traitant...</option>' +
        stPrives.map(st => `<option value="${st.id}">${escapeHtml(st.nom)} - ${st.corpsMetier}</option>`).join('');
      
      document.getElementById('contratLot').value = '';
      document.getElementById('contratMontant').value = '';
      
      openModal('modalAddContrat');
    }
    
    function saveContrat() {
      const chantierId = parseInt(document.getElementById('contratChantierId').value);
      const stId = parseInt(document.getElementById('contratSTSelect').value);
      const lot = document.getElementById('contratLot').value;
      const montant = parseFloat(document.getElementById('contratMontant').value) || 0;
      
      if (!stId || !lot || !montant) {
        showToast('âš ï¸ Veuillez remplir tous les champs obligatoires', 'warning');
        return;
      }
      
      const st = sousTraitants.find(s => s.id === stId);
      const chantier = chantiers.find(c => c.id === chantierId);
      
      contrats.push({
        id: Date.now(),
        chantierId: chantierId,
        stId: stId,
        lot: lot,
        montantMarche: montant
      });
      
      closeModal('modalAddContrat');
      renderChantiers();
      showToast(`âœ… Contrat crÃ©Ã©: ${st?.nom} - ${lot}`, 'success');
      addAdminLog('success', `Contrat crÃ©Ã©: ${st?.nom} sur ${chantier?.nom}`);
    }

    function openChantierDetail(id) {
      console.log('Opening chantier detail:', id);
      const c = chantiers.find(x => x.id === id);
      if (!c) {
        console.error('Chantier not found:', id);
        return;
      }
      const chContrats = contrats.filter(x => x.chantierId === id);
      const situationsChantier = situations.filter(s => s.chantierId === id);
      const factureValidee = situationsChantier.filter(s => s.flux === 'flux2' && s.statut === 'validee').reduce((a, b) => a + (b.montantMois || 0), 0);
      const pct = c.montantTotal > 0 ? Math.round(factureValidee / c.montantTotal * 100) : 0;
      const statutBadge = c.statut === 'en_cours' ? 'ğŸŸ¢ En cours' : c.statut === 'termine' ? 'âœ… TerminÃ©' : 'â¸ï¸ Suspendu';
      const statutColor = c.statut === 'en_cours' ? 'emerald' : c.statut === 'termine' ? 'sky' : 'amber';
      
      // Calcul dÃ©taillÃ© de l'avancement
      const totalContrats = chContrats.reduce((s, ct) => s + (ct.montantMarche || 0), 0);
      const avancementMoyen = chContrats.length > 0 ? Math.round(chContrats.reduce((s, ct) => s + (ct.avancement || 0), 0) / chContrats.length) : 0;
      
      // GÃ©nÃ©rer le HTML des contrats
      let contratsHtml = '';
      chContrats.forEach(ct => {
        const st = sousTraitants.find(x => x.id === ct.stId);
        const ctSituations = situationsChantier.filter(s => s.contratId === ct.id);
        const ctAvancement = ctSituations.length > 0 ? Math.round(ctSituations.reduce((s, sit) => s + (sit.avancement || 0), 0) / ctSituations.length) : 0;
        contratsHtml += '<div class="p-3 bg-slate-800/30 rounded-xl">' +
          '<div class="flex justify-between items-center mb-2">' +
            '<div class="flex items-center gap-3">' +
              '<span class="text-xl">' + (st?.logo || 'ğŸ¢') + '</span>' +
              '<div>' +
                '<p class="font-medium text-slate-200">' + escapeHtml(st?.nom || 'ST') + '</p>' +
                '<p class="text-sm text-slate-500">' + escapeHtml(ct.lot || '') + '</p>' +
              '</div>' +
            '</div>' +
            '<span class="text-emerald-400 font-medium">' + formatMontant(ct.montantMarche) + '</span>' +
          '</div>' +
          '<div class="flex items-center gap-2">' +
            '<div class="flex-1 progress-bar h-1"><div class="progress-fill bg-violet-500" style="width: ' + ctAvancement + '%"></div></div>' +
            '<span class="text-xs text-slate-500">' + ctAvancement + '%</span>' +
          '</div>' +
        '</div>';
      });
      if (!contratsHtml) contratsHtml = '<p class="text-slate-500 text-center py-4">Aucun contrat</p>';
      
      // Boutons actions selon le rÃ´le
      let actionsHtml = '<button onclick="openNewContratModal(' + c.id + '); closeModal(\'modalDetailChantier\');" class="flex-1 px-4 py-2 bg-violet-600 hover:bg-violet-500 rounded-xl text-white">â• Ajouter contrat</button>';
      if (currentUser?.role === 'admin') {
        actionsHtml += '<button onclick="openEditChantier(' + c.id + ')" class="flex-1 px-4 py-2 bg-sky-600 hover:bg-sky-500 rounded-xl text-white">âœï¸ Modifier</button>';
        actionsHtml += '<button onclick="deleteChantier(' + c.id + ')" class="px-4 py-2 bg-red-600 hover:bg-red-500 rounded-xl text-white">ğŸ—‘ï¸</button>';
      } else {
        actionsHtml += '<button onclick="openEditChantier(' + c.id + ')" class="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-xl text-slate-200">ğŸ‘ï¸ Voir plus</button>';
      }
      
      document.getElementById('modalChantierTitle').textContent = c.nom;
      document.getElementById('modalChantierContent').innerHTML = 
        '<div class="flex justify-between items-center mb-4">' +
          '<p class="text-slate-400">ğŸ“ ' + escapeHtml(c.adresse || '') + '</p>' +
          '<span class="badge bg-' + statutColor + '-500/20 text-' + statutColor + '-400 border border-' + statutColor + '-500/30">' + statutBadge + '</span>' +
        '</div>' +
        '<div class="grid grid-cols-2 gap-4 mb-4">' +
          '<div class="p-3 bg-slate-800/30 rounded-xl"><p class="text-xs text-slate-500">Client</p><p class="text-slate-200">' + escapeHtml(c.client || '') + '</p></div>' +
          '<div class="p-3 bg-slate-800/30 rounded-xl"><p class="text-xs text-slate-500">Montant total</p><p class="text-emerald-400 font-medium">' + formatMontant(c.montantTotal) + '</p></div>' +
          '<div class="p-3 bg-slate-800/30 rounded-xl"><p class="text-xs text-slate-500">Date dÃ©but</p><p class="text-slate-200">' + (c.dateDebut ? formatDate(c.dateDebut) : 'Non dÃ©finie') + '</p></div>' +
          '<div class="p-3 bg-slate-800/30 rounded-xl"><p class="text-xs text-slate-500">Date fin prÃ©vue</p><p class="text-slate-200">' + (c.dateFin ? formatDate(c.dateFin) : 'Non dÃ©finie') + '</p></div>' +
        '</div>' +
        '<div class="mb-4 p-4 bg-emerald-500/10 border border-emerald-500/30 rounded-xl">' +
          '<h4 class="font-semibold text-emerald-400 mb-2">ğŸ“Š Avancement Facturation</h4>' +
          '<div class="flex justify-between text-sm mb-1"><span class="text-slate-300">Progression</span><span class="text-emerald-400 font-bold">' + pct + '%</span></div>' +
          '<div class="progress-bar h-3"><div class="progress-fill bg-emerald-500" style="width: ' + pct + '%"></div></div>' +
          '<p class="text-xs text-slate-500 mt-2">' + formatMontant(factureValidee) + ' facturÃ© sur ' + formatMontant(c.montantTotal) + '</p>' +
          '<div class="mt-3 p-2 bg-slate-800/30 rounded-lg text-xs text-slate-400">' +
            '<strong>ğŸ“ Calcul :</strong> Somme des situations validÃ©es (Flux 2) / Montant total du chantier' +
          '</div>' +
        '</div>' +
        '<h4 class="font-semibold text-slate-200 mb-3">ğŸ“‹ Contrats sous-traitants (' + chContrats.length + ')</h4>' +
        '<div class="space-y-2 mb-4 max-h-48 overflow-y-auto">' + contratsHtml + '</div>' +
        '<div class="mb-4 desktop-only">' +
          '<h4 class="font-semibold text-slate-200 mb-3">ğŸ“ Documents attachÃ©s</h4>' +
          '<div class="p-3 bg-slate-800/30 rounded-xl text-center">' +
            '<input type="file" id="chantierDocInput" class="hidden" multiple onchange="uploadChantierDoc(' + c.id + ', this)">' +
            '<button onclick="document.getElementById(\'chantierDocInput\').click()" class="px-4 py-2 bg-violet-600 hover:bg-violet-500 rounded-lg text-white text-sm">ğŸ“ Joindre un document</button>' +
          '</div>' +
        '</div>' +
        '<div class="flex gap-3 pt-4 border-t border-slate-700">' + actionsHtml + '</div>';
      openModal('modalDetailChantier');
    }
    
    function uploadChantierDoc(chantierId, input) {
      const files = input.files;
      if (!files.length) return;
      showToast('ğŸ“ ' + files.length + ' document(s) ajoutÃ©(s) au chantier', 'success');
      input.value = '';
    }
    
    function deleteChantier(id) {
      if (currentUser?.role !== 'admin') {
        showToast('â›” Seul un administrateur peut supprimer un chantier', 'error');
        return;
      }
      if (!confirm('ÃŠtes-vous sÃ»r de vouloir supprimer ce chantier ? Cette action est irrÃ©versible.')) return;
      
      const index = chantiers.findIndex(c => c.id === id);
      if (index >= 0) {
        const deleted = chantiers.splice(index, 1)[0];
        localStorage.setItem('btp-chantiers', JSON.stringify(chantiers));
        closeModal('modalDetailChantier');
        renderChantiers();
        showToast('ğŸ—‘ï¸ Chantier "' + deleted.nom + '" supprimÃ©', 'warning');
        addAdminLog('warning', 'Chantier supprimÃ©: ' + deleted.nom);
      }
    }
    
    function openEditChantier(id) {
      const c = chantiers.find(x => x.id === id);
      if (!c) return;
      
      closeModal('modalDetailChantier');
      
      document.getElementById('editChantierId').value = id;
      document.getElementById('editChantierNom').value = c.nom || '';
      document.getElementById('editChantierAdresse').value = c.adresse || '';
      document.getElementById('editChantierClient').value = c.client || '';
      document.getElementById('editChantierMontant').value = c.montantTotal || 0;
      document.getElementById('editChantierStatut').value = c.statut || 'en_cours';
      
      openModal('modalEditChantier');
    }
    
    function saveChantier() {
      const id = parseInt(document.getElementById('editChantierId').value);
      const c = chantiers.find(x => x.id === id);
      if (!c) return;
      
      c.nom = document.getElementById('editChantierNom').value;
      c.adresse = document.getElementById('editChantierAdresse').value;
      c.client = document.getElementById('editChantierClient').value;
      c.montantTotal = parseFloat(document.getElementById('editChantierMontant').value) || 0;
      c.statut = document.getElementById('editChantierStatut').value;
      
      closeModal('modalEditChantier');
      renderChantiers();
      showToast('âœ… Chantier modifiÃ©', 'success');
      addAdminLog('info', `Chantier modifiÃ©: ${c.nom}`);
    }

    function addChantier() {
      const nom = document.getElementById('newChantierNom').value;
      if (!nom) { showToast('âš ï¸ Nom requis'); return; }
      chantiers.push({ id: Date.now(), nom, adresse: document.getElementById('newChantierAdresse').value, client: document.getElementById('newChantierClient').value, 
        montantTotal: parseFloat(document.getElementById('newChantierMontant').value) || 0, statut: 'en_cours', avancement: 0 });
      closeModal('modalNewChantier'); showToast('âœ… Chantier crÃ©Ã©'); renderChantiers();
      addAdminLog('success', `Nouveau chantier: ${nom}`);
    }

    // ========== SITUATIONS ==========
    function populateSituFilters() {
      document.getElementById('filterSituChantier').innerHTML = '<option value="">Tous les chantiers</option>' + chantiers.map(c => `<option value="${c.id}">${escapeHtml(c.nom)}</option>`).join('');
    }

    function setFlux(flux) {
      currentFlux = flux;
      document.getElementById('btn-flux1').classList.toggle('active', flux === 'flux1');
      document.getElementById('btn-flux2').classList.toggle('active', flux === 'flux2');
      renderSituations();
    }

    function renderSituations() {
      const chantierId = document.getElementById('filterSituChantier')?.value;
      const statut = document.getElementById('filterSituStatut')?.value;
      let data = situations.filter(s => s.flux === currentFlux);
      if (statut) data = data.filter(s => s.statut === statut);

      const grouped = {};
      data.forEach(s => {
        let chId = currentFlux === 'flux1' ? contrats.find(c => c.id === s.contratId)?.chantierId : s.chantierId;
        if (chantierId && chId != chantierId) return;
        if (!grouped[chId]) grouped[chId] = [];
        grouped[chId].push(s);
      });

      document.getElementById('situationsList').innerHTML = Object.entries(grouped).map(([chId, situs]) => {
        const ch = chantiers.find(c => c.id == chId);
        return `<div class="card overflow-hidden">
          <div class="p-4 bg-slate-800/50 cursor-pointer" onclick="this.nextElementSibling.classList.toggle('open')">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3"><span class="text-2xl">ğŸ—ï¸</span><div><h4 class="font-medium text-slate-200">${ch?.nom || 'Chantier'}</h4><p class="text-sm text-slate-500">${situs.length} situation(s)</p></div></div>
              <span>â–¼</span>
            </div>
          </div>
          <div class="accordion-content"><div class="p-4 space-y-3">
            ${situs.map(s => {
              const info = getSituInfo(s);
              const badge = s.statut === 'validee' ? 'badge-success' : s.statut === 'soumise' ? 'badge-warning' : 'badge-danger';
              const label = s.statut === 'validee' ? 'âœ“ ValidÃ©e' : s.statut === 'soumise' ? 'â³ En attente' : 'âœ— RefusÃ©e';
              return `<div class="p-4 bg-slate-800/30 rounded-xl cursor-pointer hover:bg-slate-700/30" onclick="openSituationDetail(${s.id})">
                <div class="flex items-center justify-between mb-2">
                  <div><p class="font-medium text-slate-200">Situation nÂ°${s.numero}</p><p class="text-sm text-slate-500">${formatDate(s.date)}${currentFlux === 'flux1' && info.st ? ' - ' + info.st.nom : ''}</p></div>
                  <span class="badge ${badge}">${label}</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-emerald-400 font-medium">${formatMontant(s.montantMois)}</span>
                  ${s.statut === 'soumise' ? `<div class="flex gap-2" onclick="event.stopPropagation()">
                    <button onclick="validerSituation(${s.id})" class="px-3 py-1 btn-success rounded text-white text-sm">âœ“</button>
                    <button onclick="refuserSituation(${s.id})" class="px-3 py-1 btn-danger rounded text-white text-sm">âœ—</button>
                  </div>` : ''}
                </div>
              </div>`;
            }).join('')}
          </div></div>
        </div>`;
      }).join('') || '<p class="text-slate-500 text-center py-8">Aucune situation</p>';

      updateSituStats();
    }

    function openSituationDetail(id) {
      const s = situations.find(x => x.id === id);
      if (!s) return;
      const info = getSituInfo(s);
      document.getElementById('modalSituTitle').textContent = `Situation nÂ°${s.numero}`;
      document.getElementById('modalSituContent').innerHTML = `
        <div class="mb-4">
          <span class="badge ${s.statut === 'validee' ? 'badge-success' : s.statut === 'soumise' ? 'badge-warning' : 'badge-danger'}">
            ${s.statut === 'validee' ? 'âœ“ ValidÃ©e' : s.statut === 'soumise' ? 'â³ En attente' : 'âœ— RefusÃ©e'}
          </span>
        </div>
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div class="p-3 bg-slate-800/30 rounded-xl"><p class="text-xs text-slate-500">Date</p><p class="text-slate-200">${formatDate(s.date)}</p></div>
          <div class="p-3 bg-slate-800/30 rounded-xl"><p class="text-xs text-slate-500">Montant mois</p><p class="text-emerald-400 font-medium">${formatMontant(s.montantMois)}</p></div>
          <div class="p-3 bg-slate-800/30 rounded-xl"><p class="text-xs text-slate-500">Cumul antÃ©rieur</p><p class="text-slate-200">${formatMontant(s.cumulAnt)}</p></div>
          <div class="p-3 bg-slate-800/30 rounded-xl"><p class="text-xs text-slate-500">Cumul total</p><p class="text-sky-400 font-medium">${formatMontant(s.cumulAnt + s.montantMois)}</p></div>
        </div>
        <div class="p-3 bg-slate-800/30 rounded-xl mb-4"><p class="text-xs text-slate-500">Chantier / Tiers</p><p class="text-slate-200">${info.label}</p></div>
        
        <!-- Zone PDF de la situation -->
        <div class="mb-4">
          <p class="text-sm text-slate-400 mb-2">ğŸ“„ Document PDF de la situation</p>
          <div id="situPdfZone-${s.id}" class="border-2 border-dashed border-slate-600 rounded-xl p-4 text-center cursor-pointer hover:border-violet-500/50 transition-colors" onclick="document.getElementById('situPdfInput-${s.id}').click()">
            ${s.pdfFile ? `
              <div class="flex items-center justify-center gap-3">
                <span class="text-3xl">ğŸ“„</span>
                <div class="text-left">
                  <p class="font-medium text-slate-200">${s.pdfFile}</p>
                  <p class="text-xs text-slate-500">Cliquez pour remplacer</p>
                </div>
                <button onclick="event.stopPropagation(); removeSituPdf(${s.id})" class="p-2 hover:bg-slate-700 rounded-lg text-slate-400">âœ•</button>
              </div>
            ` : `
              <span class="text-3xl">ğŸ“¤</span>
              <p class="text-slate-300 font-medium mt-2">Joindre le PDF de la situation</p>
              <p class="text-xs text-slate-500 mt-1">Glissez ou cliquez pour ajouter</p>
            `}
            <input type="file" id="situPdfInput-${s.id}" class="hidden" accept=".pdf" onchange="handleSituPdfUpload(event, ${s.id})">
          </div>
        </div>
        
        ${s.commentaireRefus ? `<div class="p-3 bg-red-500/10 border border-red-500/30 rounded-xl mb-4"><p class="text-xs text-red-400">Motif refus</p><p class="text-slate-200">${s.commentaireRefus}</p></div>` : ''}
        ${s.statut === 'soumise' ? `<div class="flex gap-3">
          <button onclick="validerSituation(${s.id}); closeModal('modalDetailSituation')" class="flex-1 btn-success px-4 py-2 rounded-xl text-white">âœ“ Valider</button>
          <button onclick="refuserSituation(${s.id}); closeModal('modalDetailSituation')" class="flex-1 btn-danger px-4 py-2 rounded-xl text-white">âœ— Refuser</button>
        </div>` : ''}
      `;
      openModal('modalDetailSituation');
    }
    
    function handleSituPdfUpload(event, situId) {
      const file = event.target.files[0];
      if (file) {
        const situ = situations.find(s => s.id === situId);
        if (situ) {
          situ.pdfFile = file.name;
          showToast('ğŸ“„ PDF ajoutÃ©: ' + file.name);
          openSituationDetail(situId); // RafraÃ®chir l'affichage
        }
      }
    }
    
    function removeSituPdf(situId) {
      const situ = situations.find(s => s.id === situId);
      if (situ) {
        situ.pdfFile = null;
        showToast('ğŸ—‘ï¸ PDF supprimÃ©');
        openSituationDetail(situId);
      }
    }

    function validerSituation(id) { const s = situations.find(s => s.id === id); if (s) { s.statut = 'validee'; showToast('âœ… ValidÃ©e'); renderSituations(); renderDashboard(); } }
    function refuserSituation(id) { const s = situations.find(s => s.id === id); if (s) { s.statut = 'refusee'; s.commentaireRefus = 'RefusÃ©'; showToast('âŒ RefusÃ©e'); renderSituations(); renderDashboard(); } }

    function updateSituStats() {
      const flux = situations.filter(s => s.flux === currentFlux);
      document.getElementById('situ-attente').textContent = flux.filter(s => s.statut === 'soumise').length;
      document.getElementById('situ-validees').textContent = flux.filter(s => s.statut === 'validee').length;
      document.getElementById('situ-refusees').textContent = flux.filter(s => s.statut === 'refusee').length;
      document.getElementById('situ-montant').textContent = formatMontant(flux.reduce((s, st) => s + st.montantMois, 0)).replace(' â‚¬', '');
    }

    // ========== FACTURATION ==========
    function setFactFlux(flux) {
      currentFactFlux = flux;
      document.getElementById('btn-fact-recues').classList.toggle('active', flux === 'recues');
      document.getElementById('btn-fact-emises').classList.toggle('active', flux === 'emises');
      renderFactures();
    }

    function renderFactures() {
      const today = new Date();
      const statutFilter = document.getElementById('filterFactStatut')?.value || '';
      const searchFilter = document.getElementById('searchFactures')?.value?.toLowerCase() || '';
      
      let data = factures.filter(f => currentFactFlux === 'recues' ? f.type === 'recue' : f.type === 'emise');
      
      // Appliquer le filtre de statut
      if (statutFilter) {
        data = data.filter(f => {
          const enRetard = f.dateEcheance && new Date(f.dateEcheance) < today && !['payee', 'encaissee'].includes(f.statut);
          if (statutFilter === 'en_retard') return enRetard;
          if (statutFilter === 'payee') return ['payee', 'encaissee'].includes(f.statut);
          if (statutFilter === 'en_attente') return !['payee', 'encaissee'].includes(f.statut) && !enRetard;
          return true;
        });
      }
      
      // Appliquer le filtre de recherche
      if (searchFilter) {
        data = data.filter(f => {
          const ch = chantiers.find(c => c.id === f.chantierId);
          const st = sousTraitants.find(s => s.id === f.stId);
          return (f.numero || '').toLowerCase().includes(searchFilter) ||
                 (ch?.nom || '').toLowerCase().includes(searchFilter) ||
                 (st?.nom || '').toLowerCase().includes(searchFilter) ||
                 (ch?.client || '').toLowerCase().includes(searchFilter);
        });
      }
      
      const enRetardCount = factures.filter(f => new Date(f.dateEcheance) < today && !['payee', 'encaissee'].includes(f.statut)).length;
      document.getElementById('fact-attente').textContent = factures.filter(f => !['payee', 'encaissee'].includes(f.statut)).length;
      document.getElementById('fact-payees').textContent = factures.filter(f => ['payee', 'encaissee'].includes(f.statut)).length;
      document.getElementById('fact-retard').textContent = enRetardCount;
      document.getElementById('fact-total').textContent = formatMontant(factures.reduce((s, f) => s + f.montantHT, 0)).replace(' â‚¬', '');

      document.getElementById('facturesTableBody').innerHTML = data.map(f => {
        const ch = chantiers.find(c => c.id === f.chantierId);
        const st = sousTraitants.find(s => s.id === f.stId);
        const tiers = currentFactFlux === 'recues' ? st?.nom : ch?.client;
        const enRetard = f.dateEcheance && new Date(f.dateEcheance) < today && !['payee', 'encaissee'].includes(f.statut);
        const badge = f.statut === 'payee' || f.statut === 'encaissee' ? 'badge-success' : enRetard ? 'badge-danger' : 'badge-warning';
        const label = f.statut === 'payee' || f.statut === 'encaissee' ? 'âœ“ PayÃ©e' : enRetard ? 'âš ï¸ Retard' : 'â³ En cours';
        return `<tr class="${enRetard ? 'bg-red-500/10' : ''} cursor-pointer hover:bg-slate-800/50" onclick="openFactureDetail(${f.id})">
          <td>${f.numero || '-'}</td>
          <td>${ch?.nom || '-'}</td>
          <td>${tiers || '-'}</td>
          <td class="text-right font-medium text-emerald-400">${formatMontant(f.montantHT)}</td>
          <td>${formatDate(f.dateEcheance)}</td>
          <td><span class="badge ${badge}">${label}</span></td>
          <td>${!['payee', 'encaissee'].includes(f.statut) ? `<button onclick="event.stopPropagation(); payerFacture(${f.id})" class="px-2 py-1 btn-success rounded text-white text-xs">ğŸ’¶</button>` : ''}</td>
        </tr>`;
      }).join('') || '<tr><td colspan="7" class="text-center text-slate-500 py-8">Aucune facture correspondant aux critÃ¨res</td></tr>';
    }

    function payerFacture(id) { 
      const f = factures.find(f => f.id === id); 
      if (f) { f.statut = f.type === 'recue' ? 'payee' : 'encaissee'; showToast('âœ… Facture payÃ©e'); renderFactures(); }
    }

    // ========== DOCUMENTS ==========
    function filterDocsByType(type) {
      docTypeFilter = type;
      renderDocuments();
      if (type) showToast(`ğŸ” Filtre: ${type}`);
    }

    function renderDocuments() {
      const search = document.getElementById('searchDocs')?.value.toLowerCase() || '';
      const typeFilter = document.getElementById('filterDocType')?.value || '';
      const statutFilter = document.getElementById('filterDocStatut')?.value || '';
      const today = new Date();
      
      // DonnÃ©es documents simulÃ©es pour chaque ST
      const documentsObligatoires = [];
      sousTraitants.forEach(st => {
        documentsObligatoires.push(
          { id: st.id * 10 + 1, stId: st.id, type: 'Kbis', dateExpiration: '2026-06-15', iaStatus: 'valide', iaScore: 98 },
          { id: st.id * 10 + 2, stId: st.id, type: 'Attestation URSSAF', dateExpiration: st.id % 2 === 0 ? '2026-02-01' : '2026-04-15', iaStatus: 'valide', iaScore: 95 },
          { id: st.id * 10 + 3, stId: st.id, type: 'RC Pro', dateExpiration: st.id % 3 === 0 ? '2025-12-20' : '2026-05-01', iaStatus: st.id % 4 === 0 ? 'rejete' : 'valide', iaScore: st.id % 4 === 0 ? 45 : 92, iaErreur: st.id % 4 === 0 ? 'SIRET non correspondant' : null },
          { id: st.id * 10 + 4, stId: st.id, type: 'DÃ©cennale', dateExpiration: '2026-08-01', iaStatus: 'valide', iaScore: 97 },
          { id: st.id * 10 + 5, stId: st.id, type: 'Attestation vigilance', dateExpiration: st.id % 5 === 0 ? '2026-01-10' : '2026-03-20', iaStatus: st.id % 5 === 0 ? 'en_attente' : 'valide', iaScore: st.id % 5 === 0 ? null : 91 }
        );
      });
      
      // Calcul des stats
      let statsValides = 0, statsAttente = 0, statsRejetes = 0, statsExpire60 = 0, statsExpire30 = 0, statsExpires = 0;
      documentsObligatoires.forEach(doc => {
        const exp = new Date(doc.dateExpiration);
        const daysLeft = Math.floor((exp - today) / (1000 * 60 * 60 * 24));
        if (doc.iaStatus === 'rejete' && !doc.forceAdmin) statsRejetes++;
        else if (doc.iaStatus === 'en_attente') statsAttente++;
        else if (daysLeft < 0) statsExpires++;
        else if (daysLeft <= 30) statsExpire30++;
        else if (daysLeft <= 60) statsExpire60++;
        else statsValides++;
      });
      
      document.getElementById('docs-valides').textContent = statsValides;
      document.getElementById('docs-attente').textContent = statsAttente;
      document.getElementById('docs-rejetes').textContent = statsRejetes;
      document.getElementById('docs-expire60').textContent = statsExpire60;
      document.getElementById('docs-expire30').textContent = statsExpire30;
      document.getElementById('docs-expires').textContent = statsExpires;
      
      // Regrouper par ST
      const grouped = {};
      sousTraitants.forEach(st => {
        if (search && !st.nom.toLowerCase().includes(search)) return;
        
        let stDocs = documentsObligatoires.filter(d => d.stId === st.id);
        
        // Filtre type
        if (typeFilter) {
          stDocs = stDocs.filter(d => d.type.includes(typeFilter));
        }
        
        // Filtre statut
        if (statutFilter) {
          stDocs = stDocs.filter(d => {
            const exp = new Date(d.dateExpiration);
            const daysLeft = Math.floor((exp - today) / (1000 * 60 * 60 * 24));
            if (statutFilter === 'valide') return d.iaStatus === 'valide' && daysLeft > 30;
            if (statutFilter === 'en_attente') return d.iaStatus === 'en_attente';
            if (statutFilter === 'rejete') return d.iaStatus === 'rejete';
            if (statutFilter === 'expire') return daysLeft < 0;
            return true;
          });
        }
        
        if (stDocs.length > 0) grouped[st.id] = { st, docs: stDocs };
      });

      // Rendu HTML avec dÃ©roulÃ© par ST (style V7)
      document.getElementById('documentsList').innerHTML = Object.values(grouped).map(g => {
        const stExpires = g.docs.filter(d => new Date(d.dateExpiration) < today).length;
        const stRejetes = g.docs.filter(d => d.iaStatus === 'rejete').length;
        const stWarning = g.docs.filter(d => {
          const daysLeft = Math.floor((new Date(d.dateExpiration) - today) / (1000 * 60 * 60 * 24));
          return daysLeft >= 0 && daysLeft <= 30;
        }).length;
        
        let headerClass = 'border-emerald-500/30';
        if (stExpires > 0 || stRejetes > 0) headerClass = 'border-red-500/50';
        else if (stWarning > 0) headerClass = 'border-amber-500/50';
        
        const docsHtml = g.docs.map(doc => {
          const exp = new Date(doc.dateExpiration);
          const daysLeft = Math.floor((exp - today) / (1000 * 60 * 60 * 24));
          
          let statusClass = 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30';
          let statusIcon = 'âœ…';
          let statusText = 'Valide';
          
          if (doc.iaStatus === 'rejete' && !doc.forceAdmin) {
            statusClass = 'bg-red-500/20 text-red-400 border-red-500/30';
            statusIcon = 'âŒ';
            statusText = 'RejetÃ© IA';
          } else if (doc.iaStatus === 'en_attente') {
            statusClass = 'bg-amber-500/20 text-amber-400 border-amber-500/30';
            statusIcon = 'â³';
            statusText = 'En analyse';
          } else if (daysLeft < 0) {
            statusClass = 'bg-red-500/20 text-red-400 border-red-500/30';
            statusIcon = 'ğŸš¨';
            statusText = 'ExpirÃ©';
          } else if (daysLeft <= 30) {
            statusClass = 'bg-amber-500/20 text-amber-400 border-amber-500/30';
            statusIcon = 'âš ï¸';
            statusText = daysLeft + 'j';
          } else if (daysLeft <= 60) {
            statusClass = 'bg-sky-500/20 text-sky-400 border-sky-500/30';
            statusIcon = 'ğŸ“…';
            statusText = daysLeft + 'j';
          }
          
          let actionsHtml = `<button onclick="voirDocumentDetail(${doc.id})" class="p-2 hover:bg-slate-700 rounded-lg text-slate-400" title="Voir dÃ©tail">ğŸ‘ï¸</button>`;
          if (doc.iaStatus === 'rejete') {
            actionsHtml += `<button onclick="forcerValidationDoc(${doc.id})" class="px-2 py-1 bg-violet-600 hover:bg-violet-500 rounded-lg text-xs text-white">ğŸ”“ Forcer</button>`;
          }
          if (daysLeft < 0 || doc.iaStatus === 'rejete') {
            actionsHtml += `<button onclick="relancerDocST(${doc.id})" class="px-2 py-1 bg-amber-600 hover:bg-amber-500 rounded-lg text-xs text-white">ğŸ“§</button>`;
          }
          
          return `<div class="flex items-center justify-between p-3 bg-slate-800/30 rounded-xl">
            <div class="flex items-center gap-3">
              <span class="text-lg">${statusIcon}</span>
              <div>
                <p class="font-medium text-slate-200">${doc.type}</p>
                <p class="text-xs text-slate-500">Expire le ${formatDate(doc.dateExpiration)}${doc.iaScore ? ` â€¢ IA: ${doc.iaScore}%` : ''}</p>
                ${doc.iaErreur ? `<p class="text-xs text-red-400 mt-1">âš ï¸ ${doc.iaErreur}</p>` : ''}
              </div>
            </div>
            <div class="flex items-center gap-2">
              <span class="px-3 py-1 rounded-full text-xs font-medium border ${statusClass}">${statusText}</span>
              ${actionsHtml}
            </div>
          </div>`;
        }).join('');
        
        return `<div class="card mb-4 ${headerClass}">
          <div class="p-4 flex items-center gap-4 cursor-pointer hover:bg-slate-800/30" onclick="toggleDocAccordion(this)">
            <div class="w-12 h-12 bg-slate-700 rounded-xl flex items-center justify-center text-2xl">${g.st.logo}</div>
            <div class="flex-1">
              <h3 class="font-semibold text-slate-100">${g.st.nom}</h3>
              <p class="text-sm text-slate-500">${g.docs.length} document(s) ${stExpires > 0 ? `â€¢ <span class="text-red-400">${stExpires} expirÃ©(s)</span>` : ''} ${stRejetes > 0 ? `â€¢ <span class="text-red-400">${stRejetes} rejetÃ©(s)</span>` : ''} ${stWarning > 0 ? `â€¢ <span class="text-amber-400">${stWarning} Ã  renouveler</span>` : ''}</p>
            </div>
            <div class="flex gap-2">
              <button onclick="event.stopPropagation(); envoyerLienPortailST(${g.st.id})" class="px-3 py-2 bg-violet-600 hover:bg-violet-500 rounded-lg text-sm text-white">ğŸ”— Lien portail</button>
              <button onclick="event.stopPropagation(); relancerTousDocsST(${g.st.id})" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm text-slate-300">ğŸ“§ Relancer</button>
            </div>
            <span class="accordion-chevron text-slate-500 transition-transform">â–¼</span>
          </div>
          <div class="accordion-content">
            <div class="p-4 pt-0 space-y-2">${docsHtml}</div>
          </div>
        </div>`;
      }).join('') || '<p class="text-slate-500 text-center py-8">Aucun document trouvÃ©</p>';
    }
    
    function toggleDocAccordion(el) {
      const content = el.nextElementSibling;
      const chevron = el.querySelector('.accordion-chevron');
      content.classList.toggle('open');
      chevron?.classList.toggle('open');
    }
    
    function voirDocumentDetail(docId) {
      showToast('ğŸ“„ DÃ©tail document #' + docId);
    }
    
    function forcerValidationDoc(docId) {
      showToast('ğŸ”“ Document forcÃ© validÃ©');
      renderDocuments();
    }
    
    function relancerDocST(docId) {
      showToast('ğŸ“§ Relance envoyÃ©e');
    }
    
    function envoyerLienPortailST(stId) {
      showToast('ğŸ”— Lien portail envoyÃ© par email');
    }
    
    function relancerTousDocsST(stId) {
      showToast('ğŸ“§ Relance globale envoyÃ©e');
    }
    
    function filterDocsByStatut(statut) {
      document.getElementById('filterDocStatut').value = statut === 'valides' ? 'valide' : statut === 'rejetes' ? 'rejete' : statut === 'attente' ? 'en_attente' : statut === 'expires' ? 'expire' : '';
      renderDocuments();
    }

    // ========== ANALYSE IA ==========
    function initAnalyse() {
      document.getElementById('analyseChantier').innerHTML = '<option value="">SÃ©lectionner...</option>' + chantiers.map(c => `<option value="${c.id}">${escapeHtml(c.nom)}</option>`).join('');
      document.getElementById('analyseLot').innerHTML = '<option value="">SÃ©lectionner d\'abord un chantier...</option>';
    }
    
    function updateAnalyseLots() {
      const chantierId = parseInt(document.getElementById('analyseChantier').value);
      const lotSelect = document.getElementById('analyseLot');
      
      if (!chantierId) {
        lotSelect.innerHTML = '<option value="">SÃ©lectionner d\'abord un chantier...</option>';
        return;
      }
      
      // RÃ©cupÃ©rer les lots associÃ©s Ã  ce chantier via les contrats
      const chantierContrats = contrats.filter(c => c.chantierId === chantierId);
      const lots = [...new Set(chantierContrats.map(c => c.lot))];
      
      // Ajouter des lots standards si le chantier n'a pas de contrats
      const lotsStandards = ['Ã‰lectricitÃ© CFO/CFA', 'Plomberie', 'CVC Climatisation', 'Peinture', 'Menuiserie', 'Carrelage', 'MaÃ§onnerie', 'Couverture', 'Serrurerie'];
      const allLots = lots.length > 0 ? lots : lotsStandards;
      
      lotSelect.innerHTML = '<option value="">SÃ©lectionner un lot...</option>' + 
        allLots.map(lot => `<option value="${escapeHtml(lot)}">${escapeHtml(lot)}</option>`).join('');
    }
    
    let currentAnalyseMode = 'comparaison';
    
    function setAnalyseMode(mode) {
      currentAnalyseMode = mode;
      document.getElementById('mode-comparaison').classList.toggle('border-violet-500', mode === 'comparaison');
      document.getElementById('mode-comparaison').classList.toggle('bg-violet-500/10', mode === 'comparaison');
      document.getElementById('mode-unique').classList.toggle('border-violet-500', mode === 'unique');
      document.getElementById('mode-unique').classList.toggle('bg-violet-500/10', mode === 'unique');
      
      // Mettre Ã  jour le label de la zone de drop
      const devisLabel = document.querySelector('#dropDevis .drop-zone-text');
      if (devisLabel) {
        devisLabel.textContent = mode === 'unique' 
          ? 'ğŸ“¤ DÃ©posez UN devis (PDF/Excel)' 
          : 'ğŸ“¤ DÃ©posez 2 Ã  5 devis (PDF/Excel)';
      }
      
      // RÃ©initialiser les fichiers
      analyseFiles.devis = [];
      const listDiv = document.getElementById('devisFilesList');
      if (listDiv) listDiv.innerHTML = '';
      const dropZone = document.getElementById('dropDevis');
      if (dropZone) dropZone.classList.remove('border-emerald-500', 'bg-emerald-500/10');
    }
    
    // ========== ANALYSE IA - UPLOAD & EXPORT ==========
    let analyseFiles = { cctp: null, dpgf: null, devis: [] };
    
    function handleAnalyseFile(input, type) {
      const file = input.files[0];
      if (!file) return;
      
      analyseFiles[type] = file;
      const label = document.getElementById(`label${type.toUpperCase()}`);
      const dropZone = document.getElementById(`drop${type.toUpperCase()}`);
      
      if (label) label.innerHTML = `âœ… ${file.name}`;
      if (dropZone) dropZone.classList.add('border-emerald-500', 'bg-emerald-500/10');
      
      showToast(`âœ… ${type.toUpperCase()} chargÃ©: ${file.name}`, 'success');
    }
    
    function handleAnalyseDevis(input) {
      const files = Array.from(input.files);
      
      // Mode unique : un seul devis
      if (currentAnalyseMode === 'unique') {
        if (files.length > 1) {
          showToast('âš ï¸ Mode analyse unique: un seul devis autorisÃ©', 'warning');
          input.value = '';
          return;
        }
        if (files.length === 0) return;
        
        analyseFiles.devis = [files[0]];
        const dropZone = document.getElementById('dropDevis');
        const listDiv = document.getElementById('devisFilesList');
        
        dropZone.classList.add('border-emerald-500', 'bg-emerald-500/10');
        listDiv.innerHTML = `
          <div class="flex items-center justify-between p-2 bg-slate-800/50 rounded-lg">
            <span class="text-slate-300 text-sm">ğŸ“„ ${files[0].name}</span>
            <button onclick="removeDevisFile(0)" class="text-red-400 hover:text-red-300">âœ•</button>
          </div>
        `;
        showToast(`âœ… Devis chargÃ©: ${files[0].name}`, 'success');
        return;
      }
      
      // Mode comparaison : 2 Ã  5 devis
      if (files.length < 2) {
        showToast('âš ï¸ Minimum 2 devis requis pour la comparaison', 'warning');
        return;
      }
      if (files.length > 5) {
        showToast('âš ï¸ Maximum 5 devis autorisÃ©s', 'warning');
        return;
      }
      
      analyseFiles.devis = files;
      const dropZone = document.getElementById('dropDevis');
      const listDiv = document.getElementById('devisFilesList');
      
      dropZone.classList.add('border-emerald-500', 'bg-emerald-500/10');
      listDiv.innerHTML = files.map((f, i) => `
        <div class="flex items-center justify-between p-2 bg-slate-800/50 rounded-lg">
          <span class="text-sm text-slate-300">ğŸ“ Devis ${i+1}: ${f.name}</span>
          <button onclick="removeDevisFile(${i})" class="text-red-400 hover:text-red-300 text-sm">âœ•</button>
        </div>
      `).join('');
      
      showToast(`âœ… ${files.length} devis chargÃ©s`, 'success');
    }
    
    function removeDevisFile(index) {
      analyseFiles.devis.splice(index, 1);
      const listDiv = document.getElementById('devisFilesList');
      listDiv.innerHTML = analyseFiles.devis.map((f, i) => `
        <div class="flex items-center justify-between p-2 bg-slate-800/50 rounded-lg">
          <span class="text-sm text-slate-300">ğŸ“ Devis ${i+1}: ${f.name}</span>
          <button onclick="removeDevisFile(${i})" class="text-red-400 hover:text-red-300 text-sm">âœ•</button>
        </div>
      `).join('');
      
      if (analyseFiles.devis.length === 0) {
        document.getElementById('dropDevis').classList.remove('border-emerald-500', 'bg-emerald-500/10');
      }
    }
    
    function resetAnalyseFiles() {
      analyseFiles = { cctp: null, dpgf: null, devis: [] };
      
      ['CCTP', 'DPGF'].forEach(type => {
        const label = document.getElementById(`label${type}`);
        const dropZone = document.getElementById(`drop${type}`);
        const input = document.getElementById(`file${type}`);
        
        if (label) label.textContent = `${type} (obligatoire)`;
        if (dropZone) dropZone.classList.remove('border-emerald-500', 'bg-emerald-500/10');
        if (input) input.value = '';
      });
      
      document.getElementById('fileDevis').value = '';
      document.getElementById('dropDevis').classList.remove('border-emerald-500', 'bg-emerald-500/10');
      document.getElementById('devisFilesList').innerHTML = '';
      document.getElementById('analyseProgress').classList.add('hidden');
      
      showToast('ğŸ”„ Fichiers rÃ©initialisÃ©s', 'info');
    }
    
    function launchAnalyseIA() {
      // VÃ©rifications
      if (!analyseFiles.cctp) {
        showToast('âš ï¸ Le CCTP est obligatoire', 'warning');
        return;
      }
      if (!analyseFiles.dpgf) {
        showToast('âš ï¸ Le DPGF est obligatoire', 'warning');
        return;
      }
      if (analyseFiles.devis.length < 2) {
        showToast('âš ï¸ Minimum 2 devis requis', 'warning');
        return;
      }
      
      const chantier = document.getElementById('analyseChantier').value;
      const lot = document.getElementById('analyseLot').value;
      
      if (!chantier || !lot) {
        showToast('âš ï¸ SÃ©lectionnez un chantier et un lot', 'warning');
        return;
      }
      
      // Afficher la progression
      const progressDiv = document.getElementById('analyseProgress');
      const progressBar = document.getElementById('analyseProgressBar');
      const progressText = document.getElementById('analyseProgressText');
      
      progressDiv.classList.remove('hidden');
      
      // Simulation de l'analyse avec progression
      let progress = 0;
      const steps = [
        'Lecture du CCTP...',
        'Analyse du DPGF...',
        'Comparaison des devis...',
        'Calcul des Ã©carts...',
        'GÃ©nÃ©ration des recommandations...',
        'CrÃ©ation du rapport Excel...'
      ];
      
      const interval = setInterval(() => {
        progress += 17;
        const stepIndex = Math.min(Math.floor(progress / 17), steps.length - 1);
        progressBar.style.width = `${Math.min(progress, 100)}%`;
        progressText.textContent = steps[stepIndex];
        
        if (progress >= 100) {
          clearInterval(interval);
          setTimeout(() => {
            progressDiv.classList.add('hidden');
            generateAnalyseExcel();
          }, 500);
        }
      }, 800);
    }
    
    function generateAnalyseExcel() {
      const chantierObj = chantiers.find(c => c.id == document.getElementById('analyseChantier').value);
      const lot = document.getElementById('analyseLot').value;
      const devisNames = analyseFiles.devis.map(f => f.name.replace(/\.[^/.]+$/, ''));
      
      // GÃ©nÃ©ration du contenu Excel (format CSV compatible Excel)
      let content = '\uFEFF'; // BOM UTF-8
      
      // En-tÃªte
      content += 'RAPPORT D\'ANALYSE IA - BTP CONNECT\n';
      content += `Date;${new Date().toLocaleDateString('fr-FR')}\n`;
      content += `Chantier;${chantierObj?.nom || 'N/A'}\n`;
      content += `Lot;${lot}\n`;
      content += `Nombre de devis;${analyseFiles.devis.length}\n\n`;
      
      // Tableau comparatif
      content += 'COMPARATIF DES DEVIS\n';
      content += `CritÃ¨re;${devisNames.join(';')};Ã‰cart Max;Recommandation\n`;
      
      // DonnÃ©es simulÃ©es d'analyse
      const criteres = [
        { nom: 'Prix total HT', values: devisNames.map(() => Math.floor(Math.random() * 50000) + 80000) },
        { nom: 'DÃ©lai (jours)', values: devisNames.map(() => Math.floor(Math.random() * 30) + 45) },
        { nom: 'Main d\'oeuvre', values: devisNames.map(() => Math.floor(Math.random() * 20000) + 30000) },
        { nom: 'Fournitures', values: devisNames.map(() => Math.floor(Math.random() * 30000) + 40000) },
        { nom: 'ConformitÃ© CCTP (%)', values: devisNames.map(() => Math.floor(Math.random() * 20) + 80) },
        { nom: 'Garantie (mois)', values: devisNames.map(() => [12, 24, 36][Math.floor(Math.random() * 3)]) },
        { nom: 'Qualification', values: devisNames.map(() => ['RGE', 'Qualibat', 'NF'][Math.floor(Math.random() * 3)]) }
      ];
      
      criteres.forEach(c => {
        const numericValues = c.values.filter(v => typeof v === 'number');
        const ecart = numericValues.length > 0 ? Math.max(...numericValues) - Math.min(...numericValues) : 'N/A';
        const minIndex = numericValues.indexOf(Math.min(...numericValues));
        const reco = c.nom.includes('Prix') || c.nom.includes('DÃ©lai') ? 
          `Devis ${minIndex + 1} le plus avantageux` : 
          c.nom.includes('ConformitÃ©') ? `Devis ${c.values.indexOf(Math.max(...c.values)) + 1} le plus conforme` : 
          'Ã€ Ã©valuer selon prioritÃ©s';
        
        content += `${c.nom};${c.values.join(';')};${ecart};${reco}\n`;
      });
      
      content += '\n';
      
      // Analyse des risques
      content += 'ANALYSE DES RISQUES\n';
      content += 'Type de risque;Niveau;Description;Recommandation\n';
      content += 'Ã‰cart de prix;Moyen;DiffÃ©rence de ' + Math.floor(Math.random() * 15 + 5) + '% entre devis;VÃ©rifier le dÃ©tail des prestations\n';
      content += 'DÃ©lai;Faible;DÃ©lais cohÃ©rents;PrÃ©voir marge de sÃ©curitÃ© de 10%\n';
      content += 'ConformitÃ©;Moyen;Certains devis incomplets;Demander complÃ©ments aux ST concernÃ©s\n';
      
      content += '\n';
      
      // Recommandation finale
      content += 'RECOMMANDATION FINALE\n';
      const bestDevis = Math.floor(Math.random() * devisNames.length);
      content += `Devis recommandÃ©;${devisNames[bestDevis]}\n`;
      content += 'Justification;Meilleur rapport qualitÃ©/prix avec conformitÃ© CCTP optimale\n';
      content += 'Score global;' + (85 + Math.floor(Math.random() * 10)) + '/100\n';
      
      // TÃ©lÃ©chargement
      const filename = `Analyse_IA_${chantierObj?.nom?.replace(/\s/g, '_') || 'Chantier'}_${lot.replace(/\s/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
      
      const blob = new Blob([content], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
      
      showToast(`âœ… Rapport d'analyse tÃ©lÃ©chargÃ©: ${filename}`, 'success');
      addAdminLog('success', `Analyse IA gÃ©nÃ©rÃ©e: ${chantierObj?.nom} - ${lot}`);
    }

    // ========== PARAMETRES ==========
    function showParamSection(section) {
      document.querySelectorAll('.param-section').forEach(s => s.classList.add('hidden'));
      document.getElementById('param-section-' + section)?.classList.remove('hidden');
      document.querySelectorAll('[id^="param-btn-"]').forEach(b => { 
        b.classList.remove('bg-violet-600', 'text-white'); 
        b.classList.add('bg-slate-700', 'text-slate-300'); 
      });
      const btn = document.getElementById('param-btn-' + section);
      if (btn) { 
        btn.classList.add('bg-violet-600', 'text-white'); 
        btn.classList.remove('bg-slate-700', 'text-slate-300'); 
      }
    }

    // ========== A2 SYSTEME (mode local/LAN/cloud) ==========
    let _sysLanExpose = false;

    function toggleLanExpose() {
      _sysLanExpose = !_sysLanExpose;
      const btn = document.getElementById('sysLanExposeBtn');
      if (!btn) return;
      if (_sysLanExpose) {
        btn.textContent = 'ActivÃ©';
        btn.classList.add('active');
      } else {
        btn.textContent = 'DÃ©sactivÃ©';
        btn.classList.remove('active');
      }
    }

    async function loadSystemeConfig() {
      try {
        if (!window.btpconnect || !window.btpconnect.config) {
          // Mode navigateur - simuler des valeurs par dÃ©faut
          document.getElementById('sysMode').value = 'local';
          document.getElementById('sysBackendPort').value = 3000;
          document.getElementById('sysResolvedBackendUrl').textContent = window.location.origin;
          document.getElementById('sysCurrentMode').textContent = 'Navigateur (web)';
          document.getElementById('sysLocalIP').textContent = 'N/A (mode web)';
          document.getElementById('sysLanUrl').textContent = 'N/A (mode web)';
          updateModeCards();
          showToast('â„¹ï¸ Mode navigateur: configuration systÃ¨me limitÃ©e', 'info');
          return;
        }
        
        const cfg = await window.btpconnect.config.get();
        document.getElementById('sysMode').value = cfg.mode || 'local';
        document.getElementById('sysApiUrl').value = cfg.cloudUrl || cfg.apiUrl || '';
        document.getElementById('sysBackendPort').value = cfg.backendPort || 3000;
        _sysLanExpose = !!cfg.lanExpose;
        
        // Update toggle button
        const btn = document.getElementById('sysLanExposeBtn');
        if (btn) {
          if (_sysLanExpose) {
            btn.textContent = 'ActivÃ©';
            btn.classList.add('active', 'bg-emerald-600');
          } else {
            btn.textContent = 'DÃ©sactivÃ©';
            btn.classList.remove('active', 'bg-emerald-600');
          }
        }
        
        // Get backend URL and network info
        const url = await window.btpconnect.backendUrl();
        document.getElementById('sysResolvedBackendUrl').textContent = url || '';
        
        // Afficher le mode actuel
        const modeLabels = { local: 'ğŸ’» Local', lan: 'ğŸŒ LAN', cloud: 'â˜ï¸ Cloud' };
        document.getElementById('sysCurrentMode').textContent = modeLabels[cfg.mode] || cfg.mode;
        
        // Afficher les infos rÃ©seau
        if (cfg.localIP) {
          document.getElementById('sysLocalIP').textContent = cfg.localIP;
          document.getElementById('sysLanUrl').textContent = cfg.lanUrl || `http://${cfg.localIP}:${cfg.backendPort}`;
        }
        
        // Essayer d'obtenir plus d'infos rÃ©seau
        if (window.btpconnect.network) {
          const netInfo = await window.btpconnect.network.info();
          if (netInfo) {
            document.getElementById('sysLocalIP').textContent = netInfo.localIP || '-';
            document.getElementById('sysLanUrl').textContent = netInfo.lanUrl || '-';
          }
        }
        
        updateModeCards();
        
      } catch (e) {
        console.error(e);
        showToast('âŒ Impossible de charger la configuration systÃ¨me', 'error');
      }
    }
    
    function selectMode(mode) {
      document.getElementById('sysMode').value = mode;
      updateModeCards();
    }
    
    function updateModeCards() {
      const mode = document.getElementById('sysMode').value;
      
      // Update cards
      document.querySelectorAll('.mode-card').forEach(card => {
        card.classList.remove('border-violet-500', 'bg-violet-500/10');
        card.classList.add('border-transparent');
      });
      const activeCard = document.getElementById(`mode-card-${mode}`);
      if (activeCard) {
        activeCard.classList.add('border-violet-500', 'bg-violet-500/10');
        activeCard.classList.remove('border-transparent');
      }
      
      // Show/hide relevant sections
      const cloudSection = document.getElementById('cloudUrlSection');
      const lanSection = document.getElementById('lanExposeSection');
      
      if (cloudSection) cloudSection.classList.toggle('hidden', mode !== 'cloud');
      if (lanSection) lanSection.classList.toggle('hidden', mode !== 'lan');
    }
    
    function copyLanUrl() {
      const url = document.getElementById('sysLanUrl')?.textContent;
      if (url && url !== '-' && url !== 'N/A (mode web)') {
        navigator.clipboard?.writeText(url);
        showToast('ğŸ“‹ URL LAN copiÃ©e', 'success');
      } else {
        showToast('âš ï¸ URL non disponible', 'warning');
      }
    }

    async function saveSystemeConfig(andRestart) {
      try {
        if (!window.btpconnect || !window.btpconnect.config) {
          showToast('âš ï¸ Mode navigateur: configuration systÃ¨me indisponible', 'warning');
          return;
        }

        const payload = {
          mode: document.getElementById('sysMode').value,
          apiUrl: document.getElementById('sysApiUrl').value,
          backendPort: Number(document.getElementById('sysBackendPort').value || 3000),
          lanExpose: _sysLanExpose,
        };

        const res = await window.btpconnect.config.set(payload);
        if (!res || !res.ok) {
          showToast('âŒ Sauvegarde refusÃ©e', 'error');
          return;
        }
        showToast('âœ… Configuration enregistrÃ©e', 'success');

        if (andRestart) {
          if (confirm('Appliquer le nouveau mode nÃ©cessite un redÃ©marrage. RedÃ©marrer maintenant ?')) {
            await window.btpconnect.relaunch();
          }
        } else {
          showToast('â„¹ï¸ Le changement de mode sera appliquÃ© au prochain dÃ©marrage', 'info');
        }
      } catch (e) {
        console.error(e);
        showToast('âŒ Erreur lors de la sauvegarde', 'error');
      }
    }
    
    function sauvegarderParametres() {
      // Mettre Ã  jour l'aperÃ§u
      const nom = document.getElementById('configNomEntreprise')?.value || '';
      const adresse = document.getElementById('configAdresse')?.value || '';
      const cp = document.getElementById('configCodePostal')?.value || '';
      const ville = document.getElementById('configVille')?.value || '';
      const tel = document.getElementById('configTelephone')?.value || '';
      const email = document.getElementById('configEmail')?.value || '';
      const siret = document.getElementById('configSiret')?.value || '';
      const tva = document.getElementById('configTva')?.value || '';
      
      if (document.getElementById('apercuNom')) document.getElementById('apercuNom').textContent = nom;
      if (document.getElementById('apercuAdresse')) document.getElementById('apercuAdresse').textContent = `${adresse}, ${cp} ${ville}`;
      if (document.getElementById('apercuContact')) document.getElementById('apercuContact').textContent = `${tel} / ${email}`;
      if (document.getElementById('apercuLegal')) document.getElementById('apercuLegal').textContent = `SIRET: ${siret} - TVA: ${tva}`;
      
      showToast('âœ… ParamÃ¨tres sauvegardÃ©s avec succÃ¨s !');
    }
    
    function reinitialiserParametres() {
      if (confirm('RÃ©initialiser tous les paramÃ¨tres aux valeurs par dÃ©faut ?')) {
        showToast('ğŸ”„ ParamÃ¨tres rÃ©initialisÃ©s');
      }
    }
    
    function exporterCSV(type) {
      // Mapper les noms de type vers ceux attendus par exportCSV
      const typeMap = {
        'sous-traitants': 'soustraitants',
        'chantiers': 'chantiers',
        'situations': 'situations',
        'factures': 'factures'
      };
      const mappedType = typeMap[type] || type;
      exportCSV(mappedType);
    }
    
    function copierLienPortail(type, stId = null) {
      let lien = '';
      const baseUrl = window.location.origin;
      
      if (stId) {
        // Lien spÃ©cifique Ã  une entreprise
        const st = sousTraitants.find(s => s.id === stId);
        const token = btoa(`st-${stId}-${Date.now()}`).replace(/=/g, '');
        lien = `${baseUrl}/portail/entreprise/${token}`;
        showToast(`ğŸ“‹ Lien portail copiÃ© pour ${st?.nom || 'l\'entreprise'}`, 'success');
      } else if (type === 'st') {
        lien = `${baseUrl}/portail/sous-traitants`;
        showToast('ğŸ“‹ Lien portail ST copiÃ©', 'success');
      } else {
        lien = `${baseUrl}/portail/maitre-ouvrage`;
        showToast('ğŸ“‹ Lien portail MO copiÃ©', 'success');
      }
      
      navigator.clipboard?.writeText(lien);
    }
    
    function envoyerDemandeDoc() {
      const stId = document.getElementById('demandeDocST')?.value;
      if (!stId) { showToast('âš ï¸ SÃ©lectionnez un sous-traitant', 'warning'); return; }
      
      const st = sousTraitants.find(s => s.id == stId);
      if (!st?.email) {
        showToast('âš ï¸ Cette entreprise n\'a pas d\'email configurÃ©', 'warning');
        return;
      }
      
      const docTypes = [];
      document.querySelectorAll('#modalDemandeDoc input[type="checkbox"]:checked').forEach(cb => {
        docTypes.push(cb.value || cb.nextSibling?.textContent?.trim());
      });
      
      // Envoi de l'email via l'API
      envoyerEmailDemande(st, docTypes);
      closeModal('modalDemandeDoc');
    }
    
    async function envoyerEmailDemande(st, docTypes) {
      const emailTemplate = localStorage.getItem('btp-email-template-demande') || getDefaultEmailTemplate('demande');
      const subject = `[BTP Connect] Demande de documents - ${currentUser?.entreprise || 'Entreprise'}`;
      const body = emailTemplate
        .replace('{NOM_ST}', st.nom)
        .replace('{DOCUMENTS}', docTypes.join(', ') || 'Documents requis')
        .replace('{NOM_ENTREPRISE}', currentUser?.entreprise || 'Notre entreprise')
        .replace('{LIEN_PORTAIL}', `${window.location.origin}/portail/depot/${btoa(st.id)}`);
      
      // Ouvrir le client mail avec les infos prÃ©-remplies
      const mailtoLink = `mailto:${st.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      window.open(mailtoLink, '_blank');
      
      showToast(`ğŸ“§ Email de demande prÃ©parÃ© pour ${st.nom}`, 'success');
      addAdminLog('info', `Demande de documents envoyÃ©e Ã  ${st.nom}`);
    }
    
    function getDefaultEmailTemplate(type) {
      const templates = {
        demande: `Bonjour {NOM_ST},

Nous avons besoin des documents suivants pour votre dossier :
{DOCUMENTS}

Merci de les dÃ©poser sur notre portail sÃ©curisÃ© :
{LIEN_PORTAIL}

Cordialement,
{NOM_ENTREPRISE}`,
        relance: `Bonjour {NOM_ST},

Nous vous rappelons que le document "{DOCUMENT}" est manquant ou expirÃ©.

Merci de le dÃ©poser rapidement sur notre portail :
{LIEN_PORTAIL}

Cordialement,
{NOM_ENTREPRISE}`
      };
      return templates[type] || templates.demande;
    }
    
    function relancerDocST(docId) {
      const doc = documents.find(d => d.id === docId);
      if (!doc) return;
      
      const st = sousTraitants.find(s => s.id === doc.stId);
      if (!st?.email) {
        showToast('âš ï¸ Email non configurÃ© pour ce ST', 'warning');
        return;
      }
      
      const emailTemplate = localStorage.getItem('btp-email-template-relance') || getDefaultEmailTemplate('relance');
      const subject = `[BTP Connect] Relance document - ${doc.type || doc.nom}`;
      const body = emailTemplate
        .replace('{NOM_ST}', st.nom)
        .replace('{DOCUMENT}', doc.type || doc.nom)
        .replace('{NOM_ENTREPRISE}', currentUser?.entreprise || 'Notre entreprise')
        .replace('{LIEN_PORTAIL}', `${window.location.origin}/portail/depot/${btoa(st.id)}`);
      
      const mailtoLink = `mailto:${st.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      window.open(mailtoLink, '_blank');
      
      showToast(`ğŸ“§ Relance envoyÃ©e Ã  ${st.nom}`, 'success');
      addAdminLog('info', `Relance document envoyÃ©e Ã  ${st.nom}: ${doc.type || doc.nom}`);
    }
    
    function filterAnnuaire() {
      const search = document.getElementById('searchAnnuaire')?.value.toLowerCase() || '';
      const metier = document.getElementById('filterCorpsMetier')?.value || '';
      renderAnnuaire(search, metier);
    }

    // ========== MODAL STATS ==========
    function renderModalContent(id) {
      if (id === 'modalStatsAnnuaire') {
        // Calculer les stats par mÃ©tier
        const metierStats = {};
        sousTraitants.forEach(st => {
          const m = st.corpsMetier || 'Autre';
          metierStats[m] = (metierStats[m] || 0) + 1;
        });
        
        const metierEmojis = {
          'Ã‰lectricitÃ©': 'âš¡', 'Plomberie': 'ğŸ”§', 'Climatisation': 'â„ï¸', 'Peinture': 'ğŸ¨',
          'MaÃ§onnerie': 'ğŸ§±', 'Menuiserie': 'ğŸªµ', 'Carrelage': 'ğŸ”²', 'Couverture': 'ğŸ ',
          'Serrurerie': 'ğŸ”©', 'Transport': 'ğŸš›', 'Autre': 'ğŸ¢'
        };
        
        const sortedMetiers = Object.entries(metierStats).sort((a, b) => b[1] - a[1]);
        const totalST = sousTraitants.length;
        const avgNote = totalST > 0 ? (sousTraitants.reduce((s, st) => s + (st.note || 0), 0) / totalST).toFixed(1) : '0';
        const priveCount = sousTraitants.filter(s => s.dansAnnuairePrivate !== false).length;
        
        document.getElementById('statsAnnuaireContent').innerHTML = `
          <div class="grid grid-cols-3 gap-4 mb-6">
            <div class="p-4 bg-violet-500/10 rounded-xl text-center">
              <p class="text-3xl font-bold text-violet-400">${totalST}</p>
              <p class="text-sm text-slate-500">Total ST</p>
            </div>
            <div class="p-4 bg-emerald-500/10 rounded-xl text-center">
              <p class="text-3xl font-bold text-emerald-400">${priveCount}</p>
              <p class="text-sm text-slate-500">Annuaire privÃ©</p>
            </div>
            <div class="p-4 bg-amber-500/10 rounded-xl text-center">
              <p class="text-3xl font-bold text-amber-400">${avgNote}</p>
              <p class="text-sm text-slate-500">Note moyenne</p>
            </div>
          </div>
          <h4 class="font-semibold text-slate-200 mb-4">ğŸ“Š RÃ©partition par corps de mÃ©tier</h4>
          <div class="space-y-3">
            ${sortedMetiers.map(([metier, count]) => {
              const pct = Math.round((count / totalST) * 100);
              return `
                <div class="p-3 bg-slate-800/30 rounded-xl">
                  <div class="flex justify-between mb-2">
                    <span class="text-slate-300">${metierEmojis[metier] || 'ğŸ¢'} ${metier}</span>
                    <span class="text-violet-400 font-medium">${count} ST (${pct}%)</span>
                  </div>
                  <div class="progress-bar h-2"><div class="progress-fill bg-violet-500" style="width: ${pct}%"></div></div>
                </div>
              `;
            }).join('')}
          </div>`;
      }
      
      if (id === 'modalStatsChantiers') {
        const totalCA = chantiers.reduce((s, c) => s + (c.montantTotal || 0), 0);
        const avgAvancement = chantiers.length > 0 ? Math.round(chantiers.reduce((s, c) => s + (c.avancement || 0), 0) / chantiers.length) : 0;
        const enCours = chantiers.filter(c => c.statut === 'en_cours').length;
        const termines = chantiers.filter(c => c.statut === 'termine').length;
        
        document.getElementById('statsChantiersContent').innerHTML = `
          <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="p-4 bg-emerald-500/10 rounded-xl text-center">
              <p class="text-2xl font-bold text-emerald-400">${chantiers.length}</p>
              <p class="text-xs text-slate-500">Total</p>
            </div>
            <div class="p-4 bg-sky-500/10 rounded-xl text-center">
              <p class="text-2xl font-bold text-sky-400">${enCours}</p>
              <p class="text-xs text-slate-500">En cours</p>
            </div>
            <div class="p-4 bg-violet-500/10 rounded-xl text-center">
              <p class="text-2xl font-bold text-violet-400">${termines}</p>
              <p class="text-xs text-slate-500">TerminÃ©s</p>
            </div>
            <div class="p-4 bg-amber-500/10 rounded-xl text-center">
              <p class="text-2xl font-bold text-amber-400">${avgAvancement}%</p>
              <p class="text-xs text-slate-500">Avancement moy.</p>
            </div>
          </div>
          <div class="p-4 bg-emerald-500/10 rounded-xl mb-6 text-center">
            <p class="text-sm text-slate-400">Chiffre d'affaires total</p>
            <p class="text-3xl font-bold text-emerald-400">${formatMontant(totalCA)}</p>
          </div>
          <h4 class="font-semibold text-slate-200 mb-4">ğŸ—ï¸ DÃ©tail par chantier</h4>
          <div class="space-y-3 max-h-64 overflow-y-auto">
            ${chantiers.map(c => `
              <div class="p-4 bg-slate-800/30 rounded-xl">
                <div class="flex justify-between mb-2">
                  <span class="font-medium text-slate-200">${escapeHtml(c.nom)}</span>
                  <span class="text-emerald-400">${formatMontant(c.montantTotal)}</span>
                </div>
                <div class="flex items-center gap-3">
                  <div class="flex-1 progress-bar h-2"><div class="progress-fill bg-violet-500" style="width: ${c.avancement || 0}%"></div></div>
                  <span class="text-xs text-slate-500">${c.avancement || 0}%</span>
                </div>
                <p class="text-xs text-slate-500 mt-1">ğŸ“ ${escapeHtml(c.adresse || '')} â€¢ ${c.statut === 'en_cours' ? 'ğŸŸ¢ En cours' : c.statut === 'termine' ? 'âœ… TerminÃ©' : 'â¸ï¸ Suspendu'}</p>
              </div>
            `).join('') || '<p class="text-slate-500 text-center">Aucun chantier</p>'}
          </div>`;
      }
      
      if (id === 'modalStatsSituations') {
        const flux = situations.filter(s => s.flux === currentFlux);
        const soumises = flux.filter(s => s.statut === 'soumise').length;
        const validees = flux.filter(s => s.statut === 'validee').length;
        const refusees = flux.filter(s => s.statut === 'refusee').length;
        const totalMontant = flux.reduce((s, x) => s + (x.montantMois || 0), 0);
        const montantValide = flux.filter(s => s.statut === 'validee').reduce((s, x) => s + (x.montantMois || 0), 0);
        
        document.getElementById('statsSituationsContent').innerHTML = `
          <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="p-4 bg-amber-500/10 rounded-xl text-center">
              <p class="text-3xl font-bold text-amber-400">${soumises}</p>
              <p class="text-sm text-slate-500">â³ En attente</p>
            </div>
            <div class="p-4 bg-emerald-500/10 rounded-xl text-center">
              <p class="text-3xl font-bold text-emerald-400">${validees}</p>
              <p class="text-sm text-slate-500">âœ… ValidÃ©es</p>
            </div>
            <div class="p-4 bg-red-500/10 rounded-xl text-center">
              <p class="text-3xl font-bold text-red-400">${refusees}</p>
              <p class="text-sm text-slate-500">âŒ RefusÃ©es</p>
            </div>
            <div class="p-4 bg-violet-500/10 rounded-xl text-center">
              <p class="text-3xl font-bold text-violet-400">${flux.length}</p>
              <p class="text-sm text-slate-500">ğŸ“‹ Total</p>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="p-4 bg-slate-800/30 rounded-xl text-center">
              <p class="text-sm text-slate-400">Montant total</p>
              <p class="text-2xl font-bold text-slate-200">${formatMontant(totalMontant)}</p>
            </div>
            <div class="p-4 bg-emerald-500/10 rounded-xl text-center">
              <p class="text-sm text-slate-400">Montant validÃ©</p>
              <p class="text-2xl font-bold text-emerald-400">${formatMontant(montantValide)}</p>
            </div>
          </div>
          <h4 class="font-semibold text-slate-200 mb-4">ğŸ“Š Taux de validation</h4>
          <div class="p-4 bg-slate-800/30 rounded-xl">
            <div class="flex justify-between mb-2">
              <span class="text-slate-400">Taux global</span>
              <span class="text-emerald-400 font-bold">${flux.length > 0 ? Math.round((validees / flux.length) * 100) : 0}%</span>
            </div>
            <div class="progress-bar h-3"><div class="progress-fill bg-emerald-500" style="width: ${flux.length > 0 ? Math.round((validees / flux.length) * 100) : 0}%"></div></div>
          </div>`;
      }
      if (id === 'modalDemandeDoc') {
        document.getElementById('demandeDocST').innerHTML = sousTraitants.map(st => `<option value="${st.id}">${st.nom}</option>`).join('');
      }
    }

    // ========== ADMIN FUNCTIONS ==========
    let adminImportData = null;
    let iaFiles = [];
    const adminLogs = [];

    function addAdminLog(type, message) {
      const now = new Date();
      const timeStr = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
      const icons = { success: 'âœ“', info: 'â„¹', warning: 'âš¡', error: 'âœ•' };
      const colors = { success: 'emerald', info: 'sky', warning: 'amber', error: 'red' };
      adminLogs.unshift({ type, message, time: timeStr });
      renderAdminLogs();
    }
    
    // Gestion de l'historique des modifications
    function undoHistoryAction(actionId, actionType, tableName) {
      if (!confirm(`Annuler cette action (${actionType} sur ${tableName}) ?`)) return;
      
      // Simulation de l'annulation
      showToast(`ğŸ”„ Action annulÃ©e: ${actionType} sur ${tableName}`, 'info');
      addAdminLog('warning', `Action annulÃ©e: ${actionType} sur ${tableName}`);
      
      // Masquer la ligne dans le tableau
      const row = event.target.closest('tr');
      if (row) {
        row.style.opacity = '0.5';
        row.querySelector('button').disabled = true;
        row.querySelector('button').textContent = 'âœ“ AnnulÃ©';
      }
    }
    
    function restoreHistoryAction(actionId, actionType, tableName) {
      if (!confirm(`Restaurer cet Ã©lÃ©ment supprimÃ© de ${tableName} ?`)) return;
      
      // Simulation de la restauration
      showToast(`âœ… Ã‰lÃ©ment restaurÃ© dans ${tableName}`, 'success');
      addAdminLog('success', `Ã‰lÃ©ment restaurÃ©: ${tableName}`);
      
      // Masquer la ligne dans le tableau
      const row = event.target.closest('tr');
      if (row) {
        row.style.opacity = '0.5';
        row.querySelector('button').disabled = true;
        row.querySelector('button').textContent = 'âœ“ RestaurÃ©';
      }
    }

    function renderAdminLogs() {
      const container = document.getElementById('adminLogsContainer');
      if (!container) return;
      const icons = { success: 'âœ“', info: 'â„¹', warning: 'âš¡', error: 'âœ•' };
      const colors = { success: 'emerald', info: 'sky', warning: 'amber', error: 'red' };
      container.innerHTML = adminLogs.slice(0, 20).map(log => `
        <div class="flex items-center gap-3 p-2 bg-slate-800/30 rounded-lg text-sm">
          <span class="text-${colors[log.type]}-400">${icons[log.type]}</span>
          <span class="text-slate-500 text-xs">${log.time}</span>
          <span class="text-slate-300">${log.message}</span>
        </div>
      `).join('');
    }

    function updateAdminStats() {
      // Mettre Ã  jour les stats depuis les donnÃ©es locales et l'API
      document.getElementById('admin-st-count').textContent = sousTraitants.length;
      document.getElementById('admin-chantiers-count').textContent = chantiers.length;
      
      // Charger les stats supplÃ©mentaires depuis l'API
      loadAdminStatsFromAPI();
    }

    // Charger les stats admin depuis l'API
    async function loadAdminStatsFromAPI() {
      try {
        const [contratsRes, situationsRes, docsRes, facturesRes] = await Promise.all([
          apiFetch('/contrats').catch(() => ({ items: [] })),
          apiFetch('/situations').catch(() => ({ items: [] })),
          apiFetch('/documents').catch(() => ({ items: [] })),
          apiFetch('/factures/stats').catch(() => ({ stats: {} }))
        ]);
        
        document.getElementById('admin-contrats-count').textContent = contratsRes.items?.length || 0;
        document.getElementById('admin-situations-count').textContent = situationsRes.items?.length || 0;
        document.getElementById('admin-docs-count').textContent = docsRes.items?.length || 0;
        
        // Stocker pour export
        window.adminData = {
          contrats: contratsRes.items || [],
          situations: situationsRes.items || [],
          documents: docsRes.items || [],
          facturesStats: facturesRes.stats || {}
        };
        
        console.log('âœ… Stats admin chargÃ©es depuis API');
      } catch (err) {
        console.warn('âš ï¸ Erreur chargement stats admin:', err);
      }
    }

    function handleAdminDrop(e) {
      e.preventDefault();
      const files = e.dataTransfer.files;
      handleAdminFiles(files);
    }

    function handleAdminFiles(files) {
      if (files.length === 0) return;
      const file = files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          if (file.name.endsWith('.json')) {
            adminImportData = JSON.parse(e.target.result);
          } else if (file.name.endsWith('.csv')) {
            const lines = e.target.result.split('\n').filter(l => l.trim());
            adminImportData = { rows: lines.length - 1, raw: e.target.result };
          }
          document.getElementById('adminImportPreview').classList.remove('hidden');
          document.getElementById('adminImportFileName').textContent = file.name;
          document.getElementById('adminImportInfo').textContent = 
            Array.isArray(adminImportData) ? `${adminImportData.length} Ã©lÃ©ments dÃ©tectÃ©s` :
            adminImportData.rows ? `${adminImportData.rows} lignes dÃ©tectÃ©es` : 'DonnÃ©es chargÃ©es';
          addAdminLog('info', `Fichier chargÃ©: ${file.name}`);
        } catch (err) {
          showToast('Erreur de lecture du fichier', 'error');
          addAdminLog('error', `Erreur lecture: ${file.name}`);
        }
      };
      reader.readAsText(file);
    }

    function clearAdminImport() {
      adminImportData = null;
      document.getElementById('adminImportPreview').classList.add('hidden');
      document.getElementById('adminFileInput').value = '';
    }

    function executeAdminImport() {
      const type = document.getElementById('adminImportType').value;
      if (!type) { showToast('SÃ©lectionnez un type de donnÃ©es', 'warning'); return; }
      if (!adminImportData) { showToast('Aucun fichier chargÃ©', 'warning'); return; }
      
      // Simulation d'import
      const count = Array.isArray(adminImportData) ? adminImportData.length : (adminImportData.rows || 0);
      showToast(`${count} ${type} importÃ©s avec succÃ¨s`, 'success');
      addAdminLog('success', `Import ${type}: ${count} Ã©lÃ©ments`);
      clearAdminImport();
      updateAdminStats();
    }

    function exportAdminData(format) {
      // Utiliser les donnÃ©es de l'API si disponibles
      const data = { 
        soustraitants: sousTraitants, 
        chantiers: chantiers, 
        contrats: window.adminData?.contrats || [],
        situations: window.adminData?.situations || [],
        factures: window.adminData?.factures || [],
        documents: window.adminData?.documents || [],
        users: users
      };
      
      let content, filename, type;
      
      if (format === 'json') {
        content = JSON.stringify(data, null, 2);
        filename = `btp-connect-export-${new Date().toISOString().slice(0,10)}.json`;
        type = 'application/json';
      } else if (format === 'backup') {
        content = JSON.stringify({
          exportDate: new Date().toISOString(),
          version: 'v8.11-API',
          data: data
        }, null, 2);
        filename = `btp-backup-${new Date().toISOString().split('T')[0]}.json`;
        type = 'application/json';
      } else if (format === 'csv') {
        // Export CSV complet avec BOM UTF-8 et sÃ©parateur ;
        content = '\uFEFF'; // BOM UTF-8
        content += 'TYPE;ID;NOM;DETAILS;MONTANT;STATUT\n';
        sousTraitants.forEach(st => content += `Sous-traitant;${st.id};"${st.nom}";"${st.corpsMetier || ''} - ${st.ville || ''}";0;Actif\n`);
        chantiers.forEach(c => content += `Chantier;${c.id};"${c.nom}";"${c.client || ''}";${c.montantTotal || 0};${c.statut || ''}\n`);
        (window.adminData?.contrats || []).forEach(c => content += `Contrat;${c.id};"${c.lot || ''}";"Chantier:${c.chantierId}";${c.montantMarche || 0};${c.statut || ''}\n`);
        (window.adminData?.situations || []).forEach(s => content += `Situation;${s.id};"Situation ${s.numero}";"${s.mois || ''}";${s.montantHT || 0};${s.statut || ''}\n`);
        (window.adminData?.factures || []).forEach(f => content += `Facture;${f.id};"${f.numero || ''}";"Chantier";${f.montantHT || 0};${f.statut || ''}\n`);
        filename = `btp-connect-export-${new Date().toISOString().slice(0,10)}.csv`;
        type = 'text/csv;charset=utf-8';
      } else if (format === 'sql') {
        content = '-- ================================================\n';
        content += '-- BTP Connect SQL Export v8.11\n';
        content += '-- Date: ' + new Date().toISOString() + '\n';
        content += '-- ================================================\n\n';
        
        content += '-- Table: SousTraitant\n';
        sousTraitants.forEach(st => {
          const nom = (st.nom || '').replace(/'/g, "''");
          content += `INSERT INTO SousTraitant (nom, metier, ville, note) VALUES ('${nom}', '${st.corpsMetier || ''}', '${st.ville || ''}', ${st.note || 0});\n`;
        });
        
        content += '\n-- Table: Chantier\n';
        chantiers.forEach(c => {
          const nom = (c.nom || '').replace(/'/g, "''");
          const client = (c.client || '').replace(/'/g, "''");
          content += `INSERT INTO Chantier (nom, client, montant, statut) VALUES ('${nom}', '${client}', ${c.montantTotal || 0}, '${c.statut || ''}');\n`;
        });
        
        filename = `btp-connect-export-${new Date().toISOString().slice(0,10)}.sql`;
        type = 'text/plain';
      } else {
        showToast('Format non supportÃ©', 'error');
        return;
      }
      
      const blob = new Blob([content], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
      
      addAdminLog('success', `Export ${format.toUpperCase()} gÃ©nÃ©rÃ© (${filename})`);
      showToast(`âœ… Export ${format.toUpperCase()} tÃ©lÃ©chargÃ©`, 'success');
    }

    function confirmResetTable() {
      const table = prompt('Quelle table vider ? (soustraitants/chantiers/contrats/situations/documents)');
      if (!table) return;
      if (confirm(`âš ï¸ ATTENTION: Voulez-vous vraiment vider la table "${table}" ? Cette action est irrÃ©versible.`)) {
        addAdminLog('warning', `Table ${table} vidÃ©e`);
        showToast(`Table ${table} vidÃ©e`, 'warning');
        updateAdminStats();
      }
    }

    function confirmResetAll() {
      if (confirm('âš ï¸ DANGER: Voulez-vous vraiment TOUT supprimer ? Cette action est IRRÃ‰VERSIBLE !')) {
        if (prompt('Tapez "CONFIRMER" pour valider') === 'CONFIRMER') {
          addAdminLog('error', 'Base de donnÃ©es rÃ©initialisÃ©e');
          showToast('Base de donnÃ©es rÃ©initialisÃ©e', 'warning');
          updateAdminStats();
        }
      }
    }

    function handleIADrop(e) {
      e.preventDefault();
      handleIAFiles(e.dataTransfer.files);
    }

    function handleIAFiles(files) {
      for (let file of files) {
        if (!iaFiles.find(f => f.name === file.name)) {
          iaFiles.push(file);
        }
      }
      renderIAFilesList();
    }

    function renderIAFilesList() {
      const container = document.getElementById('iaFilesList');
      container.innerHTML = iaFiles.map((f, i) => `
        <div class="flex items-center justify-between p-2 bg-slate-800/30 rounded-lg">
          <span class="text-sm text-slate-300">ğŸ“„ ${f.name}</span>
          <button onclick="iaFiles.splice(${i},1); renderIAFilesList();" class="text-red-400 hover:text-red-300 text-sm">âœ•</button>
        </div>
      `).join('');
    }

    function launchIAAnalysis() {
      if (iaFiles.length === 0) { showToast('Ajoutez des documents Ã  analyser', 'warning'); return; }
      const type = document.querySelector('input[name="iaAnalyseType"]:checked')?.value || 'extraction';
      
      document.getElementById('iaResultsContainer').classList.remove('hidden');
      document.getElementById('iaResults').innerHTML = `
        <div class="flex items-center gap-2 text-violet-400">
          <div class="animate-spin">â³</div>
          <span>Analyse en cours...</span>
        </div>
      `;
      
      setTimeout(() => {
        const results = iaFiles.map(f => ({
          file: f.name,
          status: 'success',
          findings: type === 'extraction' ? 'DonnÃ©es extraites avec succÃ¨s' :
                    type === 'conformite' ? 'Document conforme' :
                    type === 'anomalies' ? 'Aucune anomalie dÃ©tectÃ©e' :
                    'Classification: Document administratif'
        }));
        
        document.getElementById('iaResults').innerHTML = results.map(r => `
          <div class="p-3 bg-slate-800/50 rounded-lg mb-2">
            <div class="flex items-center gap-2 mb-1">
              <span class="text-emerald-400">âœ“</span>
              <span class="text-slate-200 font-medium">${r.file}</span>
            </div>
            <p class="text-sm text-slate-400 ml-6">${r.findings}</p>
          </div>
        `).join('');
        
        addAdminLog('success', `Analyse IA: ${iaFiles.length} documents traitÃ©s`);
        showToast('Analyse terminÃ©e', 'success');
      }, 2000);
    }

    function checkAdminAccess() {
      // VÃ©rifie si l'utilisateur est admin et affiche le menu
      const userStr = localStorage.getItem('btp-user');
      let isAdmin = false;
      
      if (userStr) {
        try {
          const user = JSON.parse(userStr);
          isAdmin = user.role === 'admin' || user.email === 'admin@btpconnect.fr' || user.email === 'demo@btpconnect.fr' || user.email === 'admin@btpconnect.local';
        } catch(e) {
          isAdmin = false;
        }
      }
      
      const adminContainer = document.getElementById('menu-admin-container');
      if (adminContainer) {
        if (isAdmin) {
          adminContainer.classList.remove('hidden');
        } else {
          adminContainer.classList.add('hidden');
        }
      }

      // Restreindre les onglets RÃ´les, Apparence et SystÃ¨me aux admins uniquement
      const adminOnlyTabs = ['param-btn-roles', 'param-btn-apparence', 'param-btn-systeme'];
      adminOnlyTabs.forEach(tabId => {
        const btn = document.getElementById(tabId);
        if (btn) {
          if (isAdmin) {
            btn.classList.remove('hidden');
          } else {
            btn.classList.add('hidden');
          }
        }
      });
      
      // Restreindre la modification des paramÃ¨tres aux admins
      const paramInputs = document.querySelectorAll('#tab-parametres input, #tab-parametres select, #tab-parametres textarea');
      paramInputs.forEach(input => {
        if (!isAdmin && !input.closest('#param-section-profil')) {
          input.disabled = true;
          input.title = 'Modification rÃ©servÃ©e aux administrateurs';
        }
      });
      
      // Cacher le bouton Documents dans la sidebar pour mobile
      const docsContainer = document.getElementById('menu-documents-container');
      if (docsContainer && window.innerWidth <= 768) {
        docsContainer.classList.add('hidden');
      }
    }
    
    function deconnexion() {
      if (confirm('ÃŠtes-vous sÃ»r de vouloir vous dÃ©connecter ?')) {
        showToast('ğŸšª DÃ©connexion en cours...');
        setTimeout(() => {
          localStorage.removeItem('btp-user');
          localStorage.removeItem('btp-token');
          isLoggedIn = false;
          showLandingPage();
          showToast('âœ… DÃ©connexion rÃ©ussie');
        }, 1000);
      }
    }
    
    // ========== INTEGRATIONS QUICK DEVIS / OPTIMA ==========
    function testQuickDevisConnection() {
      showToast('ğŸ”„ Test de connexion Quick Devis...');
      setTimeout(() => {
        const apiKey = document.getElementById('quickDevisApiKey').value;
        if (apiKey && apiKey.length > 10) {
          showToast('âœ… Connexion Quick Devis rÃ©ussie !', 'success');
          addAdminLog('success', 'Test Quick Devis: connexion OK');
        } else {
          showToast('âŒ ClÃ© API invalide', 'error');
          addAdminLog('error', 'Test Quick Devis: Ã©chec');
        }
      }, 1500);
    }
    
    function connectQuickDevis() {
      const apiKey = document.getElementById('quickDevisApiKey').value;
      if (!apiKey) { showToast('âš ï¸ Entrez une clÃ© API', 'warning'); return; }
      
      showToast('ğŸ”— Connexion Ã  Quick Devis...');
      setTimeout(() => {
        document.getElementById('quickDevisStatus').textContent = 'ConnectÃ©';
        document.getElementById('quickDevisStatus').className = 'ml-auto px-3 py-1 bg-emerald-500/20 text-emerald-400 rounded-full text-xs';
        document.getElementById('quickDevisActions').classList.remove('hidden');
        addAdminLog('success', 'Quick Devis connectÃ©');
        showToast('âœ… Quick Devis connectÃ© !', 'success');
      }, 2000);
    }
    
    function syncQuickDevis(action) {
      showToast(`ğŸ”„ ${action === 'import' ? 'Import' : 'Export'} Quick Devis en cours...`);
      setTimeout(() => {
        const count = Math.floor(Math.random() * 10) + 5;
        showToast(`âœ… ${count} devis ${action === 'import' ? 'importÃ©s' : 'exportÃ©s'}`, 'success');
        addAdminLog('success', `Quick Devis: ${count} devis ${action === 'import' ? 'importÃ©s' : 'exportÃ©s'}`);
      }, 2500);
    }
    
    function testOptimaConnection() {
      showToast('ğŸ”„ Test de connexion Optima...');
      setTimeout(() => {
        const token = document.getElementById('optimaToken').value;
        if (token && token.length > 10) {
          showToast('âœ… Connexion Optima rÃ©ussie !', 'success');
          addAdminLog('success', 'Test Optima: connexion OK');
        } else {
          showToast('âŒ Token invalide', 'error');
          addAdminLog('error', 'Test Optima: Ã©chec');
        }
      }, 1500);
    }
    
    function connectOptima() {
      const token = document.getElementById('optimaToken').value;
      if (!token) { showToast('âš ï¸ Entrez un token d\'accÃ¨s', 'warning'); return; }
      
      showToast('ğŸ”— Connexion Ã  Optima...');
      setTimeout(() => {
        document.getElementById('optimaStatus').textContent = 'ConnectÃ©';
        document.getElementById('optimaStatus').className = 'ml-auto px-3 py-1 bg-emerald-500/20 text-emerald-400 rounded-full text-xs';
        document.getElementById('optimaActions').classList.remove('hidden');
        addAdminLog('success', 'Optima connectÃ©');
        showToast('âœ… Optima connectÃ© !', 'success');
      }, 2000);
    }
    
    function syncOptima(dataType) {
      showToast(`ğŸ”„ Synchronisation ${dataType} Optima...`);
      setTimeout(() => {
        const count = Math.floor(Math.random() * 15) + 5;
        showToast(`âœ… ${count} ${dataType} synchronisÃ©s`, 'success');
        addAdminLog('success', `Optima: ${count} ${dataType} synchronisÃ©s`);
        if (dataType === 'chantiers') renderChantiers();
        if (dataType === 'soustraitants') renderAnnuaire();
      }, 3000);
    }
    
    // ========== ASSISTANT IA ADMIN ==========
    function sendAdminAiMessage() {
      const input = document.getElementById('adminAiInput');
      const message = input.value.trim();
      if (!message) return;
      askAdminAi(message);
      input.value = '';
    }
    
    function askAdminAi(question) {
      const chatContainer = document.getElementById('adminAiChat');
      
      chatContainer.innerHTML += `
        <div class="flex gap-3 mb-4 justify-end">
          <div class="bg-violet-600 p-3 rounded-xl rounded-tr-sm max-w-md">
            <p class="text-sm text-white">${escapeHtml(question)}</p>
          </div>
          <div class="w-8 h-8 bg-slate-700 rounded-full flex items-center justify-center text-sm">ğŸ‘¤</div>
        </div>
      `;
      
      setTimeout(() => {
        let response = '';
        const q = question.toLowerCase();
        
        // RÃ©ponses intelligentes basÃ©es sur les donnÃ©es rÃ©elles
        if (q.includes('documents expirÃ©s') || q.includes('docs expirÃ©s')) {
          const expiredDocs = documents.filter(d => {
            if (!d.dateExpiration) return false;
            return new Date(d.dateExpiration) < new Date();
          });
          const stWithExpired = [...new Set(expiredDocs.map(d => d.stId))].length;
          response = `D'aprÃ¨s mon analyse, <strong>${expiredDocs.length} documents</strong> sont expirÃ©s, concernant <strong>${stWithExpired} sous-traitants</strong>. Je recommande d'envoyer des relances via le module Documents.`;
        } 
        else if (q.includes('situations en attente') || q.includes('situation en attente')) {
          const attente = situations.filter(s => s.statut === 'soumise');
          const byChantier = {};
          attente.forEach(s => {
            const ch = chantiers.find(c => c.id === s.chantierId);
            const nom = ch?.nom || 'Non assignÃ©';
            byChantier[nom] = (byChantier[nom] || 0) + 1;
          });
          const top = Object.entries(byChantier).sort((a,b) => b[1] - a[1])[0];
          response = `Il y a actuellement <strong>${attente.length} situations en attente</strong> de validation. ${top ? `Le chantier "<strong>${top[0]}</strong>" concentre ${top[1]} situations.` : ''}<br><br>ğŸ“‹ RÃ©partition:<br>${Object.entries(byChantier).map(([k,v]) => `â€¢ ${k}: ${v}`).join('<br>')}`;
        } 
        else if (q.includes('doublons') || q.includes('doublon')) {
          const sirets = sousTraitants.filter(st => st.siret).map(st => st.siret.replace(/\s/g, ''));
          const duplicates = sirets.filter((s, i) => sirets.indexOf(s) !== i);
          if (duplicates.length > 0) {
            response = `âš ï¸ J'ai dÃ©tectÃ© <strong>${duplicates.length} doublons potentiels</strong> basÃ©s sur les SIRET. VÃ©rifiez les entreprises suivantes.`;
          } else {
            response = `âœ… J'ai analysÃ© la base de ${sousTraitants.length} sous-traitants. <strong>Aucun doublon dÃ©tectÃ©</strong>. La base est cohÃ©rente.`;
          }
        } 
        else if (q.includes('rapport') || q.includes('synthÃ¨se') || q.includes('resume')) {
          const caTotal = chantiers.reduce((s, c) => s + (c.montantTotal || 0), 0);
          const factureValide = situations.filter(s => s.statut === 'validee').reduce((s, x) => s + (x.montantMois || 0), 0);
          response = `<strong>ğŸ“Š Rapport de synthÃ¨se BTP Connect</strong><br><br>
            ğŸ¢ <strong>${sousTraitants.length}</strong> sous-traitants enregistrÃ©s<br>
            ğŸ—ï¸ <strong>${chantiers.length}</strong> chantiers (${chantiers.filter(c=>c.statut==='en_cours').length} en cours)<br>
            ğŸ“‹ <strong>${contrats.length}</strong> contrats actifs<br>
            ğŸ“„ <strong>${situations.length}</strong> situations (${situations.filter(s=>s.statut==='soumise').length} en attente)<br>
            ğŸ’¶ CA chantiers: <strong>${formatMontant(caTotal)}</strong><br>
            âœ… Montant validÃ©: <strong>${formatMontant(factureValide)}</strong>`;
        }
        else if (q.includes('facture') || q.includes('paiement') || q.includes('retard')) {
          const enRetard = factures.filter(f => f.statut === 'en_retard' || f.statut === 'impayee').length;
          const totalImpaye = factures.filter(f => f.statut !== 'payee').reduce((s, f) => s + (f.montantHT || 0), 0);
          response = `ğŸ“Š <strong>Analyse facturation</strong><br><br>
            ğŸ”´ <strong>${enRetard} factures</strong> en retard ou impayÃ©es<br>
            ğŸ’° Montant total impayÃ©: <strong>${formatMontant(totalImpaye)}</strong><br><br>
            Recommandation: Envoyez des relances pour les factures > 30 jours.`;
        }
        else if (q.includes('meilleur') || q.includes('top') || q.includes('performance')) {
          const sortedST = [...sousTraitants].sort((a, b) => (b.note || 0) - (a.note || 0)).slice(0, 5);
          response = `ğŸ† <strong>Top 5 sous-traitants (par note)</strong>:<br><br>${sortedST.map((st, i) => `${i+1}. <strong>${st.nom}</strong> - Note: ${st.note || 0}/5 (${st.corpsMetier || 'N/A'})`).join('<br>')}`;
        }
        else if (q.includes('export') || q.includes('sql') || q.includes('requÃªte')) {
          response = `Pour exporter vos donnÃ©es, utilisez les boutons du panneau "Gestion Base de DonnÃ©es":<br><br>
            ğŸ“‹ <strong>JSON</strong>: Export complet structurÃ©<br>
            ğŸ“Š <strong>CSV</strong>: Compatible Excel<br>
            ğŸ—ƒï¸ <strong>SQL</strong>: Instructions INSERT<br>
            ğŸ’¾ <strong>Backup</strong>: Sauvegarde complÃ¨te<br><br>
            Pour une requÃªte SQL personnalisÃ©e, utilisez l'export SQL puis modifiez le fichier.`;
        }
        else if (q.includes('aide') || q.includes('help') || q.includes('comment')) {
          response = `Je peux vous aider avec:<br><br>
            ğŸ“Š <strong>"rapport"</strong> - SynthÃ¨se globale<br>
            ğŸ“„ <strong>"documents expirÃ©s"</strong> - Docs Ã  renouveler<br>
            â³ <strong>"situations en attente"</strong> - Ã€ valider<br>
            ğŸ” <strong>"doublons"</strong> - DÃ©tecter les doublons<br>
            ğŸ’° <strong>"factures en retard"</strong> - ImpayÃ©s<br>
            ğŸ† <strong>"top performance"</strong> - Meilleurs ST<br>
            ğŸ“¤ <strong>"export"</strong> - Options d'export`;
        }
        else {
          response = `Je comprends votre question. Voici ce que je peux faire:<br><br>
            â€¢ Tapez <strong>"rapport"</strong> pour une synthÃ¨se<br>
            â€¢ Tapez <strong>"aide"</strong> pour voir toutes les commandes<br><br>
            Pour des requÃªtes spÃ©cifiques, utilisez l'export SQL ou demandez des statistiques prÃ©cises.`;
        }
        
        chatContainer.innerHTML += `
          <div class="flex gap-3 mb-4">
            <div class="w-8 h-8 bg-violet-500/30 rounded-full flex items-center justify-center text-sm">ğŸ¤–</div>
            <div class="flex-1 bg-slate-800 p-3 rounded-xl rounded-tl-sm max-w-md">
              <p class="text-sm text-slate-300">${response}</p>
            </div>
          </div>
        `;
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }, 1000);
      
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // ========== AIDE & TUTORIELS ==========
    function filterAide(query) {
      const q = query.toLowerCase();
      document.querySelectorAll('#tutorielsGrid > div').forEach(el => {
        const text = el.textContent.toLowerCase();
        el.style.display = text.includes(q) ? '' : 'none';
      });
      document.querySelectorAll('#faqContainer > details').forEach(el => {
        const text = el.textContent.toLowerCase();
        el.style.display = text.includes(q) ? '' : 'none';
      });
    }
    
    function openTutoriel(type) {
      const tutoriels = {
        demarrer: {
          title: 'ğŸš€ DÃ©marrer avec BTP Connect',
          content: `<div class="space-y-4"><div class="p-4 bg-violet-500/10 border border-violet-500/30 rounded-xl"><p class="text-violet-300">Ce tutoriel vous guide pour utiliser BTP Connect efficacement.</p></div><h4 class="text-lg font-semibold text-white">Ã‰tape 1 : CrÃ©ez votre premier chantier</h4><p class="text-slate-400">Allez dans <strong>Chantiers</strong> et cliquez sur <strong>â• Nouveau Chantier</strong>.</p><h4 class="text-lg font-semibold text-white">Ã‰tape 2 : Ajoutez vos sous-traitants</h4><p class="text-slate-400">Dans <strong>Annuaire</strong>, recherchez via SIRENE ou ajoutez manuellement.</p><h4 class="text-lg font-semibold text-white">Ã‰tape 3 : CrÃ©ez des contrats</h4><p class="text-slate-400">Depuis un chantier, cliquez sur <strong>â• Contrat</strong> pour attribuer un lot.</p><h4 class="text-lg font-semibold text-white">Ã‰tape 4 : GÃ©rez les situations</h4><p class="text-slate-400">Validez ou refusez les situations dans l'onglet <strong>Situations</strong>.</p><div class="mt-4 p-4 bg-emerald-500/10 border border-emerald-500/30 rounded-xl"><p class="text-emerald-400">âœ… Vous Ãªtes prÃªt !</p></div></div>`
        },
        situation: {
          title: 'ğŸ“‹ CrÃ©er une situation de travaux',
          content: `<div class="space-y-4"><h4 class="text-lg font-semibold text-white">Qu'est-ce qu'une situation ?</h4><p class="text-slate-400">Une situation de travaux est un Ã©tat d'avancement mensuel des travaux rÃ©alisÃ©s par un sous-traitant.</p><h4 class="text-lg font-semibold text-white">Flux 1 : ST â†’ Vous</h4><p class="text-slate-400">Vos sous-traitants soumettent leurs situations via leur portail. Elles apparaissent dans votre onglet Situations.</p><h4 class="text-lg font-semibold text-white">Flux 2 : Vous â†’ Client</h4><p class="text-slate-400">CrÃ©ez des situations globales pour vos maÃ®tres d'ouvrage incluant tous les lots.</p><h4 class="text-lg font-semibold text-white">Validation</h4><p class="text-slate-400">Cliquez sur âœ“ Valider pour approuver ou âœ• Refuser avec un motif.</p></div>`
        },
        soustraitants: {
          title: 'ğŸ‘¥ GÃ©rer les sous-traitants',
          content: `<div class="space-y-4"><h4 class="text-lg font-semibold text-white">Recherche SIRENE</h4><p class="text-slate-400">Utilisez l'API Gouvernement pour importer automatiquement les infos d'une entreprise via son SIRET.</p><h4 class="text-lg font-semibold text-white">Annuaire privÃ©</h4><p class="text-slate-400">Vos ST favoris sont dans votre annuaire privÃ© avec leurs contrats et notes.</p><h4 class="text-lg font-semibold text-white">Documents obligatoires</h4><p class="text-slate-400">Suivez la conformitÃ© documentaire (Kbis, URSSAF, RC Pro, DÃ©cennale) via l'onglet Documents.</p></div>`
        },
        facturation: {
          title: 'ğŸ’¶ Facturation et encaissements',
          content: `<div class="space-y-4"><h4 class="text-lg font-semibold text-white">Factures reÃ§ues</h4><p class="text-slate-400">Les factures de vos ST apparaissent automatiquement aprÃ¨s validation des situations.</p><h4 class="text-lg font-semibold text-white">Factures Ã©mises</h4><p class="text-slate-400">Ã‰mettez des factures vers vos clients basÃ©es sur vos situations Flux 2.</p><h4 class="text-lg font-semibold text-white">Suivi des paiements</h4><p class="text-slate-400">Marquez les factures comme payÃ©es et suivez les retards de paiement.</p><h4 class="text-lg font-semibold text-white">IntÃ©grations</h4><p class="text-slate-400">Connectez Quick Devis ou Optima dans ParamÃ¨tres â†’ IntÃ©grations.</p></div>`
        }
      };
      
      const tuto = tutoriels[type];
      if (tuto) {
        document.getElementById('tutorielTitle').textContent = tuto.title;
        document.getElementById('tutorielContent').innerHTML = tuto.content;
        closeModal('modalAide');
        openModal('modalTutoriel');
      }
    }
    
    function openLiveChat() {
      showToast('ğŸ’¬ Chat en direct en cours de connexion...', 'info');
      setTimeout(() => showToast('ğŸ‘‹ Un conseiller va vous rÃ©pondre sous peu !', 'success'), 1500);
    }
    
    function envoyerSupport() {
      const subject = document.getElementById('supportSubject').value;
      const message = document.getElementById('supportMessage').value;
      if (!subject || !message) { showToast('âš ï¸ Veuillez remplir tous les champs', 'warning'); return; }
      showToast('ğŸ“¨ Message envoyÃ© au support !', 'success');
      closeModal('modalContactSupport');
    }
    
    // ========== PAIEMENT ==========
    let selectedPlan = 'enterprise';
    
    function setPlanPaiement(plan) {
      selectedPlan = plan;
      const plans = { starter: { nom: 'Starter', montant: 'Gratuit' }, pro: { nom: 'Pro', montant: '29â‚¬/mois' }, enterprise: { nom: 'Enterprise', montant: '99â‚¬/mois' } };
      document.getElementById('paiementPlanNom').textContent = plans[plan].nom;
      document.getElementById('paiementMontant').textContent = plans[plan].montant;
    }
    
    function formatCardNumber(input) {
      let value = input.value.replace(/\D/g, '');
      value = value.replace(/(.{4})/g, '$1 ').trim();
      input.value = value.substring(0, 19);
    }
    
    function formatExpiry(input) {
      let value = input.value.replace(/\D/g, '');
      if (value.length >= 2) value = value.substring(0, 2) + '/' + value.substring(2);
      input.value = value.substring(0, 5);
    }
    
    function processerPaiement() {
      const cardNumber = document.getElementById('cardNumber').value;
      const expiry = document.getElementById('cardExpiry').value;
      const cvv = document.getElementById('cardCVV').value;
      const name = document.getElementById('cardName').value;
      
      if (!cardNumber || !expiry || !cvv || !name) {
        showToast('âš ï¸ Veuillez remplir tous les champs', 'warning');
        return;
      }
      
      showToast('ğŸ”„ Traitement du paiement en cours...', 'info');
      setTimeout(() => {
        showToast('âœ… Paiement acceptÃ© ! Votre abonnement est actif.', 'success');
        closeModal('modalPaiement');
      }, 2500);
    }
    
    // ========== MOYENS DE PAIEMENT ==========
    let savedPaymentMethods = [
      { id: 1, type: 'visa', last4: '4242', expiry: '12/2027', holder: 'JEAN DUPONT', isDefault: true }
    ];
    let selectedCardType = 'visa';
    
    function selectCardType(type) {
      selectedCardType = type;
      ['visa', 'mastercard', 'amex'].forEach(t => {
        const btn = document.getElementById(`cardType${t.charAt(0).toUpperCase() + t.slice(1)}`);
        if (btn) {
          btn.classList.toggle('border-violet-500', t === type);
          btn.classList.toggle('bg-violet-500/10', t === type);
          btn.classList.toggle('border-transparent', t !== type);
          btn.classList.toggle('bg-slate-800/50', t !== type);
        }
      });
    }
    
    function formatCardNumber(input) {
      let value = input.value.replace(/\D/g, '');
      value = value.replace(/(\d{4})/g, '$1 ').trim();
      input.value = value.substring(0, 19);
    }
    
    function formatExpiry(input) {
      let value = input.value.replace(/\D/g, '');
      if (value.length >= 2) value = value.substring(0, 2) + '/' + value.substring(2);
      input.value = value.substring(0, 5);
    }
    
    function savePaymentMethod() {
      const cardNumber = document.getElementById('newCardNumber').value.replace(/\s/g, '');
      const holder = document.getElementById('newCardHolder').value;
      const expiry = document.getElementById('newCardExpiry').value;
      const cvv = document.getElementById('newCardCVV').value;
      const isDefault = document.getElementById('newCardDefault').checked;
      
      if (!cardNumber || cardNumber.length < 13) {
        showToast('âš ï¸ NumÃ©ro de carte invalide', 'warning');
        return;
      }
      if (!holder) {
        showToast('âš ï¸ Nom du titulaire requis', 'warning');
        return;
      }
      if (!expiry || expiry.length < 5) {
        showToast('âš ï¸ Date d\'expiration invalide', 'warning');
        return;
      }
      if (!cvv || cvv.length < 3) {
        showToast('âš ï¸ CVV invalide', 'warning');
        return;
      }
      
      showToast('ğŸ”„ VÃ©rification de la carte...', 'info');
      
      setTimeout(() => {
        // Si par dÃ©faut, retirer le statut des autres
        if (isDefault) {
          savedPaymentMethods.forEach(pm => pm.isDefault = false);
        }
        
        const newMethod = {
          id: Date.now(),
          type: selectedCardType,
          last4: cardNumber.slice(-4),
          expiry: expiry,
          holder: holder.toUpperCase(),
          isDefault: isDefault
        };
        
        savedPaymentMethods.push(newMethod);
        renderPaymentMethods();
        
        closeModal('modalAddPayment');
        // Reset form
        document.getElementById('newCardNumber').value = '';
        document.getElementById('newCardHolder').value = '';
        document.getElementById('newCardExpiry').value = '';
        document.getElementById('newCardCVV').value = '';
        
        showToast('âœ… Carte enregistrÃ©e avec succÃ¨s', 'success');
      }, 1500);
    }
    
    function removePaymentMethod(id) {
      const method = savedPaymentMethods.find(pm => pm.id === id);
      if (!method) return;
      
      if (method.isDefault && savedPaymentMethods.length > 1) {
        showToast('âš ï¸ Impossible de supprimer le moyen de paiement par dÃ©faut', 'warning');
        return;
      }
      
      if (!confirm('Supprimer ce moyen de paiement ?')) return;
      
      savedPaymentMethods = savedPaymentMethods.filter(pm => pm.id !== id);
      renderPaymentMethods();
      showToast('ğŸ—‘ï¸ Moyen de paiement supprimÃ©', 'info');
    }
    
    function setDefaultPayment(id) {
      savedPaymentMethods.forEach(pm => pm.isDefault = pm.id === id);
      renderPaymentMethods();
      showToast('âœ… Moyen de paiement par dÃ©faut mis Ã  jour', 'success');
    }
    
    function renderPaymentMethods() {
      const container = document.getElementById('savedPaymentMethods');
      if (!container) return;
      
      const cardIcons = { visa: 'ğŸ’³', mastercard: 'ğŸ’³', amex: 'ğŸ’³' };
      const cardNames = { visa: 'Visa', mastercard: 'Mastercard', amex: 'Amex' };
      
      container.innerHTML = savedPaymentMethods.map(pm => `
        <div class="p-4 bg-slate-800/50 rounded-xl flex items-center justify-between ${pm.isDefault ? 'border border-emerald-500/30' : ''}">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-blue-500/20 rounded-xl flex items-center justify-center text-2xl">${cardIcons[pm.type]}</div>
            <div>
              <p class="font-medium text-slate-200">${cardNames[pm.type]} â€¢â€¢â€¢â€¢ ${pm.last4}</p>
              <p class="text-sm text-slate-500">Expire ${pm.expiry} â€¢ ${pm.holder}</p>
            </div>
          </div>
          <div class="flex items-center gap-3">
            ${pm.isDefault ? '<span class="badge badge-success">Par dÃ©faut</span>' : `<button onclick="setDefaultPayment(${pm.id})" class="text-violet-400 hover:text-violet-300 text-sm">DÃ©finir par dÃ©faut</button>`}
            <button onclick="removePaymentMethod(${pm.id})" class="text-red-400 hover:text-red-300 text-sm">Supprimer</button>
          </div>
        </div>
      `).join('') || '<p class="text-slate-500 text-center py-4">Aucun moyen de paiement enregistrÃ©</p>';
    }
    
    // ========== PORTAIL DEPOT DOCUMENTS ==========
    let portailFile = null;
    
    function handlePortailFile(input) {
      const file = input.files[0];
      if (file) {
        if (file.size > 10 * 1024 * 1024) {
          showToast('âš ï¸ Fichier trop volumineux (max 10 Mo)', 'warning');
          return;
        }
        portailFile = file;
        document.getElementById('portailFileName').textContent = file.name;
        document.getElementById('portailFileSize').textContent = (file.size / (1024 * 1024)).toFixed(2) + ' Mo';
        document.getElementById('portailFilePreview').classList.remove('hidden');
        document.getElementById('portailDropZone').classList.add('border-emerald-500');
      }
    }
    
    function clearPortailFile() {
      portailFile = null;
      document.getElementById('portailFileInput').value = '';
      document.getElementById('portailFilePreview').classList.add('hidden');
      document.getElementById('portailDropZone').classList.remove('border-emerald-500');
    }
    
    function soumettreDocument() {
      const docType = document.getElementById('portailDocType').value;
      if (!docType) { showToast('âš ï¸ SÃ©lectionnez un type de document', 'warning'); return; }
      if (!portailFile) { showToast('âš ï¸ Veuillez sÃ©lectionner un fichier', 'warning'); return; }
      
      showToast('ğŸ”„ Analyse IA en cours...', 'info');
      setTimeout(() => {
        showToast('âœ… Document dÃ©posÃ© et analysÃ© avec succÃ¨s !', 'success');
        closeModal('modalPortailDepot');
        clearPortailFile();
      }, 2000);
    }
    
    function ouvrirPortailDepot() {
      openModal('modalPortailDepot');
    }
    
    // ========== COOKIES ==========
    function saveCookiePreferences() {
      const analytics = document.getElementById('cookieAnalytics').checked;
      const marketing = document.getElementById('cookieMarketing').checked;
      localStorage.setItem('cookies-analytics', analytics);
      localStorage.setItem('cookies-marketing', marketing);
      showToast('âœ… PrÃ©fÃ©rences cookies enregistrÃ©es', 'success');
    }
    
    // ========== FILTRES SITUATIONS ==========
    function filterByStatut(statut) {
      document.getElementById('filterSituStatut').value = statut;
      renderSituations();
      showTab('situations');
    }
    
    function openFacturationModal(type) {
      // Filtrer les factures selon le type cliquÃ©
      let filterValue = '';
      let filterLabel = '';
      
      switch(type) {
        case 'attente':
          filterValue = 'en_attente';
          filterLabel = 'â³ En attente';
          break;
        case 'payees':
          filterValue = 'payee';
          filterLabel = 'âœ… PayÃ©es';
          break;
        case 'retard':
          filterValue = 'en_retard';
          filterLabel = 'ğŸš¨ En retard';
          break;
        case 'total':
          filterValue = '';
          filterLabel = 'ğŸ“Š Toutes les factures';
          break;
      }
      
      // Appliquer le filtre
      const filterSelect = document.getElementById('filterFactStatut');
      if (filterSelect) {
        // CrÃ©er l'option si elle n'existe pas
        let optionExists = Array.from(filterSelect.options).some(opt => opt.value === filterValue);
        if (!optionExists && filterValue) {
          const option = document.createElement('option');
          option.value = filterValue;
          option.textContent = filterLabel;
          filterSelect.appendChild(option);
        }
        filterSelect.value = filterValue;
      }
      
      // Re-rendre les factures avec le filtre
      renderFactures();
      
      // Afficher un toast de confirmation
      showToast(`ğŸ“Š Filtre appliquÃ©: ${filterLabel}`, 'info');
    }
    
    // ========== AUTHENTIFICATION ==========
    function showLandingPage() {
      document.getElementById('landingPage').classList.remove('hidden');
      document.getElementById('landingPage').style.display = 'block';
      document.getElementById('loginPage').classList.add('hidden');
      document.getElementById('loginPage').style.display = 'none';
    }
    
    function showLoginPage() {
      document.getElementById('landingPage').classList.add('hidden');
      document.getElementById('landingPage').style.display = 'none';
      document.getElementById('loginPage').classList.remove('hidden');
      document.getElementById('loginPage').style.display = 'block';
      // Reset forms
      hideLoginMessage();
      showLoginForm('connexion');
    }
    
    function showLoginForm(type) {
      document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.login-form').forEach(f => f.classList.remove('active'));
      
      if (type === 'connexion') {
        document.querySelector('.login-tabs .login-tab:first-child').classList.add('active');
        document.getElementById('form-connexion').classList.add('active');
      } else {
        document.querySelector('.login-tabs .login-tab:last-child').classList.add('active');
        document.getElementById('form-inscription').classList.add('active');
      }
      hideLoginMessage();
    }
    
    function showLoginMessage(text, type) {
      const msg = document.getElementById('loginMessage');
      msg.textContent = text;
      msg.className = 'login-message ' + type;
    }
    
    function hideLoginMessage() {
      const msg = document.getElementById('loginMessage');
      if (msg) msg.className = 'login-message';
    }
    
    function doLogin(e) {
      if (e) e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;

      if (!email || !password) {
        showLoginMessage('Veuillez saisir email et mot de passe.', 'error');
        return;
      }

      hideLoginMessage();
      showLoginMessage('Connexion en cours...', 'info');

      // 1) Essayer backend (API) d'abord
      apiLogin(email, password).then((user) => {
        loginSuccess(user, { tokenAlreadyStored: true });
      }).catch((err) => {
        // 2) Fallback mode local/dÃ©mo si API indisponible
        console.warn('API login failed, fallback local:', err);

        // Credentials admin principal
        if (email === AUTH_CREDENTIALS.email && password === AUTH_CREDENTIALS.password) {
          loginSuccess({ id: 1, nom: 'JÃ©rÃ©mie Durand', email: email, role: 'admin', entreprise: 'BTP Connect' });
          return;
        }

        // Credentials alternatifs admin
        if (email === 'admin@btpconnect.local' && password === 'BtpConnect2026!') {
          loginSuccess({ id: 1, nom: 'Administrateur', email: email, role: 'admin', entreprise: 'BTP Connect' });
          return;
        }

        // Chercher dans la liste des utilisateurs locaux
        const user = users.find(u => u.email === email && u.password === password);
        if (user) { loginSuccess(user); return; }

        // Mode dÃ©mo
        if (email === 'demo@btpconnect.fr' && password === 'demo123') {
          loginSuccess({ id: 999, nom: 'Utilisateur Demo', email: email, role: 'admin', entreprise: 'Demo SARL' });
          return;
        }

        showLoginMessage('Email ou mot de passe incorrect.', 'error');
      });
    }

    function loginSuccess(user, opts = {}) {
      isLoggedIn = true;
      if (!opts.tokenAlreadyStored) { localStorage.setItem('btp-token', getToken() || ('token-' + Date.now())); }
      localStorage.setItem('btp-user', JSON.stringify(user));
      // Charger les donnÃ©es depuis l'API si disponible
      Promise.resolve().then(() => syncAllFromAPI()).catch(() => {});
      
      showLoginMessage('Connexion rÃ©ussie ! Redirection...', 'success');
      
      setTimeout(() => {
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('landingPage').classList.add('hidden');
        document.getElementById('landingPage').style.display = 'none';
        showToast(`âœ… Bienvenue ${user.nom} !`, 'success');
        syncAllFromAPI().then(() => {
            renderDashboard();
            renderNotifications();
            renderUsers();
            checkAdminAccess();
          }).catch(() => {
            // fallback donnÃ©es locales
            renderDashboard();
            renderNotifications();
            renderUsers();
            checkAdminAccess();
          });
      }, 1000);
    }
    
    function doRegister(e) {
      if (e) e.preventDefault();
      const nom = document.getElementById('registerNom').value;
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      const role = document.getElementById('registerRole').value;
      
      if (!nom || !email || !password) {
        showLoginMessage('Veuillez remplir tous les champs', 'error');
        return;
      }
      
      // VÃ©rifier si email existe dÃ©jÃ 
      if (users.find(u => u.email === email)) {
        showLoginMessage('Cet email est dÃ©jÃ  utilisÃ©', 'error');
        return;
      }
      
      // Ajouter l'utilisateur
      const newId = Math.max(...users.map(u => u.id)) + 1;
      users.push({ id: newId, nom, email, role, password });
      
      showLoginMessage('Inscription rÃ©ussie ! Vous pouvez maintenant vous connecter.', 'success');
      
      setTimeout(() => {
        showLoginForm('connexion');
        document.getElementById('loginEmail').value = email;
        document.getElementById('loginPassword').value = '';
      }, 1500);
    }
    
    function doLogout() {
      isLoggedIn = false;
      localStorage.removeItem('btp-token');
      localStorage.removeItem('btp-user');
      showLandingPage();
      showToast('ğŸ‘‹ DÃ©connexion rÃ©ussie', 'info');
    }
    
    // ========== GESTION UTILISATEURS ==========
    function renderUsers() {
      const tbody = document.getElementById('usersTableBody');
      if (!tbody) return;
      
      const roleLabels = { admin: 'Administrateur', conducteur: 'Conducteur', comptable: 'Comptable' };
      const roleColors = { admin: 'badge-violet', conducteur: 'badge-info', comptable: 'badge-success' };
      
      tbody.innerHTML = users.map(u => `
        <tr>
          <td class="text-slate-200">${u.nom}</td>
          <td class="text-slate-400">${u.email}</td>
          <td><span class="badge ${roleColors[u.role]}">${roleLabels[u.role]}</span></td>
          <td>
            <button onclick="editUser(${u.id})" class="text-slate-400 hover:text-white mr-2">âœï¸</button>
            ${u.id !== 1 ? `<button onclick="confirmDeleteUser(${u.id})" class="text-red-400 hover:text-red-300">ğŸ—‘ï¸</button>` : ''}
          </td>
        </tr>
      `).join('');
    }
    
    function addUser() {
      const nom = document.getElementById('newUserNom').value;
      const email = document.getElementById('newUserEmail').value;
      const password = document.getElementById('newUserPassword').value;
      const role = document.getElementById('newUserRole').value;
      
      if (!nom || !email || !password) {
        showToast('âš ï¸ Veuillez remplir tous les champs', 'warning');
        return;
      }
      
      const newId = Math.max(...users.map(u => u.id)) + 1;
      users.push({ id: newId, nom, email, role, password });
      
      renderUsers();
      closeModal('modalAddUser');
      showToast('âœ… Utilisateur ajoutÃ© avec succÃ¨s', 'success');
      
      document.getElementById('newUserNom').value = '';
      document.getElementById('newUserEmail').value = '';
      document.getElementById('newUserPassword').value = '';
    }
    
    function editUser(id) {
      const user = users.find(u => u.id === id);
      if (!user) return;
      
      document.getElementById('editUserId').value = id;
      document.getElementById('editUserNom').value = user.nom;
      document.getElementById('editUserEmail').value = user.email;
      document.getElementById('editUserRole').value = user.role;
      document.getElementById('editUserPassword').value = '';
      
      openModal('modalEditUser');
    }
    
    function saveUser() {
      const id = parseInt(document.getElementById('editUserId').value);
      const user = users.find(u => u.id === id);
      if (!user) return;
      
      user.nom = document.getElementById('editUserNom').value;
      user.email = document.getElementById('editUserEmail').value;
      user.role = document.getElementById('editUserRole').value;
      
      const newPassword = document.getElementById('editUserPassword').value;
      if (newPassword) user.password = newPassword;
      
      renderUsers();
      closeModal('modalEditUser');
      showToast('âœ… Utilisateur modifiÃ© avec succÃ¨s', 'success');
    }
    
    function confirmDeleteUser(id) {
      if (confirm('ÃŠtes-vous sÃ»r de vouloir supprimer cet utilisateur ?')) {
        deleteUserById(id);
      }
    }
    
    function deleteUserById(id) {
      users = users.filter(u => u.id !== id);
      renderUsers();
      closeModal('modalEditUser');
      showToast('ğŸ—‘ï¸ Utilisateur supprimÃ©', 'info');
    }
    
    function deleteUser() {
      const id = parseInt(document.getElementById('editUserId').value);
      if (id === 1) {
        showToast('âš ï¸ Impossible de supprimer l\'administrateur principal', 'warning');
        return;
      }
      confirmDeleteUser(id);
    }
    
    // ========== DETAIL FACTURE ==========
    function openFactureDetail(id) {
      const facture = factures.find(f => f.id === id);
      if (!facture) return;
      
      const chantier = chantiers.find(c => c.id === facture.chantierId);
      const st = facture.stId ? sousTraitants.find(s => s.id === facture.stId) : null;
      
      const statutColors = { payee: 'text-emerald-400', attente: 'text-amber-400', retard: 'text-red-400' };
      const statutLabels = { payee: 'PayÃ©e', attente: 'En attente', retard: 'En retard' };
      
      document.getElementById('detailFactureTitle').textContent = `ğŸ“„ Facture ${facture.numero}`;
      document.getElementById('detailFactureContent').innerHTML = `
        <div class="space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div class="p-4 bg-slate-800/50 rounded-xl">
              <p class="text-sm text-slate-500">NÂ° Facture</p>
              <p class="font-semibold text-slate-200">${facture.numero}</p>
            </div>
            <div class="p-4 bg-slate-800/50 rounded-xl">
              <p class="text-sm text-slate-500">Statut</p>
              <p class="font-semibold ${statutColors[facture.statut]}">${statutLabels[facture.statut]}</p>
            </div>
          </div>
          <div class="p-4 bg-slate-800/50 rounded-xl">
            <p class="text-sm text-slate-500">Chantier</p>
            <p class="font-semibold text-slate-200">${chantier?.nom || 'N/A'}</p>
          </div>
          <div class="p-4 bg-slate-800/50 rounded-xl">
            <p class="text-sm text-slate-500">${facture.type === 'recue' ? 'Ã‰metteur (ST)' : 'Destinataire'}</p>
            <p class="font-semibold text-slate-200">${st?.nom || chantier?.client || 'N/A'}</p>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div class="p-4 bg-slate-800/50 rounded-xl">
              <p class="text-sm text-slate-500">Montant HT</p>
              <p class="font-bold text-2xl text-violet-400">${formatMontant(facture.montantHT)}</p>
            </div>
            <div class="p-4 bg-slate-800/50 rounded-xl">
              <p class="text-sm text-slate-500">Ã‰chÃ©ance</p>
              <p class="font-semibold text-slate-200">${new Date(facture.dateEcheance).toLocaleDateString('fr-FR')}</p>
            </div>
          </div>
          <div class="flex gap-3 mt-6">
            ${facture.statut !== 'payee' ? `<button onclick="marquerFacturePayee(${facture.id})" class="flex-1 btn-success px-4 py-2 rounded-xl text-white">âœ“ Marquer payÃ©e</button>` : ''}
            <button onclick="exportFacturePDF(${facture.id})" class="flex-1 px-4 py-2 bg-slate-700 rounded-xl text-slate-200">ğŸ“„ Exporter PDF</button>
          </div>
        </div>
      `;
      
      openModal('modalDetailFacture');
    }
    
    function marquerFacturePayee(id) {
      const facture = factures.find(f => f.id === id);
      if (facture) {
        facture.statut = 'payee';
        renderFactures();
        closeModal('modalDetailFacture');
        showToast('âœ… Facture marquÃ©e comme payÃ©e', 'success');
      }
    }
    
    function exportFacturePDF(id) {
      const facture = factures.find(f => f.id === id);
      if (!facture) {
        showToast('âŒ Facture introuvable', 'error');
        return;
      }
      
      const chantier = chantiers.find(c => c.id === facture.chantierId);
      const statut = facture.statut === 'payee' ? 'PAYÃ‰E' : facture.statut === 'en_attente' ? 'EN ATTENTE' : 'EN RETARD';
      const statutColor = facture.statut === 'payee' ? [22, 163, 74] : facture.statut === 'en_attente' ? [217, 119, 6] : [220, 38, 38];
      
      // Utiliser jsPDF pour gÃ©nÃ©rer un vrai PDF
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // En-tÃªte
      doc.setFillColor(37, 99, 235);
      doc.rect(0, 0, 210, 40, 'F');
      
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(24);
      doc.setFont('helvetica', 'bold');
      doc.text('BTP Connect', 20, 25);
      
      doc.setFontSize(12);
      doc.setFont('helvetica', 'normal');
      doc.text('Gestion de chantiers BTP', 20, 33);
      
      // NumÃ©ro de facture
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.text(facture.numero, 190, 20, { align: 'right' });
      
      // Badge statut
      doc.setFillColor(...statutColor);
      doc.roundedRect(150, 25, 40, 10, 2, 2, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(10);
      doc.text(statut, 170, 32, { align: 'center' });
      
      // Corps du document
      let y = 55;
      
      // Section informations
      doc.setTextColor(37, 99, 235);
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.text('INFORMATIONS DE LA FACTURE', 20, y);
      y += 10;
      
      doc.setDrawColor(226, 232, 240);
      doc.setFillColor(248, 250, 252);
      doc.roundedRect(20, y, 170, 50, 3, 3, 'FD');
      y += 10;
      
      doc.setTextColor(100, 116, 139);
      doc.setFontSize(11);
      doc.setFont('helvetica', 'normal');
      
      const addRow = (label, value, yPos) => {
        doc.setTextColor(100, 116, 139);
        doc.text(label, 30, yPos);
        doc.setTextColor(15, 23, 42);
        doc.setFont('helvetica', 'bold');
        doc.text(value, 180, yPos, { align: 'right' });
        doc.setFont('helvetica', 'normal');
      };
      
      addRow('NumÃ©ro', facture.numero, y);
      y += 10;
      addRow('Type', facture.type === 'emise' ? 'Ã‰mise (Client)' : 'ReÃ§ue (ST)', y);
      y += 10;
      addRow('Chantier', chantier ? chantier.nom : 'N/A', y);
      y += 10;
      addRow('Date Ã©chÃ©ance', facture.dateEcheance, y);
      y += 20;
      
      // Section montants
      doc.setTextColor(37, 99, 235);
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.text('MONTANTS', 20, y);
      y += 10;
      
      doc.setDrawColor(226, 232, 240);
      doc.setFillColor(248, 250, 252);
      doc.roundedRect(20, y, 170, 40, 3, 3, 'FD');
      y += 10;
      
      const montantHT = facture.montantHT.toLocaleString('fr-FR') + ' â‚¬';
      const montantTVA = (facture.montantHT * 0.2).toLocaleString('fr-FR') + ' â‚¬';
      const montantTTC = (facture.montantHT * 1.2).toLocaleString('fr-FR') + ' â‚¬';
      
      addRow('Montant HT', montantHT, y);
      y += 10;
      addRow('TVA (20%)', montantTVA, y);
      y += 10;
      addRow('Montant TTC', montantTTC, y);
      y += 20;
      
      // Total
      doc.setFillColor(37, 99, 235);
      doc.roundedRect(100, y, 90, 20, 3, 3, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(16);
      doc.setFont('helvetica', 'bold');
      doc.text('TOTAL TTC: ' + montantTTC, 145, y + 13, { align: 'center' });
      
      // Pied de page
      y = 270;
      doc.setDrawColor(226, 232, 240);
      doc.line(20, y, 190, y);
      y += 10;
      
      doc.setTextColor(100, 116, 139);
      doc.setFontSize(9);
      doc.setFont('helvetica', 'normal');
      doc.text('Document gÃ©nÃ©rÃ© par BTP Connect le ' + new Date().toLocaleDateString('fr-FR') + ' Ã  ' + new Date().toLocaleTimeString('fr-FR'), 105, y, { align: 'center' });
      doc.text('Ce document est un export numÃ©rique - Conservez l\'original pour vos archives', 105, y + 5, { align: 'center' });
      
      // TÃ©lÃ©charger le PDF
      const filename = `Facture_${facture.numero.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`;
      doc.save(filename);
      
      showToast(`âœ… PDF ${filename} tÃ©lÃ©chargÃ©`, 'success');
    }
    
    // ========== LIVE CHAT ==========
    function openLiveChat() {
      closeModal('modalAide');
      openModal('modalLiveChat');
    }
    
    function sendLiveChatMessage() {
      const input = document.getElementById('liveChatInput');
      const message = input.value.trim();
      if (!message) return;
      
      const container = document.getElementById('liveChatMessages');
      
      // Message utilisateur
      container.innerHTML += `
        <div class="flex gap-3 justify-end">
          <div class="bg-violet-600 p-3 rounded-xl rounded-tr-sm max-w-xs">
            <p class="text-sm text-white">${escapeHtml(message)}</p>
            <p class="text-xs text-violet-300 mt-1">Vous â€¢ Maintenant</p>
          </div>
          <div class="w-8 h-8 bg-slate-700 rounded-full flex items-center justify-center text-white text-sm">ğŸ‘¤</div>
        </div>
      `;
      
      input.value = '';
      container.scrollTop = container.scrollHeight;
      
      // RÃ©ponse bot
      setTimeout(() => {
        let response = '';
        const lowerMsg = message.toLowerCase();
        
        if (lowerMsg.includes('bonjour') || lowerMsg.includes('salut')) {
          response = 'Bonjour ! Comment puis-je vous aider aujourd\'hui ?';
        } else if (lowerMsg.includes('aide') || lowerMsg.includes('help')) {
          response = 'Je suis lÃ  pour vous aider ! Vous pouvez me poser des questions sur les chantiers, les situations, les factures ou les sous-traitants.';
        } else if (lowerMsg.includes('facture')) {
          response = 'Pour gÃ©rer vos factures, rendez-vous dans l\'onglet "Facturation". Vous pouvez y voir toutes vos factures reÃ§ues et Ã©mises.';
        } else if (lowerMsg.includes('situation')) {
          response = 'Les situations de travaux sont accessibles dans l\'onglet "Situations". Vous pouvez y valider ou refuser les situations soumises.';
        } else if (lowerMsg.includes('document')) {
          response = 'L\'onglet "Documents" vous permet de suivre la conformitÃ© documentaire de vos sous-traitants (Kbis, URSSAF, etc.).';
        } else {
          response = 'Merci pour votre message. Un conseiller va prendre en charge votre demande. Temps d\'attente estimÃ© : 2 minutes.';
        }
        
        container.innerHTML += `
          <div class="flex gap-3">
            <div class="w-8 h-8 bg-violet-500 rounded-full flex items-center justify-center text-white text-sm">ğŸ¤–</div>
            <div class="bg-slate-800 p-3 rounded-xl rounded-tl-sm max-w-xs">
              <p class="text-sm text-slate-300">${response}</p>
              <p class="text-xs text-slate-500 mt-1">Support â€¢ Maintenant</p>
            </div>
          </div>
        `;
        container.scrollTop = container.scrollHeight;
      }, 1000);
    }
    
    // ========== LOGO UPLOAD ==========
    function handleLogoUpload(input) {
      const file = input.files[0];
      if (file) {
        if (file.size > 2 * 1024 * 1024) {
          showToast('âš ï¸ Fichier trop volumineux (max 2 Mo)', 'warning');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('logoPreview').innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover rounded-xl">`;
          showToast('âœ… Logo mis Ã  jour', 'success');
        };
        reader.readAsDataURL(file);
      }
    }
    
    // ========== EXPORTS COMPLETS ==========
    function exportCSV(type) {
      let content = '';
      let filename = '';
      
      // Utiliser ; comme sÃ©parateur pour compatibilitÃ© Excel FR
      switch(type) {
        case 'chantiers':
          content = 'ID;Nom;Adresse;Client;Montant;Statut\n';
          chantiers.forEach(c => content += `${c.id};"${c.nom}";"${c.adresse}";"${c.client}";${c.montantTotal};${c.statut}\n`);
          filename = 'chantiers.csv';
          break;
        case 'soustraitants':
          content = 'ID;Nom;MÃ©tier;SIRET;Ville;Note;Email\n';
          sousTraitants.forEach(s => content += `${s.id};"${s.nom}";"${s.corpsMetier}";"${s.siret}";"${s.ville}";${s.note};"${s.email}"\n`);
          filename = 'soustraitants.csv';
          break;
        case 'situations':
          content = 'ID;Flux;Contrat;NumÃ©ro;Date;Montant;Statut\n';
          situations.forEach(s => content += `${s.id};${s.flux};${s.contratId || s.chantierId};${s.numero};"${s.date}";${s.montantMois};${s.statut}\n`);
          filename = 'situations.csv';
          break;
        case 'factures':
          content = 'ID;NumÃ©ro;Type;Chantier;Montant HT;Ã‰chÃ©ance;Statut\n';
          factures.forEach(f => content += `${f.id};"${f.numero}";${f.type};${f.chantierId};${f.montantHT};"${f.dateEcheance}";${f.statut}\n`);
          filename = 'factures.csv';
          break;
        case 'contrats':
          content = 'ID;Chantier;ST;Lot;Montant\n';
          contrats.forEach(c => content += `${c.id};${c.chantierId};${c.stId};"${c.lot}";${c.montantMarche}\n`);
          filename = 'contrats.csv';
          break;
        default:
          content = 'Type;Count\n';
          content += `Sous-traitants;${sousTraitants.length}\n`;
          content += `Chantiers;${chantiers.length}\n`;
          content += `Contrats;${contrats.length}\n`;
          content += `Situations;${situations.length}\n`;
          content += `Factures;${factures.length}\n`;
          filename = 'resume.csv';
      }
      
      downloadFile(content, filename, 'text/csv');
      showToast(`âœ… Export ${filename} tÃ©lÃ©chargÃ©`, 'success');
    }
    
    function downloadFile(content, filename, type) {
      // Ajouter BOM UTF-8 pour les fichiers CSV (compatibilitÃ© Excel)
      let finalContent = content;
      if (type === 'text/csv') {
        finalContent = '\uFEFF' + content; // BOM UTF-8
      }
      const blob = new Blob([finalContent], { type: type + ';charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    // ========== GESTION DES TEMPLATES ==========
    let currentTemplateType = '';
    
    const defaultTemplates = {
      'facture': `FACTURE NÂ° {NUMERO}
Date: {DATE}

Client: {NOM_CLIENT}
Chantier: {CHANTIER}

Description des travaux:
{DESCRIPTION}

Montant HT: {MONTANT_HT} â‚¬
TVA (20%): {TVA} â‚¬
Montant TTC: {MONTANT_TTC} â‚¬

Conditions de paiement: 30 jours fin de mois
RIB: {IBAN}`,
      'situation': `SITUATION DE TRAVAUX NÂ° {NUMERO}
PÃ©riode: {MOIS}/{ANNEE}

Chantier: {CHANTIER}
Sous-traitant: {NOM_ST}
Lot: {LOT}

Avancement cumulÃ©: {AVANCEMENT}%
Montant cumulÃ©: {MONTANT_CUMULE} â‚¬
Montant ce mois: {MONTANT_MOIS} â‚¬

Observations:
{OBSERVATIONS}`,
      'email-demande': `Bonjour {NOM_ST},

Nous avons besoin des documents suivants pour complÃ©ter votre dossier :
{DOCUMENTS}

Merci de les dÃ©poser sur notre portail sÃ©curisÃ© :
{LIEN_PORTAIL}

Date limite: {DATE_LIMITE}

Cordialement,
{NOM_ENTREPRISE}
{EMAIL_CONTACT}`,
      'email-relance': `Bonjour {NOM_ST},

Nous vous rappelons que le document "{DOCUMENT}" est manquant ou expirÃ© dans votre dossier.

Ce document est obligatoire pour la conformitÃ© de votre entreprise sur nos chantiers.

Merci de le dÃ©poser dans les plus brefs dÃ©lais sur notre portail :
{LIEN_PORTAIL}

Sans retour de votre part sous 48h, nous serons contraints de suspendre votre activitÃ© sur nos chantiers.

Cordialement,
{NOM_ENTREPRISE}`,
      'contrat': `CONTRAT DE SOUS-TRAITANCE

Entre:
{NOM_ENTREPRISE} (Entreprise principale)
Et:
{NOM_ST} (Sous-traitant)
SIRET: {SIRET_ST}

Article 1 - Objet
Le prÃ©sent contrat a pour objet les travaux de {LOT} sur le chantier {CHANTIER}.

Article 2 - Prix
Montant du marchÃ©: {MONTANT_MARCHE} â‚¬ HT

Article 3 - DÃ©lais
Date de dÃ©but: {DATE_DEBUT}
Date de fin: {DATE_FIN}

Article 4 - Documents obligatoires
Le sous-traitant s'engage Ã  fournir les documents suivants Ã  jour:
- Attestation URSSAF
- RC Pro
- DÃ©cennale
- Kbis

Fait Ã  {VILLE}, le {DATE}`,
      'export': `# Export BTP Connect - {DATE}
## {TYPE_EXPORT}

Nombre d'enregistrements: {COUNT}

{CONTENU}

---
GÃ©nÃ©rÃ© automatiquement par BTP Connect`
    };
    
    function openTemplateEditor(type) {
      currentTemplateType = type;
      const titles = {
        'facture': 'ğŸ’¶ ModÃ¨le de Facture',
        'situation': 'ğŸ“Š ModÃ¨le de Situation',
        'email-demande': 'ğŸ“§ Email demande documents',
        'email-relance': 'ğŸ”” Email relance',
        'contrat': 'ğŸ“„ Contrat sous-traitant',
        'export': 'ğŸ“‹ Format d\'export'
      };
      
      document.getElementById('templateEditorTitle').textContent = titles[type] || 'Ã‰diter le modÃ¨le';
      document.getElementById('templateName').value = type;
      
      // Charger le template sauvegardÃ© ou le dÃ©faut
      const savedTemplate = localStorage.getItem(`btp-template-${type}`);
      document.getElementById('templateContent').value = savedTemplate || defaultTemplates[type] || '';
      
      openModal('modalTemplateEditor');
    }
    
    function saveTemplate() {
      const content = document.getElementById('templateContent').value;
      if (!content.trim()) {
        showToast('âš ï¸ Le contenu ne peut pas Ãªtre vide', 'warning');
        return;
      }
      
      localStorage.setItem(`btp-template-${currentTemplateType}`, content);
      showToast('âœ… ModÃ¨le enregistrÃ©', 'success');
      addAdminLog('success', `Template modifiÃ©: ${currentTemplateType}`);
      closeModal('modalTemplateEditor');
    }
    
    function resetTemplate() {
      if (!confirm('RÃ©initialiser ce modÃ¨le aux valeurs par dÃ©faut ?')) return;
      
      document.getElementById('templateContent').value = defaultTemplates[currentTemplateType] || '';
      localStorage.removeItem(`btp-template-${currentTemplateType}`);
      showToast('ğŸ”„ ModÃ¨le rÃ©initialisÃ©', 'info');
    }
    
    function getTemplate(type) {
      return localStorage.getItem(`btp-template-${type}`) || defaultTemplates[type] || '';
    }

    // ========== CONSOLE BDD AVANCÃ‰E ==========
    let currentAdminTable = '';
    let selectedRowData = null;
    let selectedRowIndex = -1;
    
    function getTableData(tableName) {
      switch(tableName) {
        case 'soustraitants': return sousTraitants;
        case 'chantiers': return chantiers;
        case 'contrats': return contrats;
        case 'situations': return situations;
        case 'factures': return factures;
        case 'documents': return documents;
        case 'users': return users;
        default: return [];
      }
    }
    
    function getTableColumns(tableName) {
      const columns = {
        soustraitants: ['id', 'nom', 'siret', 'corpsMetier', 'ville', 'telephone', 'email', 'note'],
        chantiers: ['id', 'nom', 'adresse', 'client', 'montantTotal', 'statut', 'avancement'],
        contrats: ['id', 'chantierId', 'stId', 'lot', 'montantMarche', 'statut'],
        situations: ['id', 'contratId', 'chantierId', 'mois', 'annee', 'avancement', 'montantMois', 'statut', 'flux'],
        factures: ['id', 'numero', 'chantierId', 'stId', 'montantHT', 'dateEcheance', 'statut', 'type'],
        documents: ['id', 'nom', 'type', 'stId', 'dateExpiration', 'statut'],
        users: ['id', 'nom', 'email', 'role']
      };
      return columns[tableName] || ['id'];
    }
    
    function loadAdminTable() {
      const tableName = document.getElementById('adminTableSelect').value;
      const container = document.getElementById('adminTableContainer');
      
      if (!tableName) {
        container.innerHTML = `<div class="text-center py-8 text-slate-500">
          <span class="text-4xl">ğŸ“‹</span>
          <p class="mt-2">SÃ©lectionnez une table pour afficher les donnÃ©es</p>
        </div>`;
        return;
      }
      
      currentAdminTable = tableName;
      const data = getTableData(tableName);
      const columns = getTableColumns(tableName);
      
      if (data.length === 0) {
        container.innerHTML = `<div class="text-center py-8 text-slate-500">
          <span class="text-4xl">ğŸ“­</span>
          <p class="mt-2">Aucune donnÃ©e dans cette table</p>
        </div>`;
        return;
      }
      
      container.innerHTML = `
        <table class="data-table w-full text-sm">
          <thead>
            <tr>${columns.map(col => `<th class="text-xs">${col}</th>`).join('')}<th>Actions</th></tr>
          </thead>
          <tbody>
            ${data.map((row, idx) => `
              <tr class="hover:bg-violet-500/10 cursor-pointer" onclick="selectAdminRow(${idx}, '${tableName}')">
                ${columns.map(col => `<td class="text-slate-300 max-w-32 truncate" title="${escapeHtml(String(row[col] || ''))}">${escapeHtml(String(row[col] || '-'))}</td>`).join('')}
                <td>
                  <div class="flex gap-1">
                    <button onclick="event.stopPropagation(); editAdminRow(${idx}, '${tableName}')" class="px-2 py-1 bg-sky-600 hover:bg-sky-500 rounded text-xs text-white">âœï¸</button>
                    <button onclick="event.stopPropagation(); deleteAdminRow(${idx}, '${tableName}')" class="px-2 py-1 bg-red-600 hover:bg-red-500 rounded text-xs text-white">ğŸ—‘ï¸</button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
        <p class="text-xs text-slate-500 mt-3">${data.length} enregistrements</p>
      `;
      
      deselectRow();
    }
    
    function selectAdminRow(index, tableName) {
      const data = getTableData(tableName);
      selectedRowData = data[index];
      selectedRowIndex = index;
      currentAdminTable = tableName;
      
      document.getElementById('selectedRowId').textContent = `#${selectedRowData.id || index}`;
      document.getElementById('adminRowActions').classList.remove('hidden');
      
      // Highlight la ligne
      document.querySelectorAll('#adminTableContainer tr').forEach((tr, i) => {
        tr.classList.toggle('bg-violet-500/20', i === index + 1); // +1 pour skip header
      });
    }
    
    function deselectRow() {
      selectedRowData = null;
      selectedRowIndex = -1;
      document.getElementById('adminRowActions').classList.add('hidden');
      document.querySelectorAll('#adminTableContainer tr').forEach(tr => {
        tr.classList.remove('bg-violet-500/20');
      });
    }
    
    function editSelectedRow() {
      if (selectedRowData && selectedRowIndex >= 0) {
        editAdminRow(selectedRowIndex, currentAdminTable);
      }
    }
    
    function deleteSelectedRow() {
      if (selectedRowData && selectedRowIndex >= 0) {
        deleteAdminRow(selectedRowIndex, currentAdminTable);
      }
    }
    
    function editAdminRow(index, tableName) {
      const data = getTableData(tableName);
      const row = data[index];
      const columns = getTableColumns(tableName);
      
      selectedRowData = row;
      selectedRowIndex = index;
      currentAdminTable = tableName;
      
      const fieldsContainer = document.getElementById('editRowFields');
      fieldsContainer.innerHTML = columns.map(col => `
        <div>
          <label class="block text-sm text-slate-400 mb-2">${col}</label>
          <input type="text" id="edit-${col}" value="${escapeHtml(String(row[col] || ''))}" 
                 class="w-full" ${col === 'id' ? 'readonly' : ''}>
        </div>
      `).join('');
      
      openModal('modalEditRow');
    }
    
    function saveRowEdit() {
      if (!selectedRowData || selectedRowIndex < 0) return;
      
      const data = getTableData(currentAdminTable);
      const columns = getTableColumns(currentAdminTable);
      
      columns.forEach(col => {
        if (col !== 'id') {
          const input = document.getElementById(`edit-${col}`);
          if (input) {
            let value = input.value;
            // Convertir en nombre si nÃ©cessaire
            if (['montantTotal', 'montantMarche', 'montantMois', 'montantHT', 'avancement', 'note'].includes(col)) {
              value = parseFloat(value) || 0;
            }
            data[selectedRowIndex][col] = value;
          }
        }
      });
      
      // Sauvegarder en localStorage
      localStorage.setItem(`btp-${currentAdminTable}`, JSON.stringify(data));
      
      closeModal('modalEditRow');
      loadAdminTable();
      showToast('âœ… Enregistrement modifiÃ©', 'success');
      addAdminLog('info', `Modification dans ${currentAdminTable}`);
    }
    
    function deleteAdminRow(index, tableName) {
      if (!confirm(`Supprimer cet enregistrement de ${tableName} ?`)) return;
      
      const data = getTableData(tableName);
      const deleted = data.splice(index, 1)[0];
      
      localStorage.setItem(`btp-${tableName}`, JSON.stringify(data));
      
      loadAdminTable();
      showToast(`ğŸ—‘ï¸ Enregistrement supprimÃ©`, 'warning');
      addAdminLog('warning', `Suppression dans ${tableName}: ID ${deleted?.id || index}`);
    }
    
    function exportTableExcel() {
      if (!currentAdminTable) {
        showToast('âš ï¸ SÃ©lectionnez d\'abord une table', 'warning');
        return;
      }
      
      const data = getTableData(currentAdminTable);
      if (data.length === 0) {
        showToast('âš ï¸ Aucune donnÃ©e Ã  exporter', 'warning');
        return;
      }
      
      try {
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, currentAdminTable);
        
        const filename = `btp-${currentAdminTable}-${new Date().toISOString().slice(0,10)}.xlsx`;
        XLSX.writeFile(wb, filename);
        
        showToast(`ğŸ“Š Export Excel tÃ©lÃ©chargÃ©: ${filename}`, 'success');
        addAdminLog('success', `Export Excel: ${currentAdminTable}`);
      } catch (err) {
        console.error('Export Excel error:', err);
        showToast('âŒ Erreur lors de l\'export', 'error');
      }
    }
    
    function exportAllExcel() {
      try {
        const wb = XLSX.utils.book_new();
        
        const tables = ['soustraitants', 'chantiers', 'contrats', 'situations', 'factures', 'documents', 'users'];
        tables.forEach(table => {
          const data = getTableData(table);
          if (data.length > 0) {
            const ws = XLSX.utils.json_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, table);
          }
        });
        
        const filename = `btp-connect-backup-${new Date().toISOString().slice(0,10)}.xlsx`;
        XLSX.writeFile(wb, filename);
        
        showToast(`ğŸ“¦ Export complet tÃ©lÃ©chargÃ©: ${filename}`, 'success');
        addAdminLog('success', 'Export Excel complet de toutes les tables');
      } catch (err) {
        console.error('Export all Excel error:', err);
        showToast('âŒ Erreur lors de l\'export complet', 'error');
      }
    }
    
    function importExcelFile(input) {
      const file = input.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          
          let importedCount = 0;
          workbook.SheetNames.forEach(sheetName => {
            const sheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(sheet);
            
            // Mapper le nom de feuille vers la table
            const tableMap = {
              'soustraitants': sousTraitants,
              'sous-traitants': sousTraitants,
              'chantiers': chantiers,
              'contrats': contrats,
              'situations': situations,
              'factures': factures,
              'documents': documents,
              'users': users
            };
            
            const targetTable = tableMap[sheetName.toLowerCase()];
            if (targetTable && jsonData.length > 0) {
              // Fusionner les donnÃ©es (ajouter nouvelles, mettre Ã  jour existantes par ID)
              jsonData.forEach(row => {
                if (row.id) {
                  const existingIndex = targetTable.findIndex(item => item.id === row.id);
                  if (existingIndex >= 0) {
                    Object.assign(targetTable[existingIndex], row);
                  } else {
                    targetTable.push(row);
                  }
                } else {
                  row.id = Date.now() + Math.random();
                  targetTable.push(row);
                }
              });
              importedCount += jsonData.length;
              localStorage.setItem(`btp-${sheetName.toLowerCase()}`, JSON.stringify(targetTable));
            }
          });
          
          if (importedCount > 0) {
            showToast(`ğŸ“¥ ${importedCount} enregistrements importÃ©s`, 'success');
            addAdminLog('success', `Import Excel: ${importedCount} enregistrements`);
            loadAdminTable();
            updateAdminStats();
          } else {
            showToast('âš ï¸ Aucune donnÃ©e importÃ©e (vÃ©rifiez les noms des feuilles)', 'warning');
          }
        } catch (err) {
          console.error('Import Excel error:', err);
          showToast('âŒ Erreur lors de l\'import', 'error');
        }
      };
      reader.readAsArrayBuffer(file);
      input.value = '';
    }

    // ========== INIT ==========
    document.addEventListener('DOMContentLoaded', async function() {
      const savedTheme = localStorage.getItem('btp-theme') || 'dark';
      setTheme(savedTheme);
      
      // ========== MODE BYPASS DÃ‰SACTIVÃ‰ (Ã‰TAPE 8 - LOGIN REQUIS) ==========
      const bypassMode = false; // DÃ©sactivÃ© - authentification requise
      
      if (bypassMode) {
        console.log("ğŸ”“ Mode BYPASS activÃ© - Chargement direct de l'application");
        isLoggedIn = true;
        
        // Masquer landing et login
        const landingPage = document.getElementById('landingPage');
        const loginPage = document.getElementById('loginPage');
        if (landingPage) { landingPage.style.display = 'none'; landingPage.classList.add('hidden'); }
        if (loginPage) { loginPage.style.display = 'none'; loginPage.classList.add('hidden'); }
        
        // Charger les donnÃ©es depuis l'API
        try {
          await syncAllFromAPI();
          console.log("âœ… DonnÃ©es chargÃ©es depuis l'API");
        } catch (err) {
          console.warn("âš ï¸ API non disponible, utilisation des donnÃ©es locales:", err);
        }
        
        // Rendre l'interface
        renderDashboard();
        renderNotifications();
        renderUsers();
        checkAdminAccess();
        showToast('ğŸ”“ Mode dÃ©mo activÃ©', 'info');
        return;
      }
      // ========== FIN MODE BYPASS ==========
      
      // VÃ©rifier si dÃ©jÃ  connectÃ©
      const token = localStorage.getItem('btp-token');
      const userStr = localStorage.getItem('btp-user');
      
      if (token && userStr) {
        try {
          const user = JSON.parse(userStr);
          isLoggedIn = true;
          // Masquer landing et login, afficher app
          document.getElementById('landingPage').style.display = 'none';
          document.getElementById('landingPage').classList.add('hidden');
          document.getElementById('loginPage').style.display = 'none';
          document.getElementById('loginPage').classList.add('hidden');
          renderDashboard();
          renderNotifications();
          renderUsers();
          checkAdminAccess();
          showToast(`ğŸ‘‹ Bon retour ${user.nom} !`, 'success');
        } catch(e) {
          localStorage.removeItem('btp-token');
          localStorage.removeItem('btp-user');
          showLandingPage();
        }
      } else {
        // Afficher la landing page
        document.getElementById('landingPage').style.display = 'block';
        document.getElementById('landingPage').classList.remove('hidden');
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('loginPage').classList.add('hidden');
      }

      // PWA: register service worker only when served over http/https (not file:// in Electron).
      try {
        if ((location.protocol === 'https:' || location.protocol === 'http:') && 'serviceWorker' in navigator) {
          navigator.serviceWorker.register('/sw.js').catch(() => {});
        }
      } catch (_) {}
      
      // Smooth scroll pour les ancres de la landing page
      document.querySelectorAll('#landingPage a[href^="#lp-"]').forEach(anchor => {
        anchor.addEventListener('click', function(e) {
          e.preventDefault();
          const target = document.querySelector(this.getAttribute('href'));
          if (target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        });
      });
    });
  </script>

<script>
// UX: ESC to close any active modal
document.addEventListener('keydown', (e) => {
  if (e.key !== 'Escape') return;
  const modal = document.querySelector('.modal-overlay.active');
  if (modal) modal.classList.remove('active');
});
</script>

</body>
</html>